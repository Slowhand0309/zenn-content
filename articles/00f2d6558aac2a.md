---
title: "NextAuthã‚’è©¦ã™"
emoji: "ğŸ”"
type: "tech" # tech: æŠ€è¡“è¨˜äº‹ / idea: ã‚¢ã‚¤ãƒ‡ã‚¢
topics:
  - "nextjs"
  - "nextauth"
  - "node"
  - "auth"
published: true
---

# [NextAuth](https://next-auth.js.org/)

> Authentication for Next.js

## å„Version

```text
"next": "13.0.6",
"next-auth": "^4.18.6",
```

## ãƒ‘ãƒƒã‚±ãƒ¼ã‚¸ã‚¤ãƒ³ã‚¹ãƒˆãƒ¼ãƒ«

```sh
yarn add next-auth
```

## ç°¡å˜ãªã‚µãƒ³ãƒ—ãƒ«å®Ÿè£…

ä»Šå›ã¯Googleèªè¨¼ã‚’è©¦ã—ã¦è¦‹ãŸã„ã¨æ€ã„ã¾ã™ã€‚

### Googleå´ã®ã‚­ãƒ¼å–å¾—ã‚„è¨­å®š

#### OAuth åŒæ„ç”»é¢ã®è¨­å®š

1. [Google API Console](https://console.developers.google.com/) ã‹ã‚‰ã€ŒOAuth åŒæ„ç”»é¢ã€ã‚’é¸æŠ
2. ä»Šå›ã¯ãƒ†ã‚¹ãƒˆç”¨ãªã®ã§å¤–éƒ¨ã‚’é¸æŠã—ä½œæˆ
    ![image1](/images/00f2d6558aac2a/image1.png =500x)
3. ã‚¢ãƒ—ãƒªã®æƒ…å ±ã‚’è¨­å®šã—ã¾ã™
    ![image2](/images/00f2d6558aac2a/image2.png =500x)
4. ã‚¹ã‚³ãƒ¼ãƒ—ã®è¨­å®šã¯ãã®ã¾ã¾ã§æ¬¡ã«é€²ã¿ã¾ã™

å‚è€ƒURL

- [OAuth ã‚¦ã‚§ãƒ– ã‚¯ãƒ©ã‚¤ã‚¢ãƒ³ãƒˆ ID ã‚’ä½œæˆã™ã‚‹ - Google Workspace Migrate](https://support.google.com/workspacemigrate/answer/9222992?hl=ja)

#### ã‚¯ãƒ©ã‚¤ã‚¢ãƒ³ãƒˆIDã¨ã‚¯ãƒ©ã‚¤ã‚¢ãƒ³ãƒˆã‚·ãƒ¼ã‚¯ãƒ¬ãƒƒãƒˆã‚’å–å¾—

1. [Google API Console](https://console.developers.google.com/) ã‹ã‚‰ã€Œèªè¨¼æƒ…å ±ã€ã‚’é¸æŠ
2. ã€Œèªè¨¼æƒ…å ±ã‚’ä½œæˆã€>ã€ŒOAuth ã‚¯ãƒ©ã‚¤ã‚¢ãƒ³ãƒˆ IDã€ã‚’é¸æŠ
    ![image3](/images/00f2d6558aac2a/image3.png =500x)
3. ã‚¢ãƒ—ãƒªã‚±ãƒ¼ã‚·ãƒ§ãƒ³ã®ç¨®é¡ã¯ã€Œã‚¦ã‚§ãƒ–ã‚¢ãƒ—ãƒªã‚±ãƒ¼ã‚·ãƒ§ãƒ³ã€ã‚’é¸æŠ
4. åå‰ã‚’é©å½“ãªåå‰ã«è¨­å®š
5. ãƒªãƒ€ã‚¤ãƒ¬ã‚¯ãƒˆURIã¯ `http://localhost:3000/api/auth/callback/google` ã‚’è¨­å®š
    ![image4](/images/00f2d6558aac2a/image4.png =500x)

ä½œæˆã™ã‚‹ã¨ã‚¯ãƒ©ã‚¤ã‚¢ãƒ³ãƒˆIDã¨ã‚¯ãƒ©ã‚¤ã‚¢ãƒ³ãƒˆã‚·ãƒ¼ã‚¯ãƒ¬ãƒƒãƒˆãŒè¡¨ç¤ºã•ã‚Œã‚‹ã®ã§ä¿å­˜ã—ã¦ãŠãã¾ã™ã€‚
![image5](/images/00f2d6558aac2a/image5.png =500x)

### API route ã‚’è¿½åŠ 

`pages/api/auth/[...nextauth].ts` ã‚’ä»¥ä¸‹å†…å®¹ã§ä½œæˆã—ã¾ã™ã€‚

```ts
import NextAuth from 'next-auth';
import GoogleProvider from 'next-auth/providers/google';

export default NextAuth({
  providers: [
    GoogleProvider({
      clientId: process.env.GOOGLE_CLIENT_ID ?? '',
      clientSecret: process.env.GOOGLE_CLIENT_SECRET ?? '',
    }),
  ],
  session: { strategy: 'jwt' },
});
```

å„Providerã«é–¢ã—ã¦ã¯[ã“ã¡ã‚‰](https://next-auth.js.org/providers)å‚ç…§
Googleã®OAuth2.0ã«é–¢é€£ã™ã‚‹ãƒ‰ã‚­ãƒ¥ãƒ¡ãƒ³ãƒˆã¯[ã“ã¡ã‚‰](https://developers.google.com/identity/protocols/oauth2)

#### callbacksã«é–¢ã—ã¦

[Callbacks | NextAuth.js](https://next-auth.js.org/configuration/callbacks)

å‘¼ã°ã‚Œã‚‹é †ç•ª

1. signIn
2. jwt
3. redirect
4. session

#### signInå¾Œã«ç‰¹å®šã®ãƒšãƒ¼ã‚¸ã«é·ç§»ã•ã›ã‚‹æ–¹æ³•

- `signIn()` ã®ç¬¬äºŒå¼•æ•°ã® `callbackUrl` ã«ç‰¹å®šã®ãƒšãƒ¼ã‚¸ã‚’è¨­å®š
- ãŸã ã— `redirect` ã‚’è¨­å®šã—ã¦ã„ã‚‹ã¨ãã¡ã‚‰ãŒå„ªå…ˆã•ã‚Œã‚‹ã®ã§ã€å¿…è¦ãªã„å ´åˆã¯å‰Šé™¤ã—ã¨ã

#### [session](https://next-auth.js.org/configuration/options#session)ã«é–¢ã—ã¦

- strategy
  - ãƒ‡ãƒ•ã‚©ãƒ«ãƒˆã¯ `jwt`

### _app.tsxã«SessionProviderè¿½åŠ 

```tsx
import { SessionProvider } from 'next-auth/react';
import type { AppProps } from 'next/app';

function MyApp({ Component, pageProps: { session, ...pageProps } }: AppProps) {
  return (
    <SessionProvider session={session}>
      <Component {...pageProps} />
    </SessionProvider>
  );
}

export default MyApp;
```

### SignIn, SignOutã‚’è©¦ã™ç”»é¢ã‚’ä½œæˆ

```tsx
import { signIn, signOut, useSession } from 'next-auth/react';

export default function Page() {
  const { data: session } = useSession();
  return session ? (
    <>
      Signed in <br />
      <button onClick={() => signOut()}>Sign Out</button>
    </>
  ) : (
    <>
      Not signed in <br />
      <button onClick={() => signIn()}>Sign In</button>
    </>
  );
}
```

## middlewareã§ãƒšãƒ¼ã‚¸ã«èªè¨¼ã‚’ã‹ã‘ã‚‹

https://next-auth.js.org/configuration/nextjs#middleware
äº‹å‰ã« [NEXTAUTH_SECRET](https://next-auth.js.org/configuration/options#nextauth_secret) ã‚’è¨­å®šã™ã‚‹å¿…è¦ãŒã‚ã‚Šã¾ã™ã€‚ä»¥ä¸‹ã‚³ãƒãƒ³ãƒ‰ã§ç”Ÿæˆã—ãŸãƒ©ãƒ³ãƒ€ãƒ ãªå€¤ã‚’ `.env.local` ã«è¨­å®šã—ã¨ãã¾ã™ã€‚

```sh
openssl rand -base64 32
```

```text:.env.local
NEXTAUTH_SECRET=ç”Ÿæˆã—ãŸãƒ©ãƒ³ãƒ€ãƒ ãªå€¤
```

æ¬¡ã« `middleware.ts` ã‚’ä»¥ä¸‹å†…å®¹ã§ãƒ—ãƒ­ã‚¸ã‚§ã‚¯ãƒˆã®ãƒ«ãƒ¼ãƒˆãƒ‡ã‚£ãƒ¬ã‚¯ãƒˆãƒªã€ã¾ãŸã¯ `pages` ã¨åŒéšå±¤ã«ä½œæˆã—ã¾ã™ã€‚

```ts
export { default } from 'next-auth/middleware';
```

â†‘ã ã‘ã§ã€å…¨ãƒšãƒ¼ã‚¸ã«SignInã—ã¦ã„ã‚‹ã‹ã®ãƒã‚§ãƒƒã‚¯ãŒã‹ã‹ã‚Šã¾ã™ã€‚
ç‰¹å®šã®ãƒšãƒ¼ã‚¸ã®ã¿ãƒã‚§ãƒƒã‚¯ã—ãŸã„å ´åˆã¯

```ts
export { default } from 'next-auth/middleware';

export const config = {
  matcher: ['/xxx'],
};
```

ç‰¹å®šã®ãƒšãƒ¼ã‚¸ã‚’æŒ‡å®šã—ãŸ `config` ã‚’è¿”ã™äº‹ã§å®Ÿç¾ã§ãã¾ã™ã€‚

## ãƒãƒƒã‚¯ã‚¨ãƒ³ãƒ‰å´ã§ã®èªè¨¼ãƒã‚§ãƒƒã‚¯

[ãƒãƒƒã‚¯ã‚¨ãƒ³ãƒ‰ ã‚µãƒ¼ãƒãƒ¼ã§èªè¨¼ã™ã‚‹ Â |Â  Authentication Â |Â  Google Developers](https://developers.google.com/identity/sign-in/web/backend-auth)
â†‘ã“ã¡ã‚‰ã‚’å‚è€ƒã«å®Ÿè£…ã—ã¦ã¿ã¾ã™ã€‚ãƒãƒƒã‚¯ã‚¨ãƒ³ãƒ‰å´ã¯Node.jsã‚µãƒ¼ãƒãƒ¼ã®æƒ³å®šã§ã™ã€‚

[googleapis/google-auth-library-nodejs: ğŸ”‘ Google Auth Library for Node.js](https://github.com/googleapis/google-auth-library-nodejs)
â†‘ã“ã¡ã‚‰ã®ãƒ‘ãƒƒã‚±ãƒ¼ã‚¸ã‚’ä½¿ãˆã°verifyéƒ¨åˆ†ã¯ã‚µã‚¯ãƒƒã¨å®Ÿè£…ã§ãã¾ã™ã€‚

```ts
import { OAuth2Client } from 'google-auth-library';

const client = new OAuth2Client();

const verify = async (
  idToken: string,
  sub: string
): Promise<boolean> => {
  const ticket = await client.verifyIdToken({
    idToken,
  });
  const payload = ticket.getPayload();
  return payload?.sub === sub;
};
```

# å‚è€ƒURL

- [NextAuth ä½¿ã£ã¦ã¿ãŸ](https://zenn.dev/happy663/articles/30dc517646653c)
- [NextAuth.jsã‚’ä½¿ã£ãŸGoogleèªè¨¼æ©Ÿèƒ½ï¼‹ãƒ‡ãƒ¼ã‚¿ãƒ™ãƒ¼ã‚¹(Prisma)ã®è¨­å®šã®ç†è§£ | ã‚¢ãƒ¼ãƒ«ã‚¨ãƒ•ã‚§ã‚¯ãƒˆ](https://reffect.co.jp/react/next-auth)
- [NextAuth.jsã«ã¤ã„ã¦èª¿ã¹ãŸã®ã§ä½¿ã„æ–¹ã¾ã¨ã‚ã¨ã](https://zenn.dev/nrikiji/articles/d37393da5ae9bc#%E3%81%9D%E3%81%AE%E4%BB%96)
- [ã€JWTã€‘ å…¥é–€ - Qiita](https://qiita.com/knaot0/items/8427918564400968bd2b)
- [NextAuth.jsã§ãƒ­ã‚°ã‚¤ãƒ³æ©Ÿèƒ½ã‚’å®Ÿè£…ã—ã¦ã¿ãŸè©± - NIFTY engineering](https://engineering.nifty.co.jp/blog/9817)
- [NextAuthã®middlewareã§ãƒšãƒ¼ã‚¸ã”ã¨ã®èªè¨¼ãƒã‚§ãƒƒã‚¯ã‚’å®Ÿè£…ã™ã‚‹](https://zenn.dev/sakazuki_xyz/articles/2cabad91bb8acb)

