---
title: "Next.js + Web Workerã§Supabaseã®Database Changesã‚’å—ã‘ã‚‹"
emoji: "ğŸ“¡"
type: "tech" # tech: æŠ€è¡“è¨˜äº‹ / idea: ã‚¢ã‚¤ãƒ‡ã‚¢
topics:
  - "nextjs"
  - "supabase"
  - "webworker"
  - "react"
  - "typescript"
published: true
---
# æ¦‚è¦

ä»Šå›ã¯Next.js + Web Workerã®æ§‹æˆã§ã€Supabaseã®Database Changesã‚’Workerå´ã§å—ã‘ã¦ãƒšãƒ¼ã‚¸å´ã«åæ˜ ã™ã‚‹ã¨ã„ã†äº‹ã‚’è©¦ã—ã¦ã¿ã¾ã—ãŸã€‚

## Web Worker

https://developer.mozilla.org/ja/docs/Web/API/Web_Workers_API

> **ã‚¦ã‚§ãƒ–ãƒ¯ãƒ¼ã‚«ãƒ¼**Â (Web Worker) ã¨ã¯ã€ã‚¦ã‚§ãƒ–ã‚¢ãƒ—ãƒªã‚±ãƒ¼ã‚·ãƒ§ãƒ³ã«ãŠã‘ã‚‹ã‚¹ã‚¯ãƒªãƒ—ãƒˆã®å‡¦ç†ã‚’ãƒ¡ã‚¤ãƒ³ã¨ã¯åˆ¥ã®ã‚¹ãƒ¬ãƒƒãƒ‰ã«ç§»ã—ã€ãƒãƒƒã‚¯ã‚°ãƒ©ã‚¦ãƒ³ãƒ‰ã§ã®å®Ÿè¡Œã‚’å¯èƒ½ã«ã™ã‚‹ä»•çµ„ã¿ã®ã“ã¨

ã¾ãŸã€ä»¥ä¸‹ã®ã‚ˆã†ãªåˆ¶é™ãŒã‚ã‚Šã¾ã™ã€‚

- ãƒ¯ãƒ¼ã‚«ãƒ¼å†…ã‹ã‚‰ç›´æ¥ DOM ã‚’æ“ä½œã™ã‚‹ã“ã¨ã¯ã§ããªã„
- [`window`](https://developer.mozilla.org/ja/docs/Web/API/Window)Â ã‚ªãƒ–ã‚¸ã‚§ã‚¯ãƒˆã®æ—¢å®šã®ãƒ¡ã‚½ãƒƒãƒ‰ã‚„ãƒ—ãƒ­ãƒ‘ãƒ†ã‚£ã«ã¯ä½¿ç”¨ã§ããªã„ã‚‚ã®ãŒã‚ã‚‹
  - [ãƒ¯ãƒ¼ã‚«ãƒ¼ã‚°ãƒ­ãƒ¼ãƒãƒ«ã‚³ãƒ³ãƒ†ã‚­ã‚¹ãƒˆã¨é–¢æ•°](https://developer.mozilla.org/ja/docs/Web/API/Web_Workers_API#%E3%83%AF%E3%83%BC%E3%82%AB%E3%83%BC%E3%82%B0%E3%83%AD%E3%83%BC%E3%83%90%E3%83%AB%E3%82%B3%E3%83%B3%E3%83%86%E3%82%AD%E3%82%B9%E3%83%88%E3%81%A8%E9%96%A2%E6%95%B0)
  - [åˆ©ç”¨å¯èƒ½ãªWeb API](https://developer.mozilla.org/ja/docs/Web/API/Web_Workers_API#%E5%88%A9%E7%94%A8%E5%8F%AF%E8%83%BD%E3%81%AA_web_api)

## Supabase Database Changes

https://supabase.com/docs/guides/realtime/subscribing-to-database-changes

> Supabaseã®Database Changesã¯ã€PostgreSQLã®æ©Ÿèƒ½ã‚’æ´»ç”¨ã—ã¦ã€ãƒ‡ãƒ¼ã‚¿ãƒ™ãƒ¼ã‚¹å†…ã®å¤‰æ›´ï¼ˆINSERTã€UPDATEã€DELETEï¼‰ã‚’ãƒªã‚¢ãƒ«ã‚¿ã‚¤ãƒ ã§æ¤œçŸ¥ã—ã¾ã™

# ãƒ—ãƒ­ã‚¸ã‚§ã‚¯ãƒˆä½œæˆ

æ—©é€Ÿã‚µãƒ³ãƒ—ãƒ«ç”¨ã®ãƒ—ãƒ­ã‚¸ã‚§ã‚¯ãƒˆã‚’ä½œæˆã—ã¦ã„ãã¾ã™ã€‚ä»Šå›ã¯ä»¥ä¸‹ãƒªãƒã‚¸ãƒˆãƒªãƒ†ãƒ³ãƒ—ãƒ¬ãƒ¼ãƒˆã‚’ä½¿ç”¨ã—ã¦ãƒ—ãƒ­ã‚¸ã‚§ã‚¯ãƒˆã‚’ä½œæˆã—ã¾ã—ãŸã€‚ä¸€ã‹ã‚‰Next.jsã®ãƒ—ãƒ­ã‚¸ã‚§ã‚¯ãƒˆã‚’ä½œæˆã—ã¦ã‚‚å¤§ä¸ˆå¤«ã§ã™ã€‚
ãƒ—ãƒ­ã‚¸ã‚§ã‚¯ãƒˆåã¯ `nextjs_web_worker_example` ã¨ã—ã¦ä½œæˆã—ã¾ã—ãŸã€‚

https://github.com/Slowhand0309/nextjs-devcontainer-boilerplate

å„ãƒãƒ¼ã‚¸ãƒ§ãƒ³ã¯ä»¥ä¸‹ã«ãªã‚Šã¾ã™ã€‚

```json
  "dependencies": {
    "@chakra-ui/icons": "^2.1.1",
    "@chakra-ui/react": "^2.8.2",
    "@emotion/react": "^11.13.5",
    "@emotion/styled": "^11.13.0",
    "framer-motion": "^11.11.17",
    "next": "^14.0.2",
    "react": "^18.2.0",
    "react-dom": "^18.2.0"
  },
    "devDependencies": {
    "@types/node": "22.7.4",
    "@types/react": "^18.2.37",
    "@types/react-dom": "^18.2.15",
    "eslint": "8.57.0",
    "eslint-config-next": "15.0.3",
    "prettier": "^3.3.3",
    "typescript": "^5.1.6"
  }
```

# ç°¡å˜ãªã‚µãƒ³ãƒ—ãƒ«å®Ÿè£…

ã¾ãšã¯ã‚·ãƒ³ãƒ—ãƒ«ã«å…¥åŠ›ã•ã‚ŒãŸæ–‡å­—ã‚’ä½•ç§’å¾Œã‹ã«è¿”ã™Workerã‚’ä½œæˆã—ãŸã„ã¨æ€ã„ã¾ã™ã€‚

`libs/echo_worker.ts` ã‚’ä»¥ä¸‹å†…å®¹ã§ä½œæˆã—ã¾ã™ã€‚

```tsx
const worker = self as unknown as Worker;

// 2ç§’å¾Œã«ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸ã‚’è¿”ã™Worker
worker.addEventListener('message', (e: MessageEvent<string>) => {
  console.log('worker received:', e.data);
  setTimeout(() => {
    worker.postMessage(e.data);
  }, 2000);
});
```

æ¬¡ã« `app/(examples)/basic/page.tsx` ã‚’ä»¥ä¸‹å†…å®¹ã«ä¿®æ­£ã—ã¾ã™ã€‚

```tsx
'use client';

import {
  Breadcrumb,
  BreadcrumbItem,
  BreadcrumbLink,
  Button,
  Heading,
  Input,
  Text,
  VStack,
} from '@chakra-ui/react';
import { useState } from 'react';

const BasicPage = () => {
  const [text, setText] = useState<string>();
  const [value, setValue] = useState<string>();
  return (
    <VStack minH="100vh" p={8} alignItems="flex-start">
      <Breadcrumb fontSize="xl">
        <BreadcrumbItem>
          <BreadcrumbLink href="/" color="blue.400">
            Home
          </BreadcrumbLink>
        </BreadcrumbItem>
        <BreadcrumbItem isCurrentPage>
          <BreadcrumbLink>Basic</BreadcrumbLink>
        </BreadcrumbItem>
      </Breadcrumb>
      <Heading as="h2" size="xl">
        Basic
      </Heading>
      <Text>æ–‡å­—ã‚’å…¥åŠ›ã—ã¦å®Ÿè¡Œã™ã‚‹ã¨2ç§’å¾Œã«WorkerãŒåŒã˜å†…å®¹ã‚’è¿”ã—ã¾ã™</Text>
      <Input onChange={(e) => setText(e.target.value)} />
      <Button
        mt={4}
        onClick={(e) => {
          e.preventDefault();
          const worker = new Worker(
            new URL('../../../libs/echo_worker', import.meta.url),
          );
          worker.addEventListener('message', ({ data }) => {
            setValue(data);
          });
          console.log('main thread:', text);
          worker.postMessage(text);
        }}
      >
        å®Ÿè¡Œ
      </Button>
      <Text>{value}</Text>
    </VStack>
  );
};

export default BasicPage;
```

æ—©é€Ÿè©¦ã—ã¦ã¿ã‚‹ã¨ğŸ‘‡ã®æ§˜ã«2ç§’å¾Œã«ãƒ¬ã‚¹ãƒãƒ³ã‚¹ãŒã‚ã‚‹ã®ãŒåˆ†ã‹ã‚Šã¾ã™ã€‚

![image1.gif](/images/40e25fcb91cf8c/image1.gif =400x)

# SharedWorker

æ¬¡ã«åå‰ã®é€šã‚Šã€å„ã‚¦ã‚£ãƒ³ãƒ‰ã‚¦ã‚„ã‚¿ãƒ–ç­‰ã§å…±æœ‰ã—ã¦ã‚¢ã‚¯ã‚»ã‚¹ã§ãã‚‹ SharedWorker ã‚’è©¦ã—ã¦ã¿ãŸã„ã¨æ€ã„ã¾ã™ã€‚

https://developer.mozilla.org/ja/docs/Web/API/SharedWorker

`libs/echo_shared_worker.ts` ã‚’ä»¥ä¸‹å†…å®¹ã§ä½œæˆã—ã¾ã™ã€‚

```tsx
const sharedWorker = self as unknown as SharedWorker;

let globalNumber = 0;

const ports: MessagePort[] = [];

sharedWorker.addEventListener('connect', (e) => {
  const port = (e as MessageEvent).ports[0];
  ports.push(port);
  port.start();
});

// 1ç§’å¾Œã«ã‚°ãƒ­ãƒ¼ãƒãƒ«ãªå€¤ã‚’ã‚¤ãƒ³ã‚¯ãƒªãƒ¡ãƒ³ãƒˆã—ã¦è¿”ã™
setInterval(() => {
  globalNumber++;
  ports.forEach((port) => port.postMessage(globalNumber));
}, 1000);
```

æ¬¡ã« `app/(examples)/shared-worker-basic/page.tsx` ã‚’ä»¥ä¸‹å†…å®¹ã§ä½œæˆã—ã¾ã™ã€‚

```tsx
'use client';

import {
  Breadcrumb,
  BreadcrumbItem,
  BreadcrumbLink,
  Heading,
  Text,
  VStack,
} from '@chakra-ui/react';
import { useEffect, useState } from 'react';

const SharedWorkerBasicPage = () => {
  const [value, setValue] = useState<number>(0);

  useEffect(() => {
    const worker = new SharedWorker(
      new URL('../../../libs/echo_shared_worker', import.meta.url),
    );
    worker.port.addEventListener('message', ({ data }) => {
      setValue(data);
    });
    worker.port.start();
    return () => {
      worker.port.close();
    };
  }, []);
  return (
    <VStack minH="100vh" p={8} alignItems="flex-start">
      <Breadcrumb fontSize="xl">
        <BreadcrumbItem>
          <BreadcrumbLink href="/" color="blue.400">
            Home
          </BreadcrumbLink>
        </BreadcrumbItem>
        <BreadcrumbItem isCurrentPage>
          <BreadcrumbLink>SharedWorker Basic</BreadcrumbLink>
        </BreadcrumbItem>
      </Breadcrumb>
      <Heading as="h2" size="xl">
        SharedWorker Basic
      </Heading>
      <Text>
        ãƒšãƒ¼ã‚¸ã‚’é–‹ãã¨1ç§’é–“éš”ã§SharedWorkerãŒã‚°ãƒ­ãƒ¼ãƒãƒ«ãªå€¤ã‚’ã‚¤ãƒ³ã‚¯ãƒªãƒ¡ãƒ³ãƒˆã—ã¦è¿”ã—ã¾ã™
      </Text>
      <Text>{value}</Text>
    </VStack>
  );
};

export default SharedWorkerBasicPage;
```

[http://localhost:3000/shared-worker-basic](http://localhost:3000/shared-worker-basic) ã«ã‚¢ã‚¯ã‚»ã‚¹ã™ã‚‹ã¨ã€ä»¥ä¸‹ã®æ§˜ã«è¤‡æ•°ã‚¿ãƒ–ã§åŒã˜å†…å®¹ãŒè¡¨ç¤ºã•ã‚Œã¦ã„ã‚‹ã®ãŒåˆ†ã‹ã‚‹ã‹ã¨æ€ã„ã¾ã™ã€‚

![image2.gif](/images/40e25fcb91cf8c/image2.gif)

SharedWorkerã«ä»•è¾¼ã‚“ã ãƒ­ã‚°ã‚’è¦‹ãŸã„å ´åˆã¯ã€`chrome://inspect/#workers` ã«ã‚¢ã‚¯ã‚»ã‚¹ã—ã¦è©²å½“ã®Workerã® `inspect` ã‚’é¸æŠã™ã‚‹ã¨è¦‹ã‚Œã‚‹ã‚ˆã†ã«ãªã‚Šã¾ã™ã€‚

![image3.png](/images/40e25fcb91cf8c/image3.png)

# ãƒ­ãƒ¼ã‚«ãƒ«ã§ã®Supabaseç’°å¢ƒæ§‹ç¯‰

https://supabase.com/docs/guides/local-development

Supabase CLI ã‚’ä½¿ã£ã¦ç’°å¢ƒæ§‹ç¯‰ã—ã¦ã„ããŸã„ã¨æ€ã„ã¾ã™ã€‚

```bash
$ npx supabase init
Generate VS Code settings for Deno? [y/N] N
Generate IntelliJ Settings for Deno? [y/N] N
```

Database Changesã®ç›£è¦–å¯¾è±¡ã®ãƒ†ãƒ¼ãƒ–ãƒ«ã‚’ä½œæˆã—ã¾ã™ã€‚

```bash
npx supabase migration new create_books_table
```

ğŸ‘†ã‚’å®Ÿè¡Œã™ã‚‹ã¨ `supabase/migrations/` é…ä¸‹ã«sqlãƒ•ã‚¡ã‚¤ãƒ«ãŒä½œæˆã•ã‚Œã‚‹ã¨æ€ã†ã®ã§ã€ã“ã¡ã‚‰ã«booksãƒ†ãƒ¼ãƒ–ãƒ«ä½œæˆã®SQLã‚’æ›¸ã„ã¦ã„ãã¾ã™ã€‚

```sql

create table
books (
  id bigint primary key generated always as identity,
  name text,
  author text,
  created_at timestamptz default now(),
  updated_at timestamptz default now()
);
```

ã“ã“ã¾ã§ç”¨æ„ãŒã§ããŸã‚‰ `npx supabase start` ã§ãƒ­ãƒ¼ã‚«ãƒ«ã§ã®Supabaseç’°å¢ƒã‚’ç«‹ã¡ä¸Šã’ã¾ã™ã€‚

ç«‹ã¡ä¸Šã’ã‚‹ã¨ `Studio URL` ãŒè¡¨ç¤ºã•ã‚Œã‚‹ã®ã§ã€ã‚¢ã‚¯ã‚»ã‚¹ã—ã¦ã¿ã‚‹ã¨ãƒ€ãƒƒã‚·ãƒ¥ãƒœãƒ¼ãƒ‰ãŒè¡¨ç¤ºã•ã‚Œã‚‹ã‹ã¨æ€ã„ã¾ã™ã€‚

ãƒ€ãƒƒã‚·ãƒ¥ãƒœãƒ¼ãƒ‰ã®ã‚µã‚¤ãƒ‰ãƒ¡ãƒ‹ãƒ¥ãƒ¼ã‹ã‚‰ã€ŒTable Editorã€ã‚’é¸æŠã—ã¾ã™ã€‚

![image4.png](/images/40e25fcb91cf8c/image4.png =400x)

ä¸Šæ‰‹ãã„ã£ã¦ã‚Œã°ã€å…ˆã»ã©ä½œæˆã—ãŸã€Œbooksã€ãƒ†ãƒ¼ãƒ–ãƒ«ãŒè¡¨ç¤ºã•ã‚Œã¦ã„ã‚‹ã‹ã¨æ€ã„ã¾ã™ã€‚

![image5.png](/images/40e25fcb91cf8c/image5.png =400x)

ã€Œbooksã€ãƒ†ãƒ¼ãƒ–ãƒ«ã‚’é¸æŠã—ã€Database Changesã‚’ç›£è¦–ã™ã‚‹ç‚ºã«ã€å³ä¸Šã®ã€ŒRealtime offã€ã‚’ã‚¯ãƒªãƒƒã‚¯ã—ã€ŒEnable realtimeã€ã‚’é¸æŠã—ã¾ã™ã€‚

![image6.png](/images/40e25fcb91cf8c/image6.png =400x)

![image7.png](/images/40e25fcb91cf8c/image7.png =400x)

å…ˆã»ã©ã®ã€ŒRealtime offã€â†’ã€ŒRealtime onã€ã«å¤‰ã‚ã£ã¦ã„ã‚Œã°OKã§ã™ã€‚ä¸€æ—¦ä»¥ä¸Šã§æœ€ä½é™ã®è¨­å®šãŒå®Œäº†ã—ã¾ã—ãŸã€‚

1ä»¶é©å½“ã«ãƒ‡ãƒ¼ã‚¿ã‚‚ç™»éŒ²ã—ã¦ãŠãã¾ã™ã€‚å·¦ä¸Šã®ã€ŒInsertã€>ã€ŒInsert rowã€ã‹ã‚‰ãƒ‡ãƒ¼ã‚¿ã‚’ç™»éŒ²ã—ã¾ã™ã€‚

![image8.png](/images/40e25fcb91cf8c/image8.png =400x)

![image9.png](/images/40e25fcb91cf8c/image9.png =400x)

# ã‚·ãƒ³ãƒ—ãƒ«ãªWeb Workerã§Database Changesã‚’å—ã‘ã‚‹ã‚µãƒ³ãƒ—ãƒ«å®Ÿè£…

ä»Šåº¦ã¯Next.jså´ã§å¿…è¦ã«ãªã‚‹ãƒ‘ãƒƒã‚±ãƒ¼ã‚¸ã‚’ã‚¤ãƒ³ã‚¹ãƒˆãƒ¼ãƒ«ã—ã¦ã„ãã¾ã™ã€‚

```bash
yarn add @supabase/supabase-js
```

æ¬¡ã« `libs/supabase.ts` ã‚’ä»¥ä¸‹å†…å®¹ã§ä½œæˆã—ã¾ã™ã€‚

```tsx
import { createClient } from '@supabase/supabase-js';

export const supabase = createClient(
  'http://localhost:54321',
  'eyJh...',
);
```

â€» å¼•æ•°ã®ç¬¬äºŒãƒ‘ãƒ©ãƒ¡ãƒ¼ã‚¿ã«ã¯ `npx supabase start` æ™‚ã«è¡¨ç¤ºã•ã‚ŒãŸ  `anon key` ã‚’è¨­å®šã—ã¾ã™ã€‚

æ¬¡ã«Workerã®å®Ÿè£…ã‚’é€²ã‚ã¦ã„ãã¾ã™ã€‚ `libs/db_changes_worker.ts` ã‚’ä»¥ä¸‹å†…å®¹ã§ä½œæˆã—ã¾ã™ã€‚

```tsx
import { RealtimeChannel } from '@supabase/supabase-js';
import { supabase } from './supabase';

const worker = self as unknown as Worker;

type ReciveMessageType = {
  type: 'start' | 'stop';
};

let channel: RealtimeChannel | null = null;

worker.addEventListener('message', (e) => {
  const message = e.data as ReciveMessageType;
  switch (message.type) {
    case 'start':
      channel = supabase
        .channel('worker-books-db-changes')
        .on(
          'postgres_changes',
          {
            event: 'UPDATE',
            schema: 'public',
            table: 'books',
          },
          (payload) => self.postMessage(payload.new),
        )
        .subscribe();
      break;
    case 'stop':
      channel?.unsubscribe();
      break;
    default:
      break;
  }
});
```

Pageå´ã®å®Ÿè£…ã¯ğŸ‘‡ã®å†…å®¹ã§ `app/(examples)/db-change-worker/page.tsx` ã‚’ä½œæˆã—ã¨ãã¾ã™ã€‚

```tsx
'use client';

import {
  Breadcrumb,
  BreadcrumbItem,
  BreadcrumbLink,
  Button,
  Heading,
  Text,
  VStack,
} from '@chakra-ui/react';
import { useEffect, useRef, useState } from 'react';

const DbChangeWorkerPage = () => {
  const [value, setValue] = useState<object>();
  const workerRef = useRef<Worker | null>(null);
  useEffect(() => {
    const worker = new Worker(
      new URL('../../../libs/db_changes_worker', import.meta.url),
    );
    worker.onmessage = (event) => {
      const data = event.data;
      setValue(data);
    };
    workerRef.current = worker;
    return () => {
      worker.terminate();
    };
  }, []);
  return (
    <VStack minH="100vh" p={8} alignItems="flex-start">
      <Breadcrumb fontSize="xl">
        <BreadcrumbItem>
          <BreadcrumbLink href="/" color="blue.400">
            Home
          </BreadcrumbLink>
        </BreadcrumbItem>
        <BreadcrumbItem isCurrentPage>
          <BreadcrumbLink>Database Changes Worker</BreadcrumbLink>
        </BreadcrumbItem>
      </Breadcrumb>
      <Heading as="h2" size="xl">
        Database Changes Worker
      </Heading>
      <Text>é–‹å§‹ã‚’ã‚¯ãƒªãƒƒã‚¯ã™ã‚‹ã¨booksãƒ†ãƒ¼ãƒ–ãƒ«ã®Updateã‚’ç›£è¦–ã—ã¾ã™</Text>
      <Button
        mt={4}
        onClick={(e) => workerRef.current?.postMessage({ type: 'start' })}
      >
        é–‹å§‹
      </Button>
      <Button
        mt={4}
        onClick={(e) => workerRef.current?.postMessage({ type: 'stop' })}
      >
        åœæ­¢
      </Button>
      <Text>{JSON.stringify(value)}</Text>
    </VStack>
  );
};

export default DbChangeWorkerPage;
```

ã„ã–å®Ÿè¡Œã—ã¦ã¿ã‚‹ã¨ğŸ‘‡ã®æ§˜ã«ã€æ›´æ–°ãŒã‚ã£ãŸã‚‰æ›´æ–°å†…å®¹ãŒè¡¨ç¤ºã•ã‚Œã¾ã™ã€‚

![image10.gif](/images/40e25fcb91cf8c/image10.gif)

ã¾ãŸã€ã€Œåœæ­¢ã€ã‚’ã‚¯ãƒªãƒƒã‚¯ã™ã‚‹ã¨ç›£è¦–ãŒåœæ­¢ã•ã‚Œã¾ã™ã€‚

![image11.gif](/images/40e25fcb91cf8c/image11.gif)

# SharedWorkerã§Database Changesã‚’å—ã‘ã‚‹ã‚µãƒ³ãƒ—ãƒ«å®Ÿè£…

æœ€å¾Œã«SharedWorkerã§Database Changesã‚’å—ã‘ã‚‹ã‚µãƒ³ãƒ—ãƒ«ã‚’ä½œæˆã—ã¦è¦‹ãŸã„ã¨æ€ã„ã¾ã™ã€‚

`libs/db_changes_shared_worker.ts` ã‚’ä»¥ä¸‹å†…å®¹ã§ä½œæˆã—ã¾ã™ã€‚

```tsx
import { RealtimeChannel } from '@supabase/supabase-js';
import type { ReciveMessageType } from './db_changes_worker';
import { supabase } from './supabase';

const dbChabgesSharedWorker = self as unknown as SharedWorker;
const workerPorts: MessagePort[] = [];

let channel: RealtimeChannel | null = null;

dbChabgesSharedWorker.addEventListener('connect', (e) => {
  const port = (e as MessageEvent).ports[0];
  port.onmessage = (event: MessageEvent) => {
    const message = event.data as ReciveMessageType;
    switch (message.type) {
      case 'start':
        channel = supabase
          .channel('worker-books-db-changes')
          .on(
            'postgres_changes',
            {
              event: 'UPDATE',
              schema: 'public',
              table: 'books',
            },
            (payload) =>
              workerPorts.forEach((port) => port.postMessage(payload.new)),
          )
          .subscribe();
        break;
      case 'stop':
        channel?.unsubscribe();
        break;
      default:
        break;
    }
  };

  workerPorts.push(port);
  port.start();
});
```

æ¬¡ã« `app/(examples)/db-change-shared-worker/page.tsx` ã‚’ä»¥ä¸‹å†…å®¹ã§ä½œæˆã—ã¾ã™ã€‚

```tsx
'use client';

import {
  Breadcrumb,
  BreadcrumbItem,
  BreadcrumbLink,
  Button,
  Heading,
  Text,
  VStack,
} from '@chakra-ui/react';
import { useEffect, useRef, useState } from 'react';

const DbChangeSharedWorkerPage = () => {
  const [value, setValue] = useState<object>();
  const workerRef = useRef<SharedWorker | null>(null);
  useEffect(() => {
    const worker = new SharedWorker(
      new URL('../../../libs/db_changes_shared_worker', import.meta.url),
    );
    worker.port.onmessage = (event) => {
      const data = event.data;
      setValue(data);
    };
    workerRef.current = worker;
    return () => {
      worker.port.close();
    };
  }, []);
  return (
    <VStack minH="100vh" p={8} alignItems="flex-start">
      <Breadcrumb fontSize="xl">
        <BreadcrumbItem>
          <BreadcrumbLink href="/" color="blue.400">
            Home
          </BreadcrumbLink>
        </BreadcrumbItem>
        <BreadcrumbItem isCurrentPage>
          <BreadcrumbLink>Database Changes Shared Worker</BreadcrumbLink>
        </BreadcrumbItem>
      </Breadcrumb>
      <Heading as="h2" size="xl">
        Database Changes Shared Worker
      </Heading>
      <Text>
        é–‹å§‹ã‚’ã‚¯ãƒªãƒƒã‚¯ã™ã‚‹ã¨SharedWorkerãŒbooksãƒ†ãƒ¼ãƒ–ãƒ«ã®Updateã‚’ç›£è¦–ã—ã¾ã™
      </Text>
      <Button
        mt={4}
        onClick={(e) => workerRef.current?.port.postMessage({ type: 'start' })}
      >
        é–‹å§‹
      </Button>
      <Button
        mt={4}
        onClick={(e) => workerRef.current?.port.postMessage({ type: 'stop' })}
      >
        åœæ­¢
      </Button>
      <Text>{JSON.stringify(value)}</Text>
    </VStack>
  );
};

export default DbChangeSharedWorkerPage;
```

ã“ã“ã¾ã§å®Ÿè£…ã§ããŸã‚‰ã€è¤‡æ•°ã‚¿ãƒ–ã‚’ç«‹ã¡ä¸Šã’ã€ã©ã‚Œã‹ä¸€ã¤ã®ã‚¿ãƒ–ã§ã€Œé–‹å§‹ã€ã‚’ã‚¯ãƒªãƒƒã‚¯ã™ã‚‹ã¨å…¨éƒ¨ã®ã‚¿ãƒ–ã§æ›´æ–°ã‚’å—ã‘ã‚Œã‚‹æ§˜ã«ãªã‚Šã¾ã™ã€‚

![image12.gif](/images/40e25fcb91cf8c/image12.gif)

# å‚è€ƒURL

https://medium.com/@ngrato/harnessing-the-power-of-web-workers-with-next-js-350901a99a10

https://zenn.dev/sora_kumo/articles/65420761a0bec2
