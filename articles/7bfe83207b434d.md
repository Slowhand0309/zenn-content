---
title: "Next.jsä½¿ã£ãŸãƒ—ãƒ­ã‚¸ã‚§ã‚¯ãƒˆã§ãƒ†ã‚¹ãƒˆã‚’æ›¸ã"
emoji: "ğŸ’«"
type: "tech"
topics:
  - "nextjs"
  - "jest"
  - "enzyme"
  - "test"
published: true
published_at: "2021-02-15 02:16"
---

# ã¯ã˜ã‚ã«

- ã“ã®è¨˜äº‹ã¯Next.jsä½¿ã£ã¦ã„ã¦ã€ã“ã‚Œã‹ã‚‰Unitãƒ†ã‚¹ãƒˆæ›¸ã“ã†ã¨æ€ã£ã¦ã„ã‚‹æ–¹å‘ã‘ã®è¨˜äº‹ã§ã™
- å¤§ã¾ã‹ãªæµã‚Œ
    - ä»–ã®Next.jsãƒ—ãƒ­ã‚¸ã‚§ã‚¯ãƒˆã§ã©ã‚“ãªãƒ†ã‚¹ãƒˆãƒ©ã‚¤ãƒ–ãƒ©ãƒªä½¿ã£ã¦ã„ã‚‹ã‹èª¿ã¹ã‚‹
    - ãƒ†ã‚¹ãƒˆç’°å¢ƒã‚’æ•´ãˆã‚‹
    - ç°¡å˜ãªãƒ†ã‚¹ãƒˆã‚’æ›¸ã„ã¦ã¿ã‚‹
    - How to
    - ã¾ã¨ã‚

# Next.js + Typescriptæ§‹æˆã§ã‚ˆãä½¿ã‚ã‚Œã¦ã„ã‚‹ãƒ†ã‚¹ãƒˆãƒ©ã‚¤ãƒ–ãƒ©ãƒª

- jestã¯ã©ã“ã®ãƒ—ãƒ­ã‚¸ã‚§ã‚¯ãƒˆã§ã‚‚ä½¿ã£ã¦ã„ãã†
- Reactã®ã‚³ãƒ³ãƒãƒ¼ãƒãƒ³ãƒˆã®ãƒ†ã‚¹ãƒˆã¯ Enzyme vs React Testing Library ã¨ã„ã†æ„Ÿã˜
    - Enzymeã¨React Testing Libraryã®æ¯”è¼ƒã¯ä»¥ä¸‹ã®è¨˜äº‹ãŒã¨ã¦ã‚‚å‚è€ƒã«ãªã‚Šèª­ã¾ã›ã¦ã„ãŸã ãã¾ã—ãŸ
        - [Enzyme vs React Testing Libraryçµå±€ã©ã£ã¡ãŒã„ã„ã®ã‹å•é¡Œã«å¯¾ã™ã‚‹å€‹äººçš„ãªå›ç­” - Qiita](https://qiita.com/nnishimura/items/521af77125d2b7ad49c5)
    - ä»Šå›ã¯Unitãƒ†ã‚¹ãƒˆãŒæ›¸ãã‚„ã™ãã†ãª `Enzyme` ã§ã‚„ã£ã¦ã„ã“ã†ã¨æ€ã„ã¾ã™

# ç’°å¢ƒæ§‹ç¯‰ã‚„æº–å‚™

å„ãƒãƒ¼ã‚¸ãƒ§ãƒ³ã‚„ç’°å¢ƒ

```
- nextjs: 10.0.1
- enzyme: 3.11.0
- enzyme-adapter-react-16: 1.15.5
- jest: 26.6.3
- react-test-renderer: 17.0.1
```

ã‚‚ã‚ã‚‚ã‚å¿…è¦ãªãƒ‘ãƒƒã‚±ãƒ¼ã‚¸ã‚’ã‚¤ãƒ³ã‚¹ãƒˆãƒ¼ãƒ«

```bash
$ yarn add -D jest ts-jest react-test-renderer enzyme enzyme-adapter-react-16 enzyme-to-json @types/react-test-renderer @types/jest @types/enzyme-adapter-react-16
```

### [react-test-renderer](https://www.npmjs.com/package/react-test-renderer)ã¨ã¯?

- React ã‚³ãƒ³ãƒãƒ¼ãƒãƒ³ãƒˆã‚’ãƒ”ãƒ¥ã‚¢ãª JavaScript ã‚ªãƒ–ã‚¸ã‚§ã‚¯ãƒˆã«ãƒ¬ãƒ³ãƒ€ãƒ¼ã™ã‚‹ã“ã¨ãŒã§ãã‚‹ React ãƒ¬ãƒ³ãƒ€ãƒ©ã‚’æä¾›
- ã‚¹ãƒŠãƒƒãƒ—ã‚·ãƒ§ãƒƒãƒˆãƒ†ã‚¹ãƒˆã§ä½¿ç”¨
- å‡ºåŠ›ã‚’èµ°æŸ»ã—ã¦ç‰¹å®šã®ãƒãƒ¼ãƒ‰ã‚’æ¤œç´¢ã—ã€ãã‚Œã‚‰ã«å¯¾ã—ã¦ã‚¢ã‚µãƒ¼ã‚·ãƒ§ãƒ³ã‚’è¡Œã†ã“ã¨ã‚‚å¯èƒ½

## 1. ç°¡å˜ãªãƒ†ã‚¹ãƒˆã‚’å‹•ã‹ã›ã‚‹ã¾ã§ã®ç’°å¢ƒæ§‹ç¯‰

### 1-1. ãƒ†ã‚¹ãƒˆç”¨ã®ãƒ‡ã‚£ãƒ¬ã‚¯ãƒˆãƒªä½œæˆ

ãƒ—ãƒ­ã‚¸ã‚§ã‚¯ãƒˆã®ç›´ä¸‹ã« `__tests__` ãƒ‡ã‚£ãƒ¬ã‚¯ãƒˆãƒªã‚’ä½œæˆã—ã€ãƒ†ã‚¹ãƒˆã‚„è¨­å®šã¯ã“ã¡ã‚‰ã«å®Ÿè£…ã—ã¦ã„ããŸã„ã¨æ€ã„ã¾ã™ã€‚
ã“ã®ä¸­ã« `setupTests.ts` ã¨ `tsconfig.jest.json` ã‚’ä»¥ä¸‹å†…å®¹ã§ä½œæˆã—ã¾ã™ã€‚

```tsx:setupTests.ts
import Enzyme from 'enzyme';
import Adapter from 'enzyme-adapter-react-16';

Enzyme.configure({ adapter: new Adapter() });

process.env = {
	...process.env,
	__NEXT_IMAGE_OPTS: {
		deviceSizes: [320, 420, 768, 1024, 1200],
		imageSizes: [],
		domains: ['images.example.com'],
		path: '/_next/image',
		loader: 'default',
	} as any,
};
```

`__NEXT_IMAGE_OPTS` ã«é–¢ã—ã¦ã¯å¾Œè¿°ã®ãƒãƒƒãƒ‰ãƒã‚¦ãƒã‚¦ã§ã‚‚å‡ºã¦ãã¾ã™ãŒã€`next/image` ã‚’ä½¿ã£ã¦ã„ã‚‹ç®‡æ‰€ã‚’ãƒ†ã‚¹ãƒˆã™ã‚‹éš›ã«å¿…è¦ã§ã™ã€‚

```json:tsconfig.jest.json
{
  "extends": "../tsconfig.json",
  "compilerOptions": {
    "jsx": "react"
  }
}
```

æ¬¡ã«ãƒ†ã‚¹ãƒˆå¯¾è±¡ã®Componentã§ `css` ãƒ•ã‚¡ã‚¤ãƒ«ã‚„ãƒªã‚½ãƒ¼ã‚¹ãƒ•ã‚¡ã‚¤ãƒ«ã‚’importã—ã¦ã„ãŸæ™‚ã«ã‚¨ãƒ©ãƒ¼ã«ãªã£ã¦ã—ã¾ã†ã®ã§ã€
ãƒ¢ãƒƒã‚¯ç”¨ã®ãƒ•ã‚¡ã‚¤ãƒ«ã‚’ä½œæˆã—ã¦ã‚„ã‚Šã¾ã™ã€‚(ã“ã‚Œã‚‚ãƒãƒƒãƒ‰ãƒã‚¦ãƒã‚¦ã§å¾Œè¿°)

`__tests__/mocks/fileMock.js` ã¨ `__tests__/mocks/styleMock.js` ã‚’ä»¥ä¸‹å†…å®¹ã§ä½œæˆã—ã¾ã™ã€‚

```jsx:fileMock.js
module.exports = 'test-file-stub';
```

```jsx:styleMock.js
module.exports = {};
```

ä¸¡æ–¹ã¨ã‚‚ãƒ¢ãƒƒã‚¯ãªã®ã§èª­ã¿è¾¼ã¾ã‚Œã¦ã‚‚ç‰¹ã«ä½•ã‚‚ã—ã¾ã›ã‚“ã€‚

### 1-2. `jest.config.js` ã®ä½œæˆ

ä¸Šè¨˜ã‚’è¸ã¾ãˆãŸ `jest.config.js` ã‚’ä»¥ä¸‹å†…å®¹ã§ä½œæˆã—ã¾ã™ã€‚

```jsx
module.exports = {
  preset: 'ts-jest',
  testEnvironment: 'node',
  roots: [
    '<rootDir>/__tests__'
  ],
  setupFilesAfterEnv: ['<rootDir>/__tests__/setupTests.ts'],
  testPathIgnorePatterns: [
    '<rootDir>/__tests__/setupTests.ts',
    '<rootDir>/__tests__/tsconfig.jest.json',
    '<rootDir>/__tests__/mocks/'
  ],
  snapshotSerializers: ['enzyme-to-json/serializer'],
  transform: {
    '^.+\\.(ts|tsx)$': 'ts-jest'
  },
  moduleFileExtensions: [
    'ts',
    'tsx',
    'js',
    'jsx',
    'json',
    'node'
  ],
  // https://github.com/zeit/next.js/issues/8663#issue-490553899
  globals: {
    // we must specify a custom tsconfig for tests because we need the typescript transform
    // to transform jsx into js rather than leaving it jsx such as the next build requires. you
    // can see this setting in tsconfig.jest.json -> "jsx": "react"
    'ts-jest': {
      'tsconfig': '<rootDir>/__tests__/tsconfig.jest.json'
    }
  },
  collectCoverage: false,
  collectCoverageFrom: ["src/**/*"],
  coverageDirectory: "./coverage/",
  moduleNameMapper:{
    "\\.(css|less|sass|scss)$": "<rootDir>/__tests__/mocks/styleMock.js",
    "\\.(gif|ttf|eot|svg)$": "<rootDir>/__tests__/mocks/fileMock.js"
   }
};
```

# ç°¡å˜ãªãƒ†ã‚¹ãƒˆã‚’æ›¸ã„ã¦ã¿ã‚‹

## 1. ãƒ†ã‚¹ãƒˆå¯¾è±¡ã®ã‚³ãƒ³ãƒãƒ¼ãƒãƒ³ãƒˆ

ãƒ†ã‚¹ãƒˆå¯¾è±¡ã¨ã—ã¦ä»¥ä¸‹ã® `Avator` ã‚³ãƒ³ãƒãƒ¼ãƒãƒ³ãƒˆã§ãƒ†ã‚¹ãƒˆã‚’æ›¸ã„ã¦ã¿ã¾ã™ã€‚
`Avator` ã‚³ãƒ³ãƒãƒ¼ãƒãƒ³ãƒˆè‡ªä½“ã¯ã¨ã¦ã‚‚ã‚·ãƒ³ãƒ—ãƒ«ã§æŒ‡å®šã•ã‚ŒãŸç”»åƒã‚’æŒ‡å®šã•ã‚ŒãŸã‚µã‚¤ã‚ºã®å††å†…ã«è¡¨ç¤ºã™ã‚‹ã‚³ãƒ³ãƒãƒ¼ãƒãƒ³ãƒˆã§ã™ã€‚

```tsx
import React from 'react';

export type AvatorProps = {
  imageUrl: string;
  width: number;
  height: number;
};

const Avator: React.FC<AvatorProps> = ({ imageUrl, width, height }) => {
  return (
    <div>
      <img
        src={imageUrl}
        style={{
          width: width,
          height: height,
          borderRadius: '50%',
        }}
      />
    </div>
  );
};

export default Avator;
```

## 2. ãƒ†ã‚¹ãƒˆã‚³ãƒ¼ãƒ‰ã‚’æ›¸ã„ã¦ã¿ã‚‹

`Avator` ã‚³ãƒ³ãƒãƒ¼ãƒãƒ³ãƒˆã‚’ãƒ†ã‚¹ãƒˆã™ã‚‹ã‚³ãƒ¼ãƒ‰ã‚’æ›¸ã„ã¦ã¿ãŸã„ã¨æ€ã„ã¾ã™ã€‚
ãƒ†ã‚¹ãƒˆå†…å®¹ã¨ã—ã¦ã¯ `Avator` ã‚³ãƒ³ãƒãƒ¼ãƒãƒ³ãƒˆå†…ã« `<img>` è¦ç´ ãŒã‚ã£ã¦ã€ãã“ã«æŒ‡å®šã—ãŸç”»åƒURLã¨ã‚µã‚¤ã‚ºãŒã¡ã‚ƒã‚“ã¨è¨­å®šã•ã‚Œã¦ã„ã‚‹ã‹ã¨ã„ã†ã‚‚ã®ã§ã™ã€‚

```tsx
import { shallow } from 'enzyme';
import * as React from 'react';
import Avator from 'xxxx/Avator';

describe('Avator', () => {
  it('å¿…è¦ãªè¦ç´ ã«æŒ‡å®šã•ã‚ŒãŸå€¤ãŒè¨­å®šã•ã‚Œã¦ã„ã‚‹ã¯ãš', () => {
    const wrapper = shallow(
      <Avator
        imageUrl={'https://randomuser.me/api/portraits/women/26.jpg'}
        width={50}
        height={50}
      />
    );
    expect(wrapper.find('img')).toHaveLength(1);

    const src = wrapper.find('img').prop('src');
    expect(src).toEqual('https://randomuser.me/api/portraits/women/26.jpg');

    const style = wrapper.find('img').prop('style');
    expect(style.width).toEqual(50);
    expect(style.height).toEqual(50);
  });
});
```

Enzymeã®[shallow render API](https://enzymejs.github.io/enzyme/docs/api/shallow.html)ã‚’ä½¿ã£ã¦ `Avator` ã‚³ãƒ³ãƒãƒ¼ãƒãƒ³ãƒˆ ã‚’shallow renderã—ãŸã‚‚ã®ã‚’ `wrapper` ã¨ã—ã¦å—ã‘å–ã£ã¦ã„ã¾ã™ã€‚
ãƒ†ã‚¹ãƒˆã¯ã“ã® `wrapper` ã‚’ä½¿ã£ã¦è¦ç´ ãŒå­˜åœ¨ã™ã‚‹ã‹ã€è¦ç´ ã«æŒ‡å®šã—ãŸå€¤ãŒè¨­å®šã•ã‚Œã¦ã„ã‚‹ã‹ã‚’ãƒ†ã‚¹ãƒˆã—ã¦ã„ã¾ã™ã€‚
ãƒ‘ãƒƒã¨è¦‹ãã“ã¾ã§é›£ã—ãã¯ãªãæ›¸ãã‚„ã™ã„æ„Ÿã˜ã§ã™ã­ âœ¨

# Enzyme How to
ç­†è€…ãŒãƒ†ã‚¹ãƒˆæ›¸ã„ã¦ã„ã¦ã€Œã“ã‚Œã©ã†ã‚„ã£ã¦ãƒ†ã‚¹ãƒˆã™ã‚‹ã®ï¼Ÿã€ã¨æ€ã£ãŸéš›ã®ãƒ¡ãƒ¢ã«ãªã‚Šã¾ã™ã€‚

## 1. shallowã§<img>ã® `src` å±æ€§ã‚’å–å¾—ã—ãŸã„æ™‚

```tsx
const wrapper = shallow(
  <App  />
);
const src = wrapper.find('img').prop('src');
```

[javascript - How do I get an attribute of an element nested in a React component using Jest and/or Enzyme? - Stack Overflow](https://stackoverflow.com/questions/41070895/how-do-i-get-an-attribute-of-an-element-nested-in-a-react-component-using-jest-a)

`find` ã¨ `props` ã‚’ä½¿ã†ã€‚

## 2. window.confirm ã‚’å«ã‚ã¦ãƒ†ã‚¹ãƒˆã—ãŸã„å ´åˆ

```tsx
declare const global;

describe('...', () => {
  beforeEach(() => {
    global.window = {};
  });

  describe('confirm', () => {
    it('XXã®ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸ãŒè¡¨ç¤ºã•ã‚Œã‚‹ã¯ãš', () => {
      const mockCallWindow = jest.fn(() => true);
      global.window.confirm = mockCallWindow;

      const wrapper = shallow(
        <ConfirmDialog/>
      );
      wrapper.find('.show-button').simulate('click');
      expect(mockCallWindow).toHaveBeenCalledWith("XX");
    });
  });
```

[javascript - Simulate clicking "Ok" or "Cancel" in a confirmation window using enzyme - Stack Overflow](https://stackoverflow.com/questions/48728167/simulate-clicking-ok-or-cancel-in-a-confirmation-window-using-enzyme/48728455)[javascript - Simulate a button click in Jest - Stack Overflow](https://stackoverflow.com/questions/43747397/simulate-a-button-click-in-jest)

ç­†è€…ã®ç’°å¢ƒã§ã¯ä¸Šè¨˜ã§ã‚„ã£ãŸã‚‰ä¸Šæ‰‹ãè¡Œãã¾ã—ãŸã€‚

## 3. useStateã‚„useEffectã‚’ä½¿ã£ã¦ã„ã‚‹ã‚³ãƒ³ãƒãƒ¼ãƒãƒ³ãƒˆã®ãƒ†ã‚¹ãƒˆ

[React Hooks Jest + enzyme + act ã§ useEffect ã‚’å«ã‚€ã‚³ãƒ³ãƒãƒ¼ãƒãƒ³ãƒˆã®ãƒ†ã‚¹ãƒˆã™ã‚‹ - ã‹ã‚‚ãƒ¡ãƒ¢](https://chaika.hatenablog.com/entry/2019/09/12/083000)

# ãƒãƒƒãƒ‰ãƒã‚¦ãƒã‚¦

## 1.`TypeError: Cannot destructure property`deviceSizes`of 'undefined' or 'null'.` ãŒç™ºç”Ÿã™ã‚‹!

### ã‚¨ãƒ©ãƒ¼ã®è©³ç´°

```tsx
    TypeError: Cannot destructure property `deviceSizes` of 'undefined' or 'null'.

      at Object.<anonymous> (node_modules/next/client/image.tsx:62:9)
      at Object.<anonymous> (node_modules/next/image.js:1:107)
```

### åŸå› 

`next/image` ã‚’ä½¿ç”¨ã—ã¦ã„ã‚‹ç®‡æ‰€ã§ `deviceSizes` ãŒè¨­å®šã•ã‚Œã¦ã„ãªã„

### è§£æ±ºæ–¹æ³•

`setupTests.ts` ã«ä»¥ä¸‹ã‚’è¿½åŠ ã™ã‚‹

```tsx
process.env = {
	...process.env,
	__NEXT_IMAGE_OPTS: {
		deviceSizes: [320, 420, 768, 1024, 1200],
		imageSizes: [],
		domains: ['images.example.com'],
		path: '/_next/image',
		loader: 'default',
	} as any,
};
```

### å‚è€ƒãƒªãƒ³ã‚¯

- [Jest next/image: Cannot destructure property `deviceSizes` of 'undefined' or 'null' Â· Discussion #18373 Â· vercel/next.js](https://github.com/vercel/next.js/discussions/18373#discussioncomment-114212)
- [https://github.com/search?l=TypeScript&q=__NEXT_IMAGE_OPTS&type=Code](https://github.com/search?l=TypeScript&q=__NEXT_IMAGE_OPTS&type=Code)

## 2. ãƒ†ã‚¹ãƒˆã§ `sass` èª­ã¿è¾¼ã¿ã§ã‚¨ãƒ©ãƒ¼ã«ãªã‚‹

[Setting Up a Next.js Project With TypeScript, Sass, and Jest | by Aristos Markogiannakis | Better Programming | Medium](https://medium.com/better-programming/setting-up-a-next-js-project-with-typescript-sass-and-jest-d9b2d3bfb34a)
ä¸Šè¨˜ãƒªãƒ³ã‚¯ã®é€šã‚Šmockç”¨ã®scssãƒ•ã‚¡ã‚¤ãƒ«ã¨ãƒªã‚½ãƒ¼ã‚¹ãƒ•ã‚¡ã‚¤ãƒ«ã‚’ç”¨æ„ã—ã¦ãƒ†ã‚¹ãƒˆæ™‚ã¯ãã‚Œã‚’èª­ã¿è¾¼ã‚€ã‚ˆã†ã«ã—ãŸã€‚

## 3. `window` ã‚’ãƒ†ã‚¹ãƒˆã®ä¸­ã§ã‚‚ä½¿ãˆã‚‹ã‚ˆã†ã«ã™ã‚‹

```tsx
declare const global;

describe('', () => {
  beforeEach(() => {
    global.window = {};
  });
  ...
  global.window = {};
  global.window.confirm = jest.fn(() => true);
);
```

# ã¾ã¨ã‚

Enzymeã¨Jestã§Unitãƒ†ã‚¹ãƒˆã¯ã¨ã¦ã‚‚æ›¸ãã‚„ã™ãã€ã™ã‚“ãªã‚Šãƒ†ã‚¹ãƒˆã™ã‚‹äº‹ãŒã§ããŸå°è±¡ã§ã—ãŸã€‚
ãŸã ã€Next.jsã®å ´åˆã€å›ºæœ‰ã®ã‚¨ãƒ©ãƒ¼ãŒã¡ã‚‰ã»ã‚‰èµ·ããŸã®ã§ã€ãã“ã ã‘ã¯åœ°é“ã«çªç ´ã—ã¦ã„ãã—ã‹ç„¡ã•ãã†ã‹ãªã¨ã„ã†æ„Ÿã˜ã§ã™ã€‚

# å‚è€ƒãƒªãƒ³ã‚¯

- [Enzyme vs React Testing Libraryçµå±€ã©ã£ã¡ãŒã„ã„ã®ã‹å•é¡Œã«å¯¾ã™ã‚‹å€‹äººçš„ãªå›ç­” - Qiita](https://qiita.com/nnishimura/items/521af77125d2b7ad49c5)
- [Next.js + TypeScriptã®ãƒ—ãƒ­ã‚¸ã‚§ã‚¯ãƒˆã«JESTã‚’å°å…¥ã™ã‚‹ - Qiita](https://qiita.com/keitakn/items/0a714997eb058f2f67e2)
- [Reactã®ãƒ†ã‚¹ãƒˆãƒ©ã‚¤ãƒ–ãƒ©ãƒªã‚’æ¯”è¼ƒã™ã‚‹ - react-test-renderer, enzyme, react-testing-library - Qiita](https://qiita.com/Hitomi_Nagano/items/8673be3c8907c6697cb6)
- [Enzymeã§ãƒ†ã‚­ã‚¹ãƒˆå¤‰æ›´ã‚’simulateã™ã‚‹ - Qiita](https://qiita.com/Mt_blue81/items/9002a79530384d960c22)
