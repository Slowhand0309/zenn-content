---
title: "ã€React/Next.jsã€‘Liveblocksã§ã®ãƒªã‚¢ãƒ«ã‚¿ã‚¤ãƒ ã‚³ãƒ©ãƒœãƒ¬ãƒ¼ã‚·ãƒ§ãƒ³é–‹ç™º"
emoji: "ğŸš€"
type: "tech" # tech: æŠ€è¡“è¨˜äº‹ / idea: ã‚¢ã‚¤ãƒ‡ã‚¢
topics:
  - "liveblocks"
  - "react"
  - "nextjs"
  - "typescript"
published: true
---

# Liveblocksã¨ã¯?

[Liveblocks | Collaborative experiences in days, not months](https://liveblocks.io/)

> Liveblocksã¯ã€é–‹ç™ºè€…å‘ã‘ã«ã€é«˜æ€§èƒ½ãªã‚³ãƒ©ãƒœãƒ¬ãƒ¼ã‚·ãƒ§ãƒ³æ©Ÿèƒ½ã‚’æ¥µã‚ã¦è¿…é€Ÿã«è£½å“ã«çµ„ã¿è¾¼ã‚€ãŸã‚ã®å®Œå…¨ãªãƒ„ãƒ¼ãƒ«ã‚­ãƒƒãƒˆã‚’æä¾›ã—ã¾ã™ã€‚

æ—©é€Ÿ Sign up ã—ã¦ä½¿ã£ã¦ã¿ãŸã„ã¨æ€ã„ã¾ã™ã€‚

![image1.png](/images/7f3d39f5b59f67/image1.png =350x)

ã‚¢ã‚«ã‚¦ãƒ³ãƒˆä½œæˆã—ã€ãƒ€ãƒƒã‚·ãƒ¥ãƒœãƒ¼ãƒ‰ã«ç§»å‹•ã™ã‚‹ã¨æ—¢ã« `Development` ã¨ `Production` ã®2ã¤ã®ãƒ—ãƒ­ã‚¸ã‚§ã‚¯ãƒˆãŒä½œæˆã•ã‚Œã¦ã„ã¾ã™ã€‚

ã¾ãŸã€MAUã‚„1Roomå†…ã§ã®åŒæ™‚æ¥ç¶šæ•°ã‚‚è¡¨ç¤ºã•ã‚Œã¦ã„ã¾ã™ã€‚

![image2.png](/images/7f3d39f5b59f67/image2.png =500x)

## ãƒ›ãƒ¯ã‚¤ãƒˆãƒœãƒ¼ãƒ‰ã®ãƒ™ãƒ¼ã‚¹å®Ÿè£…

ä»Šå›ã¯ `Whiteboard + React` ã‚’ä½œã‚‹æƒ³å®šã§é€²ã‚ã¦ã„ã“ã†ã¨æ€ã£ã¦ã„ã‚‹ã®ã§ã€ä»¥ä¸‹ã®ãƒãƒ¥ãƒ¼ãƒˆãƒªã‚¢ãƒ«ã‚’å…ƒã«é€²ã‚ã¦ã„ãã¾ã™ã€‚

[Tutorials - Creating a collaborative online whiteboard with React and Liveblocks | Liveblocks documentation](https://liveblocks.io/docs/tutorials/collaborative-online-whiteboard/react)

### å‹•ä½œç’°å¢ƒ

```json
"dependencies": {
    "@liveblocks/client": "^1.2.1",
    "@liveblocks/react": "^1.0.9",
    "next": "13.4.13",
    "react": "18.2.0",
    "react-dom": "18.2.0"
  },
  "devDependencies": {
    "@types/node": "20.4.8",
    "@types/react": "^18.2.6",
    "@types/react-dom": "^18.2.4",
    "eslint": "8.46.0",
    "eslint-config-next": "13.4.13",
    "prettier": "^2.8.8",
    "typescript": "^5.0.4"
  }
```

### APIã‚­ãƒ¼ã®å–å¾—

ã¾ãšã¯äº‹å‰ã«ä½¿ç”¨ã™ã‚‹APIã‚­ãƒ¼ã‚’å–å¾—ã—ã¾ã™ã€‚Public keyã¨Secret keyã©ã¡ã‚‰ã§ã‚‚ä½¿ãˆã‚‹ã‚ˆã†ã§ã™ãŒã€ä»Šå›ã¯ãƒãƒ¥ãƒ¼ãƒˆãƒªã‚¢ãƒ«åŒæ§˜Public keyã‚’ä½¿ã£ã¦é€²ã‚ã¦ã„ããŸã„ã¨æ€ã„ã¾ã™ã€‚

â†“ãƒ‰ã‚­ãƒ¥ãƒ¡ãƒ³ãƒˆå†…ã®infomation

> å…¬é–‹éµã¨ç§˜å¯†éµ
> ç§˜å¯†éµã‚’ä½¿ã†ã¨ã€èª°ãŒãƒ«ãƒ¼ãƒ ã«ã‚¢ã‚¯ã‚»ã‚¹ã§ãã‚‹ã‹ã‚’åˆ¶å¾¡ã§ãã¾ã™ã€‚ã“ã‚Œã¯ã‚ˆã‚Šå®‰å…¨ã§ã™ãŒã€è‡ªåˆ†è‡ªèº«ã®ãƒãƒƒã‚¯ã‚¨ãƒ³ãƒ‰ã‚¨ãƒ³ãƒ‰ãƒã‚¤ãƒ³ãƒˆãŒå¿…è¦ã§ã™ã€‚ã“ã®ãƒãƒ¥ãƒ¼ãƒˆãƒªã‚¢ãƒ«ã§ã¯ã€å…¬é–‹éµã‚’ä½¿ç”¨ã—ã¾ã™ã€‚è©³ç´°ã«ã¤ã„ã¦ã¯ã€[èªè¨¼ã‚¬ã‚¤ãƒ‰](https://liveblocks.io/docs/guides/authentication)ã‚’å‚ç…§ã—ã¦ãã ã•ã„ã€‚


`Development` ãƒ—ãƒ­ã‚¸ã‚§ã‚¯ãƒˆã«ç§»å‹•ã—ã€ã€ŒAPI keysã€ã‚’ã‚¯ãƒªãƒƒã‚¯ã—ã¾ã™ã€‚

![image3.png](/images/7f3d39f5b59f67/image3.png)

ã€Œ**Public key**ã€ã®å†…å®¹ã‚’æ§ãˆã€`env.local` ã«ä»¥ä¸‹å†…å®¹ã§è¨­å®šã—ã¨ãã¾ã™ã€‚

```text
NEXT_PUBLIC_LIVEBLOCKS_PUBLIC_API_KEY=pk_xxxxxxxxxxxxxx
```

### å¿…è¦ãªãƒ‘ãƒƒã‚±ãƒ¼ã‚¸ã®ã‚¤ãƒ³ã‚¹ãƒˆãƒ¼ãƒ«

```bash
yarn add @liveblocks/client @liveblocks/react
```

`providers/liveblocks.ts` ã‚’ä»¥ä¸‹å†…å®¹ã§ä½œæˆã—ã¾ã™ã€‚

```tsx
import { createClient } from '@liveblocks/client';

const client = createClient({
  publicApiKey: process.env.NEXT_PUBLIC_LIVEBLOCKS_PUBLIC_API_KEY ?? '',
});
```

### Roomã®ä½œæˆ

`@liveblocks/react` ã® `createRoomContext` ã‚’ä½¿ã£ã¦RoomProviderã¨ãƒ•ãƒƒã‚¯ã‚’ä½œæˆã—ã€ã‚³ãƒ³ãƒãƒ¼ãƒãƒ³ãƒˆã‹ã‚‰ç°¡å˜ã«ã‚³ãƒ³ã‚·ãƒ¥ãƒ¼ãƒ ã§ãã‚‹ã‚ˆã†ã«ã—ã¾ã™ã€‚å…ˆç¨‹ã® `providers/liveblocks.ts` ã«è¿½åŠ ã—ã¦ã„ãã¾ã™ã€‚

```tsx
import { createClient } from '@liveblocks/client';
import { createRoomContext } from '@liveblocks/react'; // è¿½åŠ 

const client = createClient({
  publicApiKey: process.env.NEXT_PUBLIC_LIVEBLOCKS_PUBLIC_API_KEY ?? '',
});

export const { RoomProvider } = createRoomContext(client); // è¿½åŠ 
```

`app/layout.tsx` ã« `RoomProvider` ã‚’é©ç”¨ã—ã¦ã„ãã¾ã™ã€‚

```tsx
'use client';

import { RoomProvider } from './liveblocks.config'; // è¿½åŠ 

export default function RootLayout({
  children,
}: {
  children: React.ReactNode;
}) {
  return (
    <html>
      <head></head>
      <body>
        {/* RoomProviderã§å›²ã‚€ */}
        <RoomProvider id="react-whiteboard-app" initialPresence={{}}>
          <div>{children}</div>
        </RoomProvider>
      </body>
    </html>
  );
}
```

RoomProviderã«åŒ…ã¾ã‚ŒãŸã™ã¹ã¦ã®ã‚³ãƒ³ãƒãƒ¼ãƒãƒ³ãƒˆã¯ã€ã“ã®éƒ¨å±‹ã¨å¯¾è©±ã™ã‚‹ãŸã‚ã«ä½¿ç”¨ã™ã‚‹ç‰¹åˆ¥ãªReactãƒ•ãƒƒã‚¯ã«ã‚¢ã‚¯ã‚»ã‚¹ã§ãã‚‹ã‚ˆã†ã«ãªã‚Šã¾ã™ã€‚

### Canvasã®ä½œæˆ

[LiveMap](https://liveblocks.io/docs/api-reference/liveblocks-client#LiveMap)ã‚’ä½¿ã£ã¦ã€éƒ¨å±‹ã®ã‚¹ãƒˆãƒ¬ãƒ¼ã‚¸å†…ã«å›³å½¢ã®ãƒãƒƒãƒ—ã‚’ä¿å­˜ã—ã¦ã„ãã¾ã™ã€‚

LiveMapã¯ã€LiveblocksãŒæä¾›ã™ã‚‹ã‚¹ãƒˆãƒ¬ãƒ¼ã‚¸ã®ä¸€ç¨®ã§ã™ã€‚LiveMapã¯JavaScriptã®ãƒãƒƒãƒ—ã®ã‚ˆã†ãªã‚‚ã®ã§ã™ãŒã€ãã®ã‚¢ã‚¤ãƒ†ãƒ ã¯ç•°ãªã‚‹ã‚¯ãƒ©ã‚¤ã‚¢ãƒ³ãƒˆé–“ã§ãƒªã‚¢ãƒ«ã‚¿ã‚¤ãƒ ã«åŒæœŸã•ã‚Œã¾ã™ã€‚è¤‡æ•°ã®ãƒ¦ãƒ¼ã‚¶ãƒ¼ãŒåŒæ™‚ã«ã‚¢ã‚¤ãƒ†ãƒ ã‚’æŒ¿å…¥ãƒ»å‰Šé™¤ã—ã¦ã‚‚ã€LiveMapã¯ãƒ«ãƒ¼ãƒ å†…ã®ã™ã¹ã¦ã®ãƒ¦ãƒ¼ã‚¶ãƒ¼ã«å¯¾ã—ã¦ä¸€è²«æ€§ã‚’ä¿ã¤ã“ã¨ãŒã§ãã¾ã™ã€‚

`RoomProvider` ã® `initialStorage` Propsã‹ã‚‰ã‚¹ãƒˆãƒ¬ãƒ¼ã‚¸ã‚’åˆæœŸåŒ–ã—ã¾ã™ã€‚

```tsx
'use client';

import { LiveMap } from '@liveblocks/client'; // è¿½åŠ 
import { RoomProvider } from './liveblocks.config';

export default function RootLayout({
  children,
}: {
  children: React.ReactNode;
}) {
  return (
    <html>
      <head></head>
      <body>
        <RoomProvider
          id="react-whiteboard-app"
          initialPresence={{}}
          initialStorage={{ // è¿½åŠ 
            shapes: new LiveMap(),
          }}
        >
          <div>{children}</div>
        </RoomProvider>
      </body>
    </html>
  );
}
```

`createRoomContext` ã® `useMap` ã‚’ä½¿ã†äº‹ã§ã€liveblockså†…ã«ä¿å­˜ã•ã‚Œã¦ã„ã‚‹Storageã«ã‚¢ã‚¯ã‚»ã‚¹ã™ã‚‹äº‹ãŒã§ãã¾ã™ã€‚

```tsx
export const { RoomProvider, useMap } = createRoomContext(client);
```

`useMap` ã¯æ¥ç¶šä¸­ã¯ `null` ã‚’è¿”ã™ã®ã§ã€nullã®å ´åˆã¯Indicatorã‚’è¡¨ç¤ºã•ã›ã¦ãŠãã¨è‰¯ã•ãã†ã§ã™ã€‚

`app/page.tsx` ã‚’ä»¥ä¸‹å†…å®¹ã§ä½œæˆã—ã¾ã™ã€‚

```tsx
'use client';

import { useMap } from '../providers/liveblocks';

const Rectangle = ({ shape }: { shape: any }) => {
  const { x, y, fill } = shape;

  return (
    <div
      className="rectangle"
      style={{
        transform: `translate(${x}px, ${y}px)`,
        backgroundColor: fill ? fill : '#CCC',
      }}
    ></div>
  );
};

const Canvas = ({ shapes }: { shapes: any }) => {
  return (
    <>
      <div className="canvas">
        {Array.from(shapes, ([shapeId, shape]) => {
          return <Rectangle key={shapeId} shape={shape} />;
        })}
      </div>
    </>
  );
};

const PageWrapper = () => {
  const shapes = useMap('shapes');

  if (shapes == null) {
    return <div className="loading">Loading</div>;
  }
  return <Canvas shapes={shapes} />;
};

const Page = () => {
  return <PageWrapper />;
};
export default Page;
```

æœ€å¾Œã« `app/global.css` ã‚’ä»¥ä¸‹å†…å®¹ã§ä½œæˆã—ã€ `app/layout.tsx` ã§importã—ã¾ã™ã€‚

```css
body {
  background-color: #eeeeee;
}

.loading {
  display: flex;
  align-items: center;
  justify-content: center;
  height: 100vh;
  width: 100vw;
}

.canvas {
  background-color: #eeeeee;
  touch-action: none;
  width: 100vw;
  height: 100vh;
}

.rectangle {
  position: absolute;
  /* transition: all 0.1s ease; */
  stroke-width: 1;
  border-style: solid;
  border-width: 2px;
  height: 100px;
  width: 100px;
}

.toolbar {
  position: fixed;
  top: 12px;
  left: 50%;
  transform: translateX(-50%);
  padding: 4px;
  border-radius: 8px;
  box-shadow: 0px 2px 4px rgba(0, 0, 0, 0.1), 0px 0px 0px 1px rgba(0, 0, 0, 0.05);
  display: flex;
  background-color: #ffffff;
  user-select: none;
}

.toolbar button {
  display: flex;
  align-items: center;
  justify-content: center;
  padding: 4px 8px;
  border-radius: 4px;
  background-color: #f8f8f8;
  color: #181818;
  border: none;
  box-shadow: 0px 2px 4px rgba(0, 0, 0, 0.1), 0px 0px 0px 1px rgba(0, 0, 0, 0.05);
  margin: 4px;
  font-weight: 500;
  font-size: 12px;
}

.toolbar button:hover,
.toolbar button:focus {
  background-color: #ffffff;
}

.toolbar button:active {
  background-color: #eeeeee;
}
```

`app/layout.tsx`

```tsx
import './globals.css';
```

## é•·æ–¹å½¢ã‚’è¿½åŠ ã§ãã‚‹ã‚ˆã†ã«ã™ã‚‹

ãƒãƒ¥ãƒ¼ãƒˆãƒªã‚¢ãƒ«é€šã‚Šã«ä»¥ä¸‹ã‚’ `app/page.tsx` è¿½åŠ ã—ã¾ã™ã€‚

```tsx
const COLORS = ['#DC2626', '#D97706', '#059669', '#7C3AED', '#DB2777'];

const getRandomInt = (max: number) => {
  return Math.floor(Math.random() * max);
};

const getRandomColor = () => {
  return COLORS[getRandomInt(COLORS.length)];
};

// ...

const Canvas = ({ shapes }: { shapes: any }) => {
  // insertRectangle è¿½åŠ 
  const insertRectangle = () => {
    const shapeId = Date.now().toString();
    const rectangle = {
      x: getRandomInt(300),
      y: getRandomInt(300),
      fill: getRandomColor(),
    };
    shapes.set(shapeId, rectangle);
  };
  return (
    <>
      <div className="canvas">
        {Array.from(shapes, ([shapeId, shape]) => {
          return <Rectangle key={shapeId} shape={shape} />;
        })}
      </div>
      {/* â†“è¿½åŠ  */}
      <div className="toolbar">
        <button onClick={insertRectangle}>Rectangle</button>
      </div>
    </>
  );
};
// ...
```

![image4.png](/images/7f3d39f5b59f67/image4.png)

ã€ŒRectangleã€ãƒœã‚¿ãƒ³ãŒè¿½åŠ ã•ã‚Œã€ã‚¯ãƒªãƒƒã‚¯ã§é•·æ–¹å½¢ã‚’è¿½åŠ ã§ãã‚‹ã‚ˆã†ã«ãªã‚Šã¾ã—ãŸ!

## Selectionã®è¿½åŠ 

æ–°ãŸã« [useMyPresence](https://liveblocks.io/docs/api-reference/liveblocks-react#useMyPresence) ã¨ [useOthers](https://liveblocks.io/docs/api-reference/liveblocks-react#useOthers) ã‚’ä½¿ã„ã¾ã™ã€‚

```tsx
export const { RoomProvider, useMap, useOthers, useMyPresence } =
  createRoomContext(client);
```

`Rectangle` ã‚’ã‚¯ãƒªãƒƒã‚¯ã—ãŸéš›ã®ã‚¤ãƒ™ãƒ³ãƒˆã¨é¸æŠæ™‚ã®ã‚«ãƒ©ãƒ¼ã‚’è¨­å®šã§ãã‚‹ã‚ˆã†ã«ã—ã¾ã™ã€‚

```tsx
const Rectangle = ({
  shape,
  id,
  onShapePointerDown,
  selectionColor,
}: {
  shape: any;
  id: string;
  onShapePointerDown: (e: any, id: string) => void;
  selectionColor: string | undefined;
}) => {
  const { x, y, fill } = shape;

  return (
    <div
      className="rectangle"
      onPointerDown={(e) => onShapePointerDown(e, id)}
      style={{
        transform: `translate(${x}px, ${y}px)`,
        backgroundColor: fill ? fill : '#CCC',
        borderColor: selectionColor || 'transparent',
      }}
    ></div>
  );
};
```

`Canvas` ã§ `useMyPresence` ã¨ `useOthers` ã‚’ä½¿ã£ã¦é¸æŠçŠ¶æ…‹ã‚’åæ˜ ã§ãã‚‹ã‚ˆã†ã«ã—ã¾ã™ã€‚

```tsx
const Canvas = ({ shapes }: { shapes: any }) => {
  const [{ selectedShape }, setPresence] = useMyPresence();
  const others = useOthers();

  const insertRectangle = () => {
    const shapeId = Date.now().toString();
    const rectangle = {
      x: getRandomInt(300),
      y: getRandomInt(300),
      fill: getRandomColor(),
    };
    shapes.set(shapeId, rectangle);
  };

  const onShapePointerDown = (e: any, shapeId: string) => {
    setPresence({ selectedShape: shapeId });
    e.stopPropagation();
  };

  return (
    <>
      <div
        className="canvas"
        onPointerDown={(e) => setPresence({ selectedShape: null })}
      >
        {Array.from(shapes, ([shapeId, shape]) => {
          const selectionColor =
            selectedShape === shapeId
              ? 'blue'
              : others.some((user) => user.presence?.selectedShape === shapeId)
              ? 'green'
              : undefined;
          return (
            <Rectangle
              key={shapeId}
              shape={shape}
              id={shapeId}
              onShapePointerDown={onShapePointerDown}
              selectionColor={selectionColor}
            />
          );
        })}
      </div>
      <div className="toolbar">
        <button onClick={insertRectangle}>Rectangle</button>
      </div>
    </>
  );
};
```

![image5.gif](/images/7f3d39f5b59f67/image5.gif)

## é•·æ–¹å½¢ã‚’å‰Šé™¤

`Canvas` ã«ä»¥ä¸‹ã‚’è¿½åŠ ã—ã¾ã™ã€‚

```tsx
const deleteRectangle = () => {
    shapes.delete(selectedShape);
    setPresence({ selectedShape: null });
  };
// ...
return (
    <>
      ...
      <div className="toolbar">
        <button onClick={insertRectangle}>Rectangle</button>
        {/* ä»¥ä¸‹ã‚’è¿½åŠ  */}
        <button onClick={deleteRectangle} disabled={selectedShape == null}>
          Delete
        </button>
      </div>
    </>
  );
```

![image6.gif](/images/7f3d39f5b59f67/image6.gif)

## é•·æ–¹å½¢ã®ç§»å‹•åŒæœŸ

`Canvas` ã‚’ä¿®æ­£ã—ã¦ã„ãã¾ã™ã€‚

```tsx
const Canvas = ({ shapes }: { shapes: any }) => {
  const [isDragging, setIsDragging] = useState(false); // è¿½åŠ 
  const [{ selectedShape }, setPresence] = useMyPresence();
  const others = useOthers();

  const onShapePointerDown = (e: any, shapeId: string) => {
    e.stopPropagation();
    setPresence({ selectedShape: shapeId });
    setIsDragging(true); // è¿½åŠ 
  };
  // â†“è¿½åŠ 
  const onCanvasPointerUp = (e: any) => {
    if (!isDragging) {
      setPresence({ selectedShape: null });
    }

    setIsDragging(false);
  };
  // â†“è¿½åŠ 
  const onCanvasPointerMove = (e: any) => {
    e.preventDefault();

    if (isDragging) {
      const shape = shapes.get(selectedShape);
      if (shape) {
        shapes.set(selectedShape, {
          ...shape,
          x: e.clientX - 50,
          y: e.clientY - 50,
        });
      }
    }
  };

  return (
    <>
      <div
        className="canvas"
        onPointerDown={(e) => setPresence({ selectedShape: null })}
        onPointerMove={onCanvasPointerMove} // è¿½åŠ 
        onPointerUp={onCanvasPointerUp} // è¿½åŠ 
      >
      ...
      </div>
    </>
  );
};
```

![image7.gif](/images/7f3d39f5b59f67/image7.gif)

## ã¾ã¨ã‚

ä»Šå›è©¦ã—ã¦ã¿ã¦ãƒªã‚¢ãƒ«ã‚¿ã‚¤ãƒ ã‚³ãƒ©ãƒœãƒ¬ãƒ¼ã‚·ãƒ§ãƒ³æ©Ÿèƒ½ãŒç°¡å˜ã«çµ„ã¿è¾¼ã‚ã¦ã€CRDTã‚’ç”¨ã„ãŸãƒ‡ãƒ¼ã‚¿ã‚¹ãƒˆã‚¢ãŒä½¿ãˆã‚‹ã®ãŒã¨ã¦ã‚‚é­…åŠ›çš„ã«æ„Ÿã˜ã¾ã—ãŸã€‚
ã‚ã¨ã¯1Roomã«MAUã®ä¸Šé™ãŒã‚ã‚‹ã®ã§ã€ãã“ã‚’è€ƒæ…®ã—ã¦çµ„ã¿è¾¼ã‚€å¿…è¦ãŒã‚ã‚Šãã†ã‹ãªã¨æ€ã„ã¾ã™ã€‚

ä»Šå›è©¦ã—ãŸåˆ†ã¯ä»¥ä¸‹ã®ãƒªãƒã‚¸ãƒˆãƒªã«ã‚¢ãƒƒãƒ—ã—ã¦ã¾ã™ã€‚

[Slowhand0309/liveblocks-example: Liveblocks whiteboard + React example.](https://github.com/Slowhand0309/liveblocks-example)
