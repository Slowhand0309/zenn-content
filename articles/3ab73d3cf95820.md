---
title: "ã€Androidã€‘Hilt + Room + Paging 3 + Composeã§ãƒšãƒ¼ã‚¸ãƒãƒ¼ã‚·ãƒ§ãƒ³ã‚’å®Ÿè£…ã™ã‚‹"
emoji: "ğŸ“ƒ"
type: "tech" # tech: æŠ€è¡“è¨˜äº‹ / idea: ã‚¢ã‚¤ãƒ‡ã‚¢
topics:
  - "android"
  - "compose"
  - "room"
  - "hilt"
  - "paging3"
published: false
---
# ã¯ã˜ã‚ã«

Androidã‚¢ãƒ—ãƒªé–‹ç™ºã§ Hilt + Room + Paging 3 + Compose ã‚’ä½¿ã£ã¦æ§‹ç¯‰ã—ã¦ã„ãæƒ³å®šã§å®Ÿéš›ã«ä½¿ã„ãã†ãªéƒ¨åˆ†ã‚’è©¦ã—ãŸè¨˜äº‹ã«ãªã‚Šã¾ã™ã€‚
æœ€çµ‚çš„ã«ãƒ¦ãƒ¼ã‚¶ãƒ¼ä¸€è¦§ã‚’ãƒšãƒ¼ã‚¸ãƒ³ã‚°ã—ãªãŒã‚‰è¡¨ç¤ºã§ãã‚‹ã¾ã§ã‚’å®Ÿè£…ã—ã¦ã¿ãŸã„ã¨æ€ã„ã¾ã™ã€‚

# å„ãƒ©ã‚¤ãƒ–ãƒ©ãƒªã®æ¦‚è¦

## Hilt

[Hilt ã‚’ä½¿ç”¨ã—ãŸä¾å­˜é–¢ä¿‚ã®æ³¨å…¥ Â |Â  Android ãƒ‡ãƒ™ãƒ­ãƒƒãƒ‘ãƒ¼ Â |Â  Android Developers](https://developer.android.com/training/dependency-injection/hilt-android?hl=ja#kts)

> Hilt ã¯ [Dagger](https://developer.android.com/training/dependency-injection/dagger-basics?hl=ja)Â ã®ä¸Šã«æ§‹ç¯‰ã•ã‚Œã¦ã„ã‚‹ Android ç”¨ã®ä¾å­˜é–¢ä¿‚ã‚¤ãƒ³ã‚¸ã‚§ã‚¯ã‚·ãƒ§ãƒ³ ãƒ©ã‚¤ãƒ–ãƒ©ãƒªã§ã™ã€‚

Codelabã¯ä»¥ä¸‹ã«ãªã‚Šã¾ã™ã€‚

[Android ã‚¢ãƒ—ãƒªã§ã® Hilt ã®ä½¿ç”¨ Â |Â  Android ãƒ‡ãƒ™ãƒ­ãƒƒãƒ‘ãƒ¼ Â |Â  Android Developers](https://developer.android.com/codelabs/android-hilt?hl=ja#0)

## Room

roomã«é–¢ã—ã¦ã¯å‰å›ã®è¨˜äº‹ã‚’å‚ç…§ã—ã¦é ‚ã‘ã‚Œã°ã¨æ€ã„ã¾ã™ã€‚

[ã€Androidã€‘Jetpack Roomå°å…¥~åŸºæœ¬çš„ãªä½¿ã„æ–¹~ã‚·ãƒ¼ãƒ‰ãƒ‡ãƒ¼ã‚¿ç™»éŒ²ã¾ã§](https://zenn.dev/slowhand/articles/bde673d6afd133)

## Paging 3

[ãƒšãƒ¼ã‚¸ãƒ³ã‚° ãƒ©ã‚¤ãƒ–ãƒ©ãƒªã®æ¦‚è¦ Â |Â  Android Developers](https://developer.android.com/topic/libraries/architecture/paging/v3-overview?hl=ja)

ãƒ‡ãƒ¼ã‚¿ã‚’æ®µéšçš„ã«ãƒ­ãƒ¼ãƒ‰ã—ãƒšãƒ¼ã‚¸ãƒ³ã‚°å‡¦ç†ã‚’ã‚µãƒãƒ¼ãƒˆã™ã‚‹Jetpackã®ãƒ©ã‚¤ãƒ–ãƒ©ãƒªã€‚

**Paging 3ã®ä¸»ãªæ§‹æˆè¦ç´ **

![image1](/images/3ab73d3cf95820/image1.png =600x)

- Repository Layer
  - [PagingSource](https://developer.android.com/reference/kotlin/androidx/paging/PagingSource?hl=ja)
    - ãƒ‡ãƒ¼ã‚¿ã‚½ãƒ¼ã‚¹ã‹ã‚‰ãƒ‡ãƒ¼ã‚¿ã‚’å–å¾—ã™ã‚‹æ–¹æ³•ã‚’å®šç¾©
    - DBã‚„APIãªã©
    - [`RemoteMediator`](https://developer.android.com/reference/kotlin/androidx/paging/RemoteMediator)
      - ã‚¢ãƒ—ãƒªãŒã‚­ãƒ£ãƒƒã‚·ãƒ¥ ãƒ‡ãƒ¼ã‚¿ã‚’ä½¿ã„åˆ‡ã£ãŸéš›ã«ã€ãƒšãƒ¼ã‚¸ãƒ³ã‚° ãƒ©ã‚¤ãƒ–ãƒ©ãƒªã‹ã‚‰ã®ã‚·ã‚°ãƒŠãƒ«ã¨ã—ã¦æ©Ÿèƒ½
      - APIã‹ã‚‰ã®å€¤ã‚’ãƒ­ãƒ¼ã‚«ãƒ«DBãªã©ã«ã‚­ãƒ£ãƒƒã‚·ãƒ¥ã—ã¦ä½¿ã†æ§˜ãªãƒ‘ã‚¿ãƒ¼ãƒ³ã§æœ‰åŠ¹
- ViewModel Layer
  - [Pager](https://developer.android.com/reference/kotlin/androidx/paging/Pager?hl=ja)
    - [PagingData](https://developer.android.com/reference/kotlin/androidx/paging/PagingData?hl=ja)ã‚¹ãƒˆãƒªãƒ¼ãƒ ã‚’ç”Ÿæˆã™ã‚‹
    - PagingSourceã¨[PagingConfig](https://developer.android.com/reference/kotlin/androidx/paging/PagingConfig?hl=ja)ã‚’çµ„ã¿åˆã‚ã›ã¦ä½¿ç”¨ã—ã€ã‚¢ãƒ—ãƒªã®è¦ä»¶ã«å¿œã˜ãŸãƒšãƒ¼ã‚¸ãƒ³ã‚°æ§‹æˆã‚’å®šç¾©ã™ã‚‹
- UI Layer
  - [PagingDataAdapter](https://developer.android.com/reference/kotlin/androidx/paging/PagingDataAdapter?hl=ja)
    - [RecyclerView](https://developer.android.com/reference/kotlin/androidx/recyclerview/widget/RecyclerView?hl=ja)Â ã®å°‚ç”¨ã‚¢ãƒ€ãƒ—ã‚¿ãƒ¼
  - Composeã‚’ä½¿ç”¨ã—ã¦ã„ã‚‹å ´åˆ
    - **[collectAsLazyPagingItems](https://developer.android.com/reference/kotlin/androidx/paging/compose/package-summary?hl=ja#collectaslazypagingitems) ã‚’ä½¿ã†**

# ãƒ—ãƒ­ã‚¸ã‚§ã‚¯ãƒˆã®ä½œæˆ

1. ã€ŒNew Projectâ€¦ã€ã§ã€ŒEmpty Activityã€ã‚’é¸æŠã—ã¾ã™  
  ![image2](/images/3ab73d3cf95820/image2.png =500x)

1. ãƒ—ãƒ­ã‚¸ã‚§ã‚¯ãƒˆåã‚’ã€ŒRoomHiltComposeExampleã€ã¨ã—ã¦ä»¥ä¸‹å†…å®¹ã§ä½œæˆã—ã¾ã™
  ![image3](/images/3ab73d3cf95820/image3.png =500x)
  â€» `Build configuration language` ã§ã¯ `Gradle Version Catalogs` ã‚’ä½¿ã†ã‚ˆã†ã«ã—ã¦ã¾ã™

# ä¾å­˜é–¢ä¿‚ã®è¿½åŠ 

`gradle/libs.versions.toml` ã«ä»¥ä¸‹ã‚’è¿½åŠ ã—ã€ŒSync Project with Gradle Filesã€ã‚’å®Ÿæ–½ã¾ã™ã€‚

â€»ä»Šå›ã‚¢ãƒãƒ†ãƒ¼ã‚·ãƒ§ãƒ³ ãƒ—ãƒ­ã‚»ãƒƒã‚µã«KSPã‚’ä½¿ç”¨ã—ã¦ã„ã¾ã™ã€‚

```toml
[versions]
room = "2.6.1"
paging = "3.2.1"
ksp = "1.9.10-1.0.13"
hilt = "2.48"
hilt-navigation-compose = "1.2.0"
lifecycle-viewmodel-ktx = "2.7.0"
coil = "2.6.0"

[libraries]
# hilt
hilt-android = { module = "com.google.dagger:hilt-android", version.ref = "hilt" }
hilt-compiler = { module = "com.google.dagger:hilt-android-compiler", version.ref = "hilt" }
hilt-navigation-compose = { module = "androidx.hilt:hilt-navigation-compose", version.ref = "hilt-navigation-compose" }
lifecycle-viewmodel-ktx = { group = "androidx.lifecycle", name = "lifecycle-viewmodel-ktx", version.ref = "lifecycle-viewmodel-ktx" }

# room
room-runtime = { module = "androidx.room:room-runtime", version.ref = "room" }
room-ktx = { module = "androidx.room:room-ktx", version.ref = "room" }
room-compiler = { module = "androidx.room:room-compiler", version.ref = "room" }
room-paging = { module = "androidx.room:room-paging", version.ref = "room" }

# paging
paging-runtime = { module = "androidx.paging:paging-runtime", version.ref = "paging" }
paging-compose = { module = "androidx.paging:paging-compose", version.ref = "paging" }

# coil (AsyncImageã§ä½¿ç”¨)
coil-compose = { module = "io.coil-kt:coil-compose", version.ref = "coil" }

[plugins]
ksp-gradle-plugin = { id = "com.google.devtools.ksp", version.ref = "ksp" }
hilt-android-gradle-plugin = { id = "com.google.dagger.hilt.android", version.ref = "hilt" }
```

ãƒ«ãƒ¼ãƒˆã® `build.gradle` ã« `hilt-android-gradle-plugin` ãƒ—ãƒ©ã‚°ã‚¤ãƒ³ã‚’è¿½åŠ ã—ã¾ã™ã€‚

```kotlin
plugins {
    alias(libs.plugins.ksp.gradle.plugin) apply false
    alias(libs.plugins.hilt.android.gradle.plugin) apply false
}
```

`app/build.gradle.kts` ã«ä»¥ä¸‹ã‚’è¿½åŠ ã—ã¾ã™ã€‚

```kotlin
plugins {
    alias(libs.plugins.ksp.gradle.plugin) // è¿½åŠ 
    alias(libs.plugins.hilt.android.gradle.plugin) // è¿½åŠ 
}

// ...

dependencies {
    // hilt
    implementation(libs.lifecycle.viewmodel.ktx)
    implementation(libs.hilt.android)
    ksp(libs.hilt.compiler)
    implementation(libs.hilt.navigation.compose)

    // room
    implementation(libs.room.runtime)
    implementation(libs.room.ktx)
    annotationProcessor(libs.room.compiler)
    ksp(libs.room.compiler)
    implementation(libs.room.paging)
    
    // paging
    implementation(libs.paging.runtime)
    implementation(libs.paging.compose)
    
    // coil
    implementation(libs.coil.compose)
}
```

å†åº¦ã€ŒSync Project with Gradle Filesã€ã‚’å®Ÿæ–½ã—ã¾ã™ã€‚

â€» ä»¥ä¸‹ã®æ§˜ãªã‚¨ãƒ©ãƒ¼ãŒç™ºç”Ÿã™ã‚‹å ´åˆã¯ `org-jetbrains-kotlin-android` ã‚’ `org-jetbrains-kotlin-android = "1.9.10"` ã«å¤‰æ›´ã™ã‚‹ã¨è§£æ±ºã™ã‚‹å ´åˆãŒã‚ã‚Šã¾ã™ã€‚

```text
Unable to find method ''org.jetbrains.kotlin.gradle.plugin.mpp.KotlinAndroidTarget org.jetbrains.kotlin.gradle.plugin.mpp.KotlinJvmAndroidCompilation.getTarget()''
'org.jetbrains.kotlin.gradle.plugin.mpp.KotlinAndroidTarget org.jetbrains.kotlin.gradle.plugin.mpp.KotlinJvmAndroidCompilation.getTarget()'
```

# å®Ÿè£…

## 1. Hilt ã‚¢ãƒ—ãƒªã‚±ãƒ¼ã‚·ãƒ§ãƒ³ ã‚¯ãƒ©ã‚¹ã®ä½œæˆ

Hilt ã‚’ä½¿ç”¨ã™ã‚‹ã‚¢ãƒ—ãƒªã«ã¯ã€`@HiltAndroidApp`Â ã‚¢ãƒãƒ†ãƒ¼ã‚·ãƒ§ãƒ³ãŒä»˜ã‘ã‚‰ã‚ŒãŸÂ `[Application](https://developer.android.com/reference/android/app/Application?hl=ja)`Â ã‚¯ãƒ©ã‚¹ãŒå«ã¾ã‚Œã¦ã„ã‚‹å¿…è¦ãŒã‚ã‚Šã¾ã™ã€‚ä»Šå›ã¯ `MainApplication.kt` ã‚’ä»¥ä¸‹å†…å®¹ã§ä½œæˆã—ã¾ã™ã€‚

```kotlin
import android.app.Application
import dagger.hilt.android.HiltAndroidApp

@HiltAndroidApp
class MainApplication : Application() {
}
```

æ¬¡ã« **`AndroidManifest.xml`** ã® `application` ã‚¿ã‚°ã« `name` ã‚’è¿½åŠ ã—ã¾ã™ã€‚

```xml
<application
    android:name=".MainApplication"
    ...>
</application>
```

## **2. @AndroidEntryPointã®è¨­å®š**

[https://dagger.dev/api/latest/dagger/hilt/android/AndroidEntryPoint.html](https://dagger.dev/api/latest/dagger/hilt/android/AndroidEntryPoint.html)

DIã®EntryPoitã¨ã—ã¦è¨­å®šã™ã‚‹ã‚¢ãƒãƒ†ãƒ¼ã‚·ãƒ§ãƒ³ã§ã€ãƒ©ã‚¤ãƒ•ã‚µã‚¤ã‚¯ãƒ«ã‚‚ä»˜ä¸ã—ãŸã‚‚ã®ã«å¿œã˜ã¦å‹•ä½œã—ã¾ã™ã€‚ä»Šå›ã¯ãƒ—ãƒ­ã‚¸ã‚§ã‚¯ãƒˆä½œæˆæ™‚ã«ä½œæˆã•ã‚Œã‚‹ `MainActivity` ã«ä»˜ä¸ã—ã¾ã™ã€‚

```kotlin
@AndroidEntryPoint
class MainActivity : ComponentActivity() {
  ...
}
```

## 3. Roomå®Ÿè£…

idã€åå‰ã€ãƒ—ãƒ­ãƒ•ã‚£ãƒ¼ãƒ«ç”»åƒã‚’æŒã¤ `users` ãƒ†ãƒ¼ãƒ–ãƒ«ã‚’å®Ÿè£…ã™ã‚‹æƒ³å®šã§é€²ã‚ã¦ã„ã“ã†ã¨æ€ã„ã¾ã™ã€‚

 `User.kt`, `UserDao.kt`, `AppDatabase` ã‚’ä½œæˆã—ã¦ã„ãã¾ã™ã€‚

### 1-1. `User.kt`

`com.example.roomhiltcomposeexample` ãƒ‘ãƒƒã‚±ãƒ¼ã‚¸é…ä¸‹ã« `data` ãƒ‘ãƒƒã‚±ãƒ¼ã‚¸ã‚’è¿½åŠ ã— `User.kt` ã‚’ä»¥ä¸‹å†…å®¹ã§ä½œæˆã—ã¾ã™ã€‚

```kotlin
package com.example.roomhiltcomposeexample.data

import androidx.room.Entity
import androidx.room.PrimaryKey

@Entity(tableName = "users")
data class User(
    @PrimaryKey(autoGenerate = true)
    val id: Int = 0,
    var name: String = "",
    var image: String
)

```

### 1-2. `UserDao.kt`

æ¬¡ã«åŒã˜ `data` ãƒ‘ãƒƒã‚±ãƒ¼ã‚¸å†…ã« `UserDao.kt` ã‚’ä»¥ä¸‹å†…å®¹ã§ä½œæˆã—ã¾ã™ã€‚

```kotlin
package com.example.roomhiltcomposeexample.data

import androidx.room.Dao
import androidx.room.Insert
import androidx.room.Query
import kotlinx.coroutines.flow.Flow

@Dao
interface UserDao {
    @Query("SELECT * from users ORDER BY name ASC")
    fun getUsers(): Flow<List<User>>

    @Query("SELECT * from users WHERE id = :id")
    fun getUser(id: Long): Flow<User>

    @Insert
    suspend fun insert(user: User): Long
}
```

### 1-3. `AppDatabase.kt`

æ¬¡ã‚‚åŒã˜ `data` ãƒ‘ãƒƒã‚±ãƒ¼ã‚¸å†…ã« `AppDatabase.kt` ã‚’ä»¥ä¸‹å†…å®¹ã§ä½œæˆã—ã¾ã™ã€‚

```kotlin
package com.example.roomhiltcomposeexample.data

import androidx.room.Database
import androidx.room.RoomDatabase

@Database(
    entities = [User::class],
    version = 1,
    exportSchema = false
)
abstract class AppDatabase : RoomDatabase() {
    abstract fun userDao(): UserDao
}
```

## 4. DatabaseModuleå®Ÿè£…

æ¬¡ã«ä½œæˆã—ãŸ `AppDatabase` ã‚’ã©ã†DIã™ã‚‹ã®ã‹ã‚’æ±ºã‚ã‚‹ `DatabaseModule` ã‚’ä½œæˆã—ã¾ã™ã€‚

æ–°è¦ã« `di` ãƒ‘ãƒƒã‚±ãƒ¼ã‚¸ã‚’ä½œæˆã—ä»¥ä¸‹å†…å®¹ã§ `DatabaseModule.kt` ã‚’ä½œæˆã—ã¾ã™ã€‚

```kotlin
package com.example.roomhiltcomposeexample.di

import android.content.Context
import androidx.room.Room
import com.example.roomhiltcomposeexample.data.AppDatabase
import dagger.Module
import dagger.Provides
import dagger.hilt.InstallIn
import dagger.hilt.android.qualifiers.ApplicationContext
import dagger.hilt.components.SingletonComponent
import javax.inject.Singleton

@Module
@InstallIn(SingletonComponent::class)
object DatabaseModule {
    @Singleton
    @Provides
    fun provideDatabase(
        @ApplicationContext context: Context
    ) = Room.databaseBuilder(context, AppDatabase::class.java, "app_database")
        .fallbackToDestructiveMigration()
        .build()

    @Singleton
    @Provides
    fun provideUserDao(db: AppDatabase) = db.userDao()
}
```

ã“ã“ã§ã¯ `AppDatabase` ã‚’ã‚·ãƒ³ã‚°ãƒ«ãƒˆãƒ³ã¨ã—ã¦DIã™ã‚‹è¨­å®šã¨ã€UserDaoã‚‚ã‚·ãƒ³ã‚°ãƒ«ãƒˆãƒ³ã¨ã—ã¦DIã•ã‚Œã‚‹ã‚ˆã†ã«å®Ÿè£…ã—ã¦ã„ã¾ã™ã€‚

## 5. è©¦ã—ã«ã¡ã‚ƒã‚“ã¨DIã•ã‚Œã¦ã„ã‚‹ã‹ç¢ºèª

ä¸Šè¨˜ã® `DatabaseModule` ãŒã¡ã‚ƒã‚“ã¨å‹•ä½œã—ã¦ã„ã‚‹ã‹æ¨ã¦ã‚³ãƒ¼ãƒ‰ã§ç¢ºèªã—ã¦ã¿ãŸã„ã¨æ€ã„ã¾ã™ã€‚

`MainActivity` ã«ä»¥ä¸‹å‡¦ç†ã‚’è¿½åŠ ã—ã¾ã™ã€‚

```kotlin
@AndroidEntryPoint
class MainActivity : ComponentActivity() {
    // â†“è¿½åŠ 
    @Inject
    lateinit var appDatabase: AppDatabase
    
    override fun onCreate(savedInstanceState: Bundle?) {
        super.onCreate(savedInstanceState)
        // â†“è¿½åŠ 
        lifecycleScope.launch {
            appDatabase.userDao().also {
                appDatabase.withTransaction {
                    val id = it.insert(User(name = "taro", image = ""))
                    val user = it.getUser(id).first()
                    Log.d("MainActivity", "userId: ${user.id}, name: ${user.name}")
                }
            }
        }
        // ...
    }
}
```

å®Ÿè£…ã—ãŸã‚‰å®Ÿéš›ã«ã‚¨ãƒŸãƒ¥ãƒ¬ãƒ¼ã‚¿ã‚’èµ·å‹•ã—ã€ãƒ­ã‚°ã« `userId` ã¨ `name` ãŒè¡¨ç¤ºã•ã‚Œã¦ã„ã‚Œã°OKã§ã™ã€‚

ç¢ºèªãŒå–ã‚ŒãŸã‚‰è¿½åŠ ã—ãŸã‚³ãƒ¼ãƒ‰ã¯å‰Šé™¤ã—ã¦ãŠãã¾ã™ã€‚

## 6. ä¸€è¦§ã§è¡¨ç¤ºã•ã›ã‚‹ãƒ€ãƒŸãƒ¼ãƒ¦ãƒ¼ã‚¶ãƒ¼ã‚’ç™»éŒ²

ä¸€è¦§ã§è¡¨ç¤ºã•ã›ã‚‹ãƒ€ãƒŸãƒ¼ã®ãƒ¦ãƒ¼ã‚¶ãƒ¼æƒ…å ±ã‚’ã‚¢ãƒ—ãƒªèµ·å‹•æ™‚ã«ä¸€åº¦ã ã‘ç™»éŒ²ã™ã‚‹ã‚ˆã†ã«ã—ã¦ã¿ãŸã„ã¨æ€ã„ã¾ã™ã€‚

å…ˆã»ã©ã® `AppDatabase` ã®æ‹¡å¼µãƒ¡ã‚½ãƒƒãƒ‰ã¨ã—ã¦ä»¥ä¸‹ã‚’è¿½åŠ ã—ã¾ã™ã€‚

```kotlin
fun AppDatabase.seed(scope: CoroutineScope) {
    scope.launch(Dispatchers.IO) {
        val dao = userDao()
        if (dao.getUsers().first().isNotEmpty()) return@launch
        for (i in 1..100) {
            User(name = "user${i}", image = "https://randomuser.me/api/portraits/thumb/men/${i}.jpg")
                .also { dao.insert(it) }
        }
    }
}
```

æ¬¡ã« `MainActivity` ã«ä»¥ä¸‹ã‚’è¿½åŠ ã—ã¾ã™ã€‚

```kotlin
@AndroidEntryPoint
class MainActivity : ComponentActivity() {
    @Inject
    lateinit var appDatabase: AppDatabase

    override fun onCreate(savedInstanceState: Bundle?) {
        super.onCreate(savedInstanceState)
        appDatabase.seed(lifecycleScope) // â† è¿½åŠ 
        
        // ...
    }
}
```

ã“ã“ã¾ã§ããŸã‚‰ã‚·ãƒ¥ãƒŸãƒ¬ãƒ¼ã‚¿ã§å®Ÿè¡Œã—AndroidStudioã® `App Inspection` > `Database Inspector` ã§ã¡ã‚ƒã‚“ã¨ç™»éŒ²ã§ãã¦ã„ã‚‹ã‹ç¢ºèªã—ã¦ã¿ã¾ã™ã€‚

![image4](/images/3ab73d3cf95820/image4.png =600x)

## 7. ä¸€è¦§è¡¨ç¤ºã•ã›ã‚‹UIéƒ¨åˆ†ã®å®Ÿè£…

æ–°è¦ã« `MainScreen.kt` ã‚’ä½œæˆã—ã¾ã™ã€‚ã¾ãšã¯å†…éƒ¨ã§å®šç¾©ã—ãŸãƒ€ãƒŸãƒ¼ãƒ‡ãƒ¼ã‚¿ã‚’ä¸€è¦§è¡¨ç¤ºã•ã›ã‚‹ã ã‘ã®UIã‚’å®Ÿè£…ã—ã¾ã™ã€‚

```kotlin
@OptIn(ExperimentalMaterial3Api::class)
@Composable
fun MainScreen() {
    val items = mapOf<String, String>(
        "user1" to "https://randomuser.me/api/portraits/thumb/men/1.jpg",
        "user2" to "https://randomuser.me/api/portraits/thumb/men/2.jpg",
        "user3" to "https://randomuser.me/api/portraits/thumb/men/3.jpg",
    ).toList()

    Scaffold(
        topBar = {
            TopAppBar(
                title = {
                    Text("MainScreen")
                }
            )
        },
    ) { innerPadding ->
        LazyColumn(
            modifier = Modifier
                .padding(innerPadding)
        ) {
            items(items = items) {
                Row(
                    horizontalArrangement = Arrangement.Center,
                    verticalAlignment = Alignment.CenterVertically,
                ) {
                    AsyncImage(
                        model = it.second,
                        modifier = Modifier
                            .padding(6.dp)
                            .height(60.dp)
                            .width(60.dp),
                        contentDescription = "Translated description of what the image contains",
                        contentScale = ContentScale.FillBounds,
                    )
                    Text(
                        modifier = Modifier
                            .padding(vertical = 18.dp, horizontal = 8.dp),
                        text = it.first
                    )
                }
                HorizontalDivider()
            }
        }
    }
}
```

æ¬¡ã« `MainActivity` ã‚’ä»¥ä¸‹ã«ä¿®æ­£ã—ã¾ã™ã€‚

```kotlin
@AndroidEntryPoint
class MainActivity : ComponentActivity() {
    @Inject
    lateinit var appDatabase: AppDatabase

    override fun onCreate(savedInstanceState: Bundle?) {
        super.onCreate(savedInstanceState)
        appDatabase.seed(lifecycleScope)

        setContent {
            RoomHiltComposeExampleTheme {
                // A surface container using the 'background' color from the theme
                Surface(
                    modifier = Modifier.fillMaxSize(),
                    color = MaterialTheme.colorScheme.background
                ) {
                    MainScreen() // ä½œæˆã—ãŸMainScreenã«ç½®ãæ›ãˆ
                }
            }
        }
    }
}
```

æœ€å¾Œã« `AndroidManifest.xml` ã« `android.permission.INTERNET` ã® `permission` ã‚’è¨­å®šã—ã‚¨ãƒŸãƒ¥ãƒ¬ãƒ¼ã‚¿ã§å®Ÿè¡Œã—ã¦ã¿ã¾ã™ã€‚â†“ã®æ§˜ã«ä¸€è¦§è¡¨ç¤ºã•ã‚Œã‚Œã°OKã§ã™ã€‚

![image5](/images/3ab73d3cf95820/image5.png =500x)

## 8. ViewModelã®ä½œæˆ

æ¬¡ã«Databaseã‹ã‚‰è¨­å®šã—ãŸä»¶æ•°åˆ†Queryã•ã‚ŒãŸãƒ‡ãƒ¼ã‚¿ã‚’UIã«æ¸¡ã™éƒ¨åˆ†ã®ViewModelã‚’ä½œæˆã—ã¦ã„ãã¾ã™ã€‚

ã¾ãšã¯ `UserDao` ã«ãƒšãƒ¼ã‚¸ãƒ³ã‚°ç”¨ã®Queryã‚’è¿½åŠ ã—ã¾ã™ã€‚

```kotlin
@Dao
interface UserDao {
    // â†“è¿½åŠ 
    @Query("SELECT * from users")
    fun getUserPages(): PagingSource<Int, User>
}
```

æ¬¡ã«ä»¥ä¸‹å†…å®¹ã§ `MainScreenViewModel` ã‚’ä½œæˆã—ã¾ã™ã€‚

```kotlin
@HiltViewModel
class MainScreenViewModel @Inject constructor(private val userDao: UserDao) :
    ViewModel() {
    fun getUsers(): Flow<PagingData<User>> =
        Pager(
            config = PagingConfig(
                pageSize = 10,
                prefetchDistance = 20,
            ),
        ) {
            userDao.getUserPages()
        }.flow.cachedIn(viewModelScope)
}
```

æœ€å¾Œã« `MainActivity` ã‚’ä»¥ä¸‹ã«ä¿®æ­£ã—ã¾ã™ã€‚

```kotlin
@OptIn(ExperimentalMaterial3Api::class)
@Composable
fun MainScreen(
    viewModel: MainScreenViewModel = hiltViewModel()
) {
    // â†“ã«å¤‰æ›´
    val items = viewModel.getUsers().collectAsLazyPagingItems()
    Scaffold(
        topBar = {
            TopAppBar(
                title = {
                    Text("MainScreen")
                }
            )
        },
    ) { innerPadding ->
        LazyColumn(
            modifier = Modifier
                .padding(innerPadding)
        ) {
            items(count = items.itemCount) {
                val item = items[it]
                Row(
                    horizontalArrangement = Arrangement.Center,
                    verticalAlignment = Alignment.CenterVertically,
                ) {
                    AsyncImage(
                        model = item?.image,
                        modifier = Modifier
                            .padding(6.dp)
                            .height(60.dp)
                            .width(60.dp),
                        contentDescription = "Translated description of what the image contains",
                        contentScale = ContentScale.FillBounds,
                    )
                    Text(
                        modifier = Modifier
                            .padding(vertical = 18.dp, horizontal = 8.dp),
                        text = item?.name ?: ""
                    )
                }
                HorizontalDivider()
            }
        }
    }
}

```

ã“ã‚Œã§å…¨ã¦ã®å®Ÿè£…ãŒå®Œäº†ã§ã™ï¼ã‚¨ãƒŸãƒ¥ãƒ¬ãƒ¼ã‚¿ã§å®Ÿè¡Œã•ã›ã¦ã¿ã‚‹ã¨ãƒšãƒ¼ã‚¸ãƒ³ã‚°ã§ãã¦ã„ã‚‹é›°å›²æ°—ã§ã™ã€‚

![image6](/images/3ab73d3cf95820/image6.gif =300x)

ãŒã€ã“ã‚Œã ã¨æœ¬å½“ã«ãƒšãƒ¼ã‚¸ãƒ³ã‚°ã§ãã¦ã„ã‚‹ã‹åˆ†ã‹ã‚‰ãªã„ã®ã§ã€pagingã®3.1.0ä»¥é™ã«è¿½åŠ ã•ã‚ŒãŸãƒ‡ãƒãƒƒã‚°æƒ…å ±ã‚’ãƒ­ã‚°è¡¨ç¤ºã—ã¦ãã‚Œã‚‹ä»¥ä¸‹ã®ã‚³ãƒãƒ³ãƒ‰ã§æœ‰åŠ¹åŒ–ã—ç¢ºèªã—ã¦ã¿ãŸã„ã¨æ€ã„ã¾ã™ã€‚

```bash
adb shell setprop log.tag.Paging VERBOSE
```

ä¸Šè¨˜ã‚’å®Ÿè¡Œã—ãƒ­ã‚°ã‚’è¦‹ã¦ã¿ã‚‹ã¨ã€

![image7](/images/3ab73d3cf95820/image7.png =500x)

â†‘åˆå›30ä»¶ãƒ‡ãƒ¼ã‚¿ãŒèª­ã¿è¾¼ã¾ã‚Œã¦ã„ã¦ã€

![image8](/images/3ab73d3cf95820/image8.png =500x)
![image9](/images/3ab73d3cf95820/image9.png =500x)

â†‘ã‚¹ã‚¯ãƒ­ãƒ¼ãƒ«ã®åº¦ã«10ä»¶ãƒ‡ãƒ¼ã‚¿ã‚’è¿½åŠ ã—ã¦ã„ã‚‹ã®ãŒåˆ†ã‹ã‚Šã¾ã™ã€‚

## ä»Šå›ã®å®Ÿè£…åˆ†ã¯ä»¥ä¸‹ãƒªãƒã‚¸ãƒˆãƒªã«ã¦å…¬é–‹ã—ã¦ã¾ã™
(Staré ‚ã‘ãŸã‚‰åŠ±ã¿ã«ãªã‚Šã¾ã™!)

https://github.com/Slowhand0309/RoomHiltComposeExample

# ã“ã®è¨˜äº‹ã¯ä»¥ä¸‹ã®æƒ…å ±ã‚’å‚è€ƒã«ã—ã¦åŸ·ç­†ã—ã¾ã—ãŸ

- [Paging 3 ãƒ©ã‚¤ãƒ–ãƒ©ãƒªã‚’ä½¿ç”¨ã—ãŸ Android Room ãƒ‡ãƒ¼ã‚¿ãƒ™ãƒ¼ã‚¹ã®ãƒšãƒ¼ã‚¸ãƒãƒ¼ã‚·ãƒ§ãƒ³](https://genicsblog.com/gouravkhunger/pagination-in-android-room-database-using-the-paging-3-library)
- [Caching and Pagination with Paging 3 in Android | ProAndroidDev](https://proandroiddev.com/caching-and-pagination-with-paging-3-in-android-jetpack-compose-b636aaf116ce)