---
title: "BlockSuiteã‚’è©¦ã™"
emoji: "ğŸ•‹"
type: "tech" # tech: æŠ€è¡“è¨˜äº‹ / idea: ã‚¢ã‚¤ãƒ‡ã‚¢
topics:
  - "react"
  - "vite"
  - "yjs"
  - "docker"
published: true
---
# BlockSuiteã¨ã¯?

[BlockSuite | Content Editing Toolkit](https://blocksuite.affine.pro/)

> **BlockSuite ã¯ã€å…±åŒç·¨é›†ã‚¢ãƒ—ãƒªã‚±ãƒ¼ã‚·ãƒ§ãƒ³ã‚’ä½œæˆã™ã‚‹ãŸã‚ã®ãƒ„ãƒ¼ãƒ«ã‚­ãƒƒãƒˆã‚’æä¾›ã—ã¾ã™ã€‚**

ãƒ‰ã‚­ãƒ¥ãƒ¡ãƒ³ãƒˆÃ—ãƒ›ãƒ¯ã‚¤ãƒˆãƒœãƒ¼ãƒ‰Ã—ãƒ‡ãƒ¼ã‚¿ãƒ™ãƒ¼ã‚¹ãŒçµ±åˆã•ã‚ŒãŸãƒ¯ãƒ¼ã‚¯ã‚¹ãƒšãƒ¼ã‚¹ **[AFFiNE](https://affine.pro/)** ã§ä½¿ç”¨ã•ã‚Œã¦ã„ã‚‹å…±åŒç·¨é›†éƒ¨åˆ†ã®ãƒ©ã‚¤ãƒ–ãƒ©ãƒªã«ãªã‚Šã¾ã™ã€‚

Editorä¸­å¿ƒã«å±•é–‹ã—ãªã„ç‹¬è‡ªã® **[Document-Centric](https://blocksuite.affine.pro/design-philosophy.html)** ã¨ã„ã†ä»¥ä¸‹ã®ã‚ˆã†ãªã‚¢ãƒ—ãƒ­ãƒ¼ãƒã‚’ã¨ã£ã¦ã„ã¾ã™ã€‚

> å„ã‚¨ãƒ‡ã‚£ã‚¿ãƒ¼ãŒãã®å†…éƒ¨çŠ¶æ…‹ã‚’çµ±åˆçš„ã«ç®¡ç†ã›ãšã€ãƒ‰ã‚­ãƒ¥ãƒ¡ãƒ³ãƒˆ(ã‚¨ãƒ‡ã‚£ã‚¿ãƒ¼ã®ãƒ‡ãƒ¼ã‚¿å±¤) ã¯ã‚¨ãƒ‡ã‚£ã‚¿ãƒ¼ã‹ã‚‰å®Œå…¨ã«ç‹¬ç«‹ã—ã¦ç¶­æŒã•ã‚Œçµµãƒ‡ã‚£ãƒƒã‚¿ãƒ¼ã¯ã‚¢ã‚¿ãƒƒãƒã™ã‚‹ã ã‘ã®æ©Ÿèƒ½ã«ç•™ã‚ã‚‹

ãƒ‰ã‚­ãƒ¥ãƒ¡ãƒ³ãƒˆã¯å…±åŒç·¨é›†ã‚’å®Ÿç¾ã™ã¹ãCRDTã®åŸºç›¤ã®ä¸Šã«æ§‹ç¯‰ã•ã‚Œã¦ã„ã¾ã™ã€‚

 **[Document-Centric](https://blocksuite.affine.pro/design-philosophy.html)** éƒ¨åˆ†ã‚’è©¦ã—ã¦ã¿ãŸã„ã®ã§ã™ãŒã€ã¾ãšã¯ä»Šå›ã¯å‹•ã‹ã›ã‚‹ã‚ˆã†ã«ã—ãŸã„ã¨æ€ã†ã®ã§ã€

ãƒ—ãƒªã‚»ãƒƒãƒˆã¨ã—ã¦æä¾›ã•ã‚Œã¦ã„ã‚‹ä»¥ä¸‹ã® `DocEditor` ã¨ `EdgelessEditor` ã‚’å‹•ã‹ã›ã‚‹ã¾ã§ã‚’è©¦ã—ã¦ã¿ãŸã„ã¨æ€ã„ã¾ã™ã€‚

# `DocEditor`

> ã“ã®ã‚¨ãƒ‡ã‚£ã‚¿ãƒ¼ ãƒ—ãƒªã‚»ãƒƒãƒˆã¯ã€ãƒ‰ãƒ©ãƒƒã‚° ãƒãƒ³ãƒ‰ãƒ«ã€ã‚¹ãƒ©ãƒƒã‚·ãƒ¥ ãƒ¡ãƒ‹ãƒ¥ãƒ¼ã€ãƒ•ã‚©ãƒ¼ãƒãƒƒãƒˆ ãƒ„ãƒ¼ãƒ«ãƒãƒ¼ã€ãã®ä»–ã®çµ„ã¿è¾¼ã¿ã®å¼·åŠ›ãªã‚¦ã‚£ã‚¸ã‚§ãƒƒãƒˆã‚’çµ„ã¿åˆã‚ã›ãŸã€ãƒ–ãƒ­ãƒƒã‚¯ãƒ™ãƒ¼ã‚¹ã®ãƒªãƒƒãƒ ãƒ†ã‚­ã‚¹ãƒˆç·¨é›†ã«å„ªã‚Œã¦ã„ã¾ã™ã€‚

# `EdgelessEditor`

> ã“ã®ã‚¨ãƒ‡ã‚£ã‚¿ãƒ¼ ãƒ—ãƒªã‚»ãƒƒãƒˆã¯ã€ãƒ›ãƒ¯ã‚¤ãƒˆãƒœãƒ¼ãƒ‰ã®ã‚°ãƒ©ãƒ•ã‚£ãƒƒã‚¯ã‚¹ã®ç·¨é›†æ©Ÿèƒ½ã«å„ªã‚Œã¦ã„ã¾ã™ã€‚ ã‚­ãƒ£ãƒ³ãƒã‚¹ãƒ™ãƒ¼ã‚¹ã®ã‚°ãƒ©ãƒ•ã‚£ãƒƒã‚¯ã‚¹ã¨ DOM ãƒ™ãƒ¼ã‚¹ã®ãƒ–ãƒ­ãƒƒã‚¯ ãƒ„ãƒªãƒ¼ã‚’çµ„ã¿åˆã‚ã›ã¾ã™ã€‚ ã“ã‚Œã«ã‚ˆã‚Šã€å‰µé€ çš„ãªã‚°ãƒ©ãƒ•ã‚£ãƒƒã‚¯ ãƒ‡ã‚¶ã‚¤ãƒ³ã¨æ§‹é€ åŒ–ã•ã‚ŒãŸãƒ‰ã‚­ãƒ¥ãƒ¡ãƒ³ãƒˆç·¨é›†ã®ã©ã¡ã‚‰ã‚‚ç°¡å˜ã«ãªã‚Šã€å¹…åºƒã„ãƒ¦ãƒ¼ã‚¶ãƒ¼ã®ãƒ‹ãƒ¼ã‚ºã¨ãƒ¯ãƒ¼ã‚¯ãƒ•ãƒ­ãƒ¼ã«å¯¾å¿œã§ãã¾ã™ã€‚

# ã‚µã‚¯ãƒƒã¨ç’°å¢ƒæ§‹ç¯‰

`DevContainer` ã®ç’°å¢ƒã§Nodeç’°å¢ƒä½œæˆã—ã¾ã™ã€‚

- .devcontainer/Dockerfile

    ```docker
    FROM node:20.10.0-bullseye-slim
    LABEL maintainer="Slowhand0309"
    
    ARG username=vscode
    ARG useruid=1001
    ARG usergid=${useruid}
    
    RUN set -ex \
        && apt-get update \
        && apt-get install -y \
            git \
            sudo \
            --no-install-recommends \
        && groupadd --gid ${usergid} ${username} \
        && useradd -s /bin/bash --uid ${useruid} --gid ${usergid} -m ${username} \
        && echo ${username} ALL=\(root\) NOPASSWD:ALL > /etc/sudoers.d/${username} \
        && chmod 0440 /etc/sudoers.d/${username}
    
    USER ${username}
    ```

- .devcontainer/docker-compose.yml

    ```yaml
    version: '3.8'
    volumes:
      modules_data:
    
    services:
      blocksuite:
        build: .
        image: slowhand/blocksuite
        container_name: "blocksuite"
        volumes:
          - ..:/usr/src
          - modules_data:/usr/src/node_modules
        command: /bin/sh -c "while sleep 1000; do :; done"
        ports:
          - '5173:5173'
        working_dir: /usr/src
    ```

- .devcontainer/devcontainer.json (ç´°ã‹ã„è¨­å®šã¯ãŠå¥½ã¿ã§)

    ```json
    {
      "name": "BlockSuite remote container dev",
      "dockerComposeFile": ["docker-compose.yml"],
      "service": "blocksuite",
      "workspaceFolder": "/usr/src",
      "customizations": {
        "vscode": {
          "extensions": [
            "formulahendry.auto-rename-tag",
            "ms-vscode.vscode-typescript-tslint-plugin",
            "dbaeumer.vscode-eslint",
            "esbenp.prettier-vscode",
            "yoavbls.pretty-ts-errors"
          ],
          "settings": {
            "editor.tabSize": 2,
            "editor.formatOnSave": true,
            "editor.codeActionsOnSave": {
              "source.fixAll.eslint": true
            },
            "files.insertFinalNewline": true,
            "files.trimFinalNewlines": true
          }
        }
      },
      "postAttachCommand": ".devcontainer/postAttach.sh",
      "remoteUser": "vscode"
    }
    ```

- .devcontainer/postAttach.sh

    ```bash
    #!/bin/sh
    
    cd `dirname $0`
    cd ..
    sudo chown -R vscode node_modules
    
    # yarn install
    # yarn dev
    ```

DevContainerã‚’VSCodeä¸Šã§èµ·å‹•ã—ã€ã‚³ãƒ³ãƒ†ãƒŠå†…ã«å…¥ã£ã¦Viteã§ç’°å¢ƒæ§‹ç¯‰ã—ã¦ã„ãã¾ã™ã€‚

```bash
$ yarn create vite
yarn create v1.22.19
[1/4] Resolving packages...
[2/4] Fetching packages...
[3/4] Linking dependencies...
[4/4] Building fresh packages...
success Installed "create-vite@5.1.0" with binaries:
      - create-vite
      - cva
âœ” Project name: â€¦ .
âœ” Current directory is not empty. Please choose how to proceed: â€º Ignore files and continue
âœ” Select a framework: â€º React
âœ” Select a variant: â€º TypeScript + SWC

Scaffolding project in /usr/src...

Done. Now run:

  yarn
  yarn dev
```

Dockerç”¨ã« `package.json` ã® `scripts` > `dev` ã‚’ä»¥ä¸‹ã«ä¿®æ­£ã—ã¾ã™ã€‚

```json
"dev": "vite --host 0.0.0.0",
```

æ—©é€Ÿèµ·å‹•ã—ã¦ã¿ã¾ã™ã€‚

```bash
yarn
yarn dev
```

ä¸Šè¨˜ã‚³ãƒãƒ³ãƒ‰ã‚’å®Ÿæ–½ã—ã€http://localhost:5173/ ã«ã‚¢ã‚¯ã‚»ã‚¹ã—ã¦è¡¨ç¤ºã•ã‚Œã¦ã„ã‚Œã°OKã§ã™ã€‚

# å¿…è¦ãªãƒ‘ãƒƒã‚±ãƒ¼ã‚¸ã‚¤ãƒ³ã‚¹ãƒˆãƒ¼ãƒ«

```bash
yarn add @blocksuite/presets@nightly @blocksuite/store@nightly yjs
```

BlockSuiteã¯å…±åŒç·¨é›†éƒ¨åˆ†ã«CRDTå®Ÿè£…ã®yjsã‚’ä½¿ã£ã¦ã„ã‚‹ã®ã§ãã¡ã‚‰ã‚‚ã‚¤ãƒ³ã‚¹ãƒˆãƒ¼ãƒ«ã—ã¾ã™ã€‚

# ã‚·ãƒ³ãƒ—ãƒ«ãª `DocEditor` ã‚’è©¦ã™

```tsx
import "@blocksuite/presets/themes/affine.css";

import { createEmptyPage, DocEditor } from "@blocksuite/presets";
import { useEffect, useRef } from "react";

function App() {
  const ref = useRef<HTMLDivElement>(null);
  useEffect(() => {
    (async () => {
      const page = await createEmptyPage().init();
      const editor = new DocEditor();
      editor.page = page;
      ref.current?.appendChild(editor);
    })();
  }, []);

  return (
    <div
      ref={ref}
      style={{ width: "100vw", height: "100vh", background: "white" }}
    ></div>
  );
}

export default App;
```

â†‘ã«ä¿®æ­£ã— `yarn dev` ã§èµ·å‹•ã•ã›ã‚‹ã¨ä»¥ä¸‹ã®æ§˜ãªã‚·ãƒ³ãƒ—ãƒ«ãªBlock EditorãŒèµ·å‹•ã—ã¾ã™ã€‚

![image1.gif](/images/30fc4316f28b85/image1.gif =800x)

# ã‚·ãƒ³ãƒ—ãƒ«ãª `EdgelessEditor` ã‚’è©¦ã™

å…ˆç¨‹ä¿®æ­£ã—ãŸ `App.tsx` ã® `DocEditor` ã‚’ `EdgelessEditor` ã«å¤‰æ›´ã—ã¾ã™ã€‚

```tsx
import "@blocksuite/presets/themes/affine.css";

import { createEmptyPage, EdgelessEditor } from "@blocksuite/presets";
import { useEffect, useRef } from "react";

function App() {
  const ref = useRef<HTMLDivElement>(null);
  useEffect(() => {
    (async () => {
      const page = await createEmptyPage().init();
      const editor = new EdgelessEditor();
      editor.page = page;
      ref.current?.appendChild(editor);
    })();
  }, []);

  return (
    <div
      ref={ref}
      style={{ width: "100vw", height: "100vh", background: "white" }}
    ></div>
  );
}

export default App;
```

![image2.gif](/images/30fc4316f28b85/image2.gif =800x)

ã“ã‚Œã ã‘ã§â†‘ã®æ§˜ãªCanvasä¸Šã§BlockEditorãŒä½¿ãˆã‚‹EditorãŒè¡¨ç¤ºã•ã‚Œã¾ã™ã€‚