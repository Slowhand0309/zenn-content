---
title: "FusedLocation - Androidã§ä½ç½®æƒ…å ±å–å¾— -"
emoji: "ğŸ—ºï¸"
type: "tech"
topics:
  - "android"
  - "kotlin"
  - "location"
published: true
published_at: "2022-03-25 18:50"
---

# æ¦‚è¦
ä»¥å‰ã¯ `LocationManager` ã‚’ä½¿ã£ã¦ã„ãŸãŒã€æœ€è¿‘ã¯ Google Play Serviceã® `FusedLocation` ã‚’ä½¿ã†ã®ãŒæ¨å¥¨ã•ã‚Œã¦ã„ã‚‹ã‚‰ã—ã„ã€‚
[å…¬å¼ã®èª¬æ˜](https://developers.google.com/location-context/fused-location-provider)ã‚’è¦‹ã‚‹ã¨ã€Providerã©ã‚Œä½¿ã†ã‹?(GPS, wifi...)ã¨ãƒãƒƒãƒ†ãƒªãƒ¼åŠ¹ç‡ã‚’è€ƒãˆã¦ä¸€ç•ªé©ã—ãŸæ–¹æ³•ã§ä½ç½®æƒ…å ±ã‚’æä¾›ã—ã¦ãã‚Œã‚‹æ§˜å­ã€‚

## [ä½ç½®æƒ…å ±ã¸ã®ã‚¢ã‚¯ã‚»ã‚¹ã‚’ãƒªã‚¯ã‚¨ã‚¹ãƒˆã™ã‚‹](https://developer.android.com/training/location/permissions)
[ã‚¢ãƒ—ãƒªã®æ¨©é™ã‚’ãƒªã‚¯ã‚¨ã‚¹ãƒˆã®åŸºæœ¬](https://developer.android.com/training/permissions/requesting) ä»Šä¸€åº¦ç¢ºèª
- æ¨©é™ã‚’å¿…è¦ã¨ã™ã‚‹æ©Ÿèƒ½ã‚’ãƒ¦ãƒ¼ã‚¶ãƒ¼ãŒæ“ä½œã—å§‹ã‚ãŸã‚‰ã€ãã®çŠ¶æ³ã«å¿œã˜ãŸæ¨©é™ã‚’ãƒªã‚¯ã‚¨ã‚¹ãƒˆã™ã‚‹ã“ã¨
- ãƒ¦ãƒ¼ã‚¶ãƒ¼ã‚’ãƒ–ãƒ­ãƒƒã‚¯ã—ãªã„ã“ã¨ã€‚æ¨©é™ã«é–¢é€£ã—ãŸèª¬æ˜ã‚’è¡¨ç¤ºã™ã‚‹ UI ãƒ•ãƒ­ãƒ¼ã¯ã€å¸¸ã«ã‚­ãƒ£ãƒ³ã‚»ãƒ«ã§ãã‚‹ã‚ˆã†ã«ã—ã¦ãã ã•ã„
- æ©Ÿèƒ½ã«å¿…è¦ãªæ¨©é™ã‚’ãƒ¦ãƒ¼ã‚¶ãƒ¼ãŒæ‹’å¦ã¾ãŸã¯å–ã‚Šæ¶ˆã—ãŸå ´åˆã¯ã€ã‚°ãƒ¬ãƒ¼ã‚¹ãƒ•ãƒ« ãƒ‡ã‚°ãƒ©ãƒ‡ãƒ¼ã‚·ãƒ§ãƒ³ã‚’è¡Œã„ã‚¢ãƒ—ãƒªã®ä½¿ç”¨ã‚’ç¶šã‘ã‚‰ã‚Œã‚‹ã‚ˆã†ã«ã™ã‚‹ã“ã¨
- ã‚·ã‚¹ãƒ†ãƒ å‹•ä½œã‚’å‰æã¨ã—ãªã„ã“ã¨

### æ¨©é™ã®ç¨®é¡
- **ACCESS_FINE_LOCATION**
    - GPSã‚„Wi-Fiã€ãƒ¢ãƒã‚¤ãƒ«ãƒ‡ãƒ¼ã‚¿ãªã©ã€åˆ©ç”¨å¯èƒ½ãªä½ç½®æƒ…å ±ãƒ—ãƒ­ãƒã‚¤ãƒ€ã‚’ä½¿ç”¨ã—ã€ã§ãã‚‹é™ã‚Šæ­£ç¢ºãªä½ç½®æƒ…å ±ã®ç‰¹å®šã‚’è¡Œã„ã¾ã™
- **ACCESS_COARSE_LOCATION**
    - Wi-Fiã‹ãƒ¢ãƒã‚¤ãƒ«ãƒ«ãƒ¼ã‚¿ã€ã‚ã‚‹ã„ã¯ãã®ä¸¡æ–¹ã‚’ä½¿ç”¨ã—ã€éƒ½å¸‚ã®ï¼‘åŒºç”»ç¨‹åº¦ã®åˆ¶åº¦ã§ä½ç½®æƒ…å ±ã®ç‰¹å®šã‚’è¡Œã„ã¾ã™

### å®Ÿè£…
ã¾ãšã¯æ¨©é™ãŒä»˜ä¸ã•ã‚Œã¦ã„ã‚‹ã‹ã®ãƒã‚§ãƒƒã‚¯

```kotlin
    private fun getLocationPermission() {
        val permission = ContextCompat.checkSelfPermission(
            this.applicationContext,
            Manifest.permission.ACCESS_FINE_LOCATION
        )
        if (permission == PackageManager.PERMISSION_GRANTED) {
            requestDeviceLocation()
        } else if (permission == PackageManager.PERMISSION_DENIED) {
            /* ä»¥å‰ãƒ¦ãƒ¼ã‚¶ãƒ¼ãŒãƒªã‚¯ã‚¨ã‚¹ãƒˆã‚’è¨±å¯ã—ãªã‹ã£ãŸå ´åˆtrueã‚’è¿”ã™
               ã¾ãŸã€Œä»Šå¾Œè¡¨ç¤ºã—ãªã„ã€ã‚’é¸æŠã—ã¦ã„ãŸå ´åˆã¯falseã‚’è¿”ã™ */
            if (ActivityCompat.shouldShowRequestPermissionRationale(
                    this,
                    Manifest.permission.ACCESS_FINE_LOCATION
                )
            ) {
                // ã“ã“ã§ãƒ¦ãƒ¼ã‚¶ãƒ¼ã«èª¬æ˜ç”¨ã®UIã‚’è¡¨ç¤ºã™ã‚‹
            } else {
                val requestPermissionLauncher =
                    registerForActivityResult(
                        ActivityResultContracts.RequestPermission()
                    ) { isGranted: Boolean ->
                        if (isGranted) {
                            requestDeviceLocation()
                        } else {
                            Napier.w("Permission not granted")
                        }
                    }
                requestPermissionLauncher.launch(
                    Manifest.permission.ACCESS_FINE_LOCATION
                )
            }
        }
    }
```

## ç›´è¿‘ã®ä½ç½®æƒ…å ±ã‚’å–å¾—ã™ã‚‹ 

```kotlin

    @SuppressLint("MissingPermission")
    private fun requestDeviceLocation() {
        fusedLocationClient = LocationServices.getFusedLocationProviderClient(this)
        try {
            val locationResult = fusedLocationClient.lastLocation
            locationResult.addOnCompleteListener { task ->
                if (task.isSuccessful) {
                    val lastKnownLocation = task.result
                    if (lastKnownLocation != null) {
		        // lastKnownLocation.latitude ã¨ lastKnownLocation.longitude ã‚’ä½¿ã†
                    }
                } else {
                    Napier.i("Request location updates")
                    locationCallback = object : LocationCallback() {
                        override fun onLocationResult(locationResult: LocationResult) {
                            locationResult.lastLocation.also {
		                // it.latitude ã¨ it.longitude ã‚’ä½¿ã†
                            }
                        }
                    }
                    startLocationUpdates()
                    requestingLocationUpdates = true
                }
            }
        } catch (e: SecurityException) {
            Napier.e("SecurityException", e)
        }
    }

    @SuppressLint("MissingPermission")
    private fun startLocationUpdates() {
        locationCallback?.also {
            fusedLocationClient.requestLocationUpdates(
                LocationRequest.create().apply {
                    interval = 5000
                    priority = LocationRequest.PRIORITY_HIGH_ACCURACY
                }, it, this.mainLooper
            )
        }
    }

    override fun onResume() {
        super.onResume()
        if (requestingLocationUpdates) {
            startLocationUpdates()
        }
    }

    override fun onPause() {
        super.onPause()
        locationCallback?.also {
            fusedLocationClient.removeLocationUpdates(it)
        }
    }
```

# å‚è€ƒURL
- [Fused Location Provider API Â |Â  Google Developers](https://developers.google.com/location-context/fused-location-provider)
- [ã€Kotlinã€‘ä½ç½®æƒ…å ±ã®ãƒ‘ãƒ¼ãƒŸãƒƒã‚·ãƒ§ãƒ³ãƒ€ã‚¤ã‚¢ãƒ­ã‚°ã‚’è¡¨ç¤ºã™ã‚‹æ–¹æ³•ã‚’è§£èª¬ | Hirauchi Genta](https://hirauchi-genta.com/kotlin-location-permission/)
- [FusedLocationProviderClientã‚’ç”¨ã„ãŸä½ç½®æƒ…å ±ã®å–å¾— - Qiita](https://qiita.com/maebaru/items/ba821938e66498d6ae76)
- [ç¾åœ¨åœ°ã®æ›´æ–°æƒ…å ±ã‚’ãƒªã‚¯ã‚¨ã‚¹ãƒˆã™ã‚‹ Â |Â  Android ãƒ‡ãƒ™ãƒ­ãƒƒãƒ‘ãƒ¼ Â |Â  Android Developers](https://developer.android.com/training/location/request-updates?hl=ja)
- [Google Play Serviceã®FusedLocationã§ä½ç½®æƒ…å ±ã‚’å–å¾— | tkt989 ğŸµ ãƒ–ãƒ­ã‚°](https://blog.tkt989.info/2017/12/09/Google-Play-Service%E3%81%AEFusedLocation%E3%81%A7%E4%BD%8D%E7%BD%AE%E6%83%85%E5%A0%B1%E3%82%92%E5%8F%96%E5%BE%97)