---
title: "ã€ReactNativeã€‘GithubActionsã§FirebaseAppDistributionã«é…å¸ƒã™ã‚‹ (Androidã®ã¿)"
emoji: "ğŸ”¥"
type: "tech" # tech: æŠ€è¡“è¨˜äº‹ / idea: ã‚¢ã‚¤ãƒ‡ã‚¢
topics:
  - "reactnative"
  - "expo"
  - "firebase"
  - "githubactions"
  - "typescript"
published: true
---
# æ¦‚è¦

ä»Šå›ã¯æ—¢ã«ã‚ã‚‹React Native ãƒ—ãƒ­ã‚¸ã‚§ã‚¯ãƒˆã§æœªã Expo Goä¸Šã§ã®ã¿å‹•ã‹ã—ã¦ã„ãªã„ã‚¢ãƒ—ãƒªã‚’ã€Androidã ã‘ Firebase App Distribution ã«é…å¸ƒã™ã‚‹æµã‚Œã‚’è©¦ã—ã¦ã¿ãŸã„ã¨æ€ã„ã¾ã™ã€‚

[EAS](https://docs.expo.dev/eas/) ã¯ä½¿ã‚ãšã«Androidãƒ—ãƒ­ã‚¸ã‚§ã‚¯ãƒˆã‚’ç”Ÿæˆã—ãƒ“ãƒ«ãƒ‰&é…å¸ƒã™ã‚‹æ–¹æ³•ã«ãªã‚Šã¾ã™ã€‚

## ç’°å¢ƒ

ä»Šå›è©¦ã™ã«ã‚ãŸã£ã¦æƒ³å®šã™ã‚‹ç’°å¢ƒã¨ã—ã¦ã¯ä»¥ä¸‹ã®2ç¨®é¡ã‚ã‚Šã€ä»Šå›ã¯ `DEV` ã®ã‚¢ãƒ—ãƒªé…å¸ƒã‚’ç›®æŒ‡ã—ã¦é€²ã‚ã¦ã„ãã¾ã™ã€‚

|  | DEV | PROD |
| --- | --- | --- |
| ã‚¢ãƒ—ãƒªå | AppName (Dev) | AppName |
| BundleID | com.my.app.dev | com.my.app |

# äº‹å‰æº–å‚™

## `android` ãƒ‡ã‚£ãƒ¬ã‚¯ãƒˆãƒªç”Ÿæˆ

ä»¥ä¸‹ã‚³ãƒãƒ³ãƒ‰ã§ `android` ãƒ‡ã‚£ãƒ¬ã‚¯ãƒˆãƒªã‚’ç”Ÿæˆã—ã¾ã™ã€‚ `-p` ã§ãƒ—ãƒ©ãƒƒãƒˆãƒ•ã‚©ãƒ¼ãƒ (ä»Šå›ã¯android)ã‚’æŒ‡å®šã—ã€ä»Šå›ã¯ `yarn` ã‚’ä½¿ã†ã“ã¨ã‚’æ˜ç¤ºçš„ã«æŒ‡å®šã—ã¦ã¾ã™ã€‚

```bash
expo prebuild -p android --yarn
```

`prebuild` ã¯ Continuous Native Generation (CNG) ã®ä»•çµ„ã¿ã‚’ä½¿ã£ã¦ `android/` ãƒ‡ã‚£ãƒ¬ã‚¯ãƒˆãƒªã‚’ä½œã‚Šã¾ã™ã€‚

## `android/app/build.gradle` ã®ä¿®æ­£

`flavor` ã®è¨­å®šè¿½åŠ ã¨ `signingConfigs` ã®è¨­å®šã‚’è¿½åŠ ã—ã¨ãã¾ã™ã€‚

```groovy
android {
    // ....
    flavorDimensions "flavor-type"

    productFlavors {
        dev {
            dimension "flavor-type"
            applicationId "com.my.app.dev"
            resValue "string", "app_name", "AppName (Dev)"
        }
        prod {
            dimension "flavor-type"
            applicationId "com.my.app"
            resValue "string", "app_name", "AppName"
        }
    }
    signingConfigs {
        release {
            if (System.getenv()["CI"]) {
                storeFile file(System.getenv()["KEYSTORE_PATH"])
                storePassword System.getenv()["KEYSTORE_PASSWORD"]
                keyAlias System.getenv()["KEYSTORE_KEY_ALIAS"]
                keyPassword System.getenv()["KEYSTORE_KEY_PASSWORD"]
            } else {
                // ...
            }
        }
    }
}
```

## `app.config.js` ã‚’ä½œæˆ

ä»¥ä¸‹å†…å®¹ã§ `app.config.js` ã‚’ä½œæˆã—ã€`app.json` ã‚’éƒ¨åˆ†çš„ãªç®‡æ‰€ã ã‘Overrideã™ã‚‹å½¢ã§è¨­å®šã—ã¾ã™ã€‚

```javascript
export default ({ config }) => {
  const isProduction = process.env.APP_ENV === 'production';
  return {
    ...config,
    expo: {
      name: isProduction ? 'AppName' : 'AppName (Dev)',
      ios: {
        bundleIdentifier: isProduction ? 'com.my.app' : 'com.my.app.dev',
      },
      android: {
        package: isProduction ? 'com.my.app' : 'com.my.app.dev',
      },
    },
  };
};
```

## Firebaseã‚³ãƒ³ã‚½ãƒ¼ãƒ«ã§ã®ä½œæ¥­

å¯¾è±¡ã®Firebaseãƒ—ãƒ­ã‚¸ã‚§ã‚¯ãƒˆã®ã‚³ãƒ³ã‚½ãƒ¼ãƒ«ç”»é¢ã§ã€Œ+ ã‚¢ãƒ—ãƒªã‚’è¿½åŠ ã€ã‚’é¸æŠã—ã€å¿…è¦ãªé …ç›®ã‚’è¨˜å…¥ã—ã¾ã™ã€‚

![image1.png](/images/f729198dada20e/image1.png =300x)

ä¸€æ—¦ã“ã‚Œã§ã€Œã‚¢ãƒ—ãƒªã‚’ç™»éŒ²ã€ã— `google-services.json` ã‚’ãƒ€ã‚¦ãƒ³ãƒ­ãƒ¼ãƒ‰ã—ã¨ã„ã¦æœ€å¾Œã¾ã§é€²ã‚ã¾ã™ã€‚

æ¬¡ã«ã€ŒApp Distributionã€ã®ç”»é¢ã«è¡Œãã€Œé–‹å§‹ã€ã‚’ã‚¯ãƒªãƒƒã‚¯ã—ã¨ãã¾ã™ã€‚ã€Œãƒ†ã‚¹ã‚¿ãƒ¼ã¨ã‚°ãƒ«ãƒ¼ãƒ—ã€ã§ã€Œã‚°ãƒ«ãƒ¼ãƒ—ã‚’è¿½åŠ ã€ã‚’ã‚¯ãƒªãƒƒã‚¯ã—ã¾ã™ã€‚

![image2.png](/images/f729198dada20e/image2.png =500x)

ä»Šå›ã¯ã€ŒDeveloperã€ã¨ã„ã†åå‰ã§ã‚°ãƒ«ãƒ¼ãƒ—ã‚’ä½œæˆã—ã¾ã—ãŸã€‚

![image3.png](/images/f729198dada20e/image3.png =500x)

æœ€å¾Œã«ã€Œãƒ†ã‚¹ã‚¿ãƒ¼ã‚’è¿½åŠ ã€ã‹ã‚‰ãƒ¡ãƒ¼ãƒ«ã‚¢ãƒ‰ãƒ¬ã‚¹ã‚’å…¥åŠ›ã—ãƒ†ã‚¹ã‚¿ãƒ¼ã‚’ç™»éŒ²ã—ã¨ãã¾ã™ã€‚

## ã‚µãƒ¼ãƒ“ã‚¹ã‚¢ã‚«ã‚¦ãƒ³ãƒˆã®èªè¨¼ãƒ•ã‚¡ã‚¤ãƒ«ä½œæˆ

Firebaseãƒ—ãƒ­ã‚¸ã‚§ã‚¯ãƒˆã®èªè¨¼ã‚’è¡Œã†ç‚ºã«

[Google Cloudã®ã‚µãƒ¼ãƒ“ã‚¹ã‚¢ã‚«ã‚¦ãƒ³ãƒˆãƒšãƒ¼ã‚¸](https://console.cloud.google.com/projectselector2/iam-admin/serviceaccounts)ã‚’é–‹ãã€å¯¾è±¡ã®ãƒ—ãƒ­ã‚¸ã‚§ã‚¯ãƒˆã‚’é¸æŠã—ã¾ã™ã€‚æ¬¡ã«ã€Œã‚µãƒ¼ãƒ“ã‚¹ã‚¢ã‚«ã‚¦ãƒ³ãƒˆã®ä½œæˆã€ã‚’ã‚¯ãƒªãƒƒã‚¯ã—ã€Œã‚µãƒ¼ãƒ“ã‚¹ã‚¢ã‚«ã‚¦ãƒ³ãƒˆåã€ã¨ã€Œã‚µãƒ¼ãƒ“ã‚¹ã‚¢ã‚«ã‚¦ãƒ³ãƒˆIDã€ã‚’è¨˜å…¥ã—ã€Œä½œæˆã—ã¦ç¶šè¡Œã€ã‚’é¸æŠã—ã¾ã™ã€‚

![image4.png](/images/f729198dada20e/image4.png =300x)

æ¬¡ã®ãƒ­ãƒ¼ãƒ«ã§ã€ŒFirebase App Distribution Admin SDKã€ã‚’é¸æŠã—ã¾ã™ã€‚

![image5.png](/images/f729198dada20e/image5.png =500x)

æœ€å¾Œã«ã€Œå®Œäº†ã€ã‚’ã‚¯ãƒªãƒƒã‚¯ã—ã‚µãƒ¼ãƒ“ã‚¹ã‚¢ã‚«ã‚¦ãƒ³ãƒˆã‚’ç™»éŒ²ã—ã¾ã™ã€‚

ä½œæˆã•ã‚ŒãŸã‚µãƒ¼ãƒ“ã‚¹ã‚¢ã‚«ã‚¦ãƒ³ãƒˆã®ãƒ¡ãƒ‹ãƒ¥ãƒ¼ã‹ã‚‰ã€Œéµã‚’ç®¡ç†ã€ã‚’é¸æŠã—ã¾ã™ã€‚

![image6.png](/images/f729198dada20e/image6.png =300x)

ã€Œã‚­ãƒ¼ã‚’è¿½åŠ ã€>ã€Œæ–°ã—ã„éµã‚’ä½œæˆã€ã‚’é¸æŠ

![image7.png](/images/f729198dada20e/image7.png =300x)

ã‚­ãƒ¼ã®ã‚¿ã‚¤ãƒ—ãŒã€ŒJSONã€ã«ãªã£ã¦ã„ã‚‹ã“ã¨ã‚’ç¢ºèªã—ã€ã€Œç”Ÿæˆã€ã‚’ã‚¯ãƒªãƒƒã‚¯ã—ã¦jsonãƒ•ã‚¡ã‚¤ãƒ«ã‚’ãƒ€ã‚¦ãƒ³ãƒ­ãƒ¼ãƒ‰ã—ã¦ä¿å­˜ã—ã¨ãã¾ã™ã€‚

![image8.png](/images/f729198dada20e/image8.png =500x)

## é…å¸ƒç”¨ã®ã‚­ãƒ¼ã‚¹ãƒˆã‚¢ç”Ÿæˆ

é…å¸ƒç”¨ã®ã‚­ãƒ¼ã‚¹ãƒˆã‚¢ã‚’ç”Ÿæˆã—ã¾ã™ã€‚XXXXX ã«ãªã£ã¦ã„ã‚‹ç®‡æ‰€ã¯é©å®œå¤‰æ›ã—ã¦ä¸‹ã•ã„ã€‚

```bash
$JAVA_HOME/bin/keytool -J-Dkeystore.pkcs12.legacy -genkey -v -keystore dev.keystore -keyalg RSA -storepass XXXXX -alias XXXXX -validity 9125 -dname "CN=Developer, O=XXXX, C=Japan"
```

## Github Repository secret ã®ç™»éŒ²

ä»¥ä¸‹ã®secretã‚’ç™»éŒ²ã—ã¦ãŠãã¾ã™ã€‚

| SECRETå | å€¤ |
| --- | --- |
| ANDROID_KEYSTORE_FILE | å…ˆã»ã©ä½œæˆã—ãŸã‚­ãƒ¼ã‚¹ãƒˆã‚¢ã‚’base64ã«ã—ã¦ã‚‚ã® `cat dev.keystore \| base64 \| pbcopy` |
| ANDROID_KEYSTORE_PASSWORD | ã‚­ãƒ¼ã‚¹ãƒˆã‚¢ç”Ÿæˆæ™‚ã«è¨­å®šã—ãŸãƒ‘ã‚¹ãƒ¯ãƒ¼ãƒ‰ |
| KEYSTORE_KEY_ALIAS | ã‚­ãƒ¼ã‚¹ãƒˆã‚¢ç”Ÿæˆæ™‚ã«è¨­å®šã—ãŸã‚¨ã‚¤ãƒªã‚¢ã‚¹ |
| ANDROID_KEY_PASSWORD | ã‚­ãƒ¼ã‚¹ãƒˆã‚¢ç”Ÿæˆæ™‚ã«è¨­å®šã—ãŸãƒ‘ã‚¹ãƒ¯ãƒ¼ãƒ‰ |
| FIREBASE_APP_ID | Firebaseã‚³ãƒ³ã‚½ãƒ¼ãƒ«ã§ç¢ºèªã§ãã‚‹ã‚‚ã® ãƒ—ãƒ­ã‚¸ã‚§ã‚¯ãƒˆã®è¨­å®š â†’ å…¨èˆ¬ â†’ Android ã‚¢ãƒ—ãƒª â†’ ã‚¢ãƒ—ãƒª ID |
| FIREBASE_SERVICE_CREDENTIALS_JSON | ã‚µãƒ¼ãƒ“ã‚¹ã‚¢ã‚«ã‚¦ãƒ³ãƒˆã®èªè¨¼ãƒ•ã‚¡ã‚¤ãƒ«ã‚’ã‚³ãƒ”ãƒšã—ãŸã‚‚ã® |

## Github Actions

æœ€çµ‚çš„ãªãƒ™ãƒ¼ã‚¿é…å¸ƒç”¨ã®Github Actionsã®è¨­å®šãƒ•ã‚¡ã‚¤ãƒ«ã‚’ `.github/workflows/deploy.yml` ã¨ã—ã¦ä»¥ä¸‹ã®å†…å®¹ã§ä½œæˆã—ã¾ã—ãŸã€‚

```yaml
name: Firebase App Distribution

on:
  workflow_dispatch:
  push:
    branches:
      - "develop"

jobs:
  distribute:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v3
      # package.jsonã®voltaé …ç›®ã‹ã‚‰èª­ã¿å–ã£ã¦å„ãƒãƒ¼ã‚¸ãƒ§ãƒ³ã‚’è¨­å®š
      - uses: volta-cli/action@v4
        with:
          package-json-path: "package.json"
      - name: Cache Yarn
        uses: actions/cache@v4
        with:
          path: ~/.yarn/cache
          key: yarn-${{ hashFiles('yarn.lock') }}-${{ runner.os }}
          restore-keys: yarn-${{ hashFiles('yarn.lock') }}-
      - name: Install dependencies
        run: yarn install --frozen-lockfile --network-timeout 300000
      # Android SDK & ã‚­ãƒ£ãƒƒã‚·ãƒ¥
      - uses: android-actions/setup-android@v3
        with: { cache: true }
      # JDK + Gradle ï¼ˆBuild/Configuration Cache æœ‰åŠ¹ï¼‰
      - uses: gradle/actions/setup-gradle@v3
      # ä½œæˆã—ã¦ãŠã„ãŸkeystoreã‚’å¾©å…ƒ
      - name: Write dev.keystore
        env:
          ANDROID_KEYSTORE_FILE: ${{ secrets.ANDROID_KEYSTORE_FILE }}
        run: |
          echo "$ANDROID_KEYSTORE_FILE" | base64 --decode > android/app/dev.keystore
      - name: Bump gradle version code
        uses: chkfung/android-version-actions@v1.2.1
        with:
          gradlePath: android/app/build.gradle
          versionCode: ${{github.run_number}}
      # key aliasã¯ä½œæˆæ™‚ã«è¨­å®šã—ãŸå†…å®¹ã«ç½®ãæ›ãˆã‚‹
      - name: Build with Gradle
        env:
          CI: true
          KEYSTORE_PATH: dev.keystore
          KEYSTORE_PASSWORD: ${{ secrets.ANDROID_KEYSTORE_PASSWORD }}
          KEYSTORE_KEY_ALIAS: xxxxxx
          KEYSTORE_KEY_PASSWORD: ${{ secrets.ANDROID_KEYSTORE_PASSWORD }}
        run: cd android && ./gradlew assembleDevRelease
      - name: Upload a Build Artifact
        id: upload_artifact
        uses: actions/upload-artifact@v4
        with:
          name: app-dev-release
          path: android/app/build/outputs/apk/dev/release/app-dev-release.apk
      - name: Deploy to Firebase App Distribution
        uses: wzieba/Firebase-Distribution-Github-Action@v1
        with:
          appId: ${{ secrets.FIREBASE_APP_ID }}
          serviceCredentialsFileContent: ${{ secrets.FIREBASE_SERVICE_CREDENTIALS_JSON }}
          groups: Developer
          file: android/app/build/outputs/apk/dev/release/app-dev-release.apk
```

- ä»Šå›ã¯ [Volta](https://volta.sh/) ã‚’ä½¿ã£ã¦ãƒãƒ¼ã‚¸ãƒ§ãƒ³ç®¡ç†ã—ã¦ã„ãŸã®ã§ä»¥ä¸‹ã®Github Actionsã‚’ä½¿ç”¨ã—ã¦ã¾ã™

https://github.com/volta-cli/action

ã“ã‚Œã§ Androidã ã‘ã§ã¯ã‚ã‚Šã¾ã™ãŒ Firebase App Distribution ã¸ãƒ™ãƒ¼ã‚¿é…å¸ƒã§ãã‚‹æ§˜ã«ãªã‚‹ã‹ã¨æ€ã„ã¾ã™ã€‚

# å‚è€ƒURL

https://zenn.dev/cureapp/articles/firebase-app-distribution

https://tudotechnologies.medium.com/setting-up-ci-cd-for-react-native-with-github-actions-and-firebase-app-distribution-86aa416e4beb

https://zenn.dev/steelydylan/articles/expo-app-distribution