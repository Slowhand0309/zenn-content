---
title: "TypeScriptè£½SQLãƒ“ãƒ«ãƒ€ãƒ¼ Kysely ã§ HonoÃ—PostgreSQL æ§‹æˆã® CRUD APIã‚’æ§‹ç¯‰"
emoji: "ğŸ› ï¸"
type: "tech" # tech: æŠ€è¡“è¨˜äº‹ / idea: ã‚¢ã‚¤ãƒ‡ã‚¢
topics:
  - "kysely"
  - "postgresql"
  - "hono"
  - "typescript"
  - "sqlbuilder"
published: true
---

# æ¦‚è¦

ã¨ã‚ã‚‹ãƒªãƒã‚¸ãƒˆãƒªã§SQL ã‚¯ã‚¨ãƒª ãƒ“ãƒ«ãƒ€ãƒ¼ã®Kyselyã‚’çŸ¥ã£ãŸã®ã§ã€ä»Šå›ã¯è‰²ã€…è©¦ã—ã¦ã¿ãŸã„ã¨æ€ã„ã¾ã™ã€‚

https://kysely.dev/

Kyselyã¨ã¯?

> [Knex](https://github.com/knex/knex)ã«è§¦ç™ºã•ã‚Œã¦é–‹ç™ºã•ã‚ŒãŸTypeScriptå‘ã‘ã®å‹å®‰å…¨ãªSQLã‚¯ã‚¨ãƒªãƒ“ãƒ«ãƒ€ãƒ¼ã§ã™ã€‚

Knexã¨ã®é•ã„ã¯?

> Knexã¯JavaScriptã§æ›¸ã‹ã‚Œã¦ãŠã‚Šã€TypeScriptã®ã‚µãƒãƒ¼ãƒˆã¯é™å®šçš„ã§ã™ã€‚ãã®ãŸã‚ã€è¤‡é›‘ãªã‚¯ã‚¨ãƒªã§ã¯å‹æ¨è«–ãŒé›£ã—ãã€å‹å®‰å…¨æ€§ãŒä¿è¨¼ã•ã‚Œãªã„å ´åˆãŒã‚ã‚Šã¾ã™ã€‚ä¸€æ–¹ã€Kyselyã¯TypeScriptã‚’ç¬¬ä¸€ç´šã§ã‚µãƒãƒ¼ãƒˆã—ã€ãƒ‡ãƒ¼ã‚¿ãƒ™ãƒ¼ã‚¹ã‚¹ã‚­ãƒ¼ãƒã®å‹æƒ…å ±ã‚’æ´»ç”¨ã—ã¦ã€ã‚³ãƒ³ãƒ‘ã‚¤ãƒ«æ™‚ã«ã‚¨ãƒ©ãƒ¼ã‚’æ¤œå‡ºã§ãã¾ã™ã€‚ã“ã‚Œã«ã‚ˆã‚Šã€é–‹ç™ºè€…ã¯ã‚ªãƒ¼ãƒˆã‚³ãƒ³ãƒ—ãƒªãƒ¼ãƒˆã‚„å‹ãƒã‚§ãƒƒã‚¯ã®æ©æµã‚’å—ã‘ãªãŒã‚‰ã€ã‚ˆã‚Šå®‰å…¨ã«ã‚¯ã‚¨ãƒªã‚’æ§‹ç¯‰ã§ãã¾ã™ã€‚

Typescriptã®æ©æµã‚’å—ã‘ã‚Œã¦å®Ÿè£…ã§ãã‚‹ã‚“ã§ã™ã­ âœ¨

# å‹•ä½œç’°å¢ƒæ§‹ç¯‰

æ—©é€Ÿ Kysely ã‚’è©¦ã—ã¦ã„ãç’°å¢ƒã‚’æ§‹ç¯‰ã—ã¦ã„ããŸã„ã¨æ€ã„ã¾ã™ã€‚æ§‹æˆã¨ã—ã¦ã¯ [Hono](https://hono.dev/) ã‚’ä½¿ã£ã¦ PostgreSQL ã¨ã‚„ã‚Šã¨ã‚Šã™ã‚‹APIã‚µãƒ¼ãƒãƒ¼ã‚’å®Ÿè£…ã—ã€ãã®ä¸­ã§ Kysely ã‚’ä½¿ã†ã‚ˆã†ãªå½¢ã§é€²ã‚ã¦ã„ããŸã„ã¨æ€ã„ã¾ã™ã€‚

æ—©é€ŸğŸ‘‡ã®ç’°å¢ƒã‚’ãƒ™ãƒ¼ã‚¹ã«æ§‹ç¯‰ã—ã¦ã„ãã¾ã™ã€‚

https://github.com/Slowhand0309/nodejs-devcontainer-boilerplate

`.devcontainer/compose.yaml` ã‚’ä»¥ä¸‹ã«ä¿®æ­£ã—ã¾ã™ã€‚

```yaml
volumes:
  modules_data:
  postgres_data:

name: kysely_example
services:
  app:
    build: .
    volumes:
      - ..:/usr/src
      - modules_data:/usr/src/node_modules
    command: /bin/sh -c "while sleep 1000; do :; done"
    working_dir: /usr/src
    depends_on:
      - db
  db:
    image: postgres:17.4
    environment:
      - POSTGRES_USER=postgres
      - POSTGRES_PASSWORD=postgres
      - POSTGRES_DB=postgres
    ports:
      - "5432:5432"
    volumes:
      - postgres_data:/var/lib/postgresql/data
```

VSCodeã§ã€ŒReopen in Containerã€ã§ã‚³ãƒ³ãƒ†ãƒŠã‚’èµ·å‹•ã—ã¦ä¸­ã«å…¥ã‚Š `Hono` ã®ç’°å¢ƒã‚’è¿½åŠ ã—ã¦ã„ãã¾ã™ã€‚

```bash
$ yarn create hono .
âœ” Using target directory â€¦ .
âœ” Which template do you want to use? nodejs
âœ” Directory not empty. Continue? Yes
âœ” Do you want to install project dependencies? Yes
âœ” Which package manager do you want to use? yarn
âœ” Cloning the template
âœ” Installing project dependencies
ğŸ‰ Copied project files
```

`.devcontainer/postAttach.sh` ã« `yarn install` ã¨ `yarn dev` ã‚’è¿½åŠ ã—Devcontainerã‚’èµ·å‹•ã—ãŸã‚‰ Hono ã® node-server ãŒèµ·å‹•ã™ã‚‹ã‚ˆã†ã«ã—ã¦ãŠãã¾ã™ã€‚

```bash
yarn install
yarn dev
```

æœ€å¾Œã« `.devcontainer/compose.yaml` ã«ä»¥ä¸‹portã‚’è¿½åŠ ã—ã¨ãã¾ã™ã€‚

```bash
    ports:
      - "3000:3000"
```

ã“ã‚Œã§å†åº¦èµ·å‹•ã—ç›´ã—ã¦ [http://localhost:3000/](http://localhost:3000/) ã«ã‚¢ã‚¯ã‚»ã‚¹ã—ã¦ `Hello Hono!` ãŒè¡¨ç¤ºã•ã‚Œã¦ã„ã‚Œã°OKã§ã™ã€‚

# ãƒ†ã‚¹ãƒˆãƒ†ãƒ¼ãƒ–ãƒ«ä½œæˆ

ã¾ãšã¯å¿…è¦ãªãƒ‘ãƒƒã‚±ãƒ¼ã‚¸ã‚’å°å…¥ã—ã¾ã™ã€‚ä»Šå›ã¯å…¬å¼ãŒå‡ºã—ã¦ã„ã‚‹kyselyã®cliãƒ„ãƒ¼ãƒ«ã§ã‚ã‚‹ [kysely-ctl](https://github.com/kysely-org/kysely-ctl) ã‚’ä½¿ã£ã¦ãƒ†ãƒ¼ãƒ–ãƒ«ä½œæˆã—ã¦ã„ã“ã†ã¨æ€ã†ã®ã§ä¸€ç·’ã«ã‚¤ãƒ³ã‚¹ãƒˆãƒ¼ãƒ«ã—ã¾ã™ã€‚

```bash
$ yarn add kysely pg
$ yarn add -D kysely-ctl
$ yarn kysely -h
A command-line tool for Kysely (kysely)                                                                     1:50:05 AM

USAGE kysely [OPTIONS] init|migrate:down|migrate:latest|migrate:list|migrate:make|migrate:rollback|seed:run|seed:make|migrate:up|migrate|seed

OPTIONS

                                                      --cwd    The current working directory to use for relative paths.                                                                                           
                                                    --debug    Show debug information.                                                                                                                            
  -e, --environment=<production | development | test | ...>    Apply environment-specific overrides to the configuration. See https://github.com/unjs/c12#environment-specific-configuration for more information.
                      --experimental-resolve-tsconfig-paths    Attempts to resolve path aliases using the tsconfig.json file.                                                                                     
                                    --no-filesystem-caching    Will not write cache files to disk. See https://github.com/unjs/jiti#fscache for more information.                                                 
                                        --no-outdated-check    Will not check for latest kysely/kysely-ctl versions and notice newer versions exist.                                                              
                                              -v, --version    Show version number                                                                                                                                

COMMANDS

              init    Create a sample kysely.config file                                             
      migrate:down    Undo the last/specified migration that was run                                   
    migrate:latest    Update the database schema to the latest version                                 
      migrate:list    List both completed and pending migrations                                       
      migrate:make    Create a new migration file                                                      
  migrate:rollback    Rollback all the completed migrations                                            
          seed:run    Run seed files                                                                   
         seed:make    Create a new seed file                                                           
        migrate:up    Run the next migration that has not yet been run                                 
           migrate    Migrate the database schema                                                      
              seed    Populate your database with test or seed data independent of your migration files

Use kysely <command> --help for more information about a command.
```

æ—©é€Ÿä½œæ¥­ã—ã¦ã„ããŸã„ã¨æ€ã„ã¾ã™ã€‚

```bash
$ yarn kysely init
```

ğŸ‘†ã‚’å®Ÿè¡Œã™ã‚‹ã¨ `.config/kysely.config.ts` ã«ä»¥ä¸‹ã®ã‚ˆã†ãªãƒ•ã‚¡ã‚¤ãƒ«ãŒä½œæˆã•ã‚Œã¾ã™ã€‚

```tsx
import {
  DummyDriver,
  PostgresAdapter,
  PostgresIntrospector,
  PostgresQueryCompiler,
} from 'kysely'
import { defineConfig } from 'kysely-ctl'

export default defineConfig({
  // replace me with a real dialect instance OR a dialect name + `dialectConfig` prop.
  dialect: {
    createAdapter() {
      return new PostgresAdapter()
    },
    createDriver() {
      return new DummyDriver()
    },
    createIntrospector(db) {
      return new PostgresIntrospector(db)
    },
    createQueryCompiler() {
      return new PostgresQueryCompiler()
    },
  },
  //   migrations: {
  //     migrationFolder: "migrations",
  //   },
  //   plugins: [],
  //   seeds: {
  //     seedFolder: "seeds",
  //   }
})
```

ã“ã‚Œã‚’ç¾åœ¨ã®ç’°å¢ƒã«åˆã‚ã›ã¦ä¿®æ­£ã—ã¾ã™ã€‚ã¾ãŸ `migrationFolder` ã‚‚æŒ‡å®šã—ã¦ã„ã¾ã™ã€‚

```tsx
import { PostgresDialect } from 'kysely';
import { defineConfig } from 'kysely-ctl';
import { Pool } from 'pg';

export default defineConfig({
  dialect: new PostgresDialect({
    pool: new Pool({
      database: 'postgres',
      host: 'db',
      user: 'postgres',
      password: 'postgres',
      port: 5432,
    }),
  }),
  migrations: {
    migrationFolder: 'migrations',
  },
  //   plugins: [],
  //   seeds: {
  //     seedFolder: "seeds",
  //   }
});
```

æ—©é€Ÿ `users` ãƒ†ãƒ¼ãƒ–ãƒ«ã‚’ä½œæˆã—ã¦ã¿ã¾ã™ã€‚ä»¥ä¸‹ã‚³ãƒãƒ³ãƒ‰ã§migrateãƒ•ã‚¡ã‚¤ãƒ«ã‚’ä½œæˆã—ã¾ã™ã€‚

```bash
$ yarn kysely migrate:make add_users_table
```

ä½œæˆã•ã‚ŒãŸãƒ•ã‚¡ã‚¤ãƒ«ã‚’ä»¥ä¸‹ã®æ§˜ã«ä¿®æ­£ã—ã¾ã™ã€‚

```tsx
import { sql, type Kysely } from 'kysely';

export async function up(db: Kysely<any>): Promise<void> {
  await db.schema
    .createTable('users')
    .addColumn('id', 'serial', (col) => col.primaryKey())
    .addColumn('first_name', 'varchar', (col) => col.notNull())
    .addColumn('last_name', 'varchar')
    .addColumn('created_at', 'timestamp', (col) =>
      col.defaultTo(sql`now()`).notNull()
    )
    .addColumn('updated_at', 'timestamp', (col) =>
      col.defaultTo(sql`now()`).notNull()
    )
    .execute();
}

export async function down(db: Kysely<any>): Promise<void> {
  await db.schema.dropTable('users').execute();
}
```

ã“ã‚Œã§æº–å‚™ãŒæ•´ã£ãŸã®ã§ã€ä»¥ä¸‹ã‚’å®Ÿæ–½ã—ã¦ãƒ†ãƒ¼ãƒ–ãƒ«ã‚’ä½œæˆã—ã¾ã™ã€‚

```bash
$ yarn kysely migrate latest
```

ä½œæˆã•ã‚Œã‚‹ã¨ãƒ†ãƒ¼ãƒ–ãƒ«ãŒä½œæˆã•ã‚Œã¦ã„ã‚‹ã‹ã¨æ€ã„ã¾ã™ã€‚

![image1.png](/images/6598214b1a738a/image1.png)

æœ€å¾Œã«ä½œæˆã—ãŸãƒ†ãƒ¼ãƒ–ãƒ«ã®å‹ã‚’å®šç¾©ã—ã¨ããŸã„ã¨æ€ã„ã¾ã™ã€‚ `src/types.ts` ã«ä»¥ä¸‹ã‚’è¿½åŠ ã—ã¾ã™ã€‚

```tsx
export type User = {
  id?: number;
  first_name: string;
  last_name: string;
  created_at?: Date;
  updated_at?: Date;
};
```

# ã‚·ãƒ¼ãƒ‰ãƒ‡ãƒ¼ã‚¿ç™»éŒ²

æ¬¡ã«ã‚·ãƒ¼ãƒ‰ãƒ‡ãƒ¼ã‚¿ã‚’ [kysely-ctl](https://github.com/kysely-org/kysely-ctl) ã‚’ä½¿ã£ã¦ç™»éŒ²ã—ã¦ã„ã“ã†ã¨æ€ã„ã¾ã™ã€‚ `.config/kysely.config.ts` ã«ã‚·ãƒ¼ãƒ‰ç”¨ã®ãƒ‡ã‚£ãƒ¬ã‚¯ãƒˆãƒªã‚’æŒ‡å®šã—ã¾ã™ã€‚

```tsx
export default defineConfig({
  // ...
  // ä»¥ä¸‹ã‚’ã‚³ãƒ¡ãƒ³ãƒˆã‚¢ã‚¦ãƒˆ
  seeds: {
    seedFolder: 'seeds',
  },
});
```

ç™»éŒ²ã•ã‚Œã‚‹ãƒ‡ãƒ¼ã‚¿ã¯å…ˆç¨‹ä½œæˆã—ãŸ `users` ãƒ†ãƒ¼ãƒ–ãƒ«ã«ç™»éŒ²ã™ã‚‹ãƒ‡ãƒ¼ã‚¿ã‚’ä½œæˆã—ãŸã„ã¨æ€ã„ã¾ã™ã€‚

```bash
$ yarn kysely seed:make users_seed
```

ä½œæˆã•ã‚ŒãŸãƒ•ã‚¡ã‚¤ãƒ«ã‚’ä»¥ä¸‹ã®æ§˜ã«ä¿®æ­£ã—ã¾ã™ã€‚

```tsx
export async function seed(db: Kysely<any>): Promise<void> {
  // id ã¯è‡ªå‹•æ¡ç•ª
  const users: User[] = [
    {
      first_name: 'Taro',
      last_name: 'Yamada',
    },
    {
      first_name: 'Hanako',
      last_name: 'Suzuki',
    },
  ];

  await db.insertInto('users').values(users).execute();
}
```

ä»¥ä¸‹ã‚³ãƒãƒ³ãƒ‰ã‚’å®Ÿæ–½ã—ãƒ‡ãƒ¼ã‚¿ç™»éŒ²ã—ã¦ã„ãã¾ã™ã€‚

```bash
$ yarn kysely seed:run
```

æˆåŠŸã™ã‚‹ã¨ãƒ‡ãƒ¼ã‚¿ç™»éŒ²ã§ãã¦ã„ã‚‹ã‹ã¨æ€ã„ã¾ã™ã€‚

![image2.png](/images/6598214b1a738a/image2.png)

# APIå®Ÿè£…

## Query

æœ€å¾Œã«ãƒ¦ãƒ¼ã‚¶ãƒ¼ä¸€è¦§ã‚„ã€idã‚’æŒ‡å®šã—ã¦ãƒ¦ãƒ¼ã‚¶ãƒ¼æƒ…å ±ã‚’å–å¾—ã™ã‚‹APIã‚’å®Ÿè£…ã—ã¦ã¿ãŸã„ã¨æ€ã„ã¾ã™ã€‚

ã¾ãšã¯ `src/types.ts` ã« `Database` ã‚’è¿½åŠ ã—ã¾ã™ã€‚

```tsx
export type Database = {
  users: User;
};
```

æœ€å¾Œã« `src/index.ts` ã‚’ä»¥ä¸‹ã®æ§˜ã«ä¿®æ­£ã—ã¾ã™ã€‚

```tsx
import pg from 'pg';
// ...

const dialect = new PostgresDialect({
  pool: new pg.Pool({
    database: 'postgres',
    host: 'db',
    user: 'postgres',
    password: 'postgres',
    port: 5432,
  }),
});

export const db = new Kysely<Database>({
  dialect,
});

const app = new Hono();

// ...

app.get('/users', async (c) => {
  const users = await db.selectFrom('users').selectAll().execute();
  return c.json(users);
});

app.get('/users/:id', async (c) => {
  const id = c.req.param('id');
  const user = await db
    .selectFrom('users')
    .selectAll()
    .where('id', '=', Number(id))
    .executeTakeFirst();
  if (!user) {
    return c.notFound();
  }
  return c.json(user);
});
```

ã“ã®æ™‚ã€Typescriptã®å‹è£œå®ŒãŒåŠ¹ã„ã¦ã„ã‚‹ã®ãŒåˆ†ã‹ã‚‹ã‹ã¨æ€ã„ã¾ã™ã€‚

![image3.gif](/images/6598214b1a738a/image3.gif =500x)

æœ€å¾Œã«å®Ÿéš›ã«ãƒªã‚¯ã‚¨ã‚¹ãƒˆã™ã‚‹ã¨ğŸ‘‡ã®æ§˜ã«ç™»éŒ²ãƒ‡ãƒ¼ã‚¿ãŒè¿”ã£ã¦ãã¦ã„ã‚‹ã®ãŒåˆ†ã‹ã‚‹ã‹ã¨æ€ã„ã¾ã™ã€‚

![image4.gif](/images/6598214b1a738a/image4.gif =500x)

## Insert

æ¬¡ã¯ãƒ¦ãƒ¼ã‚¶ãƒ¼ã‚’ç™»éŒ²ã™ã‚‹APIã‚’å®Ÿè£…ã—ã¦ã¿ãŸã„ã¨æ€ã„ã¾ã™ã€‚

 `src/index.ts` ã«ä»¥ä¸‹ `post` ã‚’è¿½åŠ ã—ã¾ã™ã€‚

```tsx
app.post('/users', async (c) => {
  const { first_name, last_name } = await c.req.json();
  const user = await db
    .insertInto('users')
    .values({ first_name, last_name })
    .returningAll()
    .executeTakeFirst();
  return c.json(user, 201);
});
```

- `returningAll` ã«é–¢ã—ã¦
  - returningç³»ã¯ä»¥ä¸‹ã®2ç¨®é¡å­˜åœ¨ã—ã¾ã™
    - [**returning**](https://kysely-org.github.io/kysely-apidoc/interfaces/ReturningInterface.html#returning)
      - å¤‰æ›´ã•ã‚ŒãŸè¡Œã‹ã‚‰ãƒ‡ãƒ¼ã‚¿ã‚’è¿”ã›ã‚‹ã‚ˆã†ã«ã—ã¾ã™
    - [**returningAll**](https://kysely-org.github.io/kysely-apidoc/interfaces/ReturningInterface.html#returningAll)
      - PostgreSQLã®ã‚ˆã†ãªreturningã‚’ã‚µãƒãƒ¼ãƒˆã™ã‚‹ãƒ‡ãƒ¼ã‚¿ãƒ™ãƒ¼ã‚¹ä¸Šã§ã€insert/update/deleteã‚¯ã‚¨ãƒªã«returning *ã‚’è¿½åŠ ã—ã¾ã™
- `executeTakeFirst` ã«é–¢ã—ã¦
  - executeç³»ã¯ä»¥ä¸‹ã®3ç¨®é¡å­˜åœ¨ã—ã¾ã™
    - [**execute**](https://kysely-org.github.io/kysely-apidoc/interfaces/SelectQueryBuilder.html#execute)
      - ã‚¯ã‚¨ãƒªã‚’å®Ÿè¡Œã—ã€è¡Œã®é…åˆ—ã‚’è¿”ã—ã¾ã™
    - [**executeTakeFirst**](https://kysely-org.github.io/kysely-apidoc/interfaces/SelectQueryBuilder.html#executeTakeFirst)
      - ã‚¯ã‚¨ãƒªã‚’å®Ÿè¡Œã—ã€æœ€åˆã®çµæœã‚’è¿”ã™ã‹ã€ã‚¯ã‚¨ãƒªãŒçµæœã‚’è¿”ã•ãªã‹ã£ãŸå ´åˆã¯ undefined ã‚’è¿”ã—ã¾ã™
    - [**executeTakeFirstOrThrow**](https://kysely-org.github.io/kysely-apidoc/interfaces/SelectQueryBuilder.html#executeTakeFirstOrThrow)
      - ã‚¯ã‚¨ãƒªã‚’å®Ÿè¡Œã—ã¦æœ€åˆã®çµæœã‚’è¿”ã™ã‹ã€ã‚¯ã‚¨ãƒªãŒçµæœã‚’è¿”ã•ãªã‹ã£ãŸå ´åˆã«ã‚¹ãƒ­ãƒ¼ã—ã¾ã™ (ãƒ‡ãƒ•ã‚©ãƒ«ãƒˆã§ã¯ NoResultError ã®ã‚¤ãƒ³ã‚¹ã‚¿ãƒ³ã‚¹ãŒã‚¹ãƒ­ãƒ¼ã•ã‚Œã¾ã™ãŒã€ç‹¬è‡ªã®ã‚¨ãƒ©ãƒ¼ã‚¯ãƒ©ã‚¹ã‚„ã‚³ãƒ¼ãƒ«ãƒãƒƒã‚¯ã‚’ç”¨æ„ã—ã¦åˆ¥ã®ã‚¨ãƒ©ãƒ¼ã‚’ã‚¹ãƒ­ãƒ¼ã™ã‚‹ã“ã¨ã‚‚ã§ãã¾ã™)

æ—©é€Ÿé©å½“ãªãƒ‡ãƒ¼ã‚¿ã‚’ç™»éŒ²ã—ã¦ã¿ãŸã„ã¨æ€ã„ã¾ã™

```bash
$ curl -H "Content-Type: application/json" \
-X POST \
-d "{\"first_name\": \"Ichiro\", \"last_name\": \"Tanaka\"}" \
http://localhost:3000/users
```

ã†ã¾ãã„ãã¨ğŸ‘‡ã®æ§˜ã«1ä»¶ãƒ‡ãƒ¼ã‚¿ãŒç™»éŒ²ã•ã‚Œã¦ã„ã‚‹ã‹ã¨æ€ã„ã¾ã™ã€‚

![image5.png](/images/6598214b1a738a/image5.png)

## Update

æ¬¡ã«ãƒ¦ãƒ¼ã‚¶ãƒ¼æƒ…å ±ã‚’æ›´æ–°ã™ã‚‹APIã‚’å®Ÿè£…ã—ã¦ã¿ãŸã„ã¨æ€ã„ã¾ã™ã€‚

 `src/index.ts` ã«ä»¥ä¸‹ `put` ã‚’è¿½åŠ ã—ã¾ã™ã€‚

```tsx
app.put('/users/:id', async (c) => {
  const id = c.req.param('id');
  const { first_name, last_name } = await c.req.json();
  const user = await db
    .updateTable('users')
    .set({ first_name, last_name, updated_at: new Date() })
    .where('id', '=', Number(id))
    .returningAll()
    .executeTakeFirst();
  if (!user) {
    return c.notFound();
  }
  return c.json(user);
});
```

`id = 2` ã®ãƒ¦ãƒ¼ã‚¶ãƒ¼ã®åå‰ã‚’å¤‰æ›´ã—ã¦ã¿ãŸã„ã¨æ€ã„ã¾ã™ã€‚

```bash
$ curl -H "Content-Type: application/json" \
-X PUT \
-d "{\"first_name\": \"Kenta\", \"last_name\": \"Fujimoto\"}" \
http://localhost:3000/users/2
```

ãƒ¦ãƒ¼ã‚¶ãƒ¼åã¨ `updated_at` ãŒæ›´æ–°ã•ã‚Œã¦ã„ã‚‹ã‹ã¨æ€ã„ã¾ã™ ğŸ‘‡

![image6.png](/images/6598214b1a738a/image6.png)

## Delete

æœ€å¾Œã«ãƒ¦ãƒ¼ã‚¶ãƒ¼å‰Šé™¤ã®APIã‚’å®Ÿè£…ã—ã¾ã™ã€‚

 `src/index.ts` ã«ä»¥ä¸‹ `delete` ã‚’è¿½åŠ ã—ã¾ã™ã€‚

```tsx
app.delete('/users/:id', async (c) => {
  const id = c.req.param('id');
  const user = await db
    .deleteFrom('users')
    .where('id', '=', Number(id))
    .returningAll()
    .executeTakeFirst();
  if (!user) {
    return c.notFound();
  }
  return c.json(user);
});
```

`id = 3` ã®ãƒ¦ãƒ¼ã‚¶ãƒ¼ã‚’å‰Šé™¤ã—ã¦ã¿ãŸã„ã¨æ€ã„ã¾ã™ã€‚

```bash
$ curl -H "Content-Type: application/json" \
-X DELETE \
http://localhost:3000/users/3
```

ãƒ¦ãƒ¼ã‚¶ãƒ¼ãŒå‰Šé™¤ã•ã‚Œã¦ã„ã‚‹ã‹ã¨æ€ã„ã¾ã™ğŸ‘‡

![image7.png](/images/6598214b1a738a/image7.png)

# ã¾ã¨ã‚

åŸºæœ¬çš„ãªç®‡æ‰€ã‚’ã–ã£ã¨è©¦ã—ã¦ã¿ã¾ã—ãŸãŒã€ã™ã”ã„å­¦ç¿’ã‚³ã‚¹ãƒˆãŒã‹ã‹ã‚‹è¨³ã§ã‚‚ãªãã€ã‚¹ãƒ ãƒ¼ã‚ºã«ä½¿ãˆã¦Typescriptã§ã®å®Ÿè£…ã‚‚å…¬å¼ã®ãƒ‰ã‚­ãƒ¥ãƒ¡ãƒ³ãƒˆã«ã‚ã‚‹é€šã‚Šã€å‹è£œå®Œã®æ©æµã‚’å—ã‘ãªãŒã‚‰å®Ÿè£…ãŒè¡Œãˆã‚‹ã®ã§å€‹äººçš„ã«ã¯è‰¯ã‹ã£ãŸã§ã™! æ¬¡ã¯å¿œç”¨çš„ãªä½¿ã„æ–¹ã‚’è©¦ã›ã‚Œã°ã¨æ€ã„ã¾ã™ã€‚

# å‚è€ƒURL

https://zenn.dev/randd_inc/articles/b8e009b74863ab