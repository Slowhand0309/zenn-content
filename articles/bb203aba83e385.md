---
title: "tldraw Ã— AIã‚¨ãƒ¼ã‚¸ã‚§ãƒ³ãƒˆï¼šAgent starter kitã‚’è§¦ã‚ŠãªãŒã‚‰ä»•çµ„ã¿ã‚’è¿½ã†"
emoji: "ğŸ¨"
type: "tech" # tech: æŠ€è¡“è¨˜äº‹ / idea: ã‚¢ã‚¤ãƒ‡ã‚¢
topics:
  - "tldraw"
  - "ai"
  - "aiã‚¨ãƒ¼ã‚¸ã‚§ãƒ³ãƒˆ"
  - "anthropic"
  - "cloudflare"
published: false
---
# æ¦‚è¦

æ‰‹æ›¸ãã®UIã‚¹ã‚±ãƒƒãƒã‹ã‚‰å‹•ãWebã‚µã‚¤ãƒˆã‚’ç”Ÿæˆã™ã‚‹ã€ŒMake Realã€ãŒè©±é¡Œã«ãªã£ãŸã‚­ãƒ£ãƒ³ãƒã‚¹ãƒ„ãƒ¼ãƒ«ã®tldrawã«ã€ã‚­ãƒ£ãƒ³ãƒã‚¹ä¸Šã®å›³å½¢ã‚’èª­ã‚“ã ã‚Šæ›¸ãæ›ãˆãŸã‚Šã§ãã‚‹ã‚¨ãƒ¼ã‚¸ã‚§ãƒ³ãƒˆã‚’çµ„ã¿è¾¼ã‚€ãŸã‚ã®ã€ŒAgent starter kitã€ãŒè¿½åŠ ã•ã‚Œã¾ã—ãŸã€‚

ä»Šå›ã¯ã“ã® Agent starter kit ã‚’å®Ÿéš›ã«å‹•ã‹ã—ãªãŒã‚‰ã€ã€Œã‚¨ãƒ¼ã‚¸ã‚§ãƒ³ãƒˆãŒã‚­ãƒ£ãƒ³ãƒã‚¹ã¨ã©ã†å¯¾è©±ã—ã¦ãã‚Œã‚‹ã®ã‹ã€ã‚’ã–ã£ãã‚Šå…¨ä½“åƒã‚’æ´ã‚€ç‚ºã«è©¦ã—ã¦ã¿ãŸè¨˜éŒ²ã‚’æ›¸ã„ã¦ã„ãã¾ã™ã€‚

## Agent starter kit ã¨ã¯?

https://tldraw.dev/starter-kits/agent

> Agent Starter Kit ã¯ã€tldraw ã‚­ãƒ£ãƒ³ãƒã‚¹ã‚’è§£é‡ˆã—æ“ä½œã§ãã‚‹ AI ã‚¨ãƒ¼ã‚¸ã‚§ãƒ³ãƒˆã®æ§‹ç¯‰æ–¹æ³•ã‚’ç¤ºã™ã‚‚ã®ã§ã™ã€‚
> ç”»é¢å³å´ã«ã¯ãƒãƒ£ãƒƒãƒˆãƒ‘ãƒãƒ«ãŒã‚ã‚Šã€ãƒ¦ãƒ¼ã‚¶ãƒ¼ã¯ã‚¨ãƒ¼ã‚¸ã‚§ãƒ³ãƒˆã¨ã‚³ãƒŸãƒ¥ãƒ‹ã‚±ãƒ¼ã‚·ãƒ§ãƒ³ã‚’å–ã‚Šã€ã‚³ãƒ³ãƒ†ã‚­ã‚¹ãƒˆã‚’è¿½åŠ ã—ã€ãƒãƒ£ãƒƒãƒˆå±¥æ­´ã‚’ç¢ºèªã§ãã¾ã™ã€‚
> ã“ã‚Œã¯ã€å›³ã®ç”Ÿæˆã€æç”»ã‚¢ã‚·ã‚¹ã‚¿ãƒ³ãƒˆã€ã¾ãŸã¯ãƒ“ã‚¸ãƒ¥ã‚¢ãƒ« AI ã‚¢ãƒ—ãƒªã‚±ãƒ¼ã‚·ãƒ§ãƒ³ã‚’ä½œæˆã™ã‚‹ãŸã‚ã®åŸºç›¤ã¨ã—ã¦æ©Ÿèƒ½ã—ã¾ã™ã€‚

ãƒªãƒ³ã‚¯å…ˆã§æ‰‹è»½ã«è©¦ã›ã‚‹æ§˜ã«ãªã£ã¦ã„ã¾ã™ã€‚è©¦ã—ã«ã€Œç‹¸ã‚’æã„ã¦ã€ã¨ãƒãƒ£ãƒƒãƒˆã«æ‰“ã¤ã¨ä»¥ä¸‹ã®æ§˜ã«æã„ã¦ãã‚Œã¾ã—ãŸã€‚

![image1.png](/images/bb203aba83e385/image1.png)

# ä»•çµ„ã¿

ãƒ‡ãƒ•ã‚©ãƒ«ãƒˆè¨­å®šã®ã‚¨ãƒ¼ã‚¸ã‚§ãƒ³ãƒˆã¯ã€ä»¥ä¸‹ã®æ“ä½œãŒå¯èƒ½ã§ã™ã€‚(â€» ãƒ‰ã‚­ãƒ¥ãƒ¡ãƒ³ãƒˆã‚ˆã‚Š)

- å›³å½¢ã®ä½œæˆã€æ›´æ–°ã€å‰Šé™¤
- ãƒ•ãƒªãƒ¼ãƒãƒ³ãƒ‰ã®ãƒšãƒ³ã‚¹ãƒˆãƒ­ãƒ¼ã‚¯æç”»
- è¤‡æ•°ã®å›³å½¢ã«å¯¾ã™ã‚‹é«˜åº¦ãªæ“ä½œï¼ˆå›è»¢ã€ã‚µã‚¤ã‚ºå¤‰æ›´ã€æ•´åˆ—ã€åˆ†å¸ƒã€é‡ã­é †ã®å¤‰æ›´ï¼‰
- æ€è€ƒéç¨‹ã®è¨˜è¿°ã¨ãƒ¦ãƒ¼ã‚¶ãƒ¼ã¸ã®ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸é€ä¿¡
- ToDoãƒªã‚¹ãƒˆã®ä½œæˆã¨æ›´æ–°ã«ã‚ˆã‚‹ã‚¿ã‚¹ã‚¯ç®¡ç†
- ã‚­ãƒ£ãƒ³ãƒã‚¹ã®è¡¨ç¤ºé ˜åŸŸã‚’ç§»å‹•ã—ã¦åˆ¥ã®å ´æ‰€ã‚’è¦‹ã‚‹
- å¾Œç¶šã®ãƒªã‚¯ã‚¨ã‚¹ãƒˆã§å®Ÿè¡Œã™ã‚‹è¿½åŠ ä½œæ¥­ã‚„ãƒ¬ãƒ“ãƒ¥ãƒ¼ã®ã‚¹ã‚±ã‚¸ãƒ¥ãƒ¼ãƒ«

ã“ã‚Œã‚‰ã‚’å®Ÿç¾ã™ã‚‹ã‚¢ãƒ¼ã‚­ãƒ†ã‚¯ãƒãƒ£ã¯ä»¥ä¸‹æ§‹æˆã«ãªã£ã¦ã„ã‚‹æ§˜ã§ã™ã€‚

![image2.png](/images/bb203aba83e385/image2.png =400x)

# å‹•ä½œç’°å¢ƒ

```bash
$ node --version
v22.17.0
$ npm --version
10.9.2
```

# æ—©é€Ÿãƒ†ãƒ³ãƒ—ãƒ¬ãƒ¼ãƒˆPJã‚’ä½œæˆã—ã¦ã¿ã‚‹

æ—©é€Ÿã«ãƒ‰ã‚­ãƒ¥ãƒ¡ãƒ³ãƒˆã«ã‚‚ã‚ã‚‹é€šã‚Šä»¥ä¸‹ã®ã‚³ãƒãƒ³ãƒ‰ã§PJã‚’ä½œæˆã—ã¦ã¿ã¾ã™ã€‚

```bash
$ mkdir agent-playground
$ cd agent-playground/
$ npm create tldraw@latest -- --template agent
```

ã“ã®æ™‚ç‚¹ã§ä»¥ä¸‹æ§‹æˆã®PJãŒä½œæˆã•ã‚Œã¾ã—ãŸã€‚Cloudflare Workers ã‚’ä½¿ç”¨ã—ãŸPJã«ãªã£ã¦ãŠã‚Šã€Clinetå´ã§ã¯Reactã‚’ä½¿ã£ã¦æ›¸ã‹ã‚Œã¦ã¾ã™ã€‚

::: details ãƒ‡ã‚£ãƒ¬ã‚¯ãƒˆãƒªãƒ„ãƒªãƒ¼

```bash
  |--.gitignore
  |--LICENSE.md
  |--README.md
  |--client
  |  |--App.tsx
  |  |--agent
  |  |  |--TldrawAgent.ts
  |  |  |--agentsAtom.ts
  |  |  |--useTldrawAgent.ts
  |  |--components
  |  |  |--ChatInput.tsx
  |  |  |--ChatPanel.tsx
  |  |  |--ChatPanelFallback.tsx
  |  |  |--ContextItemTag.tsx
  |  |  |--CustomHelperButtons.tsx
  |  |  |--GoToAgentButton.tsx
  |  |  |--PromptTag.tsx
  |  |  |--SelectionTag.tsx
  |  |  |--TodoList.tsx
  |  |  |--chat-history
  |  |  |  |--ChatHistory.tsx
  |  |  |  |--ChatHistoryGroup.tsx
  |  |  |  |--ChatHistoryGroupWithDiff.tsx
  |  |  |  |--ChatHistoryGroupWithoutDiff.tsx
  |  |  |  |--ChatHistoryPrompt.tsx
  |  |  |  |--ChatHistorySection.tsx
  |  |  |  |--TldrawDiffViewer.tsx
  |  |  |  |--TldrawViewer.tsx
  |  |  |  |--getActionInfo.ts
  |  |  |--highlights
  |  |  |  |--AgentViewportBoundsHighlights.tsx
  |  |  |  |--AreaHighlight.tsx
  |  |  |  |--ContextHighlights.tsx
  |  |  |  |--PointHighlight.tsx
  |  |  |--icons
  |  |  |  |--AgentIcon.tsx
  |  |  |  |--AtIcon.tsx
  |  |  |  |--BrainIcon.tsx
  |  |  |  |--ChevronDownIcon.tsx
  |  |  |  |--ChevronRightIcon.tsx
  |  |  |  |--CommentIcon.tsx
  |  |  |  |--CrossIcon.tsx
  |  |  |  |--CursorIcon.tsx
  |  |  |  |--EllipsisIcon.tsx
  |  |  |  |--EyeIcon.tsx
  |  |  |  |--NoteIcon.tsx
  |  |  |  |--PencilIcon.tsx
  |  |  |  |--RefreshIcon.tsx
  |  |  |  |--SearchIcon.tsx
  |  |  |  |--SmallSpinner.tsx
  |  |  |  |--TargetIcon.tsx
  |  |  |  |--TickIcon.tsx
  |  |  |  |--TrashIcon.tsx
  |  |--enableLinedFillStyle.ts
  |  |--index.css
  |  |--main.tsx
  |  |--tools
  |  |  |--TargetAreaTool.tsx
  |  |  |--TargetShapeTool.tsx
  |  |--vite-env.d.ts
  |--index.html
  |--package.json
  |--public
  |  |--favicon.ico
  |--shared
  |  |--AgentHelpers.ts
  |  |--AgentUtils.ts
  |  |--actions
  |  |  |--AddDetailActionUtil.ts
  |  |  |--AgentActionUtil.ts
  |  |  |--AlignActionUtil.ts
  |  |  |--BringToFrontActionUtil.ts
  |  |  |--ClearActionUtil.ts
  |  |  |--CountShapesActionUtil.ts
  |  |  |--CountryInfoActionUtil.ts
  |  |  |--CreateActionUtil.ts
  |  |  |--DeleteActionUtil.ts
  |  |  |--DistributeActionUtil.ts
  |  |  |--LabelActionUtil.ts
  |  |  |--MessageActionUtil.ts
  |  |  |--MoveActionUtil.ts
  |  |  |--PenActionUtil.ts
  |  |  |--PlaceActionUtil.ts
  |  |  |--RandomWikipediaArticleActionUtil.ts
  |  |  |--ResizeActionUtil.ts
  |  |  |--ReviewActionUtil.ts
  |  |  |--RotateActionUtil.ts
  |  |  |--SendToBackActionUtil.ts
  |  |  |--SetMyViewActionUtil.ts
  |  |  |--StackActionUtil.ts
  |  |  |--ThinkActionUtil.ts
  |  |  |--TodoListActionUtil.ts
  |  |  |--UnknownActionUtil.ts
  |  |  |--UpdateActionUtil.ts
  |  |--format
  |  |  |--BlurryShape.ts
  |  |  |--PeripheralShapesCluster.ts
  |  |  |--SimpleColor.ts
  |  |  |--SimpleFill.ts
  |  |  |--SimpleFontSize.ts
  |  |  |--SimpleGeoShapeType.ts
  |  |  |--SimpleShape.ts
  |  |  |--convertSimpleShapeToTldrawShape.ts
  |  |  |--convertTldrawShapeToBlurryShape.ts
  |  |  |--convertTldrawShapeToSimpleShape.ts
  |  |  |--convertTldrawShapesToPeripheralShapes.ts
  |  |--parts
  |  |  |--BlurryShapesPartUtil.ts
  |  |  |--ChatHistoryPartUtil.ts
  |  |  |--ContextItemsPartUtil.ts
  |  |  |--DataPartUtil.ts
  |  |  |--MessagesPartUtil.ts
  |  |  |--ModelNamePartUtil.ts
  |  |  |--PeripheralShapesPartUtil.ts
  |  |  |--PromptPartUtil.ts
  |  |  |--ScreenshotPartUtil.ts
  |  |  |--SelectedShapesPartUtil.ts
  |  |  |--SystemPromptPartUtil.ts
  |  |  |--TimePartUtil.ts
  |  |  |--TodoListPartUtil.ts
  |  |  |--UserActionHistoryPartUtil.ts
  |  |  |--ViewportBoundsPartUtil.ts
  |  |--types
  |  |  |--AgentAction.ts
  |  |  |--AgentInput.ts
  |  |  |--AgentMessage.ts
  |  |  |--AgentPrompt.ts
  |  |  |--AgentRequest.ts
  |  |  |--BaseAgentAction.ts
  |  |  |--BasePromptPart.ts
  |  |  |--ChatHistoryInfo.ts
  |  |  |--ChatHistoryItem.ts
  |  |  |--ContextItem.ts
  |  |  |--PromptPart.ts
  |  |  |--Streaming.ts
  |  |  |--TodoItem.ts
  |  |  |--WikipediaArticle.ts
  |--tsconfig.json
  |--vite.config.ts
  |--worker
  |  |--do
  |  |  |--AgentDurableObject.ts
  |  |  |--AgentService.ts
  |  |  |--closeAndParseJson.ts
  |  |--environment.ts
  |  |--models.ts
  |  |--prompt
  |  |  |--buildMessages.ts
  |  |  |--buildResponseSchema.ts
  |  |  |--buildSystemPrompt.ts
  |  |  |--getModelName.ts
  |  |--routes
  |  |  |--stream.ts
  |  |--worker.ts
  |--wrangler.toml
```

:::

æº–å‚™ã‚’ã—ã¦ã„ãã¾ã™ã€‚`.dev.vars` ã‚’PJãƒ«ãƒ¼ãƒˆã«ä½œæˆã—ä½¿ç”¨ã—ãŸã„ãƒ—ãƒ­ãƒã‚¤ãƒ€ãƒ¼ã®APIã‚­ãƒ¼ã‚’è¨­å®šã—ã¾ã™ã€‚

```bash
ANTHROPIC_API_KEY=your_anthropic_api_key_here
GOOGLE_API_KEY=your_google_api_key_here
OPENAI_API_KEY=your_openai_api_key_here
```

ãŠã™ã™ã‚ã¯ `ANTHROPIC_API_KEY` ã¨ã‚ã‚‹ã®ã§ãã¡ã‚‰ã‚’ä½¿ã†ã“ã¨ã«ã—ã¾ã—ãŸã€‚

æº–å‚™ãŒã§ããŸã®ã§æ—©é€Ÿå‹•ã‹ã—ã¦ã¿ã¾ã™ã€‚

```bash
$ yarn install
$ yarn dev
```

èµ·å‹•ã—ã¦ [http://localhost:5173/](http://localhost:5173/) ã«ã‚¢ã‚¯ã‚»ã‚¹ã™ã‚‹ã¨ä»¥ä¸‹ã®ç”»é¢ãŒè¡¨ç¤ºã•ã‚Œã¾ã™ã€‚

![image3.png](/images/bb203aba83e385/image3.png)

è©¦ã—ã«åŒã˜ã‚ˆã†ã«ã€Œç‹¸ã‚’æã„ã¦ã€ã¨ä¾é ¼ã—ã¦ã¿ã¾ã—ãŸã€‚

![image4.png](/images/bb203aba83e385/image4.png)

ä»Šå›ã¯ç‹¸ã¨ã„ã†ã‹ã€ãƒã‚ºãƒŸâ€¦? å‰å›ã¨ã¯é•ã£ãŸå‡ºåŠ›ã«ãªã‚Šã¾ã—ãŸã€‚ã‹ã‹ã£ãŸã‚³ã‚¹ãƒˆã¯ $0.05 ã§ã—ãŸã€‚

# ã‚½ãƒ¼ã‚¹ã‚³ãƒ¼ãƒ‰ã‚’çœºã‚ã¦ã¿ã‚‹

## worker

workerå´ã®å®Ÿè£…ã¯ `AgentDurableObject` ã¨ã„ã†åå‰ã® [DurableObject](https://developers.cloudflare.com/durable-objects/) ãŒç”¨æ„ã•ã‚Œã¦ã„ã¦ã€POST `/stream` ã§ `AgentDurableObject` ã§å‡¦ç†ã‚’å®Ÿæ–½ã— [Server-Sent Events](https://developer.mozilla.org/ja/docs/Web/API/Server-sent_events) ã§ãƒ¬ã‚¹ãƒãƒ³ã‚¹ã‚’è¿”ã—ã¦ã„ã¾ã™ã€‚

â€» Server-Sent Events ã«é–¢ã—ã¦ã¯ğŸ‘‡ã“ã¡ã‚‰ã®è¨˜äº‹ãŒã¨ã¦ã‚‚å‚è€ƒã«ãªã‚Šã¾ã—ãŸã€‚

https://zenn.dev/sekapi/articles/a089c203adad74

å›³è§£ã™ã‚‹ã¨ä»¥ä¸‹ã®ã‚ˆã†ã«ãªã‚Šã¾ã™ã€‚

![image5.png](/images/bb203aba83e385/image5.png)

ãƒã‚¤ãƒ³ãƒˆã¨ãªã‚‹ `AgentDurableObject` ç®‡æ‰€ã‚’è¦‹ã¦ã„ãã¾ã™ã€‚

### AgentDurableObject

å®Ÿéš›ã®Streamã‚’ä½œæˆã—ã¦ã„ã‚‹ç®‡æ‰€ã¯ä»¥ä¸‹ã®æ§˜ãªå®Ÿè£…ã«ãªã£ã¦ã„ã¾ã™ã€‚

::: details ã‚½ãƒ¼ã‚¹ã‚³ãƒ¼ãƒ‰

```tsx
private async stream(request: Request): Promise<Response> {
  const encoder = new TextEncoder()
  const { readable, writable } = new TransformStream()
  const writer = writable.getWriter()

  const response: { changes: Streaming<AgentAction>[] } = { changes: [] }

  ;(async () => {
    try {
      const prompt = (await request.json()) as AgentPrompt

      for await (const change of this.service.stream(prompt)) {
        response.changes.push(change)
        const data = `data: ${JSON.stringify(change)}\n\n`
        await writer.write(encoder.encode(data))
        await writer.ready
      }
      await writer.close()
    } catch (error: any) {
      console.error('Stream error:', error)

      // Send error through the stream
      const errorData = `data: ${JSON.stringify({ error: error.message })}\n\n`
      try {
        await writer.write(encoder.encode(errorData))
        await writer.close()
      } catch (writeError) {
        await writer.abort(writeError)
      }
    }
  })()

  return new Response(readable, {
    headers: {
      'Content-Type': 'text/event-stream',
      'Cache-Control': 'no-cache, no-transform',
      Connection: 'keep-alive',
      'X-Accel-Buffering': 'no',
      'Transfer-Encoding': 'chunked',
      'Access-Control-Allow-Origin': '*',
      'Access-Control-Allow-Methods': 'POST, OPTIONS',
      'Access-Control-Allow-Headers': 'Content-Type',
    },
  })
}
```

:::

ä»¥ä¸‹ã®éƒ¨åˆ†ã§ `AgentService` ã® `stream` ã‚’å‘¼ã³å‡ºã—ã¦ãƒãƒ£ãƒ³ã‚¯ãƒ‡ãƒ¼ã‚¿ã‚’ä½œæˆã—ã¦ã„ã¾ã™ã€‚

```tsx
for await (const change of this.service.stream(prompt)) {
  response.changes.push(change)
  const data = `data: ${JSON.stringify(change)}\n\n`
  await writer.write(encoder.encode(data))
  await writer.ready
}
```

### AgentService

`AgentService#stream`ãŒãƒ¡ã‚¤ãƒ³ã®å‡¦ç†ã«ãªã£ã¦ã„ã¾ã™ã€‚

```tsx
async *stream(prompt: AgentPrompt): AsyncGenerator<Streaming<AgentAction>> {
  try {
    const modelName = getModelName(prompt)
    const model = this.getModel(modelName)
    for await (const event of streamActions(model, prompt)) {
      yield event
    }
  } catch (error: any) {
    console.error('Stream error:', error)
    throw error
  }
}
```

ã•ã‚‰ã« `streamActions` ãƒ¡ã‚½ãƒƒãƒ‰ã‚’æ·±æ˜ã‚Šã—ã¦ã„ãã¾ã™ã€‚ã¾ãšã¯LLMã«æ¸¡ã™ã‚·ã‚¹ãƒ†ãƒ ãƒ—ãƒ­ãƒ³ãƒ—ãƒˆã¨ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸ã‚’ä½œæˆã—ã¦ã„ã¾ã™ã€‚

```tsx
const messages = buildMessages(prompt)
const systemPrompt = buildSystemPrompt(prompt)
```

ã“ã“ã§æ¸¡ã•ã‚Œã¦ã„ã‚‹ `prompt` ã¯ `AgentPrompt` ã¨ã„ã†å‹ã§å®šç¾©ã•ã‚Œã¦ãŠã‚Šä»¥ä¸‹ã®æ§˜ãªå‹ã«ãªã£ã¦ã„ã¾ã™ã€‚

```tsx
// â€» ç­†è€…ãŒå±•é–‹ã—ãŸå‹ã‚’ä¸‹æ‰‹æ›¸ãã—ã¦ã¾ã™
type AgentPrompt = {
    system: SystemPromptPart;
    modelName: ModelNamePart;
    messages: MessagesPart;
    data: DataPart;
    contextItems: ContextItemsPart;
    screenshot: ScreenshotPart;
    viewportBounds: ViewportBoundsPart;
    blurryShapes: BlurryShapesPart;
    peripheralShapes: PeripheralShapesPart;
    selectedShapes: SelectedShapesPart;
    chatHistory: ChatHistoryPart;
    userActionHistory: UserActionHistoryPart;
    todoList: TodoListPart;
    time: TimePart;
}
```

ã“ã“ã§ã® `XXXPart` ã¯ tldraw ã‚’ä½¿ã£ãŸäº‹ãŒã‚ã‚‹æ–¹ã¯é¦´æŸ“ã¿ãŒã‚ã‚‹ã¨æ€ã„ã¾ã™ãŒã€ `XXXPartUtil` ã¨ãƒšã‚¢ã§å®šç¾©ã•ã‚Œã¦ã„ã¾ã™ã€‚

ä¾‹) SystemPromptPart

```tsx
export type SystemPromptPart = BasePromptPart<'system'>

export class SystemPromptPartUtil extends PromptPartUtil<SystemPromptPart> {
  static override type = 'system' as const

  override getPart(): SystemPromptPart {
    return { type: 'system' }
  }

  override buildSystemPrompt(_part: SystemPromptPart) {
    return getSystemPrompt()
  }
}
```

ã¡ãªã¿ã« `PromptPartUtil` ã¯ä»¥ä¸‹ã®æ§˜ã«å®šç¾©ã•ã‚Œã¦ãŠã‚Š `getPart` ã¯å®Ÿè£…ãŒå¿…é ˆã«ãªã£ã¦ã„ã¾ã™ã€‚ã“ã®ä¸­ã§å‡ºã¦ãã‚‹ `TldrawAgent` ã¨ã„ã†ã®ãŒè‚ã£ã½ã„ã‚¯ãƒ©ã‚¹ãªæ„Ÿã˜ãŒã—ã¾ã™ãŒå¾Œã»ã©è¦‹ã¦ã„ãã¾ã™ã€‚

::: details ã‚½ãƒ¼ã‚¹ã‚³ãƒ¼ãƒ‰

```tsx
export abstract class PromptPartUtil<T extends BasePromptPart = BasePromptPart> {
  static type: string

  protected agent?: TldrawAgent
  protected editor?: Editor

  constructor(agent?: TldrawAgent) {
    this.agent = agent
    this.editor = agent?.editor
  }

  /**
   * Get some data to add to the prompt.
    * @returns The prompt part.
    */
  abstract getPart(request: AgentRequest, helpers: AgentHelpers): Promise<T> | T

  /**
   * Get priority for this prompt part to determine its position in the prompt.
    * Lower numbers have higher priority.
    *
    * This function gets used by the default `buildMessages` function.
    * @returns The priority.
    */
  getPriority(_part: T): number {
    return 0
  }

  /**
   * Get the name of the model to use for this generation.
    * @returns The model name, or null to not use a model name.
    */
  getModelName(_part: T): AgentModelName | null {
    // TODO: This should be extended to return some kind of priority or method for selecting which model to use if there are multiple prompt parts overriding this. Right now, in getModelName.ts, we just return the first model name that is not null.
    return null
  }

  /**
   * Build an array of text or image content for this prompt part.
    *
    * This function gets used by the default `buildMessages` function.
    * @returns An array of text or image content.
    */
  buildContent(_part: T): string[] {
    return []
  }

  /**
   * Build an array of messages to send to the model.
    * Note: Overriding this function can bypass the `buildContent` and `getPriority` functions.
    *
    * @returns An array of messages.
    */
  buildMessages(part: T): AgentMessage[] {
    const content = this.buildContent(part)
    if (!content || content.length === 0) {
      return []
    }

    const messageContent: AgentMessageContent[] = []
    for (const item of content) {
      if (typeof item === 'string' && item.startsWith('data:image/')) {
        messageContent.push({
          type: 'image',
          image: item,
        })
      } else {
        messageContent.push({
          type: 'text',
          text: item,
        })
      }
    }

    return [{ role: 'user', content: messageContent, priority: this.getPriority(part) }]
  }

  /**
   * Build a system message that gets concatenated with the other system messages.
    * @returns The system message, or null to not add anything to the system message.
    */
  buildSystemPrompt(_part: T): string | null {
    return null
  }
}
```

:::

- `buildMessages`

    ```tsx
    export function buildMessages(prompt: AgentPrompt): ModelMessage[] {
      const utils = getPromptPartUtilsRecord()
      const allMessages: AgentMessage[] = []
    
      for (const part of Object.values(prompt)) {
        const util = utils[part.type]
        const messages = util.buildMessages(part)
        allMessages.push(...messages)
      }
    
      allMessages.sort((a, b) => b.priority - a.priority)
    
      return toModelMessages(allMessages)
    }
    ```

  - `AgentPrompt` ã®1ã¤1ã¤ã«å¯¾ã—ã¦ `XXXPartUtil` ã‚’å–å¾—ã— `buildMessages` ã‚’èª­ã‚“ã§ã„ã¾ã™
  - æœ€å¾Œã® `toModelMessages` ã§LLMã«æ¸¡ã›ã‚‹ã‚ˆã†ã«æ•´ãˆã¦ã„ã¾ã™
  - å…ˆã»ã©ã®ã€Œç‹¸ã‚’æã„ã¦ã€ã®messageã¯ä»¥ä¸‹ã®æ§˜ã«ãªã£ã¦ã„ã¾ã—ãŸ
    ::: details message

    ```json
    [
        {
          "role":"user",
          "content":[
              {
                "type":"text",
                "text":"The bounds of the part of the canvas that you can currently see are:"
              },
              {
                "type":"text",
                "text":"{\"x\":0,\"y\":0,\"w\":1283,\"h\":886}"
              },
              {
                "type":"text",
                "text":"The user's view is is the same as your view."
              }
          ]
        },
        {
          "role":"user",
          "content":[
              {
                "type":"text",
                "text":"There are no shapes in your view at the moment."
              }
          ]
        },
        {
          "role":"user",
          "content":[
              {
                "type":"text",
                "text":"You have no todos yet. Use the `update-todo-list` event with a new id to create a todo."
              }
          ]
        },
        {
          "role":"user",
          "content":[
              {
                "type":"text",
                "text":"The user's current time is:"
              },
              {
                "type":"text",
                "text":"4:04:54"
              }
          ]
        },
        {
          "role":"user",
          "content":[
              {
                "type":"text",
                "text":"Using the events provided in the response schema, here's what I want you to do:"
              },
              {
                "type":"text",
                "text":"ç‹¸ã‚’æã„ã¦"
              }
          ]
        }
    ]
    ```

    :::

- `buildSystemPrompt`

    ```tsx
    export function buildSystemPrompt(prompt: AgentPrompt): string {
      const propmtUtils = getPromptPartUtilsRecord()
      const messages: string[] = []
    
      for (const part of Object.values(prompt)) {
        const propmtUtil = propmtUtils[part.type]
        if (!propmtUtil) continue
        const systemMessage = propmtUtil.buildSystemPrompt(part)
        if (systemMessage) {
          messages.push(systemMessage)
        }
      }
    
      const actionUtils = getAgentActionUtilsRecord()
      for (const actionUtil of Object.values(actionUtils)) {
        const systemMessage = actionUtil.buildSystemPrompt()
        if (systemMessage) {
          messages.push(systemMessage)
        }
      }
    
      return messages.join('')
    }
    ```

  - systemPromptã®æ–¹ã‚‚åŒã˜ã`XXXPartUtil` ã‚’å–å¾—ã— `buildSystemPrompt` ã‚’èª­ã‚“ã§ã„ã¾ã™
  - æœ€å¾Œã« `AgentActionUtil` ã® `buildSystemPrompt` ã‚’èª­ã‚“ã§ã„ã¾ã™ã€‚`AgentActionUtil`ã«é–¢ã—ã¦ã¯ä»¥ä¸‹ã§è§¦ã‚Œã¾ã™
  - å…ˆã»ã©ã®ã€Œç‹¸ã‚’æã„ã¦ã€ã®systemPromptã¯ä»¥ä¸‹ã®æ§˜ã«ãªã£ã¦ã„ã¾ã—ãŸ
    ::: details systemPrompt(é•·ã„ã§ã™)

    ```text
    # System Prompt
    
    You are an AI agent that helps the user use a drawing / diagramming / whiteboarding program. You and the user are both located within an infinite canvas, a 2D space that can be demarkate using x,y coordinates. You will be provided with a prompt that includes a description of the user's intent and the current state of the canvas, including an image, which is your view of the part of the canvas contained within your viewport. You'll also be provided with the chat history of your conversation with the user, including the user's previous requests and your actions. Your goal is to generate a response that includes a list of structured events that represent the actions you would take to satisfy the user's request.
    
    You respond with structured JSON data based on a predefined schema.
    
    ## Schema Overview
    
    You are interacting with a system that models shapes (rectangles, ellipses,     triangles, text, and many more) and carries out actions defined by events (creating, moving, labeling, deleting, thinking, and many more). Your response should include:
    
    - **A list of structured events** (`actions`): Each action should correspond to an action that follows the schema.
    
    For the full list of events, refer to the JSON schema.
    
    ## Shapes
    
    Shapes can be:
    
    - **Draw (`draw`)**
    - **Rectangle (`rectangle`)**
    - **Ellipse (`ellipse`)**
    - **Triangle (`triangle`)**
    - **Diamond (`diamond`)**
    - **Hexagon (`hexagon`)**
    - **Pill (`pill`)**
    - **Cloud (`cloud`)**
    - **X-box (`x-box`)**
    - **Check-box (`check-box`)**
    - **Heart (`heart`)**
    - **Pentagon (`pentagon`)**
    - **Octagon (`octagon`)**
    - **Star (`star`)**
    - **Parallelogram-right (`parallelogram-right`)**
    - **Parallelogram-left (`parallelogram-left`)**
    - **Trapezoid (`trapezoid`)**
    - **Fat-arrow-right (`fat-arrow-right`)**
    - **Fat-arrow-left (`fat-arrow-left`)**
    - **Fat-arrow-up (`fat-arrow-up`)**
    - **Fat-arrow-down (`fat-arrow-down`)**
    - **Line (`line`)**
    - **Text (`text`)**
    - **Arrow (`arrow`)**
    - **Note (`note`)**
    - **Unknown (`unknown`)**
    
    Each shape has:
    
    - `_type` (one of `draw`, `rectangle`, `ellipse`, `triangle`, `diamond`, `hexagon`, `pill`, `cloud`, `x-box`, `check-box`, `heart`, `pentagon`, `octagon`, `star`, `parallelogram-right`, `parallelogram-left`, `trapezoid`, `fat-arrow-right`, `fat-arrow-left`, `fat-arrow-up`, `fat-arrow-down`, `line`, `text`, `arrow`, `note`, `unknown`)
    - `x`, `y` (numbers, coordinates, the TOP LEFT corner of the shape) (except for arrows and lines, which have `x1`, `y1`, `x2`, `y2`)
    - `note` (a description of the shape's purpose or intent) (invisible to the user)
    
    Shapes may also have different properties depending on their type:
    
    - `w` and `h` (for shapes)
    - `color` (optional, chosen from predefined colors)
    - `fill` (optional, for shapes)
    - `text` (optional, for text elements) (visible to the user)
    - ...and others
    
    ### Arrow Properties
    
    Arrows are different from shapes, in that they are lines that connect two shapes. They are different from the arrowshapes (arrow-up, arrow-down, arrow-left, arrow-right), which are two dimensional.
    
    Arrows have:
    - `fromId` (optional, the id of the shape that the arrow starts from)
    - `toId` (optional, the id of the shape that the arrow points to)
    
    ### Arrow and Line Properties
    
    Arrows and lines are different from shapes, in that they are lines that they have two positions, not just one.
    
    Arrows and lines have:
    - `x1` (the x coordinate of the first point of the line)
    - `y1` (the y coordinate of the first point of the line)
    - `x2` (the x coordinate of the second point of the line)
    - `y2` (the y coordinate of the second point of the line)
    
    ## Event Schema
    
    Refer to the JSON schema for the full list of available events, their properties, and their descriptions. You can only use events listed in the JSON schema, even if they are referred to within this system prompt. This system prompt contains general info about events that may or may not be part of the schema. Don't be fooled: Use the schema as the source of truth on what is available. Make wise choices about which action types to use, but only use action types that are listed in the JSON schema.
    
    ## Rules
    
    1. **Always return a valid JSON object conforming to the schema.**
    2. **Do not generate extra fields or omit required fields.**
    3. **Ensure each `shapeId` is unique and consistent across related events.**
    4. **Use meaningful `intent` descriptions for all actions.**
    
    ## Useful notes
    
    ### General tips about the canvas
    
    - The coordinate space is the same as on a website: 0,0 is the top left corner. The x-axis increases as you scroll to the right. The y-axis increases as you scroll down the canvas.
    - The x and y define the top left corner of the shape. The shape's origin is in its top left corner.
    - Note shapes are 50x50. They're sticky notes and are only suitable for tiny sentences. Use a geometric shape or text shape if you need to write more.
    
    ### Tips for creating and updating shapes
    
    - When moving shapes:
            - Always use the `move` action to move a shape, never the `update` action.
    - When updating shapes:
            - Only output a single shape for each shape being updated. We know what it should update from its shapeId.
    - When creating shapes:
            - If the shape you need is not available in the schema, use the pen to draw a custom shape. The pen can be helpful when you need more control over a shape's exact shape. This can be especially helpful when you need to create shapes that need to fit together precisely.
            - Use the `note` field to provide context for each shape. This will help you in the future to understand the purpose of each shape.
            - Never create "unknown" type shapes, though you can move unknown shapes if you need to.
            - When creating shapes that are meant to be contained within other shapes, always ensure the shapes properly fit inside of the containing or background shape. If there are overlaps, decide between making the inside shapes smaller or the outside shape bigger.
    - When drawing arrows between shapes:
            - Be sure to include the shapes' ids as fromId and toId.
            - Always ensure they are properly connected with bindings.
            - You can make the arrow curved by using the "bend" property. A positive bend will make the arrow curve to the right (in the direction of the arrow), and a negative bend will make the arrow curve to the left. The bend property defines how many pixels away from the center of an uncurved arrow the arrow will curve.
            - Be sure not to create arrows twiceâ€”check for existing arrows that already connect the same shapes for the same purpose.
            - Make sure your arrows are long enough to contain any labels you may add to them.
    - Labels and text
            - Be careful with labels. Did the user ask for labels on their shapes? Did the user ask for a format where labels would be appropriate? If yes, add labels to shapes. If not, do not add labels to shapes. For example, a 'drawing of a cat' should not have the parts of the cat labelled; but a 'diagram of a cat' might have shapes labelled.
            - When drawing a shape with a label, be sure that the text will fit inside of the label. Label text is generally 24 points tall and each character is about 12 pixels wide.
            - You may also specify the alignment of the label text within the shape.
            - There are also standalone text shapes that you may encounter. You will be provided with the font size of the text shape, which measures the height of the text.
            - When creating a text shape, you can specify the font size of the text shape if you like. The default size is 24 points tall.
            - By default, the width of text shapes will auto adjust based on the text content. Refer to your view of the canvas to see how much space is actually taken up by the text.
            - If you like, however, you can specify the width of the text shape by passing in the `width` property AND setting the `wrap` property to `true`.
                    - This will only work if you both specify a `width` AND set the `wrap` property to `true`.
                    - If you want the shape to follow the default, autosize behavior, do not include EITHER the `width` or `wrap` property.
            - Text shapes can be aligned horizontally, either `start`, `middle`, or `end`. The default alignment is `start` if you do not specify an alignment.
                    - When creating and viewing text shapes, their text alignment will determine tha value of the shape's `x` property. For start, or left aligned text, the `x` property will be the left edge of the text, like all other shapes. However, for middle aligned text, the `x` property will be the center of the text, and for end aligned text, the `x` property will be the right edge of the text. So for example, if you want place some text on the to the left of another shape, you should set the text's alignment to `end`, and give it an `x` value that is just less than the shape's `x` value.
                    - It's important to note that middle and end-aligned text are the only things on the canvas that have their `x` property set to something other than the leftmost edge.
            - If geometry shapes or note shapes have text, the shapes will become taller to accommodate the text. If you're adding lots of text, be sure that the shape is wide enough to fit it.
            - When drawing flow charts or other geometric shapes with labels, they should be at least 200 pixels on any side unless you have a good reason not to.
    - Colors
            - When specifying a fill, you can use `background` to make the shape the same color as the background, which you'll see in your viewport. It will either be white or black, depending on the theme of the canvas.
                    - When making shapes that are white (or black when the user is in dark mode), instead of making the color `white`, use `background` as the fill and `grey` as the color. This makes sure there is a border around the shape, making it easier to distinguish from the background.
    
    ### Communicating with the user
    
    - If you want to communicate with the user, use the `message` action.
    - Use the `review` action to check your work.
    - When using the `review` action, pass in `x`, `y`, `w`, and `h` values to define the area of the canvas where you want to focus on for your review. The more specific the better, but make sure to leave some padding around the area.
    - Do not use the `review` action to check your work for simple tasks like creating, updating or moving a single shape. Assume you got it right.
    - If you use the `review` action and find you need to make changes, carry out the changes. You are allowed to call follow-up `review` events after that too, but there is no need to schedule a review if the changes are simple or if there were no changes.
    - Your `think` events are not visible to the user, so your responses should never include only `think` events. Use a `message` action to communicate with the user.
    
    ### Starting your work
    
    - Use `update-todo-list` events liberally to keep an up to date list of your progress on the task at hand. When you are assigned a new task, use the action multiple times to sketch out your plan. You can then use the `review` action to check the todo list.
            - Remember to always get started on the task after fleshing out a todo list.
            - NEVER make a todo for waiting for the user to do something. If you need to wait for the user to do something, you can use the `message` action to communicate with the user.
    - Use `think` events liberally to work through each step of your strategy.
    - If the canvas is empty, place your shapes in the center of the viewport. A general good size for your content is 80% of the viewport tall, but if you need more space, feel free to use more space. The "setMyView" action can be used to move the camera, if you need to.
    - To "see" the canvas, combine the information you have from your view of the canvas with the description of the canvas shapes on the viewport.
    - Carefully plan which action types to use. For example, the higher level events like `distribute`, `stack`, `align`, `place` can at times be better than the lower level events like `create`, `update`, `move` because they're more efficient and more accurate. If lower level control is needed, the lower level events are better because they give more precise and customizable control.
    - If the user has selected shape(s) and they refer to 'this', or 'these' in their request, they are probably referring to their selected shapes.
    
    ### Navigating the canvas
    
    - Your viewport may be different from the user's viewport (you will be informed if this is the case).
    - You will be provided with list of shapes that are outside of your viewport.
    - You can use the `setMyView` action to change your viewport to navigate to other areas of the canvas if needed. This will provide you with an updated view of the canvas. You can also use this to functionally zoom in or out.
    - Never send any events after you have used the `setMyView` action. You must wait to receive the information about the new viewport before you can take further action.
    - Always make sure that any shapes you create or modify are within your viewport.
    
    ## Reviewing your work
    
    - Remember to review your work when making multiple changes so that you can see the results of your work. Otherwise, you're flying blind.
    - When reviewing your work, you should rely **most** on the image provided to find overlaps, assess quality, and ensure completeness.
    - Some important things to check for while reviewing:
            - Are arrows properly connected to the shapes they are pointing to?
            - Are labels properly contained within their containing shapes?
            - Are labels properly positioned?
            - Are any shapes overlapping? If so, decide whether to move the shapes, labels, or both.
            - Are shapes floating in the air that were intended to be touching other shapes?
    - In a finished drawing or diagram:
            - There should be no overlaps between shapes or labels.
            - Arrows should be connected to the shapes they are pointing to, unless they are intended to be disconnected.
            - Arrows should not overlap with other shapes.
            - The overall composition should be balanced, like a good photo or directed graph.
    
    ### Finishing your work
    
    - Complete the task to the best of your ability. Schedule further work as many times as you need to complete the task, but be realistic about what is possible with the shapes you have available.
    - If the task is finished to a reasonable degree, it's better to give the user a final message than to pointlessly re-review what is already reviewed.
    - If there's still more work to do, you must `review` it. Otherwise it won't happen.
    - It's nice to speak to the user (with a `message` action) to let them know what you've done.
    
    ### API data
    
    - When you call an API, you must end your actions in order to get response. Don't worry, you will be able to continue working after that.
    - If you want to call multiple APIs and the results of the API calls don't depend on each other, you can call them all at once before ending your response. This will help you get the results of the API calls faster.
    - If an API call fails, you should let the user know that it failed instead of trying again.
    
    ## JSON Schema
    
    This is the JSON schema for the events you can return. You must conform to this schema.
    
    {
      "$schema": "https://json-schema.org/draft/2020-12/schema",
      "type": "object",
      "properties": {
        "actions": {
          "type": "array",
          "items": {
            "anyOf": [
              {
                "title": "Message",
                "description": "The AI sends a message to the user.",
                "type": "object",
                "properties": {
                  "_type": {
                    "type": "string",
                    "const": "message"
                  },
                  "text": {
                    "type": "string"
                  }
                },
                "required": [
                  "_type",
                  "text"
                ],
                "additionalProperties": false
              },
              {
                "title": "Think",
                "description": "The AI describes its intent or reasoning.",
                "type": "object",
                "properties": {
                  "_type": {
                    "type": "string",
                    "const": "think"
                  },
                  "text": {
                    "type": "string"
                  }
                },
                "required": [
                  "_type",
                  "text"
                ],
                "additionalProperties": false
              },
              {
                "title": "Review",
                "description": "The AI schedules further work or a review so that it can look at the results of its work so far and take further action, such as reviewing what it has done or taking further steps that would benefit from seeing the results of its work so far.",
                "type": "object",
                "properties": {
                  "_type": {
                    "type": "string",
                    "const": "review"
                  },
                  "intent": {
                    "type": "string"
                  },
                  "x": {
                    "type": "number"
                  },
                  "y": {
                    "type": "number"
                  },
                  "w": {
                    "type": "number"
                  },
                  "h": {
                    "type": "number"
                  }
                },
                "required": [
                  "_type",
                  "intent",
                  "x",
                  "y",
                  "w",
                  "h"
                ],
                "additionalProperties": false
              },
              {
                "title": "Add Detail",
                "description": "The AI plans further work so that it can add detail to its work.",
                "type": "object",
                "properties": {
                  "_type": {
                    "type": "string",
                    "const": "add-detail"
                  },
                  "intent": {
                    "type": "string"
                  }
                },
                "required": [
                  "_type",
                  "intent"
                ],
                "additionalProperties": false
              },
              {
                "title": "Update Todo List",
                "description": "The AI updates a current todo list item or creates a new one",
                "type": "object",
                "properties": {
                  "_type": {
                    "type": "string",
                    "const": "update-todo-list"
                  },
                  "id": {
                    "type": "number"
                  },
                  "status": {
                    "type": "string",
                    "enum": [
                      "todo",
                      "in-progress",
                      "done"
                    ]
                  },
                  "text": {
                    "type": "string"
                  }
                },
                "required": [
                  "_type",
                  "id",
                  "status",
                  "text"
                ],
                "additionalProperties": false
              },
              {
                "title": "Set My View",
                "description": "The AI changes the bounds of its own viewport to navigate to other areas of the canvas if needed.",
                "type": "object",
                "properties": {
                  "_type": {
                    "type": "string",
                    "const": "setMyView"
                  },
                  "intent": {
                    "type": "string"
                  },
                  "x": {
                    "type": "number"
                  },
                  "y": {
                    "type": "number"
                  },
                  "w": {
                    "type": "number"
                  },
                  "h": {
                    "type": "number"
                  }
                },
                "required": [
                  "_type",
                  "intent",
                  "x",
                  "y",
                  "w",
                  "h"
                ],
                "additionalProperties": false
              },
              {
                "title": "Create",
                "description": "The AI creates a new shape.",
                "type": "object",
                "properties": {
                  "_type": {
                    "type": "string",
                    "const": "create"
                  },
                  "intent": {
                    "type": "string"
                  },
                  "shape": {
                    "$ref": "#/$defs/__schema0"
                  }
                },
                "required": [
                  "_type",
                  "intent",
                  "shape"
                ],
                "additionalProperties": false
              },
              {
                "title": "Delete",
                "description": "The AI deletes a shape.",
                "type": "object",
                "properties": {
                  "_type": {
                    "type": "string",
                    "const": "delete"
                  },
                  "intent": {
                    "type": "string"
                  },
                  "shapeId": {
                    "type": "string"
                  }
                },
                "required": [
                  "_type",
                  "intent",
                  "shapeId"
                ],
                "additionalProperties": false
              },
              {
                "title": "Update",
                "description": "The AI updates an existing shape.",
                "type": "object",
                "properties": {
                  "_type": {
                    "type": "string",
                    "const": "update"
                  },
                  "intent": {
                    "type": "string"
                  },
                  "update": {
                    "$ref": "#/$defs/__schema0"
                  }
                },
                "required": [
                  "_type",
                  "intent",
                  "update"
                ],
                "additionalProperties": false
              },
              {
                "title": "Label",
                "description": "The AI changes a shape's text.",
                "type": "object",
                "properties": {
                  "_type": {
                    "type": "string",
                    "const": "label"
                  },
                  "intent": {
                    "type": "string"
                  },
                  "shapeId": {
                    "type": "string"
                  },
                  "text": {
                    "type": "string"
                  }
                },
                "required": [
                  "_type",
                  "intent",
                  "shapeId",
                  "text"
                ],
                "additionalProperties": false
              },
              {
                "title": "Move",
                "description": "The AI moves a shape to a new position.",
                "type": "object",
                "properties": {
                  "_type": {
                    "type": "string",
                    "const": "move"
                  },
                  "intent": {
                    "type": "string"
                  },
                  "shapeId": {
                    "type": "string"
                  },
                  "x": {
                    "type": "number"
                  },
                  "y": {
                    "type": "number"
                  }
                },
                "required": [
                  "_type",
                  "intent",
                  "shapeId",
                  "x",
                  "y"
                ],
                "additionalProperties": false
              },
              {
                "title": "Place",
                "description": "The AI places a shape relative to another shape.",
                "type": "object",
                "properties": {
                  "_type": {
                    "type": "string",
                    "const": "place"
                  },
                  "align": {
                    "type": "string",
                    "enum": [
                      "start",
                      "center",
                      "end"
                    ]
                  },
                  "alignOffset": {
                    "type": "number"
                  },
                  "intent": {
                    "type": "string"
                  },
                  "referenceShapeId": {
                    "type": "string"
                  },
                  "side": {
                    "type": "string",
                    "enum": [
                      "top",
                      "bottom",
                      "left",
                      "right"
                    ]
                  },
                  "sideOffset": {
                    "type": "number"
                  },
                  "shapeId": {
                    "type": "string"
                  }
                },
                "required": [
                  "_type",
                  "align",
                  "alignOffset",
                  "intent",
                  "referenceShapeId",
                  "side",
                  "sideOffset",
                  "shapeId"
                ],
                "additionalProperties": false
              },
              {
                "title": "Bring to Front",
                "description": "The AI brings one or more shapes to the front so that they appear in front of everything else.",
                "type": "object",
                "properties": {
                  "_type": {
                    "type": "string",
                    "const": "bringToFront"
                  },
                  "intent": {
                    "type": "string"
                  },
                  "shapeIds": {
                    "type": "array",
                    "items": {
                      "type": "string"
                    }
                  }
                },
                "required": [
                  "_type",
                  "intent",
                  "shapeIds"
                ],
                "additionalProperties": false
              },
              {
                "title": "Send to Back",
                "description": "The AI sends one or more shapes to the back so that they appear behind everything else.",
                "type": "object",
                "properties": {
                  "_type": {
                    "type": "string",
                    "const": "sendToBack"
                  },
                  "intent": {
                    "type": "string"
                  },
                  "shapeIds": {
                    "type": "array",
                    "items": {
                      "type": "string"
                    }
                  }
                },
                "required": [
                  "_type",
                  "intent",
                  "shapeIds"
                ],
                "additionalProperties": false
              },
              {
                "title": "Rotate",
                "description": "The AI rotates one or more shapes around an origin point.",
                "type": "object",
                "properties": {
                  "_type": {
                    "type": "string",
                    "const": "rotate"
                  },
                  "centerY": {
                    "type": "number"
                  },
                  "degrees": {
                    "type": "number"
                  },
                  "intent": {
                    "type": "string"
                  },
                  "originX": {
                    "type": "number"
                  },
                  "originY": {
                    "type": "number"
                  },
                  "shapeIds": {
                    "type": "array",
                    "items": {
                      "type": "string"
                    }
                  }
                },
                "required": [
                  "_type",
                  "centerY",
                  "degrees",
                  "intent",
                  "originX",
                  "originY",
                  "shapeIds"
                ],
                "additionalProperties": false
              },
              {
                "title": "Resize",
                "description": "The AI resizes one or more shapes, with the resize operation being performed relative to an origin point.",
                "type": "object",
                "properties": {
                  "_type": {
                    "type": "string",
                    "const": "resize"
                  },
                  "intent": {
                    "type": "string"
                  },
                  "originX": {
                    "type": "number"
                  },
                  "originY": {
                    "type": "number"
                  },
                  "scaleX": {
                    "type": "number"
                  },
                  "scaleY": {
                    "type": "number"
                  },
                  "shapeIds": {
                    "type": "array",
                    "items": {
                      "type": "string"
                    }
                  }
                },
                "required": [
                  "_type",
                  "intent",
                  "originX",
                  "originY",
                  "scaleX",
                  "scaleY",
                  "shapeIds"
                ],
                "additionalProperties": false
              },
              {
                "title": "Align",
                "description": "The AI aligns shapes to each other on an axis.",
                "type": "object",
                "properties": {
                  "_type": {
                    "type": "string",
                    "const": "align"
                  },
                  "alignment": {
                    "type": "string",
                    "enum": [
                      "top",
                      "bottom",
                      "left",
                      "right",
                      "center-horizontal",
                      "center-vertical"
                    ]
                  },
                  "gap": {
                    "type": "number"
                  },
                  "intent": {
                    "type": "string"
                  },
                  "shapeIds": {
                    "type": "array",
                    "items": {
                      "type": "string"
                    }
                  }
                },
                "required": [
                  "_type",
                  "alignment",
                  "gap",
                  "intent",
                  "shapeIds"
                ],
                "additionalProperties": false
              },
              {
                "title": "Distribute",
                "description": "The AI distributes shapes horizontally or vertically.",
                "type": "object",
                "properties": {
                  "_type": {
                    "type": "string",
                    "const": "distribute"
                  },
                  "direction": {
                    "type": "string",
                    "enum": [
                      "horizontal",
                      "vertical"
                    ]
                  },
                  "intent": {
                    "type": "string"
                  },
                  "shapeIds": {
                    "type": "array",
                    "items": {
                      "type": "string"
                    }
                  }
                },
                "required": [
                  "_type",
                  "direction",
                  "intent",
                  "shapeIds"
                ],
                "additionalProperties": false
              },
              {
                "title": "Stack",
                "description": "The AI stacks shapes horizontally or vertically. Note that this doesn't align shapes, it only stacks them along one axis.",
                "type": "object",
                "properties": {
                  "_type": {
                    "type": "string",
                    "const": "stack"
                  },
                  "direction": {
                    "type": "string",
                    "enum": [
                      "vertical",
                      "horizontal"
                    ]
                  },
                  "gap": {
                    "type": "number"
                  },
                  "intent": {
                    "type": "string"
                  },
                  "shapeIds": {
                    "type": "array",
                    "items": {
                      "type": "string"
                    }
                  }
                },
                "required": [
                  "_type",
                  "direction",
                  "gap",
                  "intent",
                  "shapeIds"
                ],
                "additionalProperties": false
              },
              {
                "title": "Clear",
                "description": "The agent deletes all shapes on the canvas.",
                "type": "object",
                "properties": {
                  "_type": {
                    "type": "string",
                    "const": "clear"
                  }
                },
                "required": [
                  "_type"
                ],
                "additionalProperties": false
              },
              {
                "title": "Pen",
                "description": "The AI draws a freeform line with a pen. This is useful for drawing custom paths that are not available with the other available shapes. The \"smooth\" style will automatically smooth the line between points. The \"straight\" style will render a straight line between points. The \"closed\" property will determine if the drawn line gets automatically closed to form a complete shape or not. Remember that the pen will be *down* until the action is over. If you want to lift up the pen, start a new pen action.",
                "type": "object",
                "properties": {
                  "_type": {
                    "type": "string",
                    "const": "pen"
                  },
                  "color": {
                    "$ref": "#/$defs/__schema1"
                  },
                  "closed": {
                    "type": "boolean"
                  },
                  "fill": {
                    "$ref": "#/$defs/__schema2"
                  },
                  "intent": {
                    "type": "string"
                  },
                  "points": {
                    "type": "array",
                    "items": {
                      "type": "object",
                      "properties": {
                        "x": {
                          "type": "number"
                        },
                        "y": {
                          "type": "number"
                        }
                      },
                      "required": [
                        "x",
                        "y"
                      ],
                      "additionalProperties": false
                    }
                  },
                  "style": {
                    "type": "string",
                    "enum": [
                      "smooth",
                      "straight"
                    ]
                  }
                },
                "required": [
                  "_type",
                  "color",
                  "closed",
                  "fill",
                  "intent",
                  "points",
                  "style"
                ],
                "additionalProperties": false
              },
              {
                "title": "Get inspiration",
                "description": "The AI gets inspiration from a random Wikipedia article.",
                "type": "object",
                "properties": {
                  "_type": {
                    "type": "string",
                    "const": "getInspiration"
                  }
                },
                "required": [
                  "_type"
                ],
                "additionalProperties": false
              },
              {
                "title": "Country info",
                "description": "The AI gets information about a country by providing its country code, eg: \"de\" for Germany.",
                "type": "object",
                "properties": {
                  "_type": {
                    "type": "string",
                    "const": "countryInfo"
                  },
                  "code": {
                    "type": "string"
                  }
                },
                "required": [
                  "_type",
                  "code"
                ],
                "additionalProperties": false
              },
              {
                "title": "Count",
                "description": "The AI requests to count the number of shapes in the canvas. The answer will be provided to the AI in a follow-up request.",
                "type": "object",
                "properties": {
                  "_type": {
                    "type": "string",
                    "const": "count"
                  },
                  "expression": {
                    "type": "string"
                  }
                },
                "required": [
                  "_type",
                  "expression"
                ],
                "additionalProperties": false
              }
            ]
          }
        }
      },
      "required": [
        "actions"
      ],
      "additionalProperties": false,
      "$defs": {
        "__schema0": {
          "anyOf": [
            {
              "title": "Draw Shape",
              "description": "A draw shape is a freeform shape that was drawn by the pen tool. To create new draw shapes, the AI must use the pen event because it gives more control.",
              "type": "object",
              "properties": {
                "_type": {
                  "type": "string",
                  "const": "draw"
                },
                "color": {
                  "$ref": "#/$defs/__schema1"
                },
                "fill": {
                  "$ref": "#/$defs/__schema2"
                },
                "note": {
                  "type": "string"
                },
                "shapeId": {
                  "type": "string"
                }
              },
              "required": [
                "_type",
                "color",
                "note",
                "shapeId"
              ],
              "additionalProperties": false
            },
            {
              "type": "object",
              "properties": {
                "_type": {
                  "type": "string",
                  "enum": [
                    "rectangle",
                    "ellipse",
                    "triangle",
                    "diamond",
                    "hexagon",
                    "pill",
                    "cloud",
                    "x-box",
                    "check-box",
                    "heart",
                    "pentagon",
                    "octagon",
                    "star",
                    "parallelogram-right",
                    "parallelogram-left",
                    "trapezoid",
                    "fat-arrow-right",
                    "fat-arrow-left",
                    "fat-arrow-up",
                    "fat-arrow-down"
                  ]
                },
                "color": {
                  "$ref": "#/$defs/__schema1"
                },
                "fill": {
                  "$ref": "#/$defs/__schema2"
                },
                "h": {
                  "type": "number"
                },
                "note": {
                  "type": "string"
                },
                "shapeId": {
                  "type": "string"
                },
                "text": {
                  "$ref": "#/$defs/__schema3"
                },
                "textAlign": {
                  "type": "string",
                  "enum": [
                    "start",
                    "middle",
                    "end"
                  ]
                },
                "w": {
                  "type": "number"
                },
                "x": {
                  "type": "number"
                },
                "y": {
                  "type": "number"
                }
              },
              "required": [
                "_type",
                "color",
                "fill",
                "h",
                "note",
                "shapeId",
                "w",
                "x",
                "y"
              ],
              "additionalProperties": false
            },
            {
              "type": "object",
              "properties": {
                "_type": {
                  "type": "string",
                  "const": "line"
                },
                "color": {
                  "$ref": "#/$defs/__schema1"
                },
                "note": {
                  "type": "string"
                },
                "shapeId": {
                  "type": "string"
                },
                "x1": {
                  "type": "number"
                },
                "x2": {
                  "type": "number"
                },
                "y1": {
                  "type": "number"
                },
                "y2": {
                  "type": "number"
                }
              },
              "required": [
                "_type",
                "color",
                "note",
                "shapeId",
                "x1",
                "x2",
                "y1",
                "y2"
              ],
              "additionalProperties": false
            },
            {
              "type": "object",
              "properties": {
                "_type": {
                  "type": "string",
                  "const": "text"
                },
                "color": {
                  "$ref": "#/$defs/__schema1"
                },
                "fontSize": {
                  "type": "number"
                },
                "note": {
                  "type": "string"
                },
                "shapeId": {
                  "type": "string"
                },
                "text": {
                  "$ref": "#/$defs/__schema3"
                },
                "textAlign": {
                  "type": "string",
                  "enum": [
                    "start",
                    "middle",
                    "end"
                  ]
                },
                "width": {
                  "type": "number"
                },
                "wrap": {
                  "type": "boolean"
                },
                "x": {
                  "type": "number"
                },
                "y": {
                  "type": "number"
                }
              },
              "required": [
                "_type",
                "color",
                "note",
                "shapeId",
                "text",
                "x",
                "y"
              ],
              "additionalProperties": false
            },
            {
              "type": "object",
              "properties": {
                "_type": {
                  "type": "string",
                  "const": "arrow"
                },
                "color": {
                  "$ref": "#/$defs/__schema1"
                },
                "fromId": {
                  "anyOf": [
                    {
                      "type": "string"
                    },
                    {
                      "type": "null"
                    }
                  ]
                },
                "note": {
                  "type": "string"
                },
                "shapeId": {
                  "type": "string"
                },
                "text": {
                  "type": "string"
                },
                "toId": {
                  "anyOf": [
                    {
                      "type": "string"
                    },
                    {
                      "type": "null"
                    }
                  ]
                },
                "x1": {
                  "type": "number"
                },
                "x2": {
                  "type": "number"
                },
                "y1": {
                  "type": "number"
                },
                "y2": {
                  "type": "number"
                },
                "bend": {
                  "type": "number"
                }
              },
              "required": [
                "_type",
                "color",
                "fromId",
                "note",
                "shapeId",
                "toId",
                "x1",
                "x2",
                "y1",
                "y2"
              ],
              "additionalProperties": false
            },
            {
              "type": "object",
              "properties": {
                "_type": {
                  "type": "string",
                  "const": "note"
                },
                "color": {
                  "$ref": "#/$defs/__schema1"
                },
                "note": {
                  "type": "string"
                },
                "shapeId": {
                  "type": "string"
                },
                "text": {
                  "$ref": "#/$defs/__schema3"
                },
                "x": {
                  "type": "number"
                },
                "y": {
                  "type": "number"
                }
              },
              "required": [
                "_type",
                "color",
                "note",
                "shapeId",
                "x",
                "y"
              ],
              "additionalProperties": false
            },
            {
              "title": "Unknown Shape",
              "description": "A special shape that is not represented by one of the canvas's core shape types. The AI cannot create these shapes, but it *can* interact with them. eg: The AI can move these shapes. The `subType` property contains the internal name of the shape's type.",
              "type": "object",
              "properties": {
                "_type": {
                  "type": "string",
                  "const": "unknown"
                },
                "note": {
                  "type": "string"
                },
                "shapeId": {
                  "type": "string"
                },
                "subType": {
                  "type": "string"
                },
                "x": {
                  "type": "number"
                },
                "y": {
                  "type": "number"
                }
              },
              "required": [
                "_type",
                "note",
                "shapeId",
                "subType",
                "x",
                "y"
              ],
              "additionalProperties": false
            }
          ]
        },
        "__schema1": {
          "type": "string",
          "enum": [
            "red",
            "light-red",
            "green",
            "light-green",
            "blue",
            "light-blue",
            "orange",
            "yellow",
            "black",
            "violet",
            "light-violet",
            "grey",
            "white"
          ]
        },
        "__schema2": {
          "type": "string",
          "enum": [
            "none",
            "tint",
            "background",
            "solid",
            "pattern"
          ]
        },
        "__schema3": {
          "type": "string"
        }
      }
    }
    ```

    :::

    - systemPromptå†…ã«ã¯ã€Œã‚ãªãŸã¯ã€ã‚ã‚‰ã‹ã˜ã‚å®šç¾©ã•ã‚ŒãŸã‚¹ã‚­ãƒ¼ãƒã«åŸºã¥ã„ã¦ã€æ§‹é€ åŒ–ã•ã‚ŒãŸJSONãƒ‡ãƒ¼ã‚¿ã§å¿œç­”ã—ã¾ã™ã€ã¨ã‚ã‚Šã€JSONã‚¹ã‚­ãƒ¼ãƒå®šç¾©ã‚‚æ›¸ã‹ã‚Œã¦ã„ã¾ã™ã€‚
    - ã“ã®JSONãƒ‡ãƒ¼ã‚¿ã‚’clientå´ã§ã¯Parseã—ã¦å¾Œè¿°ã™ã‚‹ `AgentAction` ã¨ã„ã†å½¢ã§ã‚­ãƒ£ãƒ³ãƒã‚¹ã«åæ˜ ã—ã¦ã„ã¾ã™

ã“ã‚Œã§ãƒ—ãƒ­ãƒ³ãƒ—ãƒˆã®æº–å‚™ãŒå‡ºæ¥ãŸã®ã§ã€[ai](https://www.npmjs.com/package/ai) ãƒ‘ãƒƒã‚±ãƒ¼ã‚¸ã® `streamText` ã‚’ä½¿ã£ã¦ãƒ—ãƒ­ãƒ³ãƒ—ãƒˆã‚’æŠ•ã’ã¦ã„ã¾ã™ã€‚ãƒ¬ã‚¹ãƒãƒ³ã‚¹ã‚’é †æ¬¡ Server-Sent Events  ã§ã‚¯ãƒ©ã‚¤ã‚¢ãƒ³ãƒˆã«è¿”ã—ã¦ã„ã‚‹æ§˜ã§ã™ã€‚

## client

æ¬¡ã«ã‚¯ãƒ©ã‚¤ã‚¢ãƒ³ãƒˆå´ã‚’è¦‹ã¦ã¿ã¾ã™ã€‚ã‚³ãƒ³ãƒãƒ¼ãƒãƒ³ãƒˆã®å¤§æ ã¯ `App.tsx` ã§ä»¥ä¸‹ã®ã‚ˆã†ã«å®šç¾©ã•ã‚Œã¦ã„ã¾ã™ã€‚

```tsx
<TldrawUiToastsProvider>
  <div className="tldraw-agent-container">
    <div className="tldraw-canvas">
      <Tldraw
        persistenceKey="tldraw-agent-demo"
        tools={tools}
        overrides={overrides}
        components={components}
      >
        <AppInner setAgent={setAgent} />
      </Tldraw>
    </div>
    <ErrorBoundary fallback={ChatPanelFallback}>
      {agent && <ChatPanel agent={agent} />}
    </ErrorBoundary>
  </div>
</TldrawUiToastsProvider>
```

`<AppInner />` å†…ã®å‡¦ç†ã¯ä»¥ä¸‹ã®æ§˜ã«ãªã£ã¦ã„ã¾ã™ã€‚

```tsx
function AppInner({ setAgent }: { setAgent: (agent: TldrawAgent) => void }) {
  const editor = useEditor()
  const agent = useTldrawAgent(editor, AGENT_ID)

  useEffect(() => {
    if (!editor || !agent) return
    setAgent(agent)
    ;(window as any).editor = editor
    ;(window as any).agent = agent
  }, [agent, editor, setAgent])

  return null
}
```

ã“ã“ã§ã®ãƒã‚¤ãƒ³ãƒˆã¨ã—ã¦ã¯ tldraw ã§å†…éƒ¨ã®APIã«ã‚¢ã‚¯ã‚»ã‚¹ã§ãã‚‹ `Editor` ã‚¤ãƒ³ã‚¹ã‚¿ãƒ³ã‚¹ã‚’å‰ã«ã‚‚å‡ºã¦ããŸ `TldrawAgent` åˆæœŸåŒ–æ™‚ã«æ¸¡ã—ã¦ãŠã‚Šã€AIã‚¨ãƒ¼ã‚¸ã‚§ãƒ³ãƒˆã‹ã‚‰ã®ãƒ¬ã‚¹ãƒãƒ³ã‚¹ã‚’å—ã‘ã¦`Editor` ã‚¤ãƒ³ã‚¹ã‚¿ãƒ³ã‚¹çµŒç”±ã§ãƒœãƒ¼ãƒ‰(TLStore)ã‚’æ“ä½œã—ã¦ã„ã‚‹æ§˜ã§ã™ã€‚

å…¨ä½“ã®ã–ã£ãã‚Šã¨ã—ãŸå›³ã¨ã—ã¦ã¯ä»¥ä¸‹ã«ãªã‚‹ã‹ã¨æ€ã„ã¾ã™ã€‚

![image6.png](/images/bb203aba83e385/image6.png)

ğŸ‘†ã®å›³ã§ã®ã€ŒAgentã‹ã‚‰ã®ãƒ¬ã‚¹ãƒãƒ³ã‚¹ã‚’å¤‰æ›ã€ã™ã‚‹å‡¦ç†ã§ `AgentActionUtil` ã‚’ä½¿ã£ã¦ã„ã¾ã™ã€‚

### AgentActionUtil

å®Ÿéš›ã«ä½•ã‹ã—ã‚‰ãƒœãƒ¼ãƒ‰ã‚’æ›´æ–°ã™ã‚‹Actionã‚’å®šç¾©ã—ãŸã‚‚ã®ã«ãªã£ã¦ã„ãã†ã§ã€ç¾æ™‚ç‚¹(2025/11)ä»¥ä¸‹ã®ActionUtilãŒå­˜åœ¨ã—ã¦ã„ã¾ã™ã€‚

| ActionUtilå | æ©Ÿèƒ½ |
| --- | --- |
| AddDetailActionUtil | Actionã«è©³ç´°ã‚’è¿½åŠ ã™ã‚‹ãŸã‚ã®è¨ˆç”»ã‚’ç«‹ã¦ã‚‹ |
| AlignActionUtil | ã‚·ã‚§ã‚¤ãƒ—ã‚’è»¸ã«æ²¿ã£ã¦æ•´åˆ—(ä¸Šä¸‹å·¦å³ã€ä¸­å¤®) |
| BringToFrontActionUtil | ã‚·ã‚§ã‚¤ãƒ—ã‚’æœ€å‰é¢ã«ç§»å‹• |
| ClearActionUtil | ã‚­ãƒ£ãƒ³ãƒã‚¹ä¸Šã®ã™ã¹ã¦ã®ã‚·ã‚§ã‚¤ãƒ—ã‚’å‰Šé™¤ |
| CountShapesActionUtil | ã‚­ãƒ£ãƒ³ãƒã‚¹ä¸Šã®ã‚·ã‚§ã‚¤ãƒ—æ•°ã‚’ã‚«ã‚¦ãƒ³ãƒˆ |
| CountryInfoActionUtil | å›½ã‚³ãƒ¼ãƒ‰ã‹ã‚‰å›½ã®æƒ…å ±ã‚’å–å¾—(REST Countries APIä½¿ç”¨) |
| CreateActionUtil | æ–°ã—ã„ã‚·ã‚§ã‚¤ãƒ—(å›³å½¢)ã‚’ä½œæˆ |
| DeleteActionUtil | ã‚·ã‚§ã‚¤ãƒ—ã‚’å‰Šé™¤ |
| DistributeActionUtil | ã‚·ã‚§ã‚¤ãƒ—ã‚’æ°´å¹³ã¾ãŸã¯å‚ç›´ã«å‡ç­‰é…ç½® |
| LabelActionUtil | ã‚·ã‚§ã‚¤ãƒ—ã®ãƒ†ã‚­ã‚¹ãƒˆãƒ©ãƒ™ãƒ«ã‚’å¤‰æ›´ |
| MessageActionUtil | ãƒ¦ãƒ¼ã‚¶ãƒ¼ã«ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸ã‚’é€ä¿¡ |
| MoveActionUtil | ã‚·ã‚§ã‚¤ãƒ—ã‚’æ–°ã—ã„ä½ç½®ã«ç§»å‹• |
| PenActionUtil | ãƒšãƒ³ãƒ„ãƒ¼ãƒ«ã§ãƒ•ãƒªãƒ¼ãƒ•ã‚©ãƒ¼ãƒ ã®ç·šã‚’æç”»(smooth/straight ã‚¹ã‚¿ã‚¤ãƒ«å¯¾å¿œ) |
| PlaceActionUtil | ä»–ã®ã‚·ã‚§ã‚¤ãƒ—ã‚’åŸºæº–ã«ã—ãŸç›¸å¯¾ä½ç½®ã«ã‚·ã‚§ã‚¤ãƒ—ã‚’é…ç½® |
| RandomWikipediaArticleActionUtil | ãƒ©ãƒ³ãƒ€ãƒ ãªWikipediaè¨˜äº‹ã‚’å–å¾—ã—ã¦ã‚¤ãƒ³ã‚¹ãƒ”ãƒ¬ãƒ¼ã‚·ãƒ§ãƒ³ã‚’å¾—ã‚‹ |
| ResizeActionUtil | ã‚·ã‚§ã‚¤ãƒ—ã®ã‚µã‚¤ã‚ºã‚’å¤‰æ›´(åŸç‚¹ã‚’åŸºæº–ã«ã‚¹ã‚±ãƒ¼ãƒ«å¤‰æ›´) |
| ReviewActionUtil | ä½œæ¥­çµæœã‚’ç¢ºèªã™ã‚‹ãŸã‚ã®ãƒ¬ãƒ“ãƒ¥ãƒ¼ã‚’ã‚¹ã‚±ã‚¸ãƒ¥ãƒ¼ãƒ« |
| RotateActionUtil | ã‚·ã‚§ã‚¤ãƒ—ã‚’åŸç‚¹ã‚’ä¸­å¿ƒã«å›è»¢ |
| SendToBackActionUtil | ã‚·ã‚§ã‚¤ãƒ—ã‚’æœ€èƒŒé¢ã«ç§»å‹• |
| SetMyViewActionUtil |  AIè‡ªèº«ã®ãƒ“ãƒ¥ãƒ¼ãƒãƒ¼ãƒˆã‚’å¤‰æ›´ã—ã¦ã‚­ãƒ£ãƒ³ãƒã‚¹ã®ä»–ã®ã‚¨ãƒªã‚¢ã«ç§»å‹• |
| StackActionUtil | ã‚·ã‚§ã‚¤ãƒ—ã‚’æ°´å¹³ã¾ãŸã¯å‚ç›´ã«ç©ã¿é‡ã­ã‚‹ |
| ThinkActionUtil | AIã®æ„å›³ã‚„æ¨è«–ã‚’è¨˜è¿° |
| TodoListActionUtil | Todoãƒªã‚¹ãƒˆã‚¢ã‚¤ãƒ†ãƒ ã‚’æ›´æ–°ã¾ãŸã¯ä½œæˆ |
| UnknownActionUtil | æœªçŸ¥ã®ã‚¢ã‚¯ã‚·ãƒ§ãƒ³ã‚¿ã‚¤ãƒ— |
| UpdateActionUtil | æ—¢å­˜ã®ã‚·ã‚§ã‚¤ãƒ—ã‚’æ›´æ–° |

`RandomWikipediaArticleActionUtil` ãªã‚“ã‹ã¯é¢ç™½ã„Actionã§ã™ã­ ğŸ‘€

å„ActionUtilã®ãƒ™ãƒ¼ã‚¹ã‚¯ãƒ©ã‚¹ã®å®Ÿè£…ã¯ä»¥ä¸‹ã«ãªã£ã¦ã„ã¾ã™ã€‚

::: details ã‚½ãƒ¼ã‚¹ã‚³ãƒ¼ãƒ‰

```tsx
export abstract class AgentActionUtil<T extends BaseAgentAction = BaseAgentAction> {
  static type: string

  protected agent?: TldrawAgent
  protected editor?: Editor

  constructor(agent?: TldrawAgent) {
    this.agent = agent
    this.editor = agent?.editor
  }

  /**
   * Get a schema to use for the model's response.
   * @returns The schema, or null to not use a schema
   */
  getSchema(): z.ZodType<T> | null {
    return null
  }

  /**
   * Get information about the action to display within the chat history UI.
   * Return null to not show anything.
   * Defaults to the stringified action if not set.
   */
  getInfo(_action: Streaming<T>): Partial<ChatHistoryInfo> | null {
    return {}
  }

  /**
   * Transforms the action before saving it to chat history.
   * Useful for sanitizing or correcting actions.
   * @returns The transformed action, or null to reject the action
   */
  sanitizeAction(action: Streaming<T>, _helpers: AgentHelpers): Streaming<T> | null {
    return action
  }

  /**
   * Apply the action to the editor.
   * Any changes that happen during this function will be displayed as a diff.
   */
  applyAction(_action: Streaming<T>, _helpers: AgentHelpers): Promise<void> | void {
    // Do nothing by default
  }

  /**
   * Whether the action gets saved to history.
   */
  savesToHistory(): boolean {
    return true
  }

  /**
   * Build a system message that gets concatenated with the other system messages.
   * @returns The system message, or null to not add anything to the system message.
   */
  buildSystemPrompt(): string | null {
    return null
  }
}

export interface AgentActionUtilConstructor<T extends BaseAgentAction = BaseAgentAction> {
  new (agent: TldrawAgent, editor: Editor): AgentActionUtil<T>
  type: T['_type']
}

```

:::

`applyAction` ãƒ¡ã‚½ãƒƒãƒ‰ã§å®Ÿéš›ã«Actionã‚’é©ç”¨ã—ã¦ã„ã‚‹ã‚ˆã†ã§ã€`TldrawAgent` ãŒä¿æŒã—ã¦ã„ã‚‹ `Editor` ã‚’é€šã˜ã¦é©ç”¨ã—ã¦ã„ã‚‹æ§˜ã§ã™ã€‚

ä¾‹): BringToFrontActionUtil

```tsx
  override applyAction(action: Streaming<BringToFrontAction>) {
    if (!this.agent) return

    if (!action.shapeIds) return
    this.agent.editor.bringToFront(
      action.shapeIds.map((shapeId) => `shape:${shapeId}` as TLShapeId)
    )
  }
```

# ã¾ã¨ã‚

å…¨ä½“ã¨ã—ã¦ã€Agent starter kit ã¯ã€Œtldraw ã®ã‚­ãƒ£ãƒ³ãƒã‚¹çŠ¶æ…‹ â†’ ãƒ—ãƒ­ãƒ³ãƒ—ãƒˆåŒ– â†’ LLM ã® JSON ãƒ¬ã‚¹ãƒãƒ³ã‚¹ â†’ Editor æ“ä½œã€ã¨ã„ã†ä¸€é€£ã®ãƒ‘ã‚¤ãƒ—ãƒ©ã‚¤ãƒ³ãŒãã‚Œã„ã«åˆ†å‰²ã•ã‚Œã¦ã„ã¦ã€è‡ªåˆ†ã§ç‹¬è‡ªã®ã‚¢ã‚¯ã‚·ãƒ§ãƒ³ã‚„ãƒ—ãƒ­ãƒ³ãƒ—ãƒˆãƒ‘ãƒ¼ãƒ„ã‚’å·®ã—è¾¼ã‚“ã§æ‹¡å¼µã—ã¦ã‚‚é¢ç™½ãã†ã¨ã„ã†å°è±¡ã§ã—ãŸã€‚
