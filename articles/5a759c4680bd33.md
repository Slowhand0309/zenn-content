---
title: "pnpm + vite + vitest + react + remixã§monorepo projectã‚»ãƒƒãƒˆã‚¢ãƒƒãƒ—"
emoji: "ğŸ—ï¸"
type: "tech" # tech: æŠ€è¡“è¨˜äº‹ / idea: ã‚¢ã‚¤ãƒ‡ã‚¢
topics:
  - "remix"
  - "vite"
  - "vitest"
  - "react"
  - "pnpm"
published: true
---
# æ¦‚è¦

ä»Šå›ã¯monorepoæ§‹æˆã®ãƒ—ãƒ­ã‚¸ã‚§ã‚¯ãƒˆã‚’ `frontend` é…ä¸‹ã«ä½œæˆã™ã‚‹ã¨ã„ã†å½¢ã§pnpm + vite + vitest + react + remixã®æ§‹æˆã§è©¦ã—ã¦ã¿ãŸã„ã¨æ€ã„ã¾ã™ã€‚

ã¾ãŸã€ã‚­ãƒ£ãƒƒãƒã‚¢ãƒƒãƒ—ã®ç‚ºremixã®å°å…¥ã‚’ä¸€ã‹ã‚‰è¡ŒãŠã†ã¨æ€ã†ã®ã§ã€æœ€åˆ pnpm + vite + vitest + react æ§‹æˆã§ãƒ—ãƒ­ã‚¸ã‚§ã‚¯ãƒˆã‚’ä½œæˆã—ã€å¾Œã‹ã‚‰remixã‚’å°å…¥ã—ã¦ã¿ãŸã„ã¨æ€ã„ã¾ã™ã€‚

# ç’°å¢ƒæ§‹ç¯‰

devcontainerã§ã®é–‹ç™ºç’°å¢ƒã‚’æ§‹ç¯‰ã—ã¦ã„ãã¾ã™ã€‚ `.devcontainer` ãƒ‡ã‚£ãƒ¬ã‚¯ãƒˆãƒªé…ä¸‹ã«æ¬¡ã®ãƒ•ã‚¡ã‚¤ãƒ«ã‚’ä½œæˆã—ã¦ã„ãã¾ã™ã€‚

- Dockerfile

    ```docker
    FROM node:20.10.0-bullseye-slim
    LABEL maintainer="Slowhand0309"
    
    ARG username=vscode
    ARG useruid=1000
    ARG usergid=${useruid}
    
    RUN set -ex \
        && apt-get update \
        && apt-get install -y \
            sudo \
            --no-install-recommends \
        # Delete node user with uid=1000 and create vscode user with uid=1000
        && userdel -r node \
        && groupadd --gid ${usergid} ${username} \
        && useradd -s /bin/bash --uid ${useruid} --gid ${usergid} -m ${username} \
        && echo ${username} ALL=\(root\) NOPASSWD:ALL > /etc/sudoers.d/${username} \
        && chmod 0440 /etc/sudoers.d/${username}
    
    USER ${username}
    ```

- docker-compose.yml (imageåãªã©ã¯é©å®œä¿®æ­£)

    ```yaml
    version: '3.8'
    volumes:
      modules_data:
    
    services:
      app:
        build: .
        image: slowhand/nodejs
        container_name: "nodejs"
        volumes:
          - ..:/usr/src
          - modules_data:/usr/src/node_modules
        command: /bin/sh -c "while sleep 1000; do :; done"
        working_dir: /usr/src
    ```

- devcontainer.json (extensionsã‚„settingsã¯ãŠå¥½ã¿ã§)

    ```json
    {
      "name": "Node.js remote container dev",
      "dockerComposeFile": ["docker-compose.yml"],
      "service": "app",
      "workspaceFolder": "/usr/src",
      "customizations": {
        "vscode": {
          "extensions": [
            "dbaeumer.vscode-eslint",
            "esbenp.prettier-vscode"
          ],
          "settings": {
            "editor.tabSize": 2,
            "editor.formatOnSave": true,
            "editor.codeActionsOnSave": {
                "source.fixAll.eslint": "always"
            },
            "files.insertFinalNewline": true,
            "files.trimFinalNewlines": true
          }
        }
      },
      "features": {
        "ghcr.io/devcontainers/features/git:1": {}
      },
      "postAttachCommand": ".devcontainer/postAttach.sh",
      "remoteUser": "vscode"
    }
    ```

- postAttach.sh

    ```bash
    #!/bin/sh
    
    cd `dirname $0`
    cd ..
    sudo chown -R vscode node_modules
    ```

ä¸Šè¨˜ãƒ•ã‚¡ã‚¤ãƒ«ã‚’æº–å‚™ã—ã€VSCodeã§é–‹ã`ã‚³ãƒ³ãƒ†ãƒŠãƒ¼ã§å†åº¦é–‹ã` ã§ã‚³ãƒ³ãƒ†ãƒŠã‚’èµ·å‹•ã—nodejsãŒã‚¤ãƒ³ã‚¹ãƒˆãƒ¼ãƒ«ã•ã‚ŒãŸé–‹ç™ºç’°å¢ƒãŒç«‹ã¡ä¸ŠãŒã‚Šã¾ã™ã€‚

â†‘ã®é–‹ç™ºç’°å¢ƒã¯ä»¥ä¸‹ã«ãƒ†ãƒ³ãƒ—ãƒ¬ãƒ¼ãƒˆãƒªãƒã‚¸ãƒˆãƒªä½œæˆã—ã¦ã„ã‚‹ã®ã§å¿…è¦ã‚ã‚Œã°ä½¿ã£ã¦é ‚ã‘ã‚Œã°ã¨æ€ã„ã¾ã™ã€‚

https://github.com/Slowhand0309/nodejs-devcontainer-boilerplate

# frontend ãƒ‡ã‚£ãƒ¬ã‚¯ãƒˆãƒªå†…ã«Vite+Reactãƒ—ãƒ­ã‚¸ã‚§ã‚¯ãƒˆä½œæˆ

ã“ã“ã‹ã‚‰ã¯ã‚³ãƒ³ãƒ†ãƒŠå†…ã§ä½œæ¥­ã—ã¦ã„ãã¾ã™ã€‚

## å°å…¥

- `package.json` ã¨ `pnpm-workspace.yaml` ã®ä½œæˆ

```bash
npm init
touch pnpm-workspace.yaml
```

- `pnpm-workspace.yaml` ã‚’æ›´æ–°

```yaml
packages:
  - "frontend/**"
```

- vite + react + typescriptã®projectã‚’ä½œæˆ

```bash
pnpm create vite frontend --template react-ts
```

â€» `Error: ENOENT: no such file or directory, copyfile ~` ãŒç™ºç”Ÿã—ãŸã‚‰

```bash
pnpm store prune
pnpm i
```

https://github.com/pnpm/pnpm/issues/4997

## æ—©é€Ÿèµ·å‹•ã•ã›ã¦ã¿ã‚‹

```bash
cd frontend
pnpm i
```

ãƒ—ãƒ­ã‚¸ã‚§ã‚¯ãƒˆãƒ«ãƒ¼ãƒˆã® `package.json` ã® `sctipts` ã«ä»¥ä¸‹ã‚’è¿½åŠ 

```json
"scripts": {
    "dev": "pnpm  --parallel --filter \"./**\" dev --host=0.0.0.0"
  },
```

`postAttach.sh` ã‚’ä»¥ä¸‹ã«ä¿®æ­£

```bash
#!/bin/sh

cd `dirname $0`
cd ..
sudo chown -R vscode node_modules

pnpm install
pnpm run dev
```

VSCodeã‚’èµ·å‹•ã—ã€`ã‚³ãƒ³ãƒ†ãƒŠãƒ¼ã§å†åº¦é–‹ã` ã§ã‚³ãƒ³ãƒ†ãƒŠã‚’èµ·å‹•ã—ã¾ã™ã€‚

[http://localhost:5173/](http://localhost:5173/) ã«ã‚¢ã‚¯ã‚»ã‚¹ã—ã€ä»¥ä¸‹ã®ç”»é¢ãŒè¡¨ç¤ºã•ã‚Œã¦ã„ã‚Œã°OKã§ã™ã€‚

![image1](/images/5a759c4680bd33/image1.png =350x)

# Vitestã‚’å°å…¥ã™ã‚‹

https://vitest.dev/

- Viteã¨åŒã˜æ§‹æˆã‚’åˆ©ç”¨ã—ã¦ãƒ†ã‚¹ãƒˆã‚’å®Ÿè¡Œã§ãã‚‹
- Jestã¨äº’æ›ãŒã‚ã‚‹
- watchãƒ¢ãƒ¼ãƒ‰ãŒé«˜ã„ãƒ‘ãƒ•ã‚©ãƒ¼ãƒãƒ³ã‚¹ã‚’æŒã¤
- ESMã¨TypeScriptã¨JSXãŒã‚µãƒãƒ¼ãƒˆã•ã‚Œã¦ã„ã‚‹

## å°å…¥

ã¾ãšã¯ãƒ«ãƒ¼ãƒˆãƒ‡ã‚£ãƒ¬ã‚¯ãƒˆãƒªã‹ã‚‰ `frontend` ã¸å‘ã‘ã¦æ“ä½œã§ãã‚‹ã‚ˆã†ã«ã™ã‚‹ç‚ºã€ `package.json` ã® `scripts` ã«ä»¥ä¸‹ã‚’è¿½åŠ ã—ã¾ã™ã€‚

```json
  "scripts": {
    "frontend": "pnpm -F \"frontend\""
  },
```

ã“ã‚Œã§ `pnpm frontend xxxx` ã§ `frontend` ã«å‘ã‘ã¦ã‚³ãƒãƒ³ãƒ‰å®Ÿè¡Œã§ãã¾ã™ã€‚

æ—©é€Ÿã‚¤ãƒ³ã‚¹ãƒˆãƒ¼ãƒ«ã—ã¦ã„ãã¾ã™ã€‚

```bash
pnpm frontend add -D vitest
```

æ¬¡ã« `frontend/vite.config.ts` ã‚’ç·¨é›†ã—ã¦ã„ãã¾ã™ã€‚

```tsx
/// <reference types="vitest" />
import react from '@vitejs/plugin-react';
import { defineConfig } from 'vite';

// https://vitejs.dev/config/
export default defineConfig({
  plugins: [react()],
  test: {
    include: ['src/**/*.{test,spec}.{js,mjs,cjs,ts,mts,cts,jsx,tsx}'],
  },
});

```

æ¬¡ã« `frontend/package.json` ã® `scripts` ã«ä»¥ä¸‹ã‚’è¿½åŠ ã—ã¾ã™ã€‚

```json
{
  "scripts": {
    // ...
    "test": "vitest",
    "coverage": "vitest run --coverage"
  }
}
```

ãƒ—ãƒ­ã‚¸ã‚§ã‚¯ãƒˆãƒ«ãƒ¼ãƒˆã® `package.json` ã«ä»¥ä¸‹ã‚’è¿½åŠ ã—ã¾ã™ã€‚

```json
{
  "scripts": {
    // ...
    "test": "pnpm  --parallel --filter \"./**\" test",
    // ...
  }
}
```

è©¦ã—ã«ä»¥ä¸‹ã®ã‚ˆã†ãªãƒ†ã‚¹ãƒˆã‚’ `frontend` é…ä¸‹ã«ä½œæˆã—ã€ãƒ—ãƒ­ã‚¸ã‚§ã‚¯ãƒˆãƒ«ãƒ¼ãƒˆã‹ã‚‰ `pnpm test` ã§å®Ÿè¡Œã§ãã‚Œã°OKã§ã™ã€‚

```tsx
import { expect, it } from 'vitest';

it('add', () => {
  expect(1 + 1).toBe(2);
});

```

# Remix ã‚’å°å…¥ã™ã‚‹

https://remix.run/

Remixã¨ã¯?

> Remixã¯ã€ãƒ¢ãƒ€ãƒ³ãªWebã‚¢ãƒ—ãƒªã‚±ãƒ¼ã‚·ãƒ§ãƒ³ã‚’æ§‹ç¯‰ã™ã‚‹ãŸã‚ã®ãƒ•ãƒ«ã‚¹ã‚¿ãƒƒã‚¯ã®Webãƒ•ãƒ¬ãƒ¼ãƒ ãƒ¯ãƒ¼ã‚¯ã§ã™ã€‚ã“ã‚Œã¯ã€é«˜é€Ÿãªãƒšãƒ¼ã‚¸ãƒ­ãƒ¼ãƒ‰ã€ç”Ÿç”£çš„ãªé–‹ç™ºä½“é¨“ã€å¼·åŠ›ãªãƒ‡ãƒ¼ã‚¿ãƒ•ã‚§ãƒƒãƒãƒ³ã‚°ã¨åŒæœŸã®ãƒ¡ã‚«ãƒ‹ã‚ºãƒ ã‚’æä¾›ã—ã€Reactã‚’ãƒ™ãƒ¼ã‚¹ã«ã—ã¦ã„ã¾ã™ã€‚Remixã¯ã€ã‚µãƒ¼ãƒãƒ¼ãƒ¬ãƒ³ãƒ€ãƒªãƒ³ã‚°ã¨ã‚¨ãƒ³ãƒ‰ãƒ„ãƒ¼ã‚¨ãƒ³ãƒ‰ã®ã‚¢ãƒ—ãƒªã‚±ãƒ¼ã‚·ãƒ§ãƒ³ã‚¢ãƒ¼ã‚­ãƒ†ã‚¯ãƒãƒ£ã‚’å¼·èª¿ã—ã€Webãƒ—ãƒ©ãƒƒãƒˆãƒ•ã‚©ãƒ¼ãƒ ã®æ©Ÿèƒ½ã‚’æœ€å¤§é™ã«æ´»ç”¨ã™ã‚‹ã“ã¨ã«ç„¦ç‚¹ã‚’å½“ã¦ã¦ã„ã¾ã™ã€‚

## å°å…¥

- ãƒ‘ãƒƒã‚±ãƒ¼ã‚¸ã‚¤ãƒ³ã‚¹ãƒˆãƒ¼ãƒ«

```bash
pnpm frontend add @remix-run/node @remix-run/react @remix-run/serve isbot@4
pnpm frontend add -D @remix-run/dev
```

- `vite.config.js` ã®ä¿®æ­£

```jsx
import { vitePlugin as remix } from '@remix-run/dev'; // è¿½åŠ 
import { defineConfig } from 'vite';

// https://vitejs.dev/config/
export default defineConfig({
  plugins: [remix()] // react() -> remix() ã«å¤‰æ›´
});

```

- `app/root.tsx` ã‚’ä»¥ä¸‹å†…å®¹ã§ä½œæˆ

```tsx
import { Links, Meta, Outlet, Scripts } from '@remix-run/react';

export default function App() {
  return (
    <html>
      <head>
        <link rel="icon" href="data:image/x-icon;base64,AA" />
        <Meta />
        <Links />
      </head>
      <body>
        <h1>Hello world!</h1>
        <Outlet />

        <Scripts />
      </body>
    </html>
  );
}

```

å…ƒã€…ã‚ã£ãŸ `src` ãƒ‡ã‚£ãƒ¬ã‚¯ãƒˆãƒªã¯ã“ã“ã§å‰Šé™¤ã—ã¾ã™ã€‚

- `tsconfig.json` ã®ä¿®æ­£

```json
{
  // ...
  "include": ["app"],  // src -> app ã«å¤‰æ›´
  // ...
}
```

- `frontend/package.json` ã® `scripts` ã‚’ä¿®æ­£

```json
  "scripts": {
    "dev": "remix vite:dev",
    "build": "remix vite:build",
    "lint": "eslint . --ext ts,tsx --report-unused-disable-directives --max-warnings 0",
    "start": "remix-serve build/server/index.js"
  },
```

ã“ã“ã¾ã§ã§remixå°å…¥ãŒå®Œäº†ã—ã¾ã—ãŸã€‚ `pnpm dev` ã‚’å®Ÿæ–½ã—ã€[http://localhost:5173](http://localhost:5173/) ã‚’ãƒ–ãƒ©ã‚¦ã‚¶ã§é–‹ã„ã¦  `app/route.tsx` ã®å†…å®¹ãŒè¡¨ç¤ºã•ã‚Œã‚Œã°OKã§ã™ã€‚

## ãã®ä»–ä¾¿åˆ©è¨­å®š

### installGlobals ã®å°å…¥

https://remix.run/docs/en/main/other-api/node

ãƒ†ã‚¹ãƒˆãªã©ã€Node.jsã§ "fetch", "Response", "Requestâ€ ãªã©ã®WebAPIã‚’ä½¿ã†éš›ã«è‡ªå‹•çš„ã«Polyfillã—ã¦ãã‚Œã‚‹ã€‚

`vite.config.js` ã«ä»¥ä¸‹ã‚’è¿½åŠ ã€‚

```jsx
import { installGlobals } from '@remix-run/node'; // è¿½åŠ 

installGlobals(); // è¿½åŠ 

export default defineConfig({
// ....
});
```

### vite-tsconfig-paths

https://chaika.hatenablog.com/entry/2022/05/14/083000

# å‚è€ƒURL

[pnpmã§vite, react, typescriptã®projectã‚’ä½œæˆã™ã‚‹ - Qiita](https://qiita.com/Gma_Gama/items/80fd28a2316e2ee4a30d)

[ãƒ¢ãƒãƒ¬ãƒã«ãŠã‘ã‚‹back/fronté–“ã®Prismaã®å‹å…±æœ‰ã®æ–¹æ³•](https://zenn.dev/takky94/articles/23f4c814432208)