---
title: "ã€Androidã€‘Ktor+Hiltã§APIã‚¯ãƒ©ã‚¤ã‚¢ãƒ³ãƒˆå®Ÿè£…"
emoji: "ğŸ›¸"
type: "tech" # tech: æŠ€è¡“è¨˜äº‹ / idea: ã‚¢ã‚¤ãƒ‡ã‚¢
topics:
  - "android"
  - "kotlin"
  - "ktor"
  - "compose"
published: true
---
# æ¦‚è¦

https://zenn.dev/slowhand/articles/d6f08410c6d698

å‰å›ã®ç¶šãã«ãªã‚Šã¾ã™ã€‚ä»Šå›ã¯ã•ã‚‰ã«Hiltã‚’ä½¿ã£ã¦DIã§ãã‚‹ã‚ˆã†ã«ã—ãŸã‚Šã€ãã®ä»–ç´°ã‹ã„éƒ¨åˆ†ã®å®Ÿè£…ã‚’é€²ã‚ã¦ã„ãã¾ã™ã€‚

# ç’°å¢ƒæ§‹ç¯‰ã‚„æº–å‚™

å„ãƒãƒ¼ã‚¸ãƒ§ãƒ³ã‚„ç’°å¢ƒ

```txt
# Android Studio Jellyfish | 2023.3.1
$ sw_vers
ProductName: macOS
ProductVersion: 14.5
BuildVersion: 23F79
```

ãƒ—ãƒ­ã‚¸ã‚§ã‚¯ãƒˆã¯å‰å›ã®ã‚‚ã®ã‚’ç¶™ç¶šã—ã¦ä½¿ã†æƒ³å®šã§é€²ã‚ã¦ã„ãã¾ã™ã€‚

ã¾ãŸã€ä»Šå›ã¯ğŸ‘‡ã®ç„¡æ–™ã§ä½¿ãˆã‚‹ãƒ¢ãƒƒã‚¯ç”¨ã®APIã‚’ä½¿ã„ã¾ã™ã€‚

https://jsonplaceholder.typicode.com/todos/1

## 1. Hiltã®ã‚¤ãƒ³ã‚¹ãƒˆãƒ¼ãƒ«

### 1-1. `gradle/libs.versions.toml` ã«ä»¥ä¸‹ã‚’è¿½åŠ 

```toml
[versions]
# â€» kotlinã®versionã¯ "2.0.0"
hilt = "2.51.1"
ksp = "2.0.0-1.0.22"

[libraries]
# ktor
ktor-client-content-negotiation = { module = "io.ktor:ktor-client-content-negotiation", version.ref = "ktor" }
ktor-client-serialization-kotlinx-json = { module = "io.ktor:ktor-serialization-kotlinx-json", version.ref = "ktor" }

# hilt
hilt-android = { module = "com.google.dagger:hilt-android", version.ref = "hilt" }
hilt-compiler = { module = "com.google.dagger:hilt-android-compiler", version.ref = "hilt" }

[plugins]
# kotlin 2.0.0 å¯¾å¿œ
compose-compiler = { id = "org.jetbrains.kotlin.plugin.compose", version.ref = "kotlin" }

jetbrains-kotlin-plugin-serialization = { id = "org.jetbrains.kotlin.plugin.serialization", version.ref = "kotlin" }

ksp-gradle-plugin = { id = "com.google.devtools.ksp", version.ref = "ksp" }
hilt-android-gradle-plugin = { id = "com.google.dagger.hilt.android", version.ref = "hilt" }
```

ä»Šå›ã¯ [kotlin.serialization](https://kotlinlang.org/docs/serialization.html) ã‚‚ä½¿ã†ãŸã‚è¿½åŠ ã—ã¦ã¾ã™ã€‚

ã¾ãŸ `io.ktor:ktor-client-content-negotiation` ã¨ `io.ktor:ktor-serialization-kotlinx-json` ã«é–¢ã—ã¦ã¯ã‚¯ãƒ©ã‚¤ã‚¢ãƒ³ãƒˆã¨ã‚µãƒ¼ãƒãƒ¼é–“ã®ãƒ¡ãƒ‡ã‚£ã‚¢ ã‚¿ã‚¤ãƒ—ã®ãƒã‚´ã‚·ã‚¨ãƒ¼ã‚·ãƒ§ãƒ³ã¨ã€JSON å½¢å¼ã§ã®å¿œç­”ã®ã‚·ãƒªã‚¢ãƒ«åŒ–/é€†ã‚·ãƒªã‚¢ãƒ«åŒ–ã®ãŸã‚ã«ä½¿ç”¨ã•ã‚Œã¾ã™ã€‚

### 1-2. `build.gradle.kts` ã«ä»¥ä¸‹ã‚’è¿½åŠ 

```kotlin
plugins {
    alias(libs.plugins.jetbrains.kotlin.plugin.serialization) apply false
    alias(libs.plugins.ksp.gradle.plugin) apply false
    alias(libs.plugins.hilt.android.gradle.plugin) apply false
    alias(libs.plugins.compose.compiler) apply false
}
```

### **1-3. `app/build.gradle.kts` ã«ä»¥ä¸‹ã‚’è¿½åŠ **

```kotlin
plugins {
    alias(libs.plugins.jetbrains.kotlin.plugin.serialization)
    alias(libs.plugins.ksp.gradle.plugin)
    alias(libs.plugins.hilt.android.gradle.plugin)
    alias(libs.plugins.compose.compiler)
}

dependencies {
    // ktor
    implementation(libs.ktor.client.content.negotiation)
    implementation(libs.ktor.client.serialization.kotlinx.json)

    // hilt
    implementation(libs.hilt.android)
    ksp(libs.hilt.compiler)
}
```

## 2. Hiltã®ã‚»ãƒƒãƒˆã‚¢ãƒƒãƒ—

### 1-1. Hiltã‚¢ãƒ—ãƒªã‚±ãƒ¼ã‚·ãƒ§ãƒ³ã‚¯ãƒ©ã‚¹ã®ä½œæˆ

`MainApplication.kt` ã‚’ä»¥ä¸‹å†…å®¹ã§ä½œæˆã—ã¾ã™ã€‚

```kotlin
@HiltAndroidApp
class MainApplication : Application() {
    override fun onCreate() {
        super.onCreate()
    }
}
```

`AndroidManifest.xml` ã«ä»¥ä¸‹ã‚’è¿½åŠ ã—ã¾ã™ã€‚

```xml
<?xml version="1.0" encoding="utf-8"?>
<manifest xmlns:android="http://schemas.android.com/apk/res/android"
    xmlns:tools="http://schemas.android.com/tools">
    <uses-permission android:name="android.permission.INTERNET" />
    <application
        ....
        android:name=".MainApplication" â† è¿½åŠ 
        >
```

### 1-2. @AndroidEntryPoint ã®è¨­å®š

`MainActivity` ã« `@AndroidEntryPoint` ã‚’è¨­å®šã—ã¾ã™ã€‚

```kotlin
@AndroidEntryPoint
class MainActivity : ComponentActivity() {
  // ...
```

### 1-3. Hiltãƒ¢ã‚¸ãƒ¥ãƒ¼ãƒ«ã®ä½œæˆ

ä»¥ä¸‹å†…å®¹ã§ `ApiModule` ã‚’ä½œæˆã—ã¾ã™ã€‚

```kotlin
@Module
@InstallIn(SingletonComponent::class)
object ApiModule {
    @Singleton
    @Provides
    fun provideHttpClient(): HttpClient {
        return HttpClient(OkHttp){
            install(DefaultRequest){
                url("https://jsonplaceholder.typicode.com")
                header(HttpHeaders.ContentType, ContentType.Application.Json)
            }
            install(ContentNegotiation){
                json(Json)
            }
            engine {
                addInterceptor(HttpLoggingInterceptor().apply {
                    level = HttpLoggingInterceptor.Level.BASIC
                })
            }
        }
    }
}
```

## 3. Serviceã‚¯ãƒ©ã‚¹å®Ÿè£…

### 3-1. Resultã‚¯ãƒ©ã‚¹å®šç¾©

APIç”¨ã®Resultã‚¯ãƒ©ã‚¹ã‚’ä»¥ä¸‹å†…å®¹ã§ä½œæˆã—ã¨ãã¾ã™ã€‚

```kotlin
sealed class ApiResult<T>(val data: T? = null, val error: String? = null){
    class Success<T>(todo: T):ApiResult<T>(data = todo)
    class Error<T>(error: String):ApiResult<T>(error = error)
    class Loading<T>:ApiResult<T>()
}
```

### 3-2. ãƒ¢ãƒ‡ãƒ«å®Ÿè£…

ä»¥ä¸‹å†…å®¹ã§ `Todo.kt` ã‚’ä½œæˆã—ã¾ã™ã€‚

```kotlin
package com.example.ktorexample.data

@kotlinx.serialization.Serializable
data class Todo(
    val id: Int,
    val userId: Int,
    val title: String,
    val completed: Boolean
)
```

### 3-2. TodoServiceã‚¯ãƒ©ã‚¹å®Ÿè£…

å®Ÿéš›ã«ãƒªã‚¯ã‚¨ã‚¹ãƒˆã™ã‚‹å‡¦ç†ã® `TodoService.kt` ã‚’ä»¥ä¸‹å†…å®¹ã§ä½œæˆã—ã¾ã™ã€‚

```kotlin
class TodoService @Inject constructor(private val client: HttpClient) {
    suspend fun todo(id: Int): Flow<ApiResult<Todo>> = flow {
        emit(ApiResult.Loading())
        try {
            val response = client.get("/todos/$id")
            emit(ApiResult.Success(response.body()))
        } catch (e: Exception) {
            emit(ApiResult.Error(e.message ?: "Something went wrong"))
        }
    }
}
```

## 4. Composeéƒ¨åˆ†ã«åæ˜ 

æœ€å¾Œã« `MainActivity.kt` ã‚’ä»¥ä¸‹å†…å®¹ã«ä¿®æ­£ã—ã¾ã™ã€‚

```kotlin
@AndroidEntryPoint
class MainActivity : ComponentActivity() {
    @Inject
    lateinit var todoService: TodoService

    override fun onCreate(savedInstanceState: Bundle?) {
        super.onCreate(savedInstanceState)
        enableEdgeToEdge()
        setContent {
            KtorExampleTheme {
                Scaffold(modifier = Modifier.fillMaxSize()) { innerPadding ->
                    val scope = rememberCoroutineScope()
                    var todo by remember { mutableStateOf<Todo?>(null) }
                    LaunchedEffect(true) {
                        scope.launch {
                            try {
                                todoService.todo(1).collect { todo = it.data }
                            } catch (e: Exception) {
                                e.localizedMessage ?: "error"
                            }
                        }
                    }
                    Todo(
                        todo = todo,
                        modifier = Modifier.padding(innerPadding)
                    )
                }
            }
        }
    }
}

@Composable
fun Todo(todo: Todo?, modifier: Modifier = Modifier) {
    Text(
        text = "Todo: ${todo?.title}",
        modifier = modifier
    )
}
```

å®Ÿéš›ã«èµ·å‹•ã—ã¦ã¿ã‚‹ã¨ğŸ‘‡ã®ã‚ˆã†ã«ãƒ¬ã‚¹ãƒãƒ³ã‚¹ã® `title` éƒ¨åˆ†ãŒåæ˜ ã•ã‚Œã¦ã„ã‚Œã°OKã§ã™ã€‚

![image1.png](/images/6114b3ead2beb6/image1.png =350x)

# å‚è€ƒURL

https://medium.com/@ominoblair/ktor-hilt-flow-in-android-bf116a630c3b

https://github.com/monjur35/Ktor-Client