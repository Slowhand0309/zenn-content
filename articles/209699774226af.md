---
title: "SupabaseCLIã§ãƒ­ãƒ¼ã‚«ãƒ«ç’°å¢ƒæ§‹ç¯‰"
emoji: "ğŸ‘‹"
type: "tech" # tech: æŠ€è¡“è¨˜äº‹ / idea: ã‚¢ã‚¤ãƒ‡ã‚¢
topics:
  - "supabase"
  - "nextjs"
  - "React"
  - "TypeScript"
published: true
---

# æ¦‚è¦

[Supabase CLI | Supabase Docs](https://supabase.com/docs/guides/cli)

Supabase CLIã¯ã€é–‹ç™ºè€…ãŒSupabaseã®ãƒ—ãƒ­ã‚¸ã‚§ã‚¯ãƒˆã‚’ãƒ­ãƒ¼ã‚«ãƒ«ç’°å¢ƒã§æ§‹ç¯‰ã€ç®¡ç†ã€ãƒ‡ãƒãƒƒã‚°ã—ãŸã‚Šã€app.supabase.com ã®ãƒ—ãƒ­ã‚¸ã‚§ã‚¯ãƒˆã¨ãƒªãƒ³ã‚¯ã—ãŸç®¡ç†ã§ãã‚‹ãƒ„ãƒ¼ãƒ«ã§ã™ã€‚

ã“ã®è¨˜äº‹ã§ã¯ã€Supabase CLIã®è¨­å®šã¨ä½¿ç”¨æ–¹æ³•ã‹ã‚‰å§‹ã‚ã€ãƒ‡ãƒ¼ã‚¿ãƒ™ãƒ¼ã‚¹ã®ãƒã‚¤ã‚°ãƒ¬ãƒ¼ã‚·ãƒ§ãƒ³æ‰‹æ³•ã€ãã—ã¦ãƒ­ãƒ¼ã‚«ãƒ«ã§èµ·å‹•ã—ãŸSupabaseç’°å¢ƒã¸ã®ã‚¯ãƒ©ã‚¤ã‚¢ãƒ³ãƒˆã‹ã‚‰ã®æ¥ç¶šã¾ã§ã‚’è©¦ã—ãŸéš›ã®è¨˜äº‹ã«ãªã‚Šã¾ã™ã€‚

## æ¤œè¨¼ç’°å¢ƒ

```bash
$ sw_vers
ProductName:      macOS
ProductVersion:   13.4
BuildVersion:     22F66

$ supabase --version
1.64.8
```

## ã‚¤ãƒ³ã‚¹ãƒˆãƒ¼ãƒ«

npmãƒ‘ãƒƒã‚±ãƒ¼ã‚¸ã‚„ã€Mac Windows Linux å‘ã‘ã«ãƒã‚¤ãƒŠãƒªãŒæä¾›ã•ã‚Œã¦ã„ã¾ã™ã€‚

[https://supabase.com/docs/guides/cli#installation](https://supabase.com/docs/guides/cli#installation)

ä»Šå›ã¯Macã®ç’°å¢ƒãªã®ã§Homebrewã‚’ä½¿ã£ã¦ã‚¤ãƒ³ã‚¹ãƒˆãƒ¼ãƒ«ã—ã¦ã„ãã¾ã™ã€‚

```bash
brew install supabase/tap/supabase
```

# [Local Development](https://supabase.com/docs/guides/getting-started/local-development)

ä¸Šè¨˜ã‚’å‚è€ƒã«ã—ãªãŒã‚‰ãƒ­ãƒ¼ã‚«ãƒ«ã§ã®Supabaseç’°å¢ƒã®æ§‹ç¯‰ã‚’é€²ã‚ã¦ã€CLIã‚’è©¦ã—ã¦ã„ããŸã„ã¨æ€ã„ã¾ã™ã€‚

## ****supabase login****

[https://supabase.com/docs/reference/cli/supabase-login](https://supabase.com/docs/reference/cli/supabase-login)

Supabaseã§ã‚¢ã‚«ã‚¦ãƒ³ãƒˆç™»éŒ²ã—ãŸã‚¢ã‚«ã‚¦ãƒ³ãƒˆã«å¯¾ã—ã¦ãƒ­ã‚°ã‚¤ãƒ³ã‚’è¡Œã†äº‹ãŒã§ãã¾ã™ã€‚

ç‰¹ã«ãƒ—ãƒ­ã‚¸ã‚§ã‚¯ãƒˆã‚’ãƒªãƒ³ã‚¯ã•ã›ã‚‹å¿…è¦ãŒãªãã€ãƒ­ãƒ¼ã‚«ãƒ«ã ã‘ã§å®Œçµã™ã‚‹å ´åˆã¯å¿…è¦ãªã„ã§ã™ã€‚

äº‹å‰ã«[ã“ã¡ã‚‰](https://supabase.com/dashboard/account/tokens)ã‹ã‚‰AccessTokenã‚’ç”Ÿæˆã—ã¦ãŠãã¾ã™ã€‚

![image1](/images/209699774226af/image1.png =600x)

ã‚³ãƒãƒ³ãƒ‰ã‚’å®Ÿè¡Œã™ã‚‹ã¨AccessTokenãŒæ±‚ã‚ã‚‰ã‚Œã‚‹ã®ã§ãƒšãƒ¼ã‚¹ãƒˆã—ãƒ­ã‚°ã‚¤ãƒ³ã—ã¦ãŠãã¾ã™ã€‚

```bash
supabase login
You can generate an access token from https://app.supabase.com/account/tokens
Enter your access token:
Finished supabase login.
```

èªè¨¼æƒ…å ±ã¯MacOSã ã¨Keychainã«ä¿å­˜ã•ã‚Œã¦ã„ã¾ã—ãŸã€‚

`supabase projects list` ã§è©²å½“ã‚¢ã‚«ã‚¦ãƒ³ãƒˆã®ãƒ—ãƒ­ã‚¸ã‚§ã‚¯ãƒˆä¸€è¦§ãŒè¡¨ç¤ºã•ã‚Œã¦ã„ã‚Œã°OKã§ã™ã€‚

---

## ****supabase init****

[https://supabase.com/docs/reference/cli/supabase-init](https://supabase.com/docs/reference/cli/supabase-init)

æ¬¡ã«ãƒ­ãƒ¼ã‚«ãƒ«ãƒ—ãƒ­ã‚¸ã‚§ã‚¯ãƒˆã‚’ä¸Šè¨˜ã‚³ãƒãƒ³ãƒ‰ã§åˆæœŸåŒ–ã—ã¾ã™ã€‚

è©¦ã—ã«é©å½“ãªãƒ‡ã‚£ãƒ¬ã‚¯ãƒˆãƒªã§ä½œæˆã™ã‚‹ã¨ã„ã‹ã®æ§˜ã«ä½œæˆã•ã‚Œã¾ã—ãŸã€‚

Generate VS Code workspace settingsã¯Yesã§ä½œæˆ

```bash
$ supabase init         
Generate VS Code workspace settings? [y/N] y
Open the supabase-cli.code-workspace file in VS Code.
Finished supabase init.
$ tree           
.
â”œâ”€â”€ supabase
â”‚Â Â  â”œâ”€â”€ config.toml
â”‚Â Â  â”œâ”€â”€ functions
â”‚Â Â  â””â”€â”€ seed.sql
â””â”€â”€ supabase-cli.code-workspace
```

æ¬¡ã« Generate VS Code workspace settings ã‚’Noã§ä½œæˆã™ã‚‹ã¨

```bash
$ supabase init
Generate VS Code workspace settings? [y/N] N
Finished supabase init.
$ tree
.
â””â”€â”€ supabase
    â”œâ”€â”€ config.toml
    â””â”€â”€ seed.sql
```

â†‘ã«ãªã‚Šã¾ã™ã€‚

é•ã„ã¯ãã®ã¾ã¾[VSCodeã®workspace](https://code.visualstudio.com/docs/editor/workspaces)ã®è¨­å®šãŒã‚ã‚‹ã‹ãªã„ã‹ã®é•ã„ã ã‘ã§ã™ã€‚

ã¡ãªã¿ã«ä½œæˆã•ã‚ŒãŸ `code-workspace` ã¯ä»¥ä¸‹ã®æ§˜ã«ãªã£ã¦ã„ã¾ã—ãŸã€‚

```json
{
  "folders": [
    {
      "name": "project-root",
      "path": "./"
    },
    {
      "name": "supabase-functions",
      "path": "supabase/functions"
    }
  ],
  "settings": {
    "files.exclude": {
      "supabase/functions/": true
    }
  }
}
```

---

## ****supabase start****

[https://supabase.com/docs/reference/cli/supabase-start](https://supabase.com/docs/reference/cli/supabase-start)

Supbaseã®ãƒ­ãƒ¼ã‚«ãƒ«ç’°å¢ƒã§å¿…è¦ãªå…¨ã‚³ãƒ³ãƒ†ãƒŠã‚’èµ·å‹•ã—ã¾ã™ã€‚

è‡ªåˆ†ã®ç’°å¢ƒã ã¨ä»¥ä¸‹ã®imageãŒpullã•ã‚Œã¦ã„ã¾ã—ãŸã€‚(2023/06/10ã®å†…å®¹ã§ã™)

```bash
public.ecr.aws/supabase/edge-runtime          v1.4.2             147MB
public.ecr.aws/supabase/postgres-meta         v0.66.0            412MB
public.ecr.aws/supabase/studio                20230512-ad596d8   268MB
public.ecr.aws/supabase/gotrue                v2.62.1            41.1MB
public.ecr.aws/supabase/postgres              15.1.0.73          852MB
public.ecr.aws/supabase/storage-api           v0.37.4            327MB
public.ecr.aws/supabase/logflare              1.0.2              395MB
public.ecr.aws/supabase/realtime              v2.10.1            180MB
public.ecr.aws/supabase/vector                0.28.1-alpine      124MB
public.ecr.aws/supabase/postgrest             v10.1.2            16.1MB
public.ecr.aws/supabase/imgproxy              v3.8.0             173MB
public.ecr.aws/supabase/kong                  2.8.1              139MB
public.ecr.aws/supabase/pgadmin-schema-diff   cli-0.0.5          244MB
public.ecr.aws/supabase/inbucket              3.0.3              25.8MB
public.ecr.aws/supabase/migra                 3.0.1621480950     66.5MB
```

ã‚³ãƒ³ãƒ†ãƒŠèµ·å‹•ã—ã€ `supabase status` ã§ç¾åœ¨ã®èµ·å‹•çŠ¶æ…‹ã‚’ç¢ºèªã§ãã¾ã™ã€‚

ã“ã®ä¸­ã® **`Studio URL`** ã®URLã«ã‚¢ã‚¯ã‚»ã‚¹ã™ã‚‹ã¨è¦‹æ…£ã‚ŒãŸDashboardãŒç¢ºèªã§ãã¾ã™ã€‚

---

## supabase stop

[https://supabase.com/docs/reference/cli/supabase-stop](https://supabase.com/docs/reference/cli/supabase-stop)

åœæ­¢ã™ã‚‹éš›ã¯ã“ã®ã‚³ãƒãƒ³ãƒ‰ã§å…¨ã‚³ãƒ³ãƒ†ãƒŠã‚’åœæ­¢ã§ãã¾ã™ã€‚

---

## **Database migrations**

[https://supabase.com/docs/guides/getting-started/local-development#database-migrations](https://supabase.com/docs/guides/getting-started/local-development#database-migrations)

æ‰‹å…ƒã§ `employees` ãƒ†ãƒ¼ãƒ–ãƒ«ã‚’ä½œæˆã™ã‚‹SQLã‚’ç”¨æ„ã—ã¦ã€ãƒ­ãƒ¼ã‚«ãƒ«ç’°å¢ƒã®Databaseã«åæ˜ ã—ã¦ã¿ãŸã„ã¨æ€ã„ã¾ã™ã€‚

ä»¥ä¸‹ã‚³ãƒãƒ³ãƒ‰ã‚’å®Ÿæ–½ã—ã¾ã™ã€‚

```bash
supabase migration new create_employees_table
```

`./supabase/migrations` ãƒ‡ã‚£ãƒ¬ã‚¯ãƒˆãƒªå†…ã« `XXXXXXXXXXXXXX_create_employees_table.sql` ãƒ•ã‚¡ã‚¤ãƒ«ãŒä½œæˆã•ã‚Œã‚‹ã®ã§ä»¥ä¸‹ã«ä¿®æ­£ã—ã¾ã™ã€‚

```sql
create table
employees (
id bigint primary key generated always as identity,
name text,
email text,
created_at timestamptz default now()
);
```

æ—©é€Ÿãƒ­ãƒ¼ã‚«ãƒ«ç’°å¢ƒã®Databaseã«ä»¥ä¸‹ã‚³ãƒãƒ³ãƒ‰ã§åæ˜ ã•ã›ã¦ã¿ã¾ã™ã€‚

```bash
$ supabase db reset
Resetting local database...
Initializing schema...
Applying migration XXXXXXXXXXXXXX_create_employees_table.sql...
Seeding data supabase/seed.sql...
Restarting containers...
Finished supabase db reset on branch main.
```

 **`Studio URL`** ã®URLã«ã‚¢ã‚¯ã‚»ã‚¹ã—ãƒ€ãƒƒã‚·ãƒ¥ãƒœãƒ¼ãƒ‰ã® Table Editor ã‚’ç¢ºèªã™ã‚‹ã¨ `employees` ãƒ†ãƒ¼ãƒ–ãƒ«ãŒä½œæˆã•ã‚Œã¦ã„ã‚‹ã‹ã¨æ€ã„ã¾ã™ã€‚

![image2](/images/209699774226af/image2.png =600x)

æ¬¡ã«Seedãƒ‡ãƒ¼ã‚¿ã‚’æŠ•å…¥ã—ã¦ã¿ãŸã„ã¨æ€ã„ã¾ã™ã€‚

`supabase/seed.sql` ãƒ•ã‚¡ã‚¤ãƒ«(å­˜åœ¨ã—ãªã„å ´åˆã¯ä½œæˆ) ã‚’ä»¥ä¸‹ã«ä¿®æ­£ã—ã¾ã™ã€‚

```sql
insert into
public.employees (name)
values
('Erlich Bachman'),
('Richard Hendricks'),
('Monica Hall');
```

å†åº¦ `supabase db reset` ã‚’å®Ÿè¡Œã—ãƒ€ãƒƒã‚·ãƒ¥ãƒœãƒ¼ãƒ‰ã§ç¢ºèªã™ã‚‹ã¨ãƒ‡ãƒ¼ã‚¿ãŒæŠ•å…¥ã•ã‚Œã¦ã„ã‚‹ã‹ã¨æ€ã„ã¾ã™ã€‚

![image3](/images/209699774226af/image3.png =600x)

# ã‚¯ãƒ©ã‚¤ã‚¢ãƒ³ãƒˆã‹ã‚‰ã®æ¥ç¶š

æ¬¡ã«ãƒ­ãƒ¼ã‚«ãƒ«ã«æ§‹ç¯‰ã—ãŸSupabaseã®ç’°å¢ƒã«å¯¾ã—ã¦ã‚¯ãƒ©ã‚¤ã‚¢ãƒ³ãƒˆã‹ã‚‰æ¥ç¶šã—ã¦ã¿ãŸã„ã¨æ€ã„ã¾ã™ã€‚

ã‚¯ãƒ©ã‚¤ã‚¢ãƒ³ãƒˆã¨ã—ã¦ã®æ¤œè¨¼ç’°å¢ƒã¯ä»¥ä¸‹ã«ãªã‚Šã¾ã™ã€‚ `@supabase/supabase-js` ã‚’ä½¿ã£ã¦æ¤œè¨¼ã—ã¾ã™ã€‚

```text
- next: v13.4.4
- react: v18.2.0
- chakra-ui/react: v2.7.0
- @supabase/supabase-js: v2.24.0
```

ã¾ãšã¯Supabaseã«æ¥ç¶šã™ã‚‹clientã‚’ä½œæˆã™ã‚‹ç‚ºã€ä»¥ä¸‹å†…å®¹ã§ `libs/supabase.ts` ã«ä½œæˆã—ã¾ã™ã€‚

```tsx
import { createClient } from '@supabase/supabase-js';

const supabaseUrl = 'http://localhost:54321'
const supabaseKey = '...'

export const supabase = createClient(supabaseUrl, supabaseKey);
```

`supabaseKey` ã«ã¯ `supabase start` æ™‚ã«è¡¨ç¤ºã•ã‚Œã‚‹ **`anon key`** ã‚’è¨­å®šã—ã¾ã™ã€‚

## Auth

ãƒ€ãƒƒã‚·ãƒ¥ãƒœãƒ¼ãƒ‰ã®Authenticationã‹ã‚‰æ–°è¦ã«ãƒ¦ãƒ¼ã‚¶ãƒ¼ã‚’ä½œæˆã—ã¦ã¿ã¾ã™ã€‚

![image4](/images/209699774226af/image4.png =600x)

é©å½“ãªãƒ¡ã‚¢ãƒ‰ã¨ãƒ‘ã‚¹ãƒ¯ãƒ¼ãƒ‰ã‚’å…¥åŠ›ã—ã¦ãƒ¦ãƒ¼ã‚¶ãƒ¼ã‚’ä½œæˆã—ã¾ã™ã€‚

![image5](/images/209699774226af/image5.png =300x)

authã‚’æ‰±ã†ç°¡æ˜“çš„ãªhooksã‚’ä»¥ä¸‹å†…å®¹ã§ä½œæˆã—ã¾ã™ã€‚

```tsx
import { Session } from '@supabase/supabase-js';
import { supabase } from 'libs/supabase';
import { useCallback, useEffect, useState } from 'react';

export const useAuth = () => {
  const [session, setSession] = useState<Session>();

  useEffect(() => {
    const { data: authData } = supabase.auth.onAuthStateChange((_, session) => {
      session && setSession(session);
    });

    return () => authData.subscription.unsubscribe();
  }, []);

  const signInWithEmail = useCallback(
    async (email: string, password: string) => {
      try {
        const { error } = await supabase.auth.signInWithPassword({
          email,
          password,
        });
        if (error) {
          throw new Error(error.message);
        }
      } catch (e) {
        console.error(e);
      }
    },
    []
  );

  const signOut = useCallback(async () => {
    await supabase.auth.signOut();
  }, []);

  return {
    session,
    signInWithEmail,
    signOut,
  };
};
```

ã“ã¡ã‚‰ã‚’ä½¿ã£ã¦ç°¡æ˜“çš„ãªSignInãƒšãƒ¼ã‚¸ã‚’ä½œã£ã¦è©¦ã—ã¦ã¿ã¾ã™ã€‚

```tsx
'use client';

import { Button, Divider, Input, VStack } from '@chakra-ui/react';
import { useAuth } from 'hooks/useAuth';
import { useRouter } from 'next/navigation';
import { useState } from 'react';

const SignIn = () => {
  const router = useRouter();
  const [email, setEmail] = useState<string>();
  const [password, setPassword] = useState<string>();
  const { session, signInWithEmail } = useAuth();
  if (session) {
    router.push('/');
  }
  return (
    <VStack w="full" justify="center" alignItems="center">
      <VStack w="40rem" p={8} spacing={4}>
        <Input
          placeholder="Email"
          type="email"
          onChange={(e) => setEmail(e.target.value)}
        />
        <Input
          placeholder="Password"
          type="password"
          onChange={(e) => setPassword(e.target.value)}
        />
        <Divider py={4} />
        <Button
          colorScheme="blue"
          onClick={() => {
            email && password && signInWithEmail(email, password);
          }}
        >
          SignIn
        </Button>
      </VStack>
    </VStack>
  );
};

export default SignIn;
```

![image6](/images/209699774226af/image6.png =600x)

ä¸Šè¨˜ç”»é¢ã«ä½œæˆã—ãŸãƒ¡ã‚¢ãƒ‰ã¨ãƒ‘ã‚¹ãƒ¯ãƒ¼ãƒ‰ã‚’å…¥åŠ›ã—ã€ŒSignInã€ãƒœã‚¿ãƒ³ã‚¯ãƒªãƒƒã‚¯ã™ã‚‹ã¨ã¡ã‚ƒã‚“ã¨SignInã§ãã‚‹ã“ã¨ãŒç¢ºèªã§ãã‚‹ã‹ã¨æ€ã„ã¾ã™ã€‚

## Database

äº‹å‰ã«å‹ç”Ÿæˆã‚’è¡Œã£ã¦ãŠãã¾ã™ã€‚

```bash
supabase gen types typescript --local > types/database.types.ts
```

å…ˆç¨‹ã® `createClient` ã«ä½œæˆã•ã‚ŒãŸå‹æƒ…å ±ã‚’è¨­å®šã—ã¾ã™ã€‚

```tsx
export const supabase = createClient<Database>(supabaseUrl, supabaseKey);
```

æ¬¡ã«ç¢ºèªç”¨ã®ç”»é¢ã‚’ä»¥ä¸‹å†…å®¹ã§ä½œæˆã—ã¾ã™ã€‚

```tsx
'use client';

import {
  Box,
  Table,
  TableContainer,
  Tbody,
  Td,
  Th,
  Thead,
  Tr,
} from '@chakra-ui/react';
import { supabase } from 'libs/supabase';
import { useEffect, useState } from 'react';
import { Database } from 'types/database.types';

const DatabasePage = () => {
  const [items, setItems] = useState<
    Database['public']['Tables']['employees']['Row'][]
  >([]);
  useEffect(() => {
    (async () => {
      const { data, error } = await supabase
        .from('employees')
        .select('*')
        .order('created_at');
      if (error) {
        console.error(error);
        return;
      }
      if (data) {
        setItems(data);
      }
    })();
  }, []);

  return (
    <Box minH="100vh">
      <TableContainer>
        <Table variant="simple">
          <Thead>
            <Tr>
              <Th>id</Th>
              <Th>name</Th>
              <Th>email</Th>
              <Th>created_at</Th>
            </Tr>
          </Thead>
          <Tbody>
            {items.map((item) => (
              <Tr>
                <Td>{item.id}</Td>
                <Td>{item.name}</Td>
                <Td>{item.email}</Td>
                <Td>{item.created_at}</Td>
              </Tr>
            ))}
          </Tbody>
        </Table>
      </TableContainer>
    </Box>
  );
};

export default DatabasePage;
```

ä»¥ä¸‹ã®æ§˜ã«ç™»éŒ²ã—ãŸemployeesã®ãƒ‡ãƒ¼ã‚¿ãŒè¡¨ç¤ºã•ã‚Œã¦ã„ã‚‹ã®ãŒç¢ºèªã§ãã¾ã™ã€‚

![image7](/images/209699774226af/image7.png =600x)

## Realtime

è©¦ã—ã«ä»¥ä¸‹ã®2ç”»é¢ã‚’ãã‚Œãã‚Œä½œæˆã—ã¾ã™ã€‚

- client1

    ```tsx
    'use client';
    
    import { supabase } from 'libs/supabase';
    import { useEffect } from 'react';
    
    const channel = supabase.channel('room1');
    
    const Client1Page = () => {
      useEffect(() => {
        const subscription = channel.subscribe((status) => {
          if (status === 'SUBSCRIBED') {
            setInterval(() => {
              channel.send({
                type: 'broadcast',
                event: 'message',
                payload: { text: 'hello' },
              });
              console.log('broadcast message');
            }, 1000);
          }
        });
        return () => {
          subscription.unsubscribe();
        };
      }, []);
      return <p>Client1Page</p>;
    };
    
    export default Client1Page;
    ```

- client2

    ```tsx
    'use client';
    
    import { supabase } from 'libs/supabase';
    import { useEffect } from 'react';
    
    const Client2Page = () => {
      useEffect(() => {
        const subscription = supabase
          .channel('room1')
          .on('broadcast', { event: 'message' }, (payload) => console.log(payload))
          .subscribe((status) => {
            if (status === 'SUBSCRIBED') {
              // ...
            }
          });
        return () => {
          subscription.unsubscribe();
        };
      }, []);
      return <p>Client2Page</p>;
    };
    
    export default Client2Page;
    ```

ãã‚Œãã‚Œã®ãƒšãƒ¼ã‚¸ã‚’è¡¨ç¤ºã•ã›ã¦ã¿ã‚‹ã¨ä»¥ä¸‹ã®æ§˜ã«BroadcastãŒé€ã‚Œã¦ã„ã‚‹ã‹ã¨æ€ã„ã¾ã™ã€‚

![image8](/images/209699774226af/image8.gif =600x)

# å‚è€ƒURL

[Supabaseã®CLIã§ãƒ­ãƒ¼ã‚«ãƒ«ç’°å¢ƒã‚’æ§‹ç¯‰ã™ã‚‹ï¼ˆLocal Developmentï¼‰ | DevelopersIO](https://dev.classmethod.jp/articles/supabase-graphql/)