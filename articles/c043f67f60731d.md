---
title: "Hono + Prisma + Cloudflare D1/R2ã‚’ãƒ­ãƒ¼ã‚«ãƒ«ã ã‘ã§å‹•ã‹ã—ã¦ã¿ã‚‹"
emoji: "ğŸ’»"
type: "tech" # tech: æŠ€è¡“è¨˜äº‹ / idea: ã‚¢ã‚¤ãƒ‡ã‚¢
topics:
  - "hono"
  - "prisma"
  - "cloudflareworkers"
  - "d1"
  - "r2"
published: true
---
# æ¦‚è¦

ã‚¿ã‚¤ãƒˆãƒ«é€šã‚Šã§ã™ãŒã€Hono + Prisma + Cloudflareã®D1/R2ã®ãƒ­ãƒ¼ã‚«ãƒ«ç’°å¢ƒã‚’ã‚»ãƒƒãƒˆã‚¢ãƒƒãƒ—ã—ã¦ã€ãƒ‡ãƒ—ãƒ­ã‚¤ã¯ã›ãšã«ãƒ­ãƒ¼ã‚«ãƒ«ã ã‘ã§å‹•ã‹ã—ã¦ã¿ã¦ã€æŒ™å‹•ã®ç¢ºèªãªã©ã‚’è©¦ã—ã¦ã¿ãŸã„ã¨æ€ã„ã¾ã™ã€‚

ğŸ‘‡ä»¥ä¸‹è»½ãå„ã‚µãƒ¼ãƒ“ã‚¹ã®æ¦‚è¦èª¬æ˜ã«ãªã‚Šã¾ã™ã€‚

## Hono ã¨ã¯

https://hono.dev/

> Edgesã®ãŸã‚ã®å°ã•ãã‚·ãƒ³ãƒ—ãƒ«ã§è¶…é«˜é€ŸãªWebãƒ•ãƒ¬ãƒ¼ãƒ ãƒ¯ãƒ¼ã‚¯ã§ã™ã€‚ã©ã®JavaScriptãƒ©ãƒ³ã‚¿ã‚¤ãƒ ã§ã‚‚å‹•ä½œã—ã¾ã™ï¼šCloudflare Workersã€Fastly Computeã€Denoã€Bunã€Vercelã€Netlifyã€AWS Lambdaã€Lambda@Edgeã€Node.js

## Prisma ã¨ã¯

https://www.prisma.io/

> Prismaã¯ã€Node.jsã¨TypeScriptã®ãŸã‚ã®æ¬¡ä¸–ä»£ã®ORM (Object-Relational Mapping) ã§ã™ã€‚ãƒ‡ãƒ¼ã‚¿ãƒ™ãƒ¼ã‚¹ã¨ã®ã‚„ã‚Šå–ã‚Šã‚’ã‚ˆã‚Šç°¡å˜ã‹ã¤å®‰å…¨ã«ã™ã‚‹ãŸã‚ã«è¨­è¨ˆã•ã‚Œã¦ã„ã¾ã™ã€‚é–‹ç™ºè€…ãŒãƒ‡ãƒ¼ã‚¿ãƒ™ãƒ¼ã‚¹ã‚¹ã‚­ãƒ¼ãƒã‚’å®šç¾©ã—ã€ãã®ã‚¹ã‚­ãƒ¼ãƒã«åŸºã¥ã„ã¦è‡ªå‹•çš„ã«å‹å®‰å…¨ãªã‚¯ãƒ©ã‚¤ã‚¢ãƒ³ãƒˆAPIã‚’ç”Ÿæˆã—ã¾ã™ã€‚ã“ã‚Œã«ã‚ˆã‚Šã€SQLã‚„ãƒ‡ãƒ¼ã‚¿ãƒ™ãƒ¼ã‚¹å›ºæœ‰ã®ã‚¯ã‚¨ãƒªè¨€èªã«ä¾å­˜ã™ã‚‹ã“ã¨ãªãã€ãƒ‡ãƒ¼ã‚¿ãƒ™ãƒ¼ã‚¹ã¨ã®ã‚„ã‚Šå–ã‚ŠãŒå¯èƒ½ã«ãªã‚Šã¾ã™ã€‚

## Cloudflare D1 ã¨ã¯

https://www.cloudflare.com/ja-jp/developer-platform/d1/

> Cloudflare D1ã¯ã€CloudflareãŒæä¾›ã™ã‚‹åˆ†æ•£å‹SQLãƒ‡ãƒ¼ã‚¿ãƒ™ãƒ¼ã‚¹ã‚µãƒ¼ãƒ“ã‚¹ã§ã™ã€‚D1ã¯ã€ãƒ‡ãƒ¼ã‚¿ãƒ™ãƒ¼ã‚¹ã®ãƒ‘ãƒ•ã‚©ãƒ¼ãƒãƒ³ã‚¹ã¨ã‚¹ã‚±ãƒ¼ãƒ©ãƒ“ãƒªãƒ†ã‚£ã‚’å‘ä¸Šã•ã›ã€ã‚°ãƒ­ãƒ¼ãƒãƒ«ã«åˆ†æ•£ã•ã‚ŒãŸãƒ‡ãƒ¼ã‚¿ãƒ™ãƒ¼ã‚¹ã‚’ç°¡å˜ã«æ§‹ç¯‰ãƒ»ç®¡ç†ã§ãã¾ã™ã€‚ã‚µãƒ¼ãƒãƒ¼ãƒ¬ã‚¹ã‚¢ãƒ¼ã‚­ãƒ†ã‚¯ãƒãƒ£ã«åŸºã¥ã„ã¦ãŠã‚Šã€é«˜é€Ÿãªã‚¯ã‚¨ãƒªå¿œç­”ã¨é«˜ã„å¯ç”¨æ€§ã‚’å®Ÿç¾ã—ã¾ã™ã€‚ã“ã‚Œã«ã‚ˆã‚Šã€é–‹ç™ºè€…ã¯è¤‡é›‘ãªã‚¤ãƒ³ãƒ•ãƒ©ç®¡ç†ã‚’ä¸è¦ã«ã—ã€ã‚¢ãƒ—ãƒªã‚±ãƒ¼ã‚·ãƒ§ãƒ³ã®è¿…é€Ÿãªé–‹ç™ºã¨ãƒ‡ãƒ—ãƒ­ã‚¤ã‚’å¯èƒ½ã«ã—ã¾ã™ã€‚

## Cloudflare R2 ã¨ã¯

https://www.cloudflare.com/ja-jp/developer-platform/r2/

> Cloudflare R2ã¯ã€ãƒ‡ãƒ¼ã‚¿è»¢é€è²»ç”¨ã‚’ãªãã—ãŸã‚ªãƒ–ã‚¸ã‚§ã‚¯ãƒˆã‚¹ãƒˆãƒ¬ãƒ¼ã‚¸ã‚µãƒ¼ãƒ“ã‚¹ã§ã™ã€‚Amazon S3ã¨äº’æ›æ€§ãŒã‚ã‚Šã€ç§»è¡ŒãŒå®¹æ˜“ã§ã™ã€‚å¤§è¦æ¨¡ãªãƒ‡ãƒ¼ã‚¿ä¿å­˜ã‚’ä½ã‚³ã‚¹ãƒˆã§æä¾›ã—ã€æ—¢å­˜ã®S3ãƒ„ãƒ¼ãƒ«ã‚„ã‚¢ãƒ—ãƒªã¨ã‚‚ã‚·ãƒ¼ãƒ ãƒ¬ã‚¹ã«çµ±åˆã§ãã¾ã™ã€‚

# ç’°å¢ƒæ§‹ç¯‰

ä»Šå›ã‚‚ğŸ‘‡ã®ç’°å¢ƒã‚’cloneã—ã¦æ§‹ç¯‰ã—ã¦ã„ãã¾ã™ã€‚(â€» nodeãŒå‹•ãç’°å¢ƒãªã‚‰å¥½ããªç’°å¢ƒã§è©¦ã—ã¦ã‚‚ã‚‰ãˆã‚Œã°ã¨æ€ã„ã¾ã™)

https://github.com/Slowhand0309/nodejs-devcontainer-boilerplate

æ¬¡ã«ğŸ‘‡ã®ãƒ•ã‚¡ã‚¤ãƒ«ã‚’å°‘ã—ä¿®æ­£ã—ã¦ã¾ã™ã€‚

- `.devcontainer/Dockerfile`

```docker
FROM node:20.10.0-bullseye-slim
LABEL maintainer="Slowhand0309"

ARG username=vscode
ARG useruid=1000
ARG usergid=${useruid}

RUN set -ex \
    && apt-get update \
    && apt-get install -y \
        sudo \
        ca-certificates \ # â† è¿½åŠ 
        --no-install-recommends \
    # Delete node user with uid=1000 and create vscode user with uid=1000
    && userdel -r node \
    && groupadd --gid ${usergid} ${username} \
    && useradd -s /bin/bash --uid ${useruid} --gid ${usergid} -m ${username} \
    && echo ${username} ALL=\(root\) NOPASSWD:ALL > /etc/sudoers.d/${username} \
    && chmod 0440 /etc/sudoers.d/${username}

USER ${username}
```

- `.devcontainer/compose.yaml`

```yaml
services:
  app:
    ...
    ports:
      - "8787:8787" # â† è¿½åŠ 
```

ã“ã“ã¾ã§ããŸã‚‰ã‚³ãƒ³ãƒ†ãƒŠèµ·å‹•ã—ã€ã‚³ãƒ³ãƒ†ãƒŠå†…ã§ğŸ‘‡ã‚³ãƒãƒ³ãƒ‰ã‹ã‚‰hono + Cloudflare workers ã®ç’°å¢ƒã‚’ã‚»ãƒƒãƒˆã‚¢ãƒƒãƒ—ã—ã¦ã„ãã¾ã™ã€‚

```bash
$ yarn create hono .
âœ” Using target directory â€¦ .
? Which template do you want to use? cloudflare-workers
? Directory not empty. Continue? yes
âœ” Cloning the template
? Do you want to install project dependencies? yes
? Which package manager do you want to use? yarn
âœ” Installing project dependencies
ğŸ‰ Copied project files
```

`wrangler.toml` ã«ğŸ‘‡ã‚’è¿½åŠ ã—ã€

```toml
[dev]
ip = "0.0.0.0"
port = 8787
```

ã‚³ãƒ³ãƒ†ãƒŠå†èµ·å‹•ã—ã¦ `yarn dev` ã§ [http://localhost:8787/](http://localhost:8787/) ã«ã‚¢ã‚¯ã‚»ã‚¹ã—ã€ã€ŒHello Hono!ã€ãŒè¡¨ç¤ºã•ã‚Œã¦ã„ã‚Œã°OKã§ã™ã€‚

# å®Œå…¨ãƒ­ãƒ¼ã‚«ãƒ«ã ã‘ã® D1 ç’°å¢ƒæ§‹ç¯‰

`wrangler.toml` ã«ğŸ‘‡ã‚’è¿½åŠ ã—ã¾ã™ã€‚

```toml
[[d1_databases]]
binding = "DB"
database_name = "trial-d1"
database_id = "1"
```

ã“ã®æ™‚ãƒ­ãƒ¼ã‚«ãƒ«ã®ã¿ã®ç’°å¢ƒãªã®ã§ `database_id` ã¯ç©ºå‡ºãªã‘ã‚Œã°ä½•ã§ã‚‚ã„ã„ã¿ãŸã„ã§ã™ã€‚

## è©¦ã—ã«seedãƒ‡ãƒ¼ã‚¿ç™»éŒ²

æ¬¡ã«è©¦ã—ã«ğŸ‘‡ã® `seed.sql` ã‚’ä½œæˆã—ã¨ãã¾ã™ã€‚

```sql
CREATE TABLE IF NOT EXISTS users (
  id INTEGER PRIMARY KEY,
  name VARCHAR(50) NOT NULL);

INSERT INTO users VALUES (1,'å±±ç”° å¤ªéƒ');
INSERT INTO users VALUES (2,'éˆ´æœ¨ èŠ±å­');

```

æ¬¡ã«ã“ã‚Œã‚’ãƒ­ãƒ¼ã‚«ãƒ«ã®D1ç’°å¢ƒã«å¯¾ã—ã¦å®Ÿè¡Œã—ã¦ã¿ã¾ã™ã€‚

```bash
yarn wrangler d1 execute trial-d1 --local --file=seed.sql
```

ğŸ‘†ã‚’å®Ÿè¡Œã™ã‚‹ã¨è‡ªåˆ†ã®ç’°å¢ƒã§ã¯ `.wrangler/state/v3/d1/miniflare-D1DatabaseObject/XXXX.sqlite` ãŒä½œæˆã•ã‚Œã€SQLã‚¯ãƒ©ã‚¤ã‚¢ãƒ³ãƒˆãƒ„ãƒ¼ãƒ«ã§é–‹ãã¨ã¡ã‚ƒã‚“ã¨ `users` ãƒ†ãƒ¼ãƒ–ãƒ«ãŒä½œæˆã•ã‚Œã€ãƒ‡ãƒ¼ã‚¿ãŒç™»éŒ²ã•ã‚Œã¦ã„ã¾ã—ãŸ âœ¨ 

![image1.png](/images/c043f67f60731d/image1.png =350x)

ç¢ºèªã§ããŸã‚‰ã“ã®å¾Œãƒã‚¤ã‚°ãƒ¬ãƒ¼ã‚·ãƒ§ãƒ³ã§åˆ¥é€”ãƒ†ãƒ¼ãƒ–ãƒ«ä½œæˆã™ã‚‹ã®ã§ã€`.wrangler/state/v3/d1/miniflare-D1DatabaseObject/XXXX.sqlite` ã‚’å‰Šé™¤ã—ã¨ãã¾ã™ã€‚

# Prismaç’°å¢ƒæ§‹ç¯‰

å…ˆãšã¯å¿…è¦ãªãƒ‘ãƒƒã‚±ãƒ¼ã‚¸ã‚’ã‚¤ãƒ³ã‚¹ãƒˆãƒ¼ãƒ«ã—ã¦ã„ãã¾ã™ã€‚

```bash
yarn add -D prisma
yarn add @prisma/client @prisma/adapter-d1
```

æ¬¡ã«Prismaã‚’åˆæœŸåŒ–ã—ã¾ã™ã€‚

```bash
npx prisma init --datasource-provider sqlite  
```

æ¬¡ã«ç”Ÿæˆã•ã‚ŒãŸ `prisma/schema.prisma` ã«ğŸ‘‡ã‚’è¿½åŠ ã—ã¾ã™ã€‚

```typescript
generator client {
  provider = "prisma-client-js"
  previewFeatures = ["driverAdapters"] # â† è¿½åŠ 
}
```

æœ€å¾Œã« `wrangler.toml` ã«Cloudflare Workersã§Node.jsã®APIã‚’æœ‰åŠ¹åŒ–ã™ã‚‹ãŸã‚ğŸ‘‡ã‚’è¿½åŠ ã—ã¾ã™ã€‚

```toml
name = "...."
compatibility_date = "2024-07-24"
compatibility_flags = ["nodejs_compat"]
```

# ãƒã‚¤ã‚°ãƒ¬ãƒ¼ã‚·ãƒ§ãƒ³

æ”¹ã‚ã¦ `users` ãƒ†ãƒ¼ãƒ–ãƒ«ã‚’ä½œæˆã™ã¹ãã€å…ˆã«ãƒã‚¤ã‚°ãƒ¬ãƒ¼ã‚·ãƒ§ãƒ³ãƒ•ã‚¡ã‚¤ãƒ«ã‚’ä½œæˆã—ã¨ãã¾ã™ã€‚

```bash
yarn wrangler d1 migrations create trial-d1 users
```

ğŸ‘†ã‚’å®Ÿè¡Œã™ã‚‹ã¨æ‰‹å…ƒã®ç’°å¢ƒã ã¨ `migrations/0001_users.sql` ãŒä½œæˆã•ã‚Œã¾ã—ãŸã€‚

æ¬¡ã« `prisma/schema.prisma` ã« `users` ãƒ†ãƒ¼ãƒ–ãƒ«ã‚’è¨­å®šã—ã¾ã™ã€‚

```tsx
model User {
  id    Int     @id @default(autoincrement())
  email String  @unique
  name  String?
}
```

æœ€å¾Œã«Prismaã®migrateã‚³ãƒãƒ³ãƒ‰ã‚’å®Ÿè¡Œã—ã¾ã™ã€‚

```bash
yarn prisma migrate diff --from-empty --to-schema-datamodel ./prisma/schema.prisma --script --output migrations/0001_users.sql
```

ã™ã‚‹ã¨ç©ºã ã£ãŸ `migrations/0001_users.sql` ã¯ğŸ‘‡ã®æ§˜ã«æ›´æ–°ã•ã‚Œã¾ã—ãŸã€‚

```sql
-- CreateTable
CREATE TABLE "User" (
    "id" INTEGER NOT NULL PRIMARY KEY AUTOINCREMENT,
    "email" TEXT NOT NULL,
    "name" TEXT
);

-- CreateIndex
CREATE UNIQUE INDEX "User_email_key" ON "User"("email");
```

ãƒ­ãƒ¼ã‚«ãƒ«ã®D1ã¸ğŸ‘†ã®ãƒã‚¤ã‚°ãƒ¬ãƒ¼ãƒˆã‚’åæ˜ ã•ã›ã¦ã¿ã¾ã™ã€‚

```bash
yarn wrangler d1 migrations apply trial-d1 --local
```

sqlãƒ•ã‚¡ã‚¤ãƒ«ã‚’é–‹ã„ã¦ã¿ã‚‹ã¨ã¡ã‚ƒã‚“ã¨åæ˜ ã•ã‚Œã¦ã„ã¾ã™ã€‚

![image2.png](/images/c043f67f60731d/image2.png =350x)

ã¡ãªã¿ã«ã€æ¬¡å›ä»¥é™ã®ãƒã‚¤ã‚°ãƒ¬ãƒ¼ã‚·ãƒ§ãƒ³ã¯ã©ã†ã™ã‚‹ã®ã‹ã¨ã„ã†ã¨ã€ `yarn prisma migrate diff` ã§ `--from-empty` ã®éƒ¨åˆ†ã‚’ `--from-local-d1` ã¨ã—ã¦ã‚„ã‚‹ã“ã¨ã§ãƒ­ãƒ¼ã‚«ãƒ«ã®D1ã‚’è¦‹ã«ã„ã `prisma/schema.prisma` ã¨ã®å·®åˆ†ã‚’å–ã£ã¦ãã‚Œã¾ã™ã€‚

# å®Œå…¨ãƒ­ãƒ¼ã‚«ãƒ«ã ã‘ã® R2 ç’°å¢ƒæ§‹ç¯‰

`wrangler.toml` ã«ğŸ‘‡ã‚’è¿½åŠ ã—ã¾ã™ã€‚

```toml
[[r2_buckets]]
binding = "R2"
bucket_name = "trial-r2"
```

ãŠè©¦ã—ç”¨ã® `seed.json` ã‚’ğŸ‘‡å†…å®¹ã§ä½œæˆã—ã¾ã™ã€‚

```json
{
  "users": [
    {
      "name": "John Doe",
      "email": "john@example.com"
    }
  ]
}

```

æ¬¡ã«ã“ã‚Œã‚’ãƒ­ãƒ¼ã‚«ãƒ«ã®R2ç’°å¢ƒã¸putã—ã¦ã¿ã¾ã™ã€‚

```bash
yarn wrangler r2 object put trial-r2/users --local --file=seed.json
```

å®Ÿè¡Œã™ã‚‹ã¨è‡ªåˆ†ã®ç’°å¢ƒã§ã¯ `.wrangler/state/v3/r2/my-bucket/blobs/xxxxx...`  ãŒä½œæˆã•ã‚Œã¦ã„ã¾ã—ãŸã€‚

objectãŒåæ˜ ã•ã‚Œã¦ã„ã‚‹ã‹ `/storage` ã«ã‚¢ã‚¯ã‚»ã‚¹ã™ã‚‹ã¨objectä¸€è¦§ã®æƒ…å ±ãŒè¿”ã‚‹ã‚ˆã†ãªAPIã‚’ä½œæˆã—ã¦ç¢ºèªã—ã¦ã¿ãŸã„ã¨æ€ã„ã¾ã™ã€‚

`src/index.ts` ã‚’ğŸ‘‡å†…å®¹ã«å¤‰æ›´ã—ã¾ã™ã€‚

```tsx
import { Hono } from 'hono';

type Bindings = {
  DB: D1Database;
  R2: R2Bucket;
};

const app = new Hono<{ Bindings: Bindings }>();

app.get('/', (c) => {
  return c.text('Hello Hono!');
});

app.get('/r2-objects', async (c) => {
  const list = await c.env.R2.list();
  return c.text(JSON.stringify(list));
});

export default app;

```

[http://localhost:8787/r2-objects](http://localhost:8787/r2-objects) ã«ã‚¢ã‚¯ã‚»ã‚¹ã—ã¦å…ˆã»ã©ç™»éŒ²ã—ãŸobjectãŒè¡¨ç¤ºã•ã‚Œã¦ã„ã‚Œã°è‰¯ã•ãã†ã§ã™ã€‚ğŸ‘‡Â æ‰‹å…ƒã§è©¦ã—ãŸæ‰€ä½œæˆã—ãŸ key: users ã®objectãŒè¿”ã£ã¦ãã¦ã¾ã—ãŸ!

![image3.png](/images/c043f67f60731d/image3.png =350x)

# å‚è€ƒURL

https://tech.fusic.co.jp/posts/hono-prisma-cloudflare-d1/

https://wp-kyoto.net/integrate-cloudflare-r2-from-hono/

https://github.com/einverne/hono-cloudflare-r2