---
title: "PostgreSQLã®RLS (Row Level Security) ã‚­ãƒ£ãƒƒãƒã‚¢ãƒƒãƒ—"
emoji: "ğŸ”"
type: "tech" # tech: æŠ€è¡“è¨˜äº‹ / idea: ã‚¢ã‚¤ãƒ‡ã‚¢
topics:
  - "postgresql"
  - "rls"
  - "security"
  - "docker"
published: true
---
# æ¦‚è¦

ä»Šå›ã¯ **RLS (Row Level Security)** ã«é–¢ã—ã¦ã‚µãƒãƒ¼ãƒˆã—ã¦ã„ã‚‹PostgreSQLã‚’ä½¿ã£ã¦
è‰²ã€…å‹•ã‹ã—ãªãŒã‚‰è©¦ã—ã¦ã„ããŸã„ã¨æ€ã„ã¾ã™ã€‚

# RLS (Row Level Security)

https://www.postgresql.org/docs/current/ddl-rowsecurity.html

> *Row Security Policies* ã§ã¯ã€é€šå¸¸ã®ã‚¯ã‚¨ãƒªã§è¿”ã•ã‚Œã‚‹è¡Œã‚„ã€ãƒ‡ãƒ¼ã‚¿å¤‰æ›´ã‚³ãƒãƒ³ãƒ‰ã§æŒ¿å…¥ã€æ›´æ–°ã€å‰Šé™¤ã§ãã‚‹è¡Œã‚’ãƒ¦ãƒ¼ã‚¶ãƒ¼ã”ã¨ã«åˆ¶é™ã—ã¾ã™ã€‚ã“ã®æ©Ÿèƒ½ã¯ *Row-Level Security* ã¨ã‚‚å‘¼ã°ã‚Œã¾ã™ã€‚

## ç‰¹å¾´

- ãƒ‡ãƒ•ã‚©ãƒ«ãƒˆã§ã¯ãƒ†ãƒ¼ãƒ–ãƒ«ã«ã¯ä½•ã®ãƒãƒªã‚·ãƒ¼ã‚‚ãªã„
- ç‰¹å®šã®ã‚³ãƒãƒ³ãƒ‰ã€ç‰¹å®šã®ãƒ­ãƒ¼ãƒ«ã€ã‚ã‚‹ã„ã¯ãã®ä¸¡æ–¹ã«å¯¾ã—ã¦å®šç¾©ã§ãã‚‹
- ãƒ¦ãƒ¼ã‚¶ã®å•ã„åˆã‚ã›ã«ã‚ã‚‹ã©ã®æ¡ä»¶ã‚„é–¢æ•°ã‚ˆã‚Šã‚‚å‰ã«é©ç”¨ã•ã‚Œã‚‹
- ã‚¹ãƒ¼ãƒ‘ãƒ¼ãƒ¦ãƒ¼ã‚¶ã€ãŠã‚ˆã³`BYPASSRLS`å±æ€§ã®ã‚ã‚‹ãƒ­ãƒ¼ãƒ«ã¯ä¾‹å¤–
- ãƒ†ãƒ¼ãƒ–ãƒ«ã®æ‰€æœ‰è€…ã‚‚é€šå¸¸ã¯è¡Œã‚»ã‚­ãƒ¥ãƒªãƒ†ã‚£ã‚’ç„¡è¦–ã™ã‚‹ãŒé©ç”¨ã™ã‚‹äº‹ã‚‚ã§ãã‚‹
- 1ã¤ã®ãƒ†ãƒ¼ãƒ–ãƒ«ã«è¤‡æ•°ã®ãƒãƒªã‚·ãƒ¼ã‚’å®šç¾©ã§ãã‚‹
- 1ã¤ã®ãƒ†ãƒ¼ãƒ–ãƒ«ã®å„ãƒãƒªã‚·ãƒ¼ã¯ç•°ãªã‚‹åå‰ã§ãªã„ã¨ã„ã‘ãªã„
- è¤‡æ•°ã®ãƒãƒªã‚·ãƒ¼ãŒé©ç”¨ã•ã‚Œã‚‹å ´åˆ
  - ãƒ‡ãƒ•ã‚©ãƒ«ãƒˆã®è¨±å®¹(permissive)ãƒãƒªã‚·ãƒ¼ã«ã¤ã„ã¦ã¯ `OR`
  - åˆ¶é™(restrictive)ãƒãƒªã‚·ãƒ¼ã«ã¤ã„ã¦ã¯ `AND`

# æ¤œè¨¼ç”¨ç’°å¢ƒã®ä½œæˆ

æ¤œè¨¼ã§ä½¿ç”¨ã™ã‚‹ç’°å¢ƒã‚’ä½œæˆã™ã‚‹ç‚ºã«ã€ä»¥ä¸‹å†…å®¹ã® `compose.yml` ã§æ¤œè¨¼ã—ã¦ãã¾ã™ã€‚

```yaml
volumes:
  db_volume:

services:
  postgres:
    image: postgres:16.3
    container_name: postgres_inspection
    working_dir: /usr/src/app
    environment:
      POSTGRES_PASSWORD: 'postgres'
      POSTGRES_USER: 'postgres'
    ports:
      - '5432:5432'
    volumes:
      - .:/usr/src/app
      - db_volume:/var/lib/postgresql/data
```

# current_user ã‚’åˆ©ç”¨ã—ãŸãƒãƒªã‚·ãƒ¼ã®ä½œæˆ

PostgreSQLã«ã¯ `current_user` ã¨ã„ã†çµ„ã¿è¾¼ã¿é–¢æ•°ãŒã‚ã‚Šã€ç¾åœ¨å®Ÿè¡Œã—ã¦ã„ã‚‹ãƒ¦ãƒ¼ã‚¶ãƒ¼(åˆã¯Role) ã‚’è¿”ã—ã¦ãã‚Œã¾ã™ã€‚

### ãƒ¦ãƒ¼ã‚¶ãƒ¼ã¨ãƒ­ãƒ¼ãƒ«ã®é•ã„

ã„ã¾ã„ã¡ãƒ”ãƒ³ã¨ãã¦ãªã‹ã£ãŸã®ã§ã€ã¡ã‚ƒã‚“ã¨èª¿ã¹ã¦ã¿ã‚‹ã¨ğŸ‘‡ã®é•ã„ãŒã‚ã‚‹ãã†ã§ã™ã€‚

- ãƒ¦ãƒ¼ã‚¶ã¯ä½œæˆæ™‚ãƒ‡ãƒ•ã‚©ãƒ«ãƒˆã§ãƒ­ã‚°ã‚¤ãƒ³æ¨©é™ãŒã‚ã‚‹
- ãƒ­ãƒ¼ãƒ«ã¯ä½œæˆæ™‚ãƒ‡ãƒ•ã‚©ãƒ«ãƒˆã§ãƒ­ã‚°ã‚¤ãƒ³æ¨©é™ãŒãªã„

https://qiita.com/dai_chi/items/6da92ab9a691b70c8772

### ç¾åœ¨ã®ãƒ­ãƒ¼ãƒ«ä¸€è¦§ã‚’è¡¨ç¤º

`\du` ã¾ãŸã¯ã‚·ã‚¹ãƒ†ãƒ ã‚«ã‚¿ãƒ­ã‚°ã® `pg_roles`  ã‹ã‚‰è¡¨ç¤ºã•ã›ã‚‹äº‹ãŒã§ãã¾ã™ã€‚

```sql
$ psql -U postgres
postgres=# \du
                             List of roles
 Role name |                         Attributes                         
-----------+------------------------------------------------------------
 postgres  | Superuser, Create role, Create DB, Replication, Bypass RLS

postgres=# SELECT CURRENT_USER;
 current_user 
--------------
 postgres
(1 row)
```

ã“ã“ã§ `managers` ã¨ã„ã† `Role` ã‚’ä½œæˆã—ã¦ã¿ã¾ã™ã€‚

```sql
postgres=# CREATE ROLE managers;
CREATE ROLE
postgres=# SET ROLE managers;
SET
postgres=> SELECT CURRENT_USER;
 current_user 
--------------
 managers
(1 row)
```

`current_user` ã¯ `managers` ã«ãªã£ã¦ã„ã¾ã™ã€‚ã“ã“ã§PostgreSQLã®ã‚»ãƒƒã‚·ãƒ§ãƒ³ã«æ¥ç¶šã—ãŸã‚ªãƒªã‚¸ãƒŠãƒ«ã®ãƒ¦ãƒ¼ã‚¶ãƒ¼ã‚’è¡¨ç¤ºã•ã›ã¦ã¿ã¾ã™ã€‚

```sql
postgres=> SELECT SESSION_USER;
 session_user 
--------------
 postgres
(1 row)

```

 `current_user` ã¨ã¯ç•°ãªã‚‹`postgres` ãƒ¦ãƒ¼ã‚¶ãƒ¼ã«ãªã£ã¦ã„ã‚‹äº‹ãŒåˆ†ã‹ã‚Šã¾ã™ã€‚

### ç°¡å˜ãªã‚µãƒ³ãƒ—ãƒ«

æ¤œè¨¼ç”¨ã®Database `inspection` ã‚’ä½œæˆã—ã¾ã™ã€‚

```sql
CREATE DATABASE inspection WITH OWNER postgres;
```

ã¡ã‚ƒã‚“ã¨ä½œæˆã•ã‚ŒãŸã‹ä¸€è¦§ã‚’è¡¨ç¤ºã—ã¦ã¿ã¾ã™ã€‚

```sql
    Name    |  Owner   | Encoding | Locale Provider |  Collate   |   Ctype    | ICU Locale | ICU Rules |   Access privileges   
------------+----------+----------+-----------------+------------+------------+------------+-----------+-----------------------
 inspection | postgres | UTF8     | libc            | en_US.utf8 | en_US.utf8 |            |           | 
 postgres   | postgres | UTF8     | libc            | en_US.utf8 | en_US.utf8 |            |           | 
 template0  | postgres | UTF8     | libc            | en_US.utf8 | en_US.utf8 |            |           | =c/postgres          +
            |          |          |                 |            |            |            |           | postgres=CTc/postgres
 template1  | postgres | UTF8     | libc            | en_US.utf8 | en_US.utf8 |            |           | =c/postgres          +
            |          |          |                 |            |            |            |           | postgres=CTc/postgres
(4 rows)

```

ä½œæˆã•ã‚Œã¦ãã†ã§ã™ã€‚æ—©é€Ÿ `inspection` Databaseã«æ¥ç¶šã—ã¦ä»¥ä¸‹ã®RLSã‚’ä½œæˆã—ã¦ã¿ãŸã„ã¨æ€ã„ã¾ã™ã€‚

```sql

$ postgres=> \c inspection
You are now connected to database "inspection" as user "postgres".

$ inspection=> CREATE TABLE accounts (manager text, company text, contact_email text);
$ inspection=> ALTER TABLE accounts ENABLE ROW LEVEL SECURITY;
$ inspection=> CREATE POLICY account_managers ON accounts TO managers
    USING (manager = current_user);
```

ğŸ‘†ã®ä¾‹ã ã¨ `manager` ãŒ `current_user = (managers)`  ã®è¡Œã®ã¿å‚ç…§ãƒ»æ›´æ–°ãŒã§ãã‚‹ã¯ãšã§ã™ã€‚æ—©é€Ÿè©¦ã—ã¦ã¿ã¾ã™ã€‚

```sql
# ã‚µãƒ³ãƒ—ãƒ«ãƒ‡ãƒ¼ã‚¿ã‚’ç™»éŒ²
$ inspection=> INSERT INTO accounts (manager, company, contact_email) VALUES
    ('managers', 'company1', 'company1@email'),
    ('admin', 'company2', 'company2@email'),
    ('managers', 'company3', 'company3@email'),
    ('admin', 'company4', 'company4@email');
# ã“ã®ã¾ã¾ã ã¨role: managersãŒaccountsãƒ†ãƒ¼ãƒ–ãƒ«ã«ã‚¢ã‚¯ã‚»ã‚¹ã§ããªã„ç‚ºã€æ¨©é™ã‚’ä»˜ä¸
$ inspection= GRANT SELECT ON accounts TO managers;
# managersã«åˆ‡ã‚Šæ›¿ãˆ
$ inspection= SET ROLE managers;
SET
$ inspection=> SELECT current_user;
 current_user 
--------------
 managers
# ã‚¢ã‚¯ã‚»ã‚¹ã—ã¦ã¿ã‚‹ã¨manager=managersã®ã‚‚ã®ã—ã‹å–å¾—ã§ãã¦ã„ãªã„
$ inspection=> SELECT * FROM accounts;
 manager  | company  | contact_email  
----------+----------+----------------
 managers | company1 | company1@email
 managers | company3 | company3@email
(2 rows)
```

è¨­å®šã—ãŸPolicyé€šã‚Šã« `manager` ãŒ `managers` ã®è€…ã ã‘å–å¾—ã§ãã¦ã„ã¾ã™ã€‚

è©¦ã—ã« `managers` ã§ã¯ãªã„è¡Œã«å¯¾ã—ã¦ã€å‚ç…§ã‚„æ›´æ–°ã‚’è¡Œã£ã¦ã¿ã¾ã™ã€‚

```sql
$ inspection=> SELECT * FROM accounts WHERE company = 'company2';
 manager | company | contact_email 
---------+---------+---------------
(0 rows)
$ inspection=> UPDATE accounts SET company = 'company99' WHERE manager = 'admin';
ERROR:  permission denied for table accounts
```

å‚ç…§ã¯ã§ããšã€æ›´æ–°ã¯ `permission error` ã«ãªã£ã¦ã„ã¾ã™ã€‚

# current_setting ã‚’åˆ©ç”¨ã—ãŸãƒãƒªã‚·ãƒ¼ã®ä½œæˆ

çµ„ã¿è¾¼ã¿é–¢æ•°ã® `current_setting` ã¨ `set_config` ã‚’ä½¿ã£ã¦ã€ã‚¢ã‚¯ã‚»ã‚¹ã—ãŸãƒ¦ãƒ¼ã‚¶ãƒ¼ã®è­˜åˆ¥å­ã‚’åˆ¤å®šã™ã‚‹æ–¹æ³•ã«ãªã‚Šã¾ã™ã€‚

https://www.postgresql.org/docs/current/functions-admin.html#FUNCTIONS-ADMIN-SET

æ—©é€Ÿ `inspection` Databaseã«æ¥ç¶šã—ã¦ä»¥ä¸‹ã®RLSã‚’ä½œæˆã—ã¦ã¿ã¾ã™ã€‚

```sql
inspection= CREATE EXTENSION IF NOT EXISTS "uuid-ossp";
inspection= CREATE TABLE users (
  id uuid default uuid_generate_v4() primary key,
  name text,
  company text,
  contact_email text
);
inspection= ALTER TABLE users ENABLE ROW LEVEL SECURITY;
inspection= CREATE POLICY user_policy ON users
USING (id = current_setting('app.user_id')::uuid);
```

é©å½“ã«ä½•ä»¶ã‹ãƒ‡ãƒ¼ã‚¿ã‚’ç™»éŒ²ã—ã¾ã™ã€‚

```sql
inspection= INSERT INTO users (name, company, contact_email) VALUES
  ('user1', 'company1', 'user1@example.com'),
  ('user2', 'company2', 'user2@example.com'),
  ('user3', 'company3', 'user3@example.com');
inspection= SELECT * FROM users;
                  id                  | name  | company  |   contact_email   
--------------------------------------+-------+----------+-------------------
 c3076642-2e59-4f0c-8109-7fdb28530e7f | user1 | company1 | user1@example.com
 1815d9ce-8b0c-4ef0-bce8-0c13d429145e | user2 | company2 | user2@example.com
 17d43dfb-b858-4404-bf16-924f43d01777 | user3 | company3 | user3@example.com
```

ã“ã“ã§è©¦ã—ã« `user2` ã® `id` ã‚’`set_config` ã§è¨­å®šã—ã¦ã‚¯ã‚¨ãƒªã—ã¦ã¿ã¾ã™ã€‚

```sql
inspection= SELECT set_config('app.user_id', '1815d9ce-8b0c-4ef0-bce8-0c13d429145e', false);
inspection= select current_setting('app.user_id');
           current_setting            
--------------------------------------
 1815d9ce-8b0c-4ef0-bce8-0c13d429145e

```

ã¡ã‚ƒã‚“ã¨è¨­å®šã§ãã¦ã„ã¾ã™ã€‚ã“ã“ã§ `role` ãŒ `postgres` ã ã¨ãƒ†ãƒ¼ãƒ–ãƒ«ã®Ownerãªã®ã§Policyé–¢ä¿‚ãªãã‚¢ã‚¯ã‚»ã‚¹ã§ãã¦ã—ã¾ã†ã®ã§ã€å…ˆã»ã©ä½œæˆã—ãŸ `managers` ãƒ­ãƒ¼ãƒ«ã«åˆ‡ã‚Šæ›¿ãˆã¦ã‚¯ã‚¨ãƒªã—ã¦ã¿ã¾ã™ã€‚

```sql
inspection= GRANT SELECT ON users TO managers;
inspection= SET ROLE managers;
inspection= SELECT * FROM users;
                  id                  | name  | company  |   contact_email   
--------------------------------------+-------+----------+-------------------
 1815d9ce-8b0c-4ef0-bce8-0c13d429145e | user2 | company2 | user2@example.com
```

ç„¡äº‹ `user2` ã ã‘ãŒå–å¾—ã§ãã¦ã„ã¾ã™ âœ¨

# ãƒªã‚¯ã‚¨ã‚¹ãƒˆæ™‚ã® `id` ã‚’ `set_config` ã«ã‚»ãƒƒãƒˆã™ã‚‹ã«ã¯?

æœ€å¾Œã«ã€ã“ã“ã¾ã§ã¯PostgreSQLå†…ã§æ“ä½œã—ã¦å®Œçµã—ã¦ã„ã¾ã—ãŸãŒã€å®Ÿéš›ã«ã¯ãƒãƒƒã‚¯ã‚¨ãƒ³ãƒ‰ç­‰ã§PostgreSQLã«ã‚¢ã‚¯ã‚»ã‚¹ã™ã‚‹ãªã©ã®ãƒ‘ã‚¿ãƒ¼ãƒ³ã®å ´åˆã‚’è€ƒãˆã¦ã¿ã¾ã™ã€‚

ã©ã†ã‚„ã‚‹ã‚“ã ã‚ã†ã¨èª¿ã¹ã¦ã„ãŸã‚‰â†“ã“ã¡ã‚‰ã®è¨˜äº‹ã‚’ç™ºè¦‹ã—ã¾ã—ãŸ âœ¨

https://zenn.dev/smallstall/articles/596d3981984587

ã©ã†ã‚„ã‚‰ `set_config` ã«ã¯ç¬¬3å¼•æ•°ã® `is_local` ãŒ `true` ã®å ´åˆãƒˆãƒ©ãƒ³ã‚¶ã‚¯ã‚·ãƒ§ãƒ³å†…ã ã‘é©ç”¨ã•ã‚Œã‚‹ãƒ•ãƒ©ã‚°ãŒå­˜åœ¨ã™ã‚‹ã‚ˆã†ã§ã€

ã“ã¡ã‚‰ã‚’ä½¿ã£ã¦ãƒªã‚¯ã‚¨ã‚¹ãƒˆã—ãŸãƒ¦ãƒ¼ã‚¶ãƒ¼ã® `id` ã‚’ã‚»ãƒƒãƒˆã™ã‚‹ã®ãŒè‰¯ã•ãã†ã§ã™ã€‚

# å‚è€ƒURL

https://zenn.dev/taxin/articles/postgresql-row-level-security-policy

https://dev.classmethod.jp/articles/postgresql-15-revoke-create-on-public-schema/

https://dev.classmethod.jp/articles/postgresql-organize-command/

https://supabase.com/docs/guides/database/postgres/row-level-security
