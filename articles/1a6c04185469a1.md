---
title: " ã€Flutterã€‘Codemagicã§TestFlightã¸Publishã™ã‚‹"
emoji: "ğŸ›«"
type: "tech" # tech: æŠ€è¡“è¨˜äº‹ / idea: ã‚¢ã‚¤ãƒ‡ã‚¢
topics:
  - "flutter"
  - "codemagic"
  - "testflight"
published: true
---

# æ¦‚è¦

[Codemagic](https://codemagic.io/start/)ã§ `codemagic.yaml` ã‚’ä½¿ã£ã¦ã€Flutterã‚¢ãƒ—ãƒªã‚’TestFlightã«Publishã§ãã‚‹ã¾ã§ã‚’æ›¸ãç•™ã‚ãŸãƒ¡ãƒ¢ã«ãªã‚Šã¾ã™ã€‚

[App Store Connect publishing using codemagic.yaml](https://docs.codemagic.io/yaml-publishing/app-store-connect/)

â†‘ã“ã¡ã‚‰ã®å…¬å¼ã®ãƒ‰ã‚­ãƒ¥ãƒ¡ãƒ³ãƒˆã‚’å…ƒã«é€²ã‚ã¦ã„ããŸã„ã¨æ€ã„ã¾ã™ã€‚

# äº‹å‰æº–å‚™

## App Store Connect API keyã®ä½œæˆ

1. App Store Connect ã«ãƒ­ã‚°ã‚¤ãƒ³ã—ã€ã€Œãƒ¦ãƒ¼ã‚¶ãƒ¼ã¨ã‚¢ã‚¯ã‚»ã‚¹ã€ > ã€Œã‚­ãƒ¼ã€ã«ç§»å‹•
    ![image1.png](/images/1a6c04185469a1/image1.png)

2. åˆå›ã¯ã€Œã‚¢ã‚¯ã‚»ã‚¹æ¨©ã‚’ãƒªã‚¯ã‚¨ã‚¹ãƒˆã€ãŒè¡¨ç¤ºã•ã‚Œã¦ã„ã‚‹ã®ã§ã€ã‚¯ãƒªãƒƒã‚¯
    ![image2.png](/images/1a6c04185469a1/image2.png)

3. ãƒ€ã‚¤ã‚¢ãƒ­ã‚°ã‚’ç¢ºèªã—ã€ã€Œæå‡ºã€ã‚’ã‚¯ãƒªãƒƒã‚¯
    ![image3.png](/images/1a6c04185469a1/image3.png =500x)

4. æ‰¿èªå¾Œã¯ã€ŒAPIã‚­ãƒ¼ã‚’ç”Ÿæˆã€ãŒè¡¨ç¤ºã•ã‚Œã¦ã„ã‚‹ã®ã§ã‚¯ãƒªãƒƒã‚¯
    ![image4.png](/images/1a6c04185469a1/image4.png)

5. æ¨©é™ã¯ã€ŒApp Managerã€ãŒå¿…è¦ãªã®ã§ã€åå‰ã‚’ä»Šå›ã¯ã€ŒPublisherã€ã€æ¨©é™ã‚’ã€ŒApp Managerã€ã«ã—ã¦ã‚­ãƒ¼ã‚’ä½œæˆ
    ![image5.png](/images/1a6c04185469a1/image5.png =500x)

6. ç§˜å¯†éµã®ãƒ€ã‚¦ãƒ³ãƒ­ãƒ¼ãƒ‰ã¯ä¸€åº¦ã—ã‹ã§ããªã„ã®ã§ã€æº–å‚™ãŒå‡ºæ¥æ¬¡ç¬¬ãƒ€ã‚¦ãƒ³ãƒ­ãƒ¼ãƒ‰ã€ç®¡ç†ã—ã¦ãŠã
    ![image6.png](/images/1a6c04185469a1/image6.png)

## ã‚¢ã‚«ã‚¦ãƒ³ãƒˆã® Apple Developer Portal çµ±åˆã‚’æ¥ç¶š

Codemagicã®ãƒ€ãƒƒã‚·ãƒ¥ãƒœãƒ¼ãƒ‰ã‹ã‚‰ã€ŒTeamsã€>ã€ŒPersonal Account(â€» ãƒãƒ¼ãƒ ã®å ´åˆã¯ãƒãƒ¼ãƒ å)ã€>ã€ŒIntegrationsã€ã‹ã‚‰ã€ŒDeveloper Portalã€ã®ã€ŒConnectã€ã‚’ã‚¯ãƒªãƒƒã‚¯ã—ã¾ã™ã€‚

![image7.png](/images/1a6c04185469a1/image7.png)

ãƒ¦ãƒ¼ã‚¶ã¨ã‚¢ã‚¯ã‚»ã‚¹ã¨ã€Œã‚­ãƒ¼ã€ã®ç”»é¢ã‚’å‚è€ƒã«ã—ãªãŒã‚‰å¿…è¦ãªé …ç›®ã‚’å…¥åŠ›ã—ã¾ã™ã€‚

![image8.png](/images/1a6c04185469a1/image8.png)

![image9.png](/images/1a6c04185469a1/image9.png =500x)

æœ€å¾Œã«ãƒ€ã‚¦ãƒ³ãƒ­ãƒ¼ãƒ‰ã—ãŸã‚­ãƒ¼ã‚’ã‚¢ãƒƒãƒ—ãƒ­ãƒ¼ãƒ‰ã—ã¦ã€ŒSaveã€ã‚’ã‚¯ãƒªãƒƒã‚¯ã—ã¾ã™ã€‚

æ­£ã—ãæ¥ç¶šã•ã‚Œã¦ã„ã‚Œã°â†“ã®æ§˜ãªè¡¨ç¤ºã«å¤‰ã‚ã‚‹ã‹ã¨æ€ã„ã¾ã™ã€‚

![image10.png](/images/1a6c04185469a1/image10.png)

# `codemagic.yaml` ã®ä½œæˆ

æº–å‚™ãŒå‡ºæ¥ãŸã®ã§TestFlightã¸ã‚¢ãƒƒãƒ—ãƒ­ãƒ¼ãƒ‰ã™ã‚‹ `codemagic.yaml` ã‚’ä½œæˆã—ã¦ã„ããŸã„ã¨æ€ã„ã¾ã™ã€‚ä»Šå›ã¯ `main` ãƒ–ãƒ©ãƒ³ãƒã«pushã•ã‚ŒãŸã‚‰TestFlightã¸ã‚¢ãƒƒãƒ—ãƒ­ãƒ¼ãƒ‰ã—æœ€å¾Œã« `dSYM` ã‚’Firebase Crashlyticsã«ã‚¢ãƒƒãƒ—ãƒ­ãƒ¼ãƒ‰ã™ã‚‹æµã‚Œã®å‡¦ç†ã‚’ä½œæˆã—ã¦ã„ã¾ã™ã€‚

ä»¥ä¸‹ãŒæœ€çµ‚çš„ãª `codemagic.yaml` ã«ãªã‚Šã¾ã™ã€‚ãƒã‚¤ãƒ³ãƒˆæ¯ã«èª¬æ˜ã—ã¦ã„ããŸã„ã¨æ€ã„ã¾ã™ã€‚
â€» å„verã‚„ç´°ã‹ã„è¨­å®šãªã©ã¯é©å®œä¿®æ­£ã—ã¦ãã ã•ã„ã€‚

```yaml
workflows:
  test-flight-ios-workflow:
    name: TestFlight iOS Workflow
    integrations:
      app_store_connect: Publisher
    labels:
      - iOS
    max_build_duration: 60
    instance_type: mac_mini_m1
    environment:
      ios_signing:
        distribution_type: app_store
        bundle_identifier: xxx.xxx.xxx
      vars:
        APP_ID: XXXXXXX
      flutter: v3.3.8
      xcode: latest
      cocoapods: default
    triggering:
      events:
        - push
      branch_patterns:
        - pattern: "main"
          include: true
          source: true
    scripts:
      - name: Set up code signing settings on Xcode project
        script: |
          xcode-project use-profiles
      - name: Get Flutter packages
        script: |
          flutter packages pub get
      - name: Install pods
        script: |
          find . -name "Podfile" -execdir pod install \;
      - name: Flutter build ipa and automatic versioning
        script: |
          flutter build ipa --release --dart-define=FLAVOR=production --flavor prod -t lib/main_prod.dart \
            --export-options-plist=/Users/builder/export_options.plist \
            --build-number=$(($(app-store-connect get-latest-testflight-build-number "$APP_ID") + 1))
    artifacts:
      - build/ios/ipa/*.ipa
      - /tmp/xcodebuild_logs/*.log
      - flutter_drive.log
      - $HOME/Library/Developer/Xcode/DerivedData/**/Build/**/*.dSYM
    publishing:
      # https://github.com/codemagic-ci-cd/codemagic-sample-projects/blob/bfcf910be8894ba63b875af6c942ac7e1dace526/integrations/firebase_crashlytics_demo_project/codemagic.yaml
      scripts:
        - name: Upload debug symbols to Firebase Crashlytics
          script: |
            echo "Find build artifacts"
            dsymPath=$(find $CM_BUILD_DIR/build/ios/archive/Runner.xcarchive -name "*.dSYM" | head -1)
            if [[ -z ${dsymPath} ]]
            then
              echo "No debug symbols were found, skip publishing to Firebase Crashlytics"
            else
              echo "Publishing debug symbols from $dsymPath to Firebase Crashlytics"
              ls -d -- ios/Pods/*
              $CM_BUILD_DIR/ios/Pods/FirebaseCrashlytics/upload-symbols \
                -gsp ios/Runner/GoogleService-Info.plist -p ios $dsymPath
            fi
      app_store_connect:
        auth: integration
        submit_to_testflight: true
        beta_groups:
          - Developer
```

## integrations / app_store_connect

```yaml
    integrations:
      app_store_connect: Publisher
```

ã“ã¡ã‚‰ã«ã¯å…ˆç¨‹Codemagicã®ãƒ€ãƒƒã‚·ãƒ¥ãƒœãƒ¼ãƒ‰ä¸Šã§ `AppStore Connect API key name` ã«è¨­å®šã—ãŸåå‰ã‚’è¨­å®šã—ã¦ã„ã¾ã™ã€‚ã“ã‚Œã§Codemagicä¸Šã§ **`App Store Connect API`** ã‚’ä½¿ãˆã‚‹ã‚ˆã†ã«ãªã‚Šã¾ã™ã€‚

## environment

```yaml
    environment:
      ios_signing:
        distribution_type: app_store
        bundle_identifier: xxx.xxx.xxx
      vars:
        APP_ID: XXXXXXX
      flutter: v3.3.8
      xcode: latest
      cocoapods: default
```

`ios_signing` ã«ã¯ä»Šå›TestFlightã¸ã®ã‚¢ãƒƒãƒ—ãƒ­ãƒ¼ãƒ‰ãªã®ã§ `app_store` ã‚’æŒ‡å®šã—ã€ `bundle_identifier` ã«ã¯ã‚¢ãƒƒãƒ—ãƒ­ãƒ¼ãƒ‰ã™ã‚‹ã‚¢ãƒ—ãƒªã®idã‚’è¨­å®šã—ã¾ã™ã€‚

`APP_ID` ã«é–¢ã—ã¦ã¯ `ipa` ã‚’ãƒ“ãƒ«ãƒ‰æ™‚ã® `build_number` ã‚’è¨­å®šã™ã‚‹éš›ã«ã€ç¾åœ¨ã®TestFlightã®version numberã‚’å–å¾—ã™ã‚‹ç‚ºã«ä½¿ç”¨ã—ã¾ã™ã€‚

```bash
          flutter build ipa --release --dart-define=FLAVOR=production --flavor prod -t lib/main_prod.dart \
            --export-options-plist=/Users/builder/export_options.plist \
            --build-number=$(($(app-store-connect get-latest-testflight-build-number "$APP_ID") + 1))
```

`APP_ID` ã¯ `App Store Connect` ã§å¯¾è±¡ã‚¢ãƒ—ãƒªã‚’é–‹ãã€ã€Œä¸€èˆ¬ã€>ã€Œã‚¢ãƒ—ãƒªæƒ…å ±ã€ã®ã€ŒApple IDã€ã®å€¤ã«ãªã‚Šã¾ã™ã€‚

![image11.png](/images/1a6c04185469a1/image11.png)

### â€» é–“é•ã„ã‚„ã™ã„é …ç›®

- [get-latest-app-store-build-number](https://github.com/codemagic-ci-cd/cli-tools/blob/master/docs/app-store-connect/get-latest-app-store-build-number.md#optional-arguments-for-action-get-latest-app-store-build-number)Â ã¨Â [get-latest-testflight-build-number](https://github.com/codemagic-ci-cd/cli-tools/blob/master/docs/app-store-connect/get-latest-testflight-build-number.md#optional-arguments-for-action-get-latest-testflight-build-number)
  - AppStoreã«å…¬é–‹ã—ã¦ã„ã‚‹buildç•ªå·ã‚’å–å¾—ã™ã‚‹ãƒ¡ã‚½ãƒƒãƒ‰ã¨TestFlightã®buildç•ªå·ã‚’å–å¾—ã™ã‚‹ãƒ¡ã‚½ãƒƒãƒ‰ãŒã‚ã‚‹ã®ã§é–“é•ãˆãªã„ã‚ˆã†ã«ã™ã‚‹

## publishing

`dSYM` ã®ã‚¢ãƒƒãƒ—ãƒ­ãƒ¼ãƒ‰ã¯ codemagicã®ã‚µãƒ³ãƒ—ãƒ«ãƒ—ãƒ­ã‚¸ã‚§ã‚¯ãƒˆã®[ã“ã¡ã‚‰](https://github.com/codemagic-ci-cd/codemagic-sample-projects/blob/bfcf910be8894ba63b875af6c942ac7e1dace526/integrations/firebase_crashlytics_demo_project/codemagic.yaml#L41)ã¨ã»ã¼åŒã˜å®Ÿè£…ã«ãªã£ã¦ã„ã¾ã™ã€‚

æœ€å¾Œã« `app_store_connect` ã«ã¦TestFlightã«ã‚¢ãƒƒãƒ—ãƒ­ãƒ¼ãƒ‰ã—ã€ `submit_to_testflight` ã‚’æœ‰åŠ¹åŒ–ã™ã‚‹äº‹ã§ `beta_groups` ã«æŒ‡å®šã—ãŸã‚°ãƒ«ãƒ¼ãƒ—ã«é…å¸ƒã™ã‚‹ã‚ˆã†ã«ã—ã¦ã„ã¾ã™ã€‚

# ã¾ã¨ã‚

ä»Šå› `get-latest-app-store-build-number` ã¨ `get-latest-testflight-build-number` ã‚’æ··åŒã—ã¦ã„ãŸç‚ºå°‘ã—ãƒãƒã‚Šã¾ã—ãŸãŒã€
äº‹å‰ã«Integrationsè¨­å®šã‚’è¡Œã£ã¦ãŠãã“ã¨ã§æ¯”è¼ƒçš„ã‚¹ãƒ ãƒ¼ã‚ºã«TestFlightã«é…å¸ƒã§ãã‚‹ã¾ã§ã‚’è¨­å®šã§ããŸã‹ã¨æ€ã„ã¾ã™ã€‚
