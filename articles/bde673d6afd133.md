---
title: "ã€Androidã€‘Jetpack Roomå°å…¥~åŸºæœ¬çš„ãªä½¿ã„æ–¹~ã‚·ãƒ¼ãƒ‰ãƒ‡ãƒ¼ã‚¿ç™»éŒ²ã¾ã§"
emoji: "ğŸ "
type: "tech" # tech: æŠ€è¡“è¨˜äº‹ / idea: ã‚¢ã‚¤ãƒ‡ã‚¢
topics:
  - "android"
  - "jetpack"
  - "room"
  - "kotlin"
published: false
---
# ã¯ã˜ã‚ã«

ä»Šå›ã¯Jetpack Roomã®å°å…¥æ–¹æ³•ã‹ã‚‰åŸºæœ¬çš„ãªä½¿ã„æ–¹ã€ã‚·ãƒ¼ãƒ‰ãƒ‡ãƒ¼ã‚¿ã‚’ç™»éŒ²ã™ã‚‹ã‚µãƒ³ãƒ—ãƒ«ã¾ã§ã‚’ã‚„ã£ã¦ã„ããŸã„ã¨æ€ã„ã¾ã™ã€‚

Jetpack Roomã¨ã¯?
> Jetpack Roomã¯ã€Android Jetpackã®ä¸€éƒ¨ã§ã‚ã‚‹æ°¸ç¶šãƒ‡ãƒ¼ã‚¿ãƒ™ãƒ¼ã‚¹ãƒ©ã‚¤ãƒ–ãƒ©ãƒªã§ã™ã€‚Roomã¯SQLiteã‚’å¯¾è±¡ã¨ã—ãŸæŠ½è±¡åŒ–ãƒ¬ã‚¤ãƒ¤ã§ã€ãƒ‡ãƒ¼ã‚¿ãƒ™ãƒ¼ã‚¹ã®ã‚»ãƒƒãƒˆã‚¢ãƒƒãƒ—ã€è¨­å®šã€ã‚¯ã‚¨ãƒªã‚’è¡Œã†ãŸã‚ã®ä¾¿åˆ©ãªAPIãŒç”¨æ„ã•ã‚Œã¦ã„ã¾ã™ã€‚ã“ã‚Œã«ã‚ˆã‚Šã€Androidã‚¢ãƒ—ãƒªãŒãƒ‡ãƒ¼ã‚¿ãƒ™ãƒ¼ã‚¹ã¨ã‚„ã‚Šã¨ã‚Šã™ã‚‹éš›ã®å‡¦ç†ã‚’è‡ªå‹•åŒ–ã™ã‚‹ã“ã¨ãŒå¯èƒ½ã«ãªã‚Šã¾ã™

- [Room ã‚’ä½¿ç”¨ã—ã¦ãƒ‡ãƒ¼ã‚¿ã‚’æ°¸ç¶šåŒ–ã™ã‚‹ Â |Â  Android Developers](https://developer.android.com/codelabs/basic-android-kotlin-compose-persisting-data-room?hl=ja#0)
- [Room ã‚’ä½¿ç”¨ã—ã¦ãƒ­ãƒ¼ã‚«ãƒ« ãƒ‡ãƒ¼ã‚¿ãƒ™ãƒ¼ã‚¹ã«ãƒ‡ãƒ¼ã‚¿ã‚’ä¿å­˜ã™ã‚‹ Â |Â  ãƒ‡ãƒ™ãƒ­ãƒƒãƒ‘ãƒ¼å‘ã‘ Android Â |Â  Android Developers](https://developer.android.com/training/data-storage/room?hl=ja)

# Roomã®æœ€æ–°ãƒãƒ¼ã‚¸ãƒ§ãƒ³

[AndroidX Tech: androidx.room:room-ktx](https://androidx.tech/artifacts/room/room-ktx/)

â†‘ã“ã¡ã‚‰ã‹ã‚‰ç¢ºèªã§ãã¾ã™ã€‚

# ã‚»ãƒƒãƒˆã‚¢ãƒƒãƒ—

## Ksp gradle pluginå°å…¥

`gradle/libs.versions.toml` ã«ä»¥ä¸‹ã‚’è¿½åŠ 

```toml
[versions]
ksp = "1.9.0-1.0.13"

[plugins]
ksp-gradle-plugin = { id = "com.google.devtools.ksp", version.ref = "ksp" }
```

`org.jetbrains.kotlin.android` pluginãŒå¤ã„ã¨æ€’ã‚‰ã‚Œã‚‹ã®ã§ `1.9.10` ä»¥ä¸Šã«ã—ã¦ãŠãã¾ã™ã€‚

`app/build.gradle.kts` ã«ä»¥ä¸‹ã‚’è¿½åŠ ã—ã¾ã™ã€‚

```kotlin
plugins {
    alias(libs.plugins.ksp.gradle.plugin) // è¿½åŠ 
}
```

## Roomé–¢é€£ãƒ‘ãƒƒã‚±ãƒ¼ã‚¸å°å…¥

`gradle/libs.versions.toml` ã«ä»¥ä¸‹ã‚’è¿½åŠ ã—ã¾ã™ã€‚

```toml
[versions]
room = "2.6.0"
lifecycle-runtime-ktx = "2.6.2" # lifecycleScopeã‚’æ‰±ã†ãŸã‚è¿½åŠ 

[libraries]
lifecycle-runtime-ktx = { group = "androidx.lifecycle", name = "lifecycle-runtime-ktx", version.ref = "lifecycle-runtime-ktx" }
# room
room-runtime = { module = "androidx.room:room-runtime", version.ref = "room" }
room-ktx = { module = "androidx.room:room-ktx", version.ref = "room" }
room-compiler = { module = "androidx.room:room-compiler", version.ref = "room" }
```

`app/build.gradle.kts` ã«ä»¥ä¸‹ã‚’è¿½åŠ ã—ã¾ã™ã€‚

```kotlin
dependencies {
    implementation(libs.lifecycle.runtime.ktx)
    // room
    implementation(libs.room.runtime)
    implementation(libs.room.ktx)
    annotationProcessor(libs.room.compiler)
    ksp(libs.room.compiler)
}
```

# ä¸»è¦ã‚³ãƒ³ãƒãƒ¼ãƒãƒ³ãƒˆ

æ—©é€ŸåŸºæœ¬çš„ãªä½¿ã„æ–¹ã‚’å®Ÿè£…ã™ã‚‹ã«å½“ãŸã‚Šã€ä»¥ä¸‹ã®ä¸»è¦ã‚³ãƒ³ãƒãƒ¼ãƒãƒ³ãƒˆã‚’ãã‚Œãã‚Œå®Ÿè£…ã—ã¦ã„ãå½¢ã«ãªã‚Šã¾ã™ã€‚

![image1.png](/images/bde673d6afd133/image1.png =500x)

- [Room ã‚¨ãƒ³ãƒ†ã‚£ãƒ†ã‚£](https://developer.android.com/training/data-storage/room/defining-data?hl=ja)
  - ä¿å­˜ã™ã‚‹ã‚ªãƒ–ã‚¸ã‚§ã‚¯ãƒˆã‚’è¡¨ã™ã‚ˆã†ã«ã‚¨ãƒ³ãƒ†ã‚£ãƒ†ã‚£ã‚’å®šç¾©ã—ã¾ã™
  - å„ã‚¨ãƒ³ãƒ†ã‚£ãƒ†ã‚£ã¯ã€é–¢é€£ä»˜ã‘ã‚‰ã‚ŒãŸ Room ãƒ‡ãƒ¼ã‚¿ãƒ™ãƒ¼ã‚¹å†…ã®ãƒ†ãƒ¼ãƒ–ãƒ«ã«å¯¾å¿œã—ã€ã‚¨ãƒ³ãƒ†ã‚£ãƒ†ã‚£ã®å„ã‚¤ãƒ³ã‚¹ã‚¿ãƒ³ã‚¹ã¯ã€å¯¾å¿œã™ã‚‹ãƒ†ãƒ¼ãƒ–ãƒ«ã®ãƒ‡ãƒ¼ã‚¿è¡Œã‚’è¡¨ã—ã¾ã™
- [RoomÂ DAO](https://developer.android.com/training/data-storage/room/accessing-data?hl=ja)
  - ãƒ‡ãƒ¼ã‚¿ã‚¢ã‚¯ã‚»ã‚¹ ã‚ªãƒ–ã‚¸ã‚§ã‚¯ãƒˆï¼ˆDAOï¼‰ã‚’å®šç¾©ã—ã¦ã€ä¿å­˜å¯¾è±¡ã®ãƒ‡ãƒ¼ã‚¿ã‚’æ“ä½œã—ã¾ã™
  - å„ DAO ã¯ã€ã‚¢ãƒ—ãƒªã®ãƒ‡ãƒ¼ã‚¿ãƒ™ãƒ¼ã‚¹ã¸ã®æŠ½è±¡ã‚¢ã‚¯ã‚»ã‚¹ã‚’å¯èƒ½ã«ã™ã‚‹ãƒ¡ã‚½ãƒƒãƒ‰ã‚’å‚™ãˆã¦ã„ã¾ã™
  - ã‚³ãƒ³ãƒ‘ã‚¤ãƒ«æ™‚ã«å®šç¾©ã—ãŸ DAO ã®å®Ÿè£…ã‚’è‡ªå‹•çš„ã«ç”Ÿæˆã—ã¾ã™
- [RoomÂ Database ã‚¯ãƒ©ã‚¹](https://developer.android.com/reference/kotlin/androidx/room/Database?hl=ja)
  - ãƒ‡ãƒ¼ã‚¿ãƒ™ãƒ¼ã‚¹ã‚’ä¿æŒã—ã€ã‚¢ãƒ—ãƒªã®æ°¸ç¶šãƒ‡ãƒ¼ã‚¿ã«å¯¾ã™ã‚‹åŸºç¤çš„ãªæ¥ç¶šã®ãƒ¡ã‚¤ãƒ³ã‚¢ã‚¯ã‚»ã‚¹ãƒã‚¤ãƒ³ãƒˆã¨ã—ã¦æ©Ÿèƒ½ã—ã¾ã™

# Entityå®Ÿè£…

ä»Šå›ã¯ `User` Entityã‚’ä½œæˆã—ã¦ã¿ãŸã„ã¨æ€ã„ã¾ã™ã€‚ `app/data/user` é…ä¸‹ã« `User.kt`ã‚’ä»¥ä¸‹å†…å®¹ã§ä½œæˆã—ã¾ã™ã€‚

```kotlin
import androidx.room.Entity
import androidx.room.PrimaryKey

@Entity(tableName = "users")
data class User(
    @PrimaryKey(autoGenerate = true)
    val id: Int,
    var name: String = "",
    var image: String
)
```

# DAOå®Ÿè£…

å…ˆç¨‹ä½œæˆã—ãŸ `User` Entityã®DAOã‚’ä½œæˆã—ã¦ã¿ã¾ã™ã€‚`app/data/user` é…ä¸‹ã« `UserDao.kt`ã‚’ä»¥ä¸‹å†…å®¹ã§ä½œæˆã—ã¾ã™ã€‚

```kotlin
import androidx.room.Dao
import androidx.room.Insert
import androidx.room.Query
import kotlinx.coroutines.flow.Flow

@Dao
interface UserDao {
    @Query("SELECT * from users WHERE id = :id")
    fun getUser(id: Int): Flow<User>

    @Insert
    suspend fun insert(user: User)
}
```

ä¸€æ—¦idæŒ‡å®šã—ã¦Userå–å¾—ã¨ç™»éŒ²ã ã‘ã§ãã‚‹Daoã‚’ä½œæˆã—ã¦ã¾ã™ã€‚

# Databaseå®Ÿè£…

`Entity`Â ã¨ DAO ã‚’ä½¿ç”¨ã™ã‚‹Â `[RoomDatabase](https://developer.android.com/reference/androidx/room/RoomDatabase?hl=ja)`Â ã‚’ä½œæˆã—ã¾ã™

```kotlin
@Database(entities = [User::class], version = 1, exportSchema = false)
abstract class AppDatabase : RoomDatabase() {
    abstract fun userDao(): UserDao

    companion object {
        @Volatile
        private var Instance: AppDatabase? = null

        fun getDatabase(context: Context): AppDatabase {
            // if the Instance is not null, return it, otherwise create a new database instance.
            return Instance ?: synchronized(this) {
                Room.databaseBuilder(context, AppDatabase::class.java, "app_database")
                    .fallbackToDestructiveMigration()
                    .build()
                    .also { Instance = it }
            }
        }
    }
}
```

`@Volatile`Â ã‚¢ãƒãƒ†ãƒ¼ã‚·ãƒ§ãƒ³ã‚’ä»˜ã‘ã€*`synchronized`*ã§å›²ã‚€ã“ã¨ã§ã‚¹ãƒ¬ãƒƒãƒ‰ã‚»ãƒ¼ãƒ•ã«ã—ã¦ã¾ã™ã€‚

[fallbackToDestructiveMigration](https://developer.android.com/reference/androidx/room/RoomDatabase.Builder#fallbackToDestructiveMigration()) ã‚’ä»˜ã‘ã‚‹ã¨ãƒã‚¤ã‚°ãƒ¬ãƒ¼ã‚·ãƒ§ãƒ³ã«å¤±æ•—ã—ãŸã‚‰**ãƒ‡ãƒ¼ã‚¿å‰Šé™¤ã—ã¦**Databaseã‚’å†æ§‹ç¯‰ã—ã¾ã™ã€‚

è©¦ã—ã«å®Ÿè¡Œã—ã¦ã¿ã¾ã™ã€‚å®Ÿéš›ã®ãƒ—ãƒ­ãƒ€ã‚¯ã‚·ãƒ§ãƒ³ã‚³ãƒ¼ãƒ‰ã§ã¯ä½¿ãˆã¾ã›ã‚“ãŒã€ä¸€åº¦é™ã‚Šã®ç¢ºèªç”¨ã®ä»¥ä¸‹ã‚³ãƒ¼ãƒ‰ã‚’ `MainActivity` ã® `onCreate` ã«è¿½åŠ ã—ã€å‹•ã‹ã—ã¦ã¿ã‚‹ã¨Logcatã«ç™»éŒ²ã•ã‚ŒãŸãƒ¦ãƒ¼ã‚¶ãƒ¼ãŒè¡¨ç¤ºã•ã‚Œã‚‹ã‹ã¨æ€ã„ã¾ã™ã€‚

```kotlin
val db = AppDatabase.getDatabase(applicationContext)
val repository: UserRepository = UserRepository(db.userDao())
val user = User(name = "Hoge", image = "Image")
lifecycleScope.launch {
    repository.insertUser(user)
    repository.getUsers().collect {
        Timber.d("user: $it")
    }
}
```

# ã‚·ãƒ¼ãƒ‰ãƒ‡ãƒ¼ã‚¿ç™»éŒ²

æ¬¡ã«DBä½œæˆå¾Œã«ä¸€åº¦ã ã‘ãƒ‡ãƒ¼ã‚¿ã‚’ç™»éŒ²ã™ã‚‹ã‚ˆã†ãªå‡¦ç†ã‚’å®Ÿè£…ã—ãŸã„ã¨æ€ã„ã¾ã™ã€‚

`databaseBuilder` ã® `addCallback` ã§ã‚³ãƒ¼ãƒ«ãƒãƒƒã‚¯ã‚’è¿½åŠ ã—ã€onCreateã‚’overrideã—ãã®ä¸­ã§ã‚·ãƒ¼ãƒ‰ãƒ‡ãƒ¼ã‚¿ã‚’ç™»éŒ²ã™ã‚‹ã‚ˆã†ã«ã—ã¾ã™ã€‚

```kotlin
@Database(entities = [User::class], version = 1, exportSchema = false)
abstract class AppDatabase : RoomDatabase() {
    abstract fun userDao(): UserDao

    companion object {
        @Volatile
        private var Instance: AppDatabase? = null

        fun getDatabase(context: Context, scope: CoroutineScope): AppDatabase {
            // if the Instance is not null, return it, otherwise create a new database instance.
            return Instance ?: synchronized(this) {
                Room.databaseBuilder(context, AppDatabase::class.java, "rediary_database")
                    .fallbackToDestructiveMigration()
                    .addCallback(seedCallback(context, scope))
                    .build()
                    .also { Instance = it }
            }
        }

        private fun seedCallback(context: Context, scope: CoroutineScope): Callback {
            return object : Callback() {
                override fun onCreate(db: SupportSQLiteDatabase) {
                    super.onCreate(db)
                    Instance?.let {
                        scope.launch(Dispatchers.IO) {
                            val repository: UserRepository = UserRepository(it.userDao())
                            val user = User(name = "Hoge", image = "Image")
                            repository.insertUser(user)
                        }
                    }
                }
            }
        }
    }
}
```

ä¸Šè¨˜ã®ä¾‹ã§ã¯ `seedCallback` ã‚’ç™»éŒ²ã—ã€DBãŒä½œæˆã•ã‚ŒãŸã‚¿ã‚¤ãƒŸãƒ³ã‚°ã§æ¸¡ã•ã‚ŒãŸ `CoroutineScope` ã‚’ `Dispatchers.IO` ã§èµ·å‹•ã—ã‚·ãƒ¼ãƒ‰ãƒ‡ãƒ¼ã‚¿ã‚’ç™»éŒ²ã—ã¦ã„ã¾ã™ã€‚

MainActivityå´ã§å…ˆç¨‹ã®ã‚³ãƒ¼ãƒ‰ã‚’ä»¥ä¸‹ã«ä¿®æ­£ã—ã¾ã™ã€‚

```kotlin
val db = AppDatabase.getDatabase(applicationContext, lifecycleScope)
val repository: UserRepository = UserRepository(db.userDao())
lifecycleScope.launch {
    repository.getUsers().collect {
        Timber.d("user: $it")
    }
}
```

`getDatabase` ã« `lifecycleScope` ã‚’æ¸¡ã™ã‚ˆã†ã«ä¿®æ­£ã—ã¦ã„ã¾ã™ã€‚å®Ÿéš›ã¯ãã®æ™‚ã€…ã® `CoroutineScope` ã‚’ä½¿ã†ã‚ˆã†ã«ãªã‚‹ã‹ã¨æ€ã„ã¾ã™ã€‚

ä»–ã«ã‚‚ã„ã„ã‚„ã‚Šæ–¹ãŒã‚ã‚‹ã‹ã‚‚ã§ã™ãŒä»Šå›ã¯ã“ã®æ–¹æ³•ã‚’è©¦ã—ã¦ã¿ã¾ã—ãŸã€‚

**ã¾ãŸã€ã‚³ãƒ¼ãƒ«ãƒãƒƒã‚¯ã® `onCreate` ãŒå‘¼ã³å‡ºã•ã‚Œã‚‹ã‚¿ã‚¤ãƒŸãƒ³ã‚°ã¨ã—ã¦ã¯ã€å®Ÿéš›ã«Queryã‚„Insertãªã©å‡¦ç†ãŒèµ°ã£ãŸåˆå›æ™‚ã«å‘¼ã³å‡ºã•ã‚Œã¾ã™ã€‚**

# å‚è€ƒURL

- [kaptã‹ã‚‰kspã«å¤‰ã‚ã‚‹ã¨ã©ã‚Œãã‚‰ã„æ—©ããªã‚‹ã®ã‹ã€œRoomç·¨ã€œ - Qiita](https://qiita.com/RyuNen344/items/d61f1bc1cf57f575eace)
- [Android: Roomã®ã‚¢ãƒãƒ†ãƒ¼ã‚·ãƒ§ãƒ³ãƒ—ãƒ­ã‚»ãƒƒã‚µã‚’KSPã«å¤‰æ›´ã™ã‚‹ - å‰äººæœªè¸ã®é ˜åŸŸã¸ Androidã‚¢ãƒ—ãƒªé–‹ç™ºç·¨](https://takerpg.hatenablog.jp/entry/2022/09/10/182536)
- [Roomã®ãƒã‚¤ã‚°ãƒ¬ãƒ¼ã‚·ãƒ§ãƒ³ã¾ã¨ã‚](https://star-zero.medium.com/roomã®ãƒã‚¤ã‚°ãƒ¬ãƒ¼ã‚·ãƒ§ãƒ³ã¾ã¨ã‚-a07593aa7c78)
- [Seed Android Room Database with Kotlin](https://matthiaslischka.at/2019/01/15/Seed-Room-Database/)
- [https://github.com/estherlaraaaa/android-room-with-a-view-kotlin](https://github.com/estherlaraaaa/android-room-with-a-view-kotlin)