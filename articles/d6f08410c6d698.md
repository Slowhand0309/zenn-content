---
title: "ã€Androidã€‘Ktorã§HTTPã‚¯ãƒ©ã‚¤ã‚¢ãƒ³ãƒˆå®Ÿè£…"
emoji: "ğŸš€"
type: "tech" # tech: æŠ€è¡“è¨˜äº‹ / idea: ã‚¢ã‚¤ãƒ‡ã‚¢
topics:
  - "android"
  - "kotlin"
  - "ktor"
  - "compose"
published: true
---
# ã¯ã˜ã‚ã«

ä»Šå›ã¯Ktorã‚’ä½¿ã£ãŸAndroidã‚¢ãƒ—ãƒªã§ã®HTTPã‚¯ãƒ©ã‚¤ã‚¢ãƒ³ãƒˆã®ã‚»ãƒƒãƒˆã‚¢ãƒƒãƒ—ã€œç°¡å˜ãªå®Ÿè£…ã¾ã§ã®è¨˜äº‹ã«ãªã‚Šã¾ã™ã€‚

# ãƒ©ã‚¤ãƒ–ãƒ©ãƒªã®å€™è£œ

Ktorã‚’è©¦ã™å‰ã«ãã‚‚ãã‚‚Androidã‚¢ãƒ—ãƒªã§HTTPã‚¯ãƒ©ã‚¤ã‚¢ãƒ³ãƒˆã‚’æ‰±ã†å ´åˆã€ã©ã®ã‚ˆã†ãªãƒ©ã‚¤ãƒ–ãƒ©ãƒªãŒå€™è£œã«ã‚ã‚‹ã®ã‹èª¿ã¹ã¦ã¿ã¾ã—ãŸã€‚

## 1. Retrofit

https://square.github.io/retrofit/

> Retrofitã¯ã€SquareãŒæä¾›ã™ã‚‹äººæ°—ã®é«˜ã„HTTPã‚¯ãƒ©ã‚¤ã‚¢ãƒ³ãƒˆãƒ©ã‚¤ãƒ–ãƒ©ãƒªã§ã™ã€‚APIã‚¨ãƒ³ãƒ‰ãƒã‚¤ãƒ³ãƒˆã‚’ã‚¤ãƒ³ã‚¿ãƒ¼ãƒ•ã‚§ãƒ¼ã‚¹ã¨ã—ã¦å®šç¾©ã—ã€ã‚¢ãƒãƒ†ãƒ¼ã‚·ãƒ§ãƒ³ã‚’ä½¿ç”¨ã—ã¦HTTPãƒ¡ã‚½ãƒƒãƒ‰ã‚„URLãƒ‘ã‚¹ã‚’æŒ‡å®šã§ãã¾ã™ã€‚

## 2. OkHttp

https://square.github.io/okhttp/

> OkHttpã¯ã€Retrofitã®åŸºç›¤ã¨ãªã£ã¦ã„ã‚‹HTTPã‚¯ãƒ©ã‚¤ã‚¢ãƒ³ãƒˆãƒ©ã‚¤ãƒ–ãƒ©ãƒªã§ã™ã€‚ä½ãƒ¬ãƒ™ãƒ«ã®HTTPæ“ä½œãŒå¿…è¦ãªå ´åˆã‚„ã€ã‚«ã‚¹ã‚¿ãƒã‚¤ã‚ºã•ã‚ŒãŸãƒªã‚¯ã‚¨ã‚¹ãƒˆ/ãƒ¬ã‚¹ãƒãƒ³ã‚¹ãƒãƒ³ãƒ‰ãƒªãƒ³ã‚°ãŒå¿…è¦ãªå ´åˆã«ä½¿ç”¨ã•ã‚Œã¾ã™ã€‚

## 3. Ktor

https://ktor.io/

> Ktorã¯ã€Kotlinè£½ã®éåŒæœŸWebãƒ•ãƒ¬ãƒ¼ãƒ ãƒ¯ãƒ¼ã‚¯ã§ã€ã‚¯ãƒ©ã‚¤ã‚¢ãƒ³ãƒˆã¨ã‚µãƒ¼ãƒãƒ¼ã®ä¸¡æ–¹ã§ä½¿ç”¨ã§ãã¾ã™ã€‚Jetpack Composeã¨çµ„ã¿åˆã‚ã›ã¦ä½¿ã†ã¨ã€ãƒã‚¤ãƒ†ã‚£ãƒ–ã«éåŒæœŸå‡¦ç†ãŒè¡Œãˆã¾ã™ã€‚

èª¿ã¹ã¦ã¿ã‚‹ã¨ã€Retrofitã¨Ktorã®æ¯”è¼ƒã‚„ã€Retrofitã‹ã‚‰Ktorã¸ç§»è¡Œã™ã‚‹å ´åˆã®è¨˜äº‹ãŒã¡ã‚‰ã»ã‚‰å‡ºã¦ãã¾ã™ã€‚ãƒãƒ«ãƒãƒ—ãƒ©ãƒƒãƒˆãƒ•ã‚©ãƒ¼ãƒ ã§ã‚ã‚Œã°Ktorã€Androidã®HTTPã‚¯ãƒ©ã‚¤ã‚¢ãƒ³ãƒˆã¨ã—ã¦ã¯ã©ã¡ã‚‰ã‹ã¨ã„ã†é¸æŠè‚¢ã«ãªã£ã¦ãã‚‹ã®ã‹ã‚‚ã—ã‚Œãªã„ã§ã™ã­ã€‚

https://www.reddit.com/r/androiddev/comments/zna320/ktor_or_retrofit/

https://apiumhub.com/tech-blog-barcelona/migrating-retrofit-to-ktor/

# ç’°å¢ƒæ§‹ç¯‰ã‚„æº–å‚™

å„ãƒãƒ¼ã‚¸ãƒ§ãƒ³ã‚„ç’°å¢ƒ

```text
# Android Studio Jellyfish | 2023.3.1
$ sw_vers
ProductName: macOS
ProductVersion: 14.5
BuildVersion: 23F79
```

## 1. ã‚µãƒ³ãƒ—ãƒ«ãƒ—ãƒ­ã‚¸ã‚§ã‚¯ãƒˆã®ä½œæˆ

æ—©é€Ÿã‚µãƒ³ãƒ—ãƒ«ãƒ—ãƒ­ã‚¸ã‚§ã‚¯ãƒˆã‚’ä½œæˆã—Ktorã‚’è©¦ã—ã¦ã„ããŸã„ã¨æ€ã„ã¾ã™ã€‚

ã¾ãšã¯ã€AndroidStudioã®ã€ŒNew Projectã€ã§ã€ŒEmpty Activityã€ã‚’é¸æŠã—ã¾ã™ã€‚

![image1.png](/images/d6f08410c6d698/image1.png =500x)

ä»Šå›ã¯åå‰ã‚’ã€ŒKtorExampleã€ã«ã— `Package name` ã‚’ã€Œcom.example.ktorexampleã€ã¨ã—ã¦é€²ã‚ã¦ã„ãã¾ã™ã€‚

![image2.png](/images/d6f08410c6d698/image2.png =500x)

## 2. Ktorã¨Coroutinesã®ã‚¤ãƒ³ã‚¹ãƒˆãƒ¼ãƒ«

### 2-1. `gradle/libs.versions.toml` ã«ä»¥ä¸‹ã‚’è¿½åŠ 

```toml
[versions]
ktor = "2.3.11"
coroutines = "1.8.1"

[libraries]
ktor-client-core = { module = "io.ktor:ktor-client-core", version.ref = "ktor" }
ktor-client-cio = { module = "io.ktor:ktor-client-cio", version.ref = "ktor" }

kotlinx-coroutines-core = { module = "org.jetbrains.kotlinx:kotlinx-coroutines-core", version.ref = "coroutines" }
kotlinx-coroutines-android = { module = "org.jetbrains.kotlinx:kotlinx-coroutines-android", version.ref = "coroutines" }
```

### 2-2. `app/build.gradle.kts` ã«ä»¥ä¸‹ã‚’è¿½åŠ 

```kotlin
dependencies {
    implementation(libs.ktor.client.core)
    implementation(libs.ktor.client.cio)
    
    implementation(libs.kotlinx.coroutines.core)
    implementation(libs.kotlinx.coroutines.android)
}
```

# å®Ÿè£…

## 1. ç°¡å˜ãªå®Ÿè£…

[ã“ã¡ã‚‰](https://ktor.io/docs/client-create-multiplatform-application.html#coroutines) ã®ãƒ‰ã‚­ãƒ¥ãƒ¡ãƒ³ãƒˆã«è¨˜è¼‰ã•ã‚Œã¦ã„ã‚‹ã‚µãƒ³ãƒ—ãƒ«ã‚’ãã®ã¾ã¾è©¦ã—ã¦ã¿ãŸã„ã¨æ€ã„ã¾ã™ã€‚

`com.example.ktorexample.data` ã« `Greeting.kt` ã‚’ä»¥ä¸‹å†…å®¹ã§ä½œæˆã—ã¾ã™ã€‚

### 1-1. Greeting.kt

```kotlin
package com.example.ktorexample.data

import io.ktor.client.*
import io.ktor.client.request.*
import io.ktor.client.statement.*

class Greeting {
    private val client = HttpClient()

    suspend fun greeting(): String {
        val response = client.get("https://ktor.io/docs/")
        return response.bodyAsText()
    }
}
```

æ¬¡ã« `MainActivity.kt` ã‚’ä»¥ä¸‹ã«ä¿®æ­£ã—ã¾ã™ã€‚

### 1-2. MainActivity.kt

```kotlin
class MainActivity : ComponentActivity() {
    override fun onCreate(savedInstanceState: Bundle?) {
        super.onCreate(savedInstanceState)
        enableEdgeToEdge()
        setContent {
            KtorExampleTheme {
                Scaffold(modifier = Modifier.fillMaxSize()) { innerPadding ->
                    val scope = rememberCoroutineScope()
                    var text by remember { mutableStateOf("Loading") }
                    LaunchedEffect(true) {
                        scope.launch {
                            text = try {
                                Greeting().greeting()
                            } catch (e: Exception) {
                                e.localizedMessage ?: "error"
                            }
                        }
                    }
                    Greeting(
                        name = text,
                        modifier = Modifier.padding(innerPadding)
                    )
                }
            }
        }
    }
}
```

æœ€å¾Œã« `AndroidManifest.xml` ã« `<uses-permission android:name="android.permission.INTERNET" />` ã‚’è¿½åŠ ã—ã€å®Ÿè¡Œã™ã‚‹ã¨â†“ã®æ§˜ã«HTMLãŒè¡¨ç¤ºã•ã‚Œã¦ã„ã‚Œã°OKã§ã™ã€‚

![image3.png](/images/d6f08410c6d698/image3.png =400x)

## 2. Engines

> Ktor HTTPã‚¯ãƒ©ã‚¤ã‚¢ãƒ³ãƒˆã¯ã€JVMã€Androidã€JavaScriptã€Nativeãªã©ã€ã•ã¾ã–ã¾ãªãƒ—ãƒ©ãƒƒãƒˆãƒ•ã‚©ãƒ¼ãƒ ã§ä½¿ç”¨ã§ãã¾ã™ã€‚ç‰¹å®šã®ãƒ—ãƒ©ãƒƒãƒˆãƒ•ã‚©ãƒ¼ãƒ ã§ã¯ã€ãƒãƒƒãƒˆãƒ¯ãƒ¼ã‚¯ãƒªã‚¯ã‚¨ã‚¹ãƒˆã‚’å‡¦ç†ã™ã‚‹ç‰¹å®šã®ã‚¨ãƒ³ã‚¸ãƒ³ãŒå¿…è¦ã«ãªã‚‹å ´åˆãŒã‚ã‚Šã¾ã™ã€‚ä¾‹ãˆã°ã€JVMã‚¢ãƒ—ãƒªã‚±ãƒ¼ã‚·ãƒ§ãƒ³ã«ã¯Apacheã‚„Jettyã‚’ã€Androidã«ã¯OkHttpã‚„Androidã‚’ã€Kotlin/Nativeã‚’ã‚¿ãƒ¼ã‚²ãƒƒãƒˆã«ã—ãŸãƒ‡ã‚¹ã‚¯ãƒˆãƒƒãƒ—ã‚¢ãƒ—ãƒªã‚±ãƒ¼ã‚·ãƒ§ãƒ³ã«ã¯Curlã‚’ã€ã¨ã„ã£ãŸå…·åˆã§ã™ã€‚ç•°ãªã‚‹ã‚¨ãƒ³ã‚¸ãƒ³ã«ã¯ç‰¹å®šã®æ©Ÿèƒ½ãŒã‚ã‚Šã€ç•°ãªã‚‹è¨­å®šã‚ªãƒ—ã‚·ãƒ§ãƒ³ãŒã‚ã‚Šã¾ã™ã€‚

ä»¥ä¸‹ã®ãƒªãƒ³ã‚¯å…ˆã«å„ã‚¨ãƒ³ã‚¸ãƒ³ã®æ¯”è¼ƒã‚’ç¢ºèªã™ã‚‹äº‹ãŒã§ãã¾ã™ã€‚

https://ktor.io/docs/client-engines.html

å…ˆã»ã©ã®å®Ÿè£…ã§ã¯ç‰¹ã«ã‚¨ãƒ³ã‚¸ãƒ³ã®æŒ‡å®šã¯è¡Œãªã£ã¦ã„ãªã‹ã£ãŸã¨æ€ã†ã®ã§ã™ãŒã€ãã®å ´åˆKtorãŒç’°å¢ƒã«å¿œã˜ã¦ã‚ˆã—ãªã«ã‚„ã£ã¦ãã‚Œã‚‹æ§˜ã§ã™ã€‚

å…ˆã»ã©ã®å®Ÿè£…ã§ã©ã®ã‚¨ãƒ³ã‚¸ãƒ³ãŒæ¡ç”¨ã•ã‚Œã¦ã„ã‚‹ã®ã‹ãƒ­ã‚°ã§ç¢ºèªã—ãŸæ‰€ã€å½“ãŸã‚Šå‰ã‹ã‚‚ã§ã™ãŒã€dependenciesã§ã‚¤ãƒ³ã‚¹ãƒˆãƒ¼ãƒ«ã—ãŸ[CIO](https://api.ktor.io/ktor-client/ktor-client-cio/io.ktor.client.engine.cio/-c-i-o/index.html)ãŒã¡ã‚ƒã‚“ã¨ä½¿ã‚ã‚Œã¦ã„ã¾ã—ãŸã€‚

### 2-1. ã‚¨ãƒ³ã‚¸ãƒ³ã«OkHttpã‚’ä½¿ã†

ã“ã“ã§ã¯ã‚ãˆã¦Androidã§ã¯ãŠãªã˜ã¿?ã®OkHttpã‚’æ˜ç¤ºçš„ã«ã‚¨ãƒ³ã‚¸ãƒ³ã¨ã—ã¦ä½¿ã£ã¦ã¿ãŸã„ã¨æ€ã„ã¾ã™ã€‚

https://ktor.io/docs/client-engines.html#okhttp

â†‘ã“ã¡ã‚‰ã‚’å‚è€ƒã«å¿…è¦ãªãƒ©ã‚¤ãƒ–ãƒ©ãƒªã‚’ã‚¤ãƒ³ã‚¹ãƒˆãƒ¼ãƒ«ã—ã¾ã™ã€‚

- `gradle/libs.versions.toml` ã«ä»¥ä¸‹ã‚’è¿½åŠ 

```toml
[libraries]
ktor-client-okhttp = { module = "io.ktor:ktor-client-okhttp", version.ref = "ktor" }
```

- `app/build.gradle.kts` ã«ä»¥ä¸‹ã‚’è¿½åŠ 

```toml
dependencies {
    implementation(libs.ktor.client.okhttp)
}
```

ã“ã‚Œã§CIOã¨OkHttpä¸¡æ–¹ãŒã‚¤ãƒ³ã‚¹ãƒˆãƒ¼ãƒ«ã•ã‚Œã¦ã„ã‚‹çŠ¶æ…‹ã«ãªã£ãŸã®ã§ `HttpClient` ä½œæˆæ™‚ã«æ˜ç¤ºçš„ã«OkHttpã‚’ã‚¨ãƒ³ã‚¸ãƒ³ã¨ã—ã¦ä½¿ã†ã‚ˆã†ã«ä¿®æ­£ã—ã¦ç¢ºèªã—ã¦ã¿ãŸã„ã¨æ€ã„ã¾ã™ã€‚

```kotlin
import android.util.Log
import io.ktor.client.*
import io.ktor.client.engine.okhttp.*
import io.ktor.client.request.*
import io.ktor.client.statement.*

class Greeting {
    private val client = HttpClient(OkHttp)

    suspend fun greeting(): String {
        Log.d("Greeting", client.engine.toString())
        val response = client.get("https://ktor.io/docs/")
        return response.bodyAsText()
    }
}
```

å®Ÿè¡Œã—ã¦ã¿ã‚‹ã¨ãƒ­ã‚°ã«ã¡ã‚ƒã‚“ã¨OkHttpãŒè¡¨ç¤ºã•ã‚Œã¦ã„ã¾ã™ã€‚

![image4.png](/images/d6f08410c6d698/image4.png)

### 2-2. OkHttpã®Logging Interceptorã‚’æŒ‡å®šã™ã‚‹

ã‚¨ãƒ³ã‚¸ãƒ³æŒ‡å®šæ™‚ã« [addInterceptor](https://api.ktor.io/ktor-client/ktor-client-okhttp/io.ktor.client.engine.okhttp/-ok-http-config/add-interceptor.html) ã§Interceptorã‚’è¨­å®šã§ãã‚‹ã®ã§[ã“ã¡ã‚‰](https://github.com/square/okhttp/tree/master/okhttp-logging-interceptor)ã®Logging Interceptorã‚’æŒ‡å®šã—ã¦ã¿ãŸã„ã¨æ€ã„ã¾ã™ã€‚

æ—©é€Ÿå¿…è¦ãªãƒ©ã‚¤ãƒ–ãƒ©ãƒªã‚’ã‚¤ãƒ³ã‚¹ãƒˆãƒ¼ãƒ«ã—ã¦ã„ãã¾ã™ã€‚

- `gradle/libs.versions.toml` ã«ä»¥ä¸‹ã‚’è¿½åŠ 
  - okhttpã®versionã¯ktorã§ã‚¤ãƒ³ã‚¹ãƒˆãƒ¼ãƒ«ã•ã‚ŒãŸokhttpã®versionã«åˆã‚ã›ã¦ã¾ã™

```toml
[versions]
okhttp = "4.12.0"

[libraries]
okhttp3-logging-interceptor = { module = "com.squareup.okhttp3:logging-interceptor", version.ref = "okhttp" }
```

- `app/build.gradle.kts` ã«ä»¥ä¸‹ã‚’è¿½åŠ 

```toml
dependencies {
    implementation(libs.okhttp3.logging.interceptor)
}
```

- `Greeting.kt`ã‚’ä»¥ä¸‹ã«ä¿®æ­£

```kotlin
import io.ktor.client.*
import io.ktor.client.engine.okhttp.*
import io.ktor.client.request.*
import io.ktor.client.statement.*
import okhttp3.logging.HttpLoggingInterceptor

class Greeting {
    private val client = HttpClient(OkHttp) {
        engine {
            addInterceptor(HttpLoggingInterceptor().apply {
                level = HttpLoggingInterceptor.Level.BASIC
            })
        }
    }

    suspend fun greeting(): String {
        val response = client.get("https://ktor.io/docs/")
        return response.bodyAsText()
    }
}
```

å®Ÿè¡Œã—ã¦ã¿ã‚‹ã¨ã¡ã‚ƒã‚“ã¨ãƒ­ã‚°ã«è¡¨ç¤ºã•ã‚Œã¦ã„ãã†ã§ã™ !

![image5.png](/images/d6f08410c6d698/image5.png)

# ã“ã®è¨˜äº‹ã¯ä»¥ä¸‹ã®æƒ…å ±ã‚’å‚è€ƒã«ã—ã¦åŸ·ç­†ã—ã¾ã—ãŸ

https://tech.unifa-e.com/entry/2023/08/03/000000