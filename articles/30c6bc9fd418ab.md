---
title: "Cloudflare Workers + Hono + Prismaã§ãƒ­ãƒ¼ã‚«ãƒ«ç’°å¢ƒæ§‹ç¯‰"
emoji: "ğŸŒŸ"
type: "tech" # tech: æŠ€è¡“è¨˜äº‹ / idea: ã‚¢ã‚¤ãƒ‡ã‚¢
topics:
  - "cloudflareworkers"
  - "hono"
  - "prisma"
  - "postgresql"
  - "devcontainer"
published: true
---
# æ¦‚è¦

ã‚¿ã‚¤ãƒˆãƒ«ã®é€šã‚Šã§ã™ãŒã€Cloudflare Workers + Hono + Prismaã§ãƒ­ãƒ¼ã‚«ãƒ«ç’°å¢ƒæ§‹ç¯‰ã‚’è¡Œã£ã¦ã¿ãŸã„ã¨æ€ã„ã¾ã™ã€‚

## Hono

https://hono.dev/

> Edgesã®ãŸã‚ã®å°ã•ãã‚·ãƒ³ãƒ—ãƒ«ã§è¶…é«˜é€ŸãªWebãƒ•ãƒ¬ãƒ¼ãƒ ãƒ¯ãƒ¼ã‚¯ã§ã™ã€‚ã©ã®JavaScriptãƒ©ãƒ³ã‚¿ã‚¤ãƒ ã§ã‚‚å‹•ä½œã—ã¾ã™ï¼šCloudflare Workersã€Fastly Computeã€Denoã€Bunã€Vercelã€Netlifyã€AWS Lambdaã€Lambda@Edgeã€Node.js

## Prisma

https://www.prisma.io/

> Prismaã¯ã€Node.jsã¨TypeScriptã®ãŸã‚ã®æ¬¡ä¸–ä»£ã®ORM (Object-Relational Mapping) ã§ã™ã€‚ãƒ‡ãƒ¼ã‚¿ãƒ™ãƒ¼ã‚¹ã¨ã®ã‚„ã‚Šå–ã‚Šã‚’ã‚ˆã‚Šç°¡å˜ã‹ã¤å®‰å…¨ã«ã™ã‚‹ãŸã‚ã«è¨­è¨ˆã•ã‚Œã¦ã„ã¾ã™ã€‚é–‹ç™ºè€…ãŒãƒ‡ãƒ¼ã‚¿ãƒ™ãƒ¼ã‚¹ã‚¹ã‚­ãƒ¼ãƒã‚’å®šç¾©ã—ã€ãã®ã‚¹ã‚­ãƒ¼ãƒã«åŸºã¥ã„ã¦è‡ªå‹•çš„ã«å‹å®‰å…¨ãªã‚¯ãƒ©ã‚¤ã‚¢ãƒ³ãƒˆAPIã‚’ç”Ÿæˆã—ã¾ã™ã€‚ã“ã‚Œã«ã‚ˆã‚Šã€SQLã‚„ãƒ‡ãƒ¼ã‚¿ãƒ™ãƒ¼ã‚¹å›ºæœ‰ã®ã‚¯ã‚¨ãƒªè¨€èªã«ä¾å­˜ã™ã‚‹ã“ã¨ãªãã€ãƒ‡ãƒ¼ã‚¿ãƒ™ãƒ¼ã‚¹ã¨ã®ã‚„ã‚Šå–ã‚ŠãŒå¯èƒ½ã«ãªã‚Šã¾ã™ã€‚

# ç’°å¢ƒæ§‹ç¯‰

ãƒ­ãƒ¼ã‚«ãƒ«ã§ã®é–‹ç™ºç’°å¢ƒã§ã™ãŒã€äº‹å‰ã«ä½œæˆã—ãŸä»¥ä¸‹ã®ãƒªãƒã‚¸ãƒˆãƒªã®ç’°å¢ƒã‚’ãƒ™ãƒ¼ã‚¹ã«é€²ã‚ã¦ã„ããŸã„ã¨æ€ã„ã¾ã™ã€‚

https://github.com/Slowhand0309/nodejs-devcontainer-boilerplate

é–‹ç™ºç’°å¢ƒã¨ã—ã¦ã¯IDE `VSCode` ã§ `DevContainer` ã‚’ä½¿ç”¨ã—ã¦é–‹ç™ºã™ã‚‹å‰æã§é€²ã‚ã¦ã„ãã¾ã™ã€‚

ãƒ—ãƒ­ã‚¸ã‚§ã‚¯ãƒˆåã¯ `hono-prisma-workers-example` ã¨ã—ã¦â†‘ã®ãƒªãƒã‚¸ãƒˆãƒªã‹ã‚‰ã€ŒUse this templateã€ã§æ–°è¦ã«ä½œæˆã—ã¦é€²ã‚ã¦ã„ãã¾ã™ã€‚

æ¬¡ã« `.devcontainer/Dockerfile` ã«ä»¥ä¸‹ã‚’è¿½åŠ ã—ã¾ã™ã€‚

```docker
FROM node:20.10.0-bullseye-slim
LABEL maintainer="Slowhand0309"

ARG username=vscode
ARG useruid=1000
ARG usergid=${useruid}

# create honoæ™‚ã®git cloneã§caè¨¼æ˜æ›¸ãŒå¿…è¦ãªã®ã§ ca-certificates ã‚’è¿½åŠ 
# ãƒ‘ãƒƒã‚±ãƒ¼ã‚¸ç®¡ç†ã¨ã—ã¦ pnpm ã‚’ä½¿ç”¨ã™ã‚‹ç‚ºè¿½åŠ 
RUN set -ex \
    && apt-get update \
    && apt-get install -y \
        sudo \
        ca-certificates \
        --no-install-recommends \
    # Delete node user with uid=1000 and create vscode user with uid=1000
    && userdel -r node \
    && groupadd --gid ${usergid} ${username} \
    && useradd -s /bin/bash --uid ${useruid} --gid ${usergid} -m ${username} \
    && echo ${username} ALL=\(root\) NOPASSWD:ALL > /etc/sudoers.d/${username} \
    && chmod 0440 /etc/sudoers.d/${username} \
    && npm install -g pnpm
    && rm -rf /var/lib/apt/lists/*

USER ${username}
```

æ¬¡ã« `.devcontainer/docker-compose.yml` ã« `ports` ã‚’è¿½åŠ ã—ã¨ãã¾ã™ã€‚

```yaml
services:
  app:
    ...
    ports:
      - "8787:8787" # è¿½åŠ 
```

ä¸€æ—¦ã“ã“ã¾ã§ã§VSCodeä¸Šã§ `Command + Shift + P` ã‹ã‚‰ã€ŒDev Container: Reopenã€ã‚’é¸æŠã—ã€DevContainerã‚’èµ·å‹•ã—ã¾ã™ã€‚

æ—©é€Ÿ`pnpm create hono@latest .` ã§æ–°è¦ãƒ—ãƒ­ã‚¸ã‚§ã‚¯ãƒˆã‚’ä½œæˆã—ã¾ã™ã€‚

templateã«ã¯ `cloudflare-workers` ã‚’é¸æŠã—ã¾ã™ã€‚

```bash
create-hono version 0.6.3
âœ” Using target directory â€¦ .
? Which template do you want to use? cloudflare-workers
? Directory not empty. Continue? yes
âœ” Cloning the template
? Do you want to install project dependencies? yes
? Which package manager do you want to use? pnpm
âœ” Installing project dependencies
ğŸ‰ Copied project files
Get started with: cd .
```

`wrangler.toml` ã® `name` ã«ãƒ—ãƒ­ã‚¸ã‚§ã‚¯ãƒˆåã‚’è¨­å®šã—ã‚³ãƒ³ãƒ†ãƒŠå¤–ã‹ã‚‰ã‚‚ã‚¢ã‚¯ã‚»ã‚¹ã§ãã‚‹ã‚ˆã†ã«ä»¥ä¸‹ã‚’è¿½åŠ ã—ã¨ãã¾ã™ã€‚

```toml
[dev]
ip = "0.0.0.0"
port = 8787
```

ã“ã‚Œã§ `pnpm dev` ã‚’å®Ÿæ–½ã— `[http://localhost:8787](http://localhost:8787)` ã«ã‚¢ã‚¯ã‚»ã‚¹ã— `Hello Hono!` ãŒè¡¨ç¤ºã•ã‚Œã¦ã„ã‚Œã°OKã§ã™ã€‚

## æ¯å› `Would you like to help improve Wrangler by sending usage metrics to Cloudflare?` ã¨èã‹ã‚Œã‚‹ã®ã‚’å›é¿ã™ã‚‹(ä¸å¿…è¦ã§ã‚ã‚Œã°ã‚¹ã‚­ãƒƒãƒ—ã—ã¦ãã ã•ã„)

Containerã‚’èµ·å‹•ã—ç›´ã™åº¦ã«â†‘ã“ã¡ã‚‰èã‹ã‚Œã‚‹ã®ã§ã€åˆå›ã®1å›ã®ã¿ã§æ¬¡ã‹ã‚‰ã¯èã‹ã‚Œãªã„ã‚ˆã†ã«ã—ã¦ã¿ãŸã„ã¨æ€ã„ã¾ã™ã€‚

åˆå›èã‹ã‚ŒãŸéš›ã«â†‘ã®æƒ…å ±ã¯ `~/.config/.wrangler/metrics.json` ã«ä¿å­˜ã•ã‚Œã¾ã™ã€‚ãã“ã§ `~/.config/.wrangler` ã‚’ `volume` ã« bind ã—ã¾ã™ã€‚

- `.devcontainer/docker-compose.yml` ã«ä»¥ä¸‹ã‚’è¿½åŠ ã—ã¾ã™

    ```yaml
    version: "3.8"
    volumes:
      modules_data:
      wrangler_data: # è¿½åŠ 
    
    services:
      app:
        build: .
        image: slowhand/nodejs
        container_name: "hono-prisma-workers"
        volumes:
          - ..:/usr/src
          - modules_data:/usr/src/node_modules
          - wrangler_data:/home/vscode/.config/.wrangler # è¿½åŠ 
        command: /bin/sh -c "while sleep 1000; do :; done"
        working_dir: /usr/src
        ports:
          - "8787:8787"
          - "5555:5555"
    
    ```

- `.devcontainer/postAttach.sh` ã«ä»¥ä¸‹ã‚’è¿½åŠ ã—ã¾ã™

    ```bash
    sudo chown -R vscode /home/vscode/.config
    ```

ã“ã‚Œã§ã‚³ãƒ³ãƒ†ãƒŠèµ·å‹•ã—ã¦ã‚‚èã‹ã‚Œã‚‹ã®ã¯åˆå›ã®ã¿ã§ã€æ¬¡å›ã‹ã‚‰ã¯èã‹ã‚Œãªããªã‚Šã¾ã™ã€‚

## PostgreSQLã‚’è¿½åŠ 

`.devcontainer/docker-compose.yml` ã«ä»¥ä¸‹ã‚’è¿½åŠ ã—ã¾ã™ã€‚

```yaml
volumes:
  db_data:
  
services:
  db:
    image: postgres:16.2
    container_name: postgres_pta
    ports:
      - 5432:5432
    volumes:
      - db_data:/var/lib/postgresql/data
    environment:
      POSTGRES_USER: postgres
      POSTGRES_PASSWORD: postgres
```

## Prismaã®è¨­å®š

ã‚³ãƒ³ãƒ†ãƒŠã‚’èµ·å‹•ã—ç›´ã—ã¦ã€Prismaã®ã‚¤ãƒ³ã‚¹ãƒˆãƒ¼ãƒ« & è¨­å®šã‚’ã‚„ã£ã¦ã„ãã¾ã™ã€‚

```bash
pnpm add -D prisma
pnpm prisma init --datasource-provider postgresql
```

ç”Ÿæˆã•ã‚ŒãŸ `.env` ãƒ•ã‚¡ã‚¤ãƒ«ã® `DATABASE_URL` ã‚’ä»¥ä¸‹ã«ä¿®æ­£ã—ã¾ã™ã€‚

```text
DATABASE_URL="postgresql://postgres:postgres@db:5432/example?schema=public"
```

æ¬¡ã« `prisma/schema.prisma` ã« `User` ãƒ†ãƒ¼ãƒ–ãƒ«ã‚’è¿½åŠ ã—ã¾ã™ã€‚

```text
model User {
  id    Int     @id @default(autoincrement())
  email String  @unique
  name  String?
}
```

ã“ã“ã¾ã§ã§ãƒã‚¤ã‚°ãƒ¬ãƒ¼ã‚·ãƒ§ãƒ³ã‚’å®Ÿè¡Œã—ã¦ã¿ã¾ã™ã€‚

```bash
$ pnpm prisma migrate dev --name init
Environment variables loaded from .env
Prisma schema loaded from prisma/schema.prisma
Datasource "db": PostgreSQL database "example", schema "public" at "db:5432"

PostgreSQL database example created at db:5432

Applying migration `20240417131428_init`

The following migration(s) have been created and applied from new schema changes:

migrations/
  â””â”€ 20240417131428_init/
    â””â”€ migration.sql

Your database is now in sync with your schema.

Running generate... (Use --skip-generate to skip the generators)
â€‰WARNâ€‰ 2 deprecated subdependencies found: rollup-plugin-inject@3.0.2, sourcemap-codec@1.4.8
Packages: +1
+
Progress: resolved 123, reused 96, downloaded 1, added 1, done
node_modules/.pnpm/@prisma+client@5.12.1_prisma@5.12.1/node_modules/@prisma/client: Runninnode_modules/.pnpm/@prisma+client@5.12.1_prisma@5.12.1/node_modules/@prisma/client: Running postinstall script, done in 18ms

dependencies:
+ @prisma/client 5.12.1

Done in 5s

âœ” Generated Prisma Client (v5.12.1) to ./node_modules/.pnpm/@prisma+client@5.12.1_prisma@5
.12.1/node_modules/@prisma/client in 15ms
```

ã“ã‚Œã§ã€å®Ÿéš›ã« `User` ãƒ†ãƒ¼ãƒ–ãƒ«ãŒä½œæˆã•ã‚Œã€ `@prisma/client` ãƒ‘ãƒƒã‚±ãƒ¼ã‚¸ãŒè¿½åŠ ã—å†…éƒ¨çš„ã« `prisma generate` ãŒå®Ÿè¡Œã•ã‚Œã¾ã™ã€‚

DBã®ãƒ†ãƒ¼ãƒ–ãƒ«ã‚„ãƒ‡ãƒ¼ã‚¿ã®ç¢ºèªã«ã¯åˆ¥é€”ã‚¯ãƒ©ã‚¤ã‚¢ãƒ³ãƒˆãƒ„ãƒ¼ãƒ«ã‚’ä½¿ã£ãŸã‚Šã€PrismaãŒæä¾›ã—ã¦ã„ã‚‹ãƒ–ãƒ©ã‚¦ã‚¶ã§ç¢ºèªã§ãã‚‹ `Prisma Studio` ã‚‚ä½¿ãˆã¾ã™ã€‚

```bash
pnpm prisma studio
```

â†‘ã‚’ã‚³ãƒ³ãƒ†ãƒŠå†…ã§å®Ÿè¡Œã—ã€[http://localhost:5555](http://localhost:5555/) ã«ã‚¢ã‚¯ã‚»ã‚¹ã™ã‚‹ã¨ `User` ãƒ†ãƒ¼ãƒ–ãƒ«ãŒä½œæˆã•ã‚Œã¦ã„ã‚‹ã®ãŒåˆ†ã‹ã‚‹ã‹ã¨æ€ã„ã¾ã™ã€‚

![image1.png](/images/30c6bc9fd418ab/image1.png)

## Seedãƒ‡ãƒ¼ã‚¿ç™»éŒ²

ã¾ãšã¯å¿…è¦ãªãƒ‘ãƒƒã‚±ãƒ¼ã‚¸ã‚’ã‚¤ãƒ³ã‚¹ãƒˆãƒ¼ãƒ«ã—ã¾ã™ã€‚

```bash
 pnpm add -D ts-node @types/node
```

æ¬¡ã« `tsconfig.json` ã‚’ä¿®æ­£ã—ã¾ã™ã€‚

```json
{
  "compilerOptions": {
    "target": "es2016", // ä¿®æ­£
    "module": "commonjs", // ä¿®æ­£
    "strict": true,
    "lib": ["ESNext"],
    "types": ["node", "@cloudflare/workers-types"], // nodeè¿½åŠ 
    "jsx": "react-jsx",
    "jsxImportSource": "hono/jsx"
  }
}

```

æ¬¡ã« `prisma/seed.ts` ã‚’ä»¥ä¸‹å†…å®¹ã§ä½œæˆã—ã¾ã™ã€‚

```tsx
import { Prisma, PrismaClient } from "@prisma/client";

const prisma = new PrismaClient();

const userData: Prisma.UserCreateInput[] = [...Array(5)].map((_, i) => ({
  name: `User${i + 1}`,
  email: `user${i + 1}@example.com`,
}));

const main = async () => {
  const result = await prisma.user.createMany({
    data: userData,
    skipDuplicates: true,
  });
  console.log({ result });
};

main()
  .catch((e) => {
    console.error(e);
    process.exit(1);
  })
  .finally(async () => {
    await prisma.$disconnect();
  });

```

`package.json` ã«ä»¥ä¸‹ã‚’è¿½åŠ ã—ã¾ã™ã€‚

```json
  "prisma": {
    "seed": "ts-node prisma/seed.ts"
  }
```

ã“ã“ã¾ã§ããŸã‚‰å®Ÿéš›ã«seedãƒ‡ãƒ¼ã‚¿ã‚’ç™»éŒ²ã—ã¦ã¿ã¾ã™ã€‚

```bash
$ pnpm prisma db seed
Environment variables loaded from .env
Running seed command `ts-node prisma/seed.ts` ...
{ result: { count: 5 } }

ğŸŒ±  The seed command has been executed.
```

`Prisma Studio` ã§ç¢ºèªã—ã¦ãƒ‡ãƒ¼ã‚¿ç™»éŒ²ã§ãã¨ã‘ã°OKã§ã™ã€‚

![image2.png](/images/30c6bc9fd418ab/image2.png)

## APIå®Ÿè£…

ã„ã‚ˆã„ã‚ˆAPIå®Ÿè£…ã§ã™ãŒã€Cloudflare Workersã§Prismaã‚’ä½¿ç”¨ã™ã‚‹å ´åˆã€Prismaã®Edgeæ©Ÿèƒ½ã‚’åˆ©ç”¨ã™ã‚‹äº‹ã«ãªã‚‹ã®ã§ã™ãŒã€[Engine](https://www.prisma.io/docs/orm/more/under-the-hood/engines) éƒ¨åˆ†ãŒ Cloudflare Workersä¸Šã§å‹•ä½œã—ãªã„ç‚ºãƒªãƒ¢ãƒ¼ãƒˆä¸Šã«åˆ¥é€”ç”¨æ„ã—ã€ãã“çµŒç”±ã§æ¥ç¶šã™ã‚‹å¿…è¦ãŒã‚ã‚Šã¾ã™ã€‚

è©³ã—ãã¯ [ã“ã¡ã‚‰](https://www.prisma.io/docs/orm/prisma-client/deployment/edge/overview#edge-compatibility-of-database-drivers)

[Prisma Accelerate](https://www.prisma.io/data-platform/accelerate) ãªã©ã®å¤–éƒ¨ã‚µãƒ¼ãƒ“ã‚¹ã‚’ä½¿ã£ã¦æ¥ç¶šå¯èƒ½ã§ã™ã€‚ãŒä»Šå›ã¯ãƒ­ãƒ¼ã‚«ãƒ«ã§å‹•ä½œã•ã›ãŸã„ç‚ºã€å¤–éƒ¨ã‚µãƒ¼ãƒ“ã‚¹ã«æ¥ç¶šã—ã¦ã€œãªã‚“ã¦ã“ã¨ã¯ã—ãŸãã‚ã‚Šã¾ã›ã‚“ã€‚

â€» ã¡ãªã¿ã«ãã®ã¾ã¾ Cloudflare Workersä¸Šã§Prismaã‚’ä½¿ãŠã†ã¨ã™ã‚‹ã¨æ¬¡ã®ã‚¨ãƒ©ãƒ¼ãŒå‡ºã¾ã™ã€‚

```bash
âœ˜ [ERROR] Error: PrismaClient is not configured to run in Cloudflare Workers. In order to run Prisma Client on edge runtime, either:

  - Use Prisma Accelerate: https://pris.ly/d/accelerate
  - Use Driver Adapters: https://pris.ly/d/driver-adapters
```

ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸ã«ã‚‚ã‚ã‚‹æ§˜ã« `Driver Adapters` ã‚’ä½¿ã£ã¦è©¦ã—ã¦ã¿ãŸã„ã¨æ€ã„ã¾ã™ã€‚

https://next-blog.croud.jp/contents/d618519a-fc88-4eb0-833e-deb2fbd662ea

### `[node-postgres](https://node-postgres.com/)` ã‚’ä½¿ã†

> Cloudflare ã®`connect()`(TCP) ã‚’ä½¿ç”¨ã—ã¦ãƒ‡ãƒ¼ã‚¿ãƒ™ãƒ¼ã‚¹ã«ã‚¢ã‚¯ã‚»ã‚¹ã—ã¾ã™ã€‚ Cloudflare Workers ã¨ã®ã¿äº’æ›æ€§ãŒã‚ã‚Šã€Vercel Edge Functions ã¨ã¯äº’æ›æ€§ãŒã‚ã‚Šã¾ã›ã‚“ã€‚

- `prisma/schema.prisma` ã«ä»¥ä¸‹ã‚’è¿½åŠ 

```text
generator client {
  provider = "prisma-client-js"
  previewFeatures = ["driverAdapters"] # â† è¿½åŠ 
}
```

- PrismaClientã‚’å†ç”Ÿæˆ

```bash
pnpm prisma generate
```

- `pg`ãƒ‘ãƒƒã‚±ãƒ¼ã‚¸ã¨ Prisma ã® Driver Adapter ã‚’ã‚¤ãƒ³ã‚¹ãƒˆãƒ¼ãƒ«

```bash
pnpm add pg @prisma/adapter-pg
pnpm add -D @types/pg
```

- `wrangler.toml` ã« `node_compat = true` ã‚’è¿½åŠ ã™ã‚‹

```toml
name = "hono-prisma-workers-example"
compatibility_date = "2023-12-01"
node_compat = true # è¿½åŠ 
```

- `.dev.vars` ã‚’ä»¥ä¸‹å†…å®¹ã§ä½œæˆã™ã‚‹

```json
DATABASE_URL="postgresql://postgres:postgres@db:5432/example?schema=public"
```

- APIãƒªã‚¯ã‚¨ã‚¹ãƒˆéƒ¨åˆ†ã®ä½œæˆ

```tsx
import { PrismaPg } from "@prisma/adapter-pg";
import { PrismaClient } from "@prisma/client";
import { Hono } from "hono";
import { Pool } from "pg";

const app = new Hono();

app.get("/", (c) => {
  return c.text("Hello Hono!");
});

app.get("/users", async (c) => {
  const connectionString = `${c.env?.DATABASE_URL ?? ""}`;
  const pool = new Pool({ connectionString });
  const adapter = new PrismaPg(pool);
  const prisma = new PrismaClient({ adapter });
  const users = await prisma.user.findMany();
  return c.json(users);
});

export default app;
```

ã“ã“ã¾ã§å‡ºæ¥ãŸã‚‰ [http://localhost:8787/users](http://localhost:8787/users) ã«ã‚¢ã‚¯ã‚»ã‚¹ã—ã€ä»¥ä¸‹ã®æ§˜ãªãƒ¬ã‚¹ãƒãƒ³ã‚¹ãŒè¿”ã£ã¦ããŸã‚‰OKã§ã™ã€‚

```json
[
  {
    "id": 1,
    "email": "user1@example.com",
    "name": "User1"
  },
  {
    "id": 2,
    "email": "user2@example.com",
    "name": "User2"
  },
  {
    "id": 3,
    "email": "user3@example.com",
    "name": "User3"
  },
  {
    "id": 4,
    "email": "user4@example.com",
    "name": "User4"
  },
  {
    "id": 5,
    "email": "user5@example.com",
    "name": "User5"
  }
]
```

# ãƒˆãƒ©ãƒ–ãƒ«ã‚·ãƒ¥ãƒ¼ãƒ†ã‚£ãƒ³ã‚°

`pnpm create hono` æ™‚ã«ä»¥ä¸‹ã‚¨ãƒ©ãƒ¼ãŒç™ºç”Ÿã™ã‚‹ã€‚

```bash
 throw new DegitError(`could not find commit hash for ${repo.ref}`, {
```

`git` ãŒã‚¤ãƒ³ã‚¹ãƒˆãƒ¼ãƒ«ã•ã‚Œã¦ã„ãªã„å ´åˆã‚¤ãƒ³ã‚¹ãƒˆãƒ¼ãƒ«ã—ã¦å†åº¦å®Ÿè¡Œã™ã‚‹ã€‚

https://zenn.dev/aipacommander/scraps/a1b42841d22bf1

`git` ãŒã‚¤ãƒ³ã‚¹ãƒˆãƒ¼ãƒ«ã•ã‚Œã¦ã„ã‚‹å ´åˆã€ `git ls-remote https://github.com/honojs/starter` ã‚’å®Ÿè¡Œã—ã¦ã¿ã¦ä»¥ä¸‹ã®ã‚¨ãƒ©ãƒ¼ãŒç™ºç”Ÿã™ã‚‹å ´åˆã€

```bash
fatal: unable to access 'https://github.com/honojs/starter': server certificate verification failed. CAfile: none CRLfile: none
```

SSLã®è¨¼æ˜è¨¼ãŒã‚¤ãƒ³ã‚¹ãƒˆãƒ¼ãƒ«ã•ã‚Œã¦ã„ãªã„ã®ã§ã€ã‚¤ãƒ³ã‚¹ãƒˆãƒ¼ãƒ«ã—ã¦å†åº¦å®Ÿè¡Œã™ã‚‹ã€‚

```bash
sudo apt-get install --reinstall ca-certificates
```

https://stackoverflow.com/questions/35821245/github-server-certificate-verification-failed

https://github.com/tiged/tiged/blob/1d5587d8bd26ce999fc3132d0fe839f42cd3d967/src/index.js#L286

---

APIãƒªã‚¯ã‚¨ã‚¹ãƒˆæ™‚ã«ä»¥ä¸‹ã‚¨ãƒ©ãƒ¼ãŒç™ºç”Ÿã™ã‚‹

```tsx
âœ˜ [ERROR] A hanging Promise was canceled. This happens when the worker runtime is waiting for a Promise from JavaScript to resolve, but has detected that the Promise cannot possibly ever resolve because all code and events related to the Promise's I/O context have already finished.
```

`src/index.ts` ã«ã¦ `app.get` å¤–ã§ `PrismaClient` å®šç¾©ã—ãŸå ´åˆã«ç™ºç”Ÿã—ãŸã‚¨ãƒ©ãƒ¼ã«ãªã‚Šã¾ã™ã€‚

```tsx
const connectionString = `${c.env?.DATABASE_URL ?? ""}`;
const pool = new Pool({ connectionString });
const adapter = new PrismaPg(pool);
const prisma = new PrismaClient({ adapter });
const app = new Hono();

app.get("/users", async (c) => {
  const users = await prisma.user.findMany();
  return c.json(users);
});
```

ãã¡ã‚“ã¨ã‚³ãƒã‚¯ã‚·ãƒ§ãƒ³ãŒçµ‚ã‚ã‚‰ãšæ®‹ã£ã¦ã—ã¾ã£ã¦ã„ã‚‹çŠ¶æ…‹ã«ãªã£ã¦ã„ã‚‹ã®ã‹ã‚‚ã—ã‚Œã¾ã›ã‚“ã€‚ã‚‚ã—ã‹ã—ãŸã‚‰ä»–ã«è§£æ±ºç­–ãŒã‚ã‚‹ã‹ã‚‚ã§ã™ãŒã€ä»Šå›ã¯ `app.get` å†…ã« `PrismaClinet` å®šç¾©ã‚’ç§»å‹•ã•ã›ã¦è§£æ”¾ã—ã¦ã‚„ã‚‹ã‚ˆã†ã«ã—ã¾ã—ãŸã€‚

# ãƒªãƒã‚¸ãƒˆãƒª

ä»Šå›ã®å†…å®¹ã¯ä»¥ä¸‹ã®ãƒªãƒã‚¸ãƒˆãƒªã«pushã—ã¦ã¾ã™ã€‚

https://github.com/Slowhand0309/hono-prisma-workers-example

# å‚è€ƒURL

- [Node + Hono + Prisma + Jestã§ç’°å¢ƒæ§‹ç¯‰](https://zenn.dev/airrnot1106/articles/d8cea0570ea6bf)
- [Cloudflare Workers ãƒ¡ãƒ¢](https://zenn.dev/voluntas/scraps/6b5022e2693aba)
- [DBã®ãƒ‡ãƒ¼ã‚¿ã‚’CDNã«ã‚­ãƒ£ãƒƒã‚·ãƒ¥ã—ã¤ã¤Edgeã‹ã‚‰ä½¿ã„ã‚„ã™ãã€€PrismaAccelerate ã‚’è©¦ã—ã¦ã¿ã‚‹](https://zenn.dev/suzuesa/articles/8038d5cccdf7e2)
- [Prismaã§Seedã§ãƒ‡ãƒ¼ã‚¿ã‚’æŠ•å…¥ã™ã‚‹ - m_shige1979ã®ã¨ãã©ãITãƒ–ãƒ­ã‚°](https://m-shige1979.hatenablog.com/entry/2021/11/20/213051)
- [ãƒã‚¤ã‚°ãƒ¬ãƒ¼ã‚·ãƒ§ãƒ³ï½œPrismaãƒãƒ¥ãƒ¼ãƒˆãƒªã‚¢ãƒ«](https://zenn.dev/thirosue/books/49a4ee418743ed/viewer/57d161)