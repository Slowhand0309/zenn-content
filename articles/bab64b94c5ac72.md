---
title: "TCA + Supabaseã§ãƒ­ã‚°ã‚¤ãƒ³ç”»é¢ã‚’ä½œã‚‹"
emoji: "ğŸ“±"
type: "tech" # tech: æŠ€è¡“è¨˜äº‹ / idea: ã‚¢ã‚¤ãƒ‡ã‚¢
topics:
  - "iOS"
  - "swift"
  - "swiftui"
  - "TCA"
  - "supabase"
published: true
---
# TCA (The Composable Architecture) ã¨ã¯?

> ã‚¢ãƒ—ãƒªã‚’é–‹ç™ºã™ã‚‹ãŸã‚ã®çŠ¶æ…‹ç®¡ç†ãƒ•ãƒ¬ãƒ¼ãƒ ãƒ¯ãƒ¼ã‚¯ã€‚TCA ã¯ã€é–‹ç™ºè€…ãŒä½¿ã„ã‚„ã™ã„ã‚ˆã†ã«ã€ä¸€è²«æ€§ã®ã‚ã‚‹ç†è§£ã—ã‚„ã™ã„æ–¹æ³•ã§ã‚¢ãƒ—ãƒªã‚±ãƒ¼ã‚·ãƒ§ãƒ³ã‚’æ§‹ç¯‰ã™ã‚‹ãŸã‚ã«ä½¿ç”¨ã•ã‚Œã‚‹ã€‚

[https://github.com/pointfreeco/swift-composable-architecture](https://github.com/pointfreeco/swift-composable-architecture)

[æ—¥æœ¬èªç‰ˆã¯ã“ã¡ã‚‰](https://gist.github.com/kalupas226/bdf577e4a7066377ea0a8aaeebcad428)

## ä¸»ãªæ©Ÿèƒ½

- **State management**
  - å˜ç´”ãªå€¤å‹ã‚’ä½¿ã£ã¦ã‚¢ãƒ—ãƒªã‚±ãƒ¼ã‚·ãƒ§ãƒ³ã®çŠ¶æ…‹ã‚’ç®¡ç†ã—ã€å¤šãã®ç”»é¢ã«ã‚ãŸã£ã¦çŠ¶æ…‹ã‚’å…±æœ‰ã™ã‚‹æ–¹æ³•
- **Composition**
  - å¤§è¦æ¨¡ãªãƒ•ã‚£ãƒ¼ãƒãƒ£ãƒ¼ã‚’ã©ã®ã‚ˆã†ã«å°ã•ãªæ§‹æˆè¦ç´ ã«åˆ†è§£ã—ã€ãã‚Œãã‚Œç‹¬ç«‹ã—ãŸãƒ¢ã‚¸ãƒ¥ãƒ¼ãƒ«ã«æŠ½å‡ºã—ã€ãƒ•ã‚£ãƒ¼ãƒãƒ£ãƒ¼ã‚’å½¢æˆã™ã‚‹ãŸã‚ã«ç°¡å˜ã«ã¤ãªãåˆã‚ã›ã‚‹ã“ã¨ãŒã§ãã‚‹ã‹
- **Side effects**
  - ã‚¢ãƒ—ãƒªã‚±ãƒ¼ã‚·ãƒ§ãƒ³ã®ç‰¹å®šã®éƒ¨åˆ†ã‚’ã€å¯èƒ½ãªé™ã‚Šãƒ†ã‚¹ãƒˆå¯èƒ½ã§ç†è§£ã—ã‚„ã™ã„æ–¹æ³•ã§å¤–ç•Œã¨å¯¾è©±ã•ã›ã‚‹æ–¹æ³•
- **Testing**
  - çµåˆãƒ†ã‚¹ãƒˆã‹ã‚‰E2Eãƒ†ã‚¹ãƒˆã¾ã§
- **Ergonomics**
  - ä¸Šè¨˜ã®ã™ã¹ã¦ã‚’ã€ã§ãã‚‹ã ã‘å°‘ãªã„ã‚³ãƒ³ã‚»ãƒ—ãƒˆã¨å¯å‹•éƒ¨å“ã§ã€ã‚·ãƒ³ãƒ—ãƒ«ãªAPIã§å®Ÿç¾ã™ã‚‹ã«ã¯ã©ã†ã™ã‚Œã°ã„ã„ã‹

## ãƒ‘ãƒƒã‚±ãƒ¼ã‚¸å°å…¥

ä»Šå›ã¯å­¦ç¿’ã®ç‚ºã€å¤–éƒ¨ãƒ‘ãƒƒã‚±ãƒ¼ã‚¸å°å…¥ç”¨ã®Packageã‚’ä½œæˆã—ã€ãã® `Package.swift` ã«TCAã‚’ã‚¤ãƒ³ãƒãƒ¼ãƒˆã™ã‚‹ã‚ˆã†ã«ã—ã¦ã¿ãŸã„ã¨æ€ã„ã¾ã™ã€‚

1. File > New > Package ã‹ã‚‰ `DependenciesPackages` ã¨ã„ã†åå‰ã§Packageã‚’ä½œæˆã™ã‚‹
   - â€» ã“ã®æ™‚ã€ŒAdd to:ã€ã«è‡ªèº«ã®ãƒ—ãƒ­ã‚¸ã‚§ã‚¯ãƒˆã‚’æŒ‡å®šã™ã‚‹
2. `Package.swift` ã‚’ä»¥ä¸‹ã«ä¿®æ­£ã™ã‚‹

    ```swift
    // swift-tools-version: 5.8
    // The swift-tools-version declares the minimum version of Swift required to build this package.
    
    import PackageDescription
    
    let package = Package(
        name: "DependenciesPackages",
        platforms: [
          .iOS(.v16)
        ],
        products: [
            .library(
                name: "DependenciesPackages",
                targets: ["DependenciesPackages"]),
        ],
        dependencies: [
            .package(url: "https://github.com/pointfreeco/swift-composable-architecture", branch: "main")
        ],
        targets: [
            .target(
                name: "DependenciesPackages",
                dependencies: [
                    .product(name: "ComposableArchitecture", package: "swift-composable-architecture")
                ]),
        ]
    )
    ```

3. ãƒ¡ã‚¤ãƒ³ã®Targetã®è¨­å®š > General > Frameworks, Libraries, and Embedded Content  ã« `DependenciesPackages` ã‚’è¿½åŠ ã™ã‚‹

## ã‚«ã‚¦ãƒ³ã‚¿ãƒ¼ã‚¢ãƒ—ãƒªã®ã‚µãƒ³ãƒ—ãƒ«

[ã“ã¡ã‚‰](https://github.com/pointfreeco/swift-composable-architecture/blob/main/Examples/CaseStudies/SwiftUICaseStudies/01-GettingStarted-Counter.swift)ã‚’å‚è€ƒã«ä½œæˆã—ã¦ã¿ãŸã„ã¨æ€ã„ã¾ã™ã€‚

### 1. Reducerã®ä½œæˆ

```swift
struct Counter: Reducer {
    struct State: Equatable {
        var count = 0
    }

    enum Action: Equatable {
        case decrement
        case increment
    }

    func reduce(into state: inout State, action: Action) -> Effect<Action> {
        switch action {
        case .decrement:
            state.count -= 1
            return .none
        case .increment:
            state.count += 1
            return .none
        }
    }
}
```

### 2. Viewã®ä¿®æ­£

```swift
struct CounterView: View {
    let store: StoreOf<Counter>

    var body: some View {
        WithViewStore(self.store, observe: { $0 }) { viewStore in
            HStack {
                Button {
                    viewStore.send(.decrement)
                } label: {
                    Image(systemName: "minus")
                }
                Text("\(viewStore.count)")
                    .monospacedDigit()
                Button {
                    viewStore.send(.increment)
                } label: {
                    Image(systemName: "plus")
                }
            }
        }
    }
}
```

### 3. Previewã®ä¿®æ­£

```swift
struct CounterView_Previews: PreviewProvider {
    static var previews: some View {
        CounterView(
            store: Store(initialState: Counter.State()) {
              Counter()
            }
        )
    }
}
```

Previewã§ç¢ºèªã—ã¦ã¿ã‚‹ã¨ã€ã¡ã‚ƒã‚“ã¨ã‚«ã‚¦ãƒ³ãƒˆã‚¢ãƒƒãƒ—ãƒ»ãƒ€ã‚¦ãƒ³ã§ãã¦ã„ã‚‹ã‹ã¨æ€ã„ã¾ã™ã€‚

![image1.gif](/images/bab64b94c5ac72/image1.gif  =350x)

# TCA + Supabaseã§ãƒ­ã‚°ã‚¤ãƒ³ç”»é¢ã‚’ä½œã£ã¦ã¿ã‚‹

ã¾ãšã¯Supabaseã®Swiftç”¨ã®ãƒ©ã‚¤ãƒ–ãƒ©ãƒªã‚’å°å…¥

[Supabase Swift Client - Introduction](https://supabase.com/docs/reference/swift/introduction)

`Package.swift` ã«ä»¥ä¸‹ã‚’è¿½åŠ 

```swift
let package = Package(
    ...
    dependencies: [
        ...
        .package(url: "https://github.com/supabase/supabase-swift", branch: "master"), // Add the package
    ],
    targets: [
        .target(
            name: "YourTargetName",
            dependencies: [
              .product(name: "Supabase", package: "supabase-swift")
            ] // Add as a dependency
        )
    ]
)
```

è©¦ã—ã«ãƒ­ã‚°ã‚¤ãƒ³ã§ãã‚‹ã‹â†“ã§ç¢ºèªã—ã¦ã¿ã¾ã™ã€‚

```swift
import Supabase
import SwiftUI

struct LoginView: View {
    // swiftlint:disable line_length
    let client = SupabaseClient(
        supabaseURL: URL(string: "...")!, // supabase projectã®urlã‚’å…¥åŠ›
        supabaseKey: "...") // // supabase projectã®anon api kyã‚’å…¥åŠ›
    // swiftlint:enable line_length
    var body: some View {
        VStack {
            Button("LOGIN") {
                Task.detached(priority: .background) {
                    do {
                        try await client.auth.signIn(email: "...", password: "...")
                        let session = try await client.auth.session
                        print("### Session Info: \(session)")
                    } catch {
                        print("### Sign In Error: \(error)")
                    }
                }
            }
        }
    }
}
```

ã€ŒLOGINã€ãƒœã‚¿ãƒ³ã‚’æŠ¼ã—ã¦ã‚»ãƒƒã‚·ãƒ§ãƒ³æƒ…å ±ãŒãƒ­ã‚°ã«è¡¨ç¤ºã•ã‚Œã¦ã„ã‚Œã°OKã§ã™ã€‚

## å®Ÿéš›ã«ã£ã½ã„ãƒ­ã‚°ã‚¤ãƒ³ç”»é¢ã‚’ä½œæˆ

### LoginButton

ã¾ãšã¯ã€å°‚ç”¨ã®LoginButtonã®ã‚³ãƒ³ãƒãƒ¼ãƒãƒ³ãƒˆã‚’ä½œã£ã¦ã„ããŸã„ã¨æ€ã„ã¾ã™ã€‚â†“ã®ButtonStyleã§èª¿æ•´ã—ã¦ã„ãã¾ã™ã€‚

#### SwiftUIã®ButtonStyle

[SwiftUIã®ButtonStyleã‚’ã‚«ã‚¹ã‚¿ãƒã‚¤ã‚º ï½œTAAT](https://note.com/taatn0te/n/n1ba90904df34)

[ButtonStyle | Apple Developer Documentation](https://developer.apple.com/documentation/swiftui/buttonstyle)

```swift
import SwiftUI

struct RoundedButtonStyle: ButtonStyle {
    @Environment(\.isEnabled)
    var isEnabled

    var color: Color = .blue
    private let disabledColor: Color = .init(uiColor: .lightGray)
    private let cornerRadius: CGFloat = 12.0

    func makeBody(configuration: Configuration) -> some View {
        configuration.label
            .padding()
            .fontWeight(.bold)
            .foregroundColor(.white)
            // æœ‰åŠ¹ç„¡åŠ¹ã§ã‚«ãƒ©ãƒ¼ã‚’å¤‰æ›´
            .background(isEnabled ? color : disabledColor)
            // æŠ¼ä¸‹æ™‚ã‹ã©ã†ã‹ã§é€æ˜åº¦ã‚’å¤‰æ›´
            .opacity(configuration.isPressed ? 0.8 : 1.0)
            .clipShape(RoundedRectangle(cornerRadius: cornerRadius))
    }
}

struct LoginButton: View {
    @Binding var isDisabled: Bool
    var onClick: () -> Void

    var body: some View {
        Button(action: onClick, label: {
            Text("Login")
        })
        .buttonStyle(RoundedButtonStyle())
        .disabled(isDisabled)
    }
}

struct LoginButton_Previews: PreviewProvider {
    static var previews: some View {
        ForEach(["iPhone 14", "iPhone SE (3rd generation)", "iPad (10th generation)"], id: \.self) { deviceName in
            VStack {
                LoginButton(isDisabled: .constant(true)) {
                    print("onClick")
                }
                LoginButton(isDisabled: .constant(false)) {
                    print("onClick")
                }
            }
            .previewDevice(PreviewDevice(rawValue: deviceName))
            .previewDisplayName(deviceName)
        }
    }
}
```

â†“Previewè¡¨ç¤ºã—ãŸæ§˜å­ãŒã“ã¡ã‚‰ã§ã™ã€‚

![image2.png](/images/bab64b94c5ac72/image2.png =350x)

## Reducerãƒ—ãƒ­ãƒˆã‚³ãƒ«ã‚’å®Ÿè£…ã—ãŸSessionã‚’ä½œæˆã™ã‚‹

Indicatorã®è¡¨ç¤º/éè¡¨ç¤ºã®åˆ‡ã‚Šæ›¿ãˆã‚„ã€name, passwordã®ãƒ‡ãƒ¼ã‚¿ã€å®Ÿéš›ã®ãƒ­ã‚°ã‚¤ãƒ³å‡¦ç†ã‚’è¡Œãˆã‚‹æ§˜ã«å®Ÿè£…ã—ã¦ã„ãã¾ã™ã€‚

```swift
struct Session: Reducer {
    struct State: Equatable {
        var isLoading = false
        var name = ""
        var password = ""
    }

    enum Action: Equatable {
        case login
        case setName(String)
        case setPassword(String)
        case startLoading
        case stopLoading
    }

    func reduce(into state: inout State, action: Action) -> Effect<Action> {
        switch action {
        case .login:
            state.isLoading = true
            return .run(priority: .background, operation: { [name = state.name, password = state.password] send in
                do {
                    try await client.auth.signIn(email: name, password: password)
                    let session = try await client.auth.session
                    print("### Session Info: \(session)")
                } catch {
                    print("### Sign Up Error: \(error)")
                }
                await send(.stopLoading) // ãƒ­ã‚°ã‚¤ãƒ³å‡¦ç†ãŒå®Œäº†ã—ãŸã‚‰è‡ªèº«ã®Actionã‚’å‘¼ã³å‡ºã—ã¦ã¾ã™
            })
        case let .setName(arg):
            state.name = arg
            return .none
        case let .setPassword(arg):
            state.password = arg
            return .none
        case .startLoading:
            state.isLoading = true
            return .none
        case .stopLoading:
            state.isLoading = false
            return .none
        }
    }
}
```

æœ€çµ‚çš„ãªãƒ­ã‚°ã‚¤ãƒ³ç”»é¢ã®å®Ÿè£…

```swift

import Combine
import ComposableArchitecture
import Supabase
import SwiftUI

// swiftlint:disable line_length
let client = SupabaseClient(
    supabaseURL: URL(string: "...")!,
    supabaseKey: "...")
// swiftlint:enable line_length

struct Session: Reducer {
    struct State: Equatable {
        var isLoading = false
        var name = ""
        var password = ""
    }

    enum Action: Equatable {
        case login
        case setName(String)
        case setPassword(String)
        case startLoading
        case stopLoading
    }

    func reduce(into state: inout State, action: Action) -> Effect<Action> {
        switch action {
        case .login:
            state.isLoading = true
            return .run(priority: .background, operation: { [name = state.name, password = state.password] send in
                do {
                    try await client.auth.signIn(email: name, password: password)
                    let session = try await client.auth.session
                    print("### Session Info: \(session)")
                } catch {
                    print("### Sign Up Error: \(error)")
                }
                await send(.stopLoading)
            })
        case let .setName(arg):
            state.name = arg
            return .none
        case let .setPassword(arg):
            state.password = arg
            return .none
        case .startLoading:
            state.isLoading = true
            return .none
        case .stopLoading:
            state.isLoading = false
            return .none
        }
    }
}
// UIActivityIndicatorViewã‚’ä½¿ã£ãŸã‚·ãƒ³ãƒ—ãƒ«ãªIndicatorã§ã™
struct ActivityIndicator: UIViewRepresentable {
    func makeUIView(context: UIViewRepresentableContext<ActivityIndicator>) -> UIActivityIndicatorView {
        return UIActivityIndicatorView(style: .large)
    }
    func updateUIView(_ uiView: UIActivityIndicatorView, context: UIViewRepresentableContext<ActivityIndicator>) {
        uiView.startAnimating()
    }
}

struct LoginView: View {
    let store: StoreOf<Session>
    @State var isDisabled = true

    var body: some View {
        WithViewStore(self.store, observe: { $0 }) { viewStore in
            ZStack {
                VStack(alignment: .center) {
                    VStack(spacing: 24) {
                        TextField("User name", text: viewStore.binding(get: \.name, send: Session.Action.setName))
                            .padding()
                            .background(Color(.systemGray6))
                            .cornerRadius(12.0)
                            .onChange(of: viewStore.name) { _ in
                                isDisabled = viewStore.name.isEmpty || viewStore.password.isEmpty
                            }
                        SecureField("Password",
                                    text: viewStore.binding(get: \.password, send: Session.Action.setPassword))
                            .padding()
                            .background(Color(.systemGray6))
                            .cornerRadius(12.0)
                            .onChange(of: viewStore.password) { _ in
                                isDisabled = viewStore.name.isEmpty || viewStore.password.isEmpty
                            }
                    }
                        .padding(.horizontal, 24)
                        .padding(.bottom, 24)
                    LoginButton(isDisabled: $isDisabled) {
                        viewStore.send(.login)
                    }
                }
                if viewStore.isLoading {
                    ActivityIndicator()
                }
            }
        }
    }
}

struct LoginView_Previews: PreviewProvider {
    static var previews: some View {
        LoginView(
            store: Store(initialState: Session.State()) {
                Session()
            }
        )
    }
}
```

ã‚·ãƒ¥ãƒŸãƒ¬ãƒ¼ã‚¿ã§å‹•ä½œã•ã›ã¦ã¿ãŸã‚‚ã®ãŒâ†“ã“ã¡ã‚‰ã«ãªã‚Šã¾ã™ã€‚ã€ŒLoginã€ãƒœã‚¿ãƒ³æŠ¼ä¸‹ã—ã¦ã‚³ãƒ³ã‚½ãƒ¼ãƒ«ãƒ­ã‚°ã«Sessionæƒ…å ±ãŒå‡ºåŠ›ã•ã‚Œã¦ã„ã‚Œã°æˆåŠŸã§ã™ï¼
![image3.gif](/images/bab64b94c5ac72/image3.gif =250x)

# å‚è€ƒURL

- [æ—¢å­˜ã® Xcode ãƒ—ãƒ­ã‚¸ã‚§ã‚¯ãƒˆã‚’ SwiftPM ã§ãƒãƒ«ãƒãƒ¢ã‚¸ãƒ¥ãƒ¼ãƒ«åŒ–ã™ã‚‹æœ€åˆã®ã‚¹ãƒ†ãƒƒãƒ—](https://zenn.dev/kalupas226/articles/73118709e316ad)

- [SwiftUIã®ViewModifierã‚’ä½¿ã£ã¦Viewã‚’ã‚«ã‚¹ã‚¿ãƒã‚¤ã‚ºã™ã‚‹ - Qiita](https://qiita.com/k_awoki/items/107773d6b14107954b91)

- [iOSã‚·ãƒŸãƒ¥ãƒ¬ãƒ¼ã‚¿ãƒ¼ã®ã‚­ãƒ¼ãƒã‚§ãƒ¼ãƒ³æƒ…å ±å‰Šé™¤ | hmhv](https://hmhv.info/2022/04/check-ios-simulator-keychain/)

- [[SwiftUI][TCA] binding](https://zenn.dev/chiii/articles/db7371f5904b2e)

- [TCA ã§ AsyncStream ã‚’ãƒ†ã‚¹ãƒˆã™ã‚‹æ–¹æ³•](https://zenn.dev/kalupas226/articles/634300ae1ca106)

- [https://software.small-desk.com/development/2020/09/19/spmrealm-swift-package-for-package-depends-on-realm/](https://software.small-desk.com/development/2020/09/19/spmrealm-swift-package-for-package-depends-on-realm/)

- [https://stackoverflow.com/questions/72092041/swiftui-focus-state-api-environment-variable-not-working](https://stackoverflow.com/questions/72092041/swiftui-focus-state-api-environment-variable-not-working)

- [https://thehappyprogrammer.com/custom-textfield-in-swiftui](https://thehappyprogrammer.com/custom-textfield-in-swiftui)

- [https://www.choge-blog.com/programming/swiftuicustomtextfieldstyle/](https://www.choge-blog.com/programming/swiftuicustomtextfieldstyle/)

- [https://software.small-desk.com/development/2021/09/22/swiftui-howto-focusstate/](https://software.small-desk.com/development/2021/09/22/swiftui-howto-focusstate/)
