---
title: "SwiftUIã§QRã‚³ãƒ¼ãƒ‰ä½œæˆ&èª­ã¿å–ã‚Šã‚’è¡Œã†"
emoji: "ğŸ“·"
type: "tech" # tech: æŠ€è¡“è¨˜äº‹ / idea: ã‚¢ã‚¤ãƒ‡ã‚¢
topics:
  - "swift"
  - "swiftui"
  - "ios"
  - "qrã‚³ãƒ¼ãƒ‰"
  - "visionkit"
published: true
---
# æ¦‚è¦

ã‚¿ã‚¤ãƒˆãƒ«ã®é€šã‚Šã§ã™ãŒã€SwiftUIã§QRã‚³ãƒ¼ãƒ‰ã®ç”Ÿæˆã¨èª­ã¿å–ã‚Šã‚’è©¦ã—ã¦è¦‹ãŸã„ã¨æ€ã„ã¾ã™ã€‚

iOS 13.0ä»¥é™ã‹ã‚‰ğŸ‘‡ã®ä¾¿åˆ©ãªãƒ¡ã‚½ãƒƒãƒ‰ã‚’ä½¿ãˆã‚‹ã®ã§ã€ã“ã¡ã‚‰ã‚’ä½¿ã£ã¦ç”Ÿæˆã—ã¦ã„ããŸã„ã¨æ€ã„ã¾ã™ã€‚

https://developer.apple.com/documentation/coreimage/cifilter/3228262-qrcodegenerator

> ã“ã®ãƒ¡ã‚½ãƒƒãƒ‰ã¯ã€QRã‚³ãƒ¼ãƒ‰ã‚’ç”»åƒã¨ã—ã¦ç”Ÿæˆã—ã¾ã™ã€‚ QRã‚³ãƒ¼ãƒ‰ã¯ã€ISO/IEC 18004:2006è¦æ ¼ã§å®šç¾©ã•ã‚Œã¦ã„ã‚‹é«˜å¯†åº¦ãƒãƒˆãƒªãƒƒã‚¯ã‚¹ãƒãƒ¼ã‚³ãƒ¼ãƒ‰ãƒ•ã‚©ãƒ¼ãƒãƒƒãƒˆã§ã™ã€‚
QRã‚³ãƒ¼ãƒ‰ãƒ»ã‚¸ã‚§ãƒãƒ¬ãƒ¼ã‚¿ãƒ¼ãƒ»ãƒ•ã‚£ãƒ«ã‚¿ãƒ¼ã¯ã€ä»¥ä¸‹ã®ãƒ—ãƒ­ãƒ‘ãƒ†ã‚£ã‚’ä½¿ç”¨ã—ã¾ã™
ãƒ»message: NSData ã¨ã—ã¦ QR ã‚³ãƒ¼ãƒ‰ã¨ã—ã¦ã‚¨ãƒ³ã‚³ãƒ¼ãƒ‰ã•ã‚Œã‚‹ãƒ‡ãƒ¼ã‚¿ã‚’è¡¨ã™æ–‡å­—åˆ—
ãƒ»correctionLevel: NSStringã¨ã—ã¦ã‚¨ãƒ©ãƒ¼è¨‚æ­£å½¢å¼ã‚’è¡¨ã™1æ–‡å­—ã®æ–‡å­—åˆ—ã€‚ Lã¯7ãƒ‘ãƒ¼ã‚»ãƒ³ãƒˆè£œæ­£ã€Mã¯15ãƒ‘ãƒ¼ã‚»ãƒ³ãƒˆè£œæ­£ã€Qã¯25ãƒ‘ãƒ¼ã‚»ãƒ³ãƒˆè£œæ­£ã€Hã¯30ãƒ‘ãƒ¼ã‚»ãƒ³ãƒˆè£œæ­£ã€‚

# å‹•ä½œç’°å¢ƒ

- MBA M3 24GB Sonoma 14.6.1
- Xcode: Version 16.1 (16B40)

# ã‚·ãƒ³ãƒ—ãƒ«ãªå®Ÿè£…

ã¾ãšã¯ä¸ãˆã‚‰ã‚ŒãŸæ–‡å­—åˆ—ã‚’QRã‚³ãƒ¼ãƒ‰ã¨ã—ã¦è¡¨ç¤ºã™ã‚‹ã ã‘ã®ã‚·ãƒ³ãƒ—ãƒ«ãªViewã‚’ä½œæˆã—ã¦ã„ããŸã„ã¨æ€ã„ã¾ã™ã€‚

`QrCodeView.swift` ã‚’ä½œæˆã—ã€ä»¥ä¸‹å®Ÿè£…ã‚’è¿½åŠ ã—ã¾ã™ã€‚

```swift
import CoreImage.CIFilterBuiltins // â‘ 
import SwiftUI

struct QrCodeView: View {
    var data: String
    var body: some View {
        Image(uiImage: qrImage)
            .interpolation(.none) // â‘¡
            .resizable() // â‘¢
            .scaledToFit()
            .accessibilityLabel(Text("QRCode"))
    }

    private var qrImage: UIImage { // â‘£
        let qrCodeGenerator = CIFilter.qrCodeGenerator()
        qrCodeGenerator.message = Data(data.utf8)
        qrCodeGenerator.correctionLevel = "H"
        if let outputimage = qrCodeGenerator.outputImage {
            if let cgImage = CIContext().createCGImage(
                outputimage, from: outputimage.extent) {
                return UIImage(cgImage: cgImage)
            }
        }
        return UIImage()
    }
}

#Preview {
    QrCodeView(data: "abc")
        .frame(width: 150, height: 150)
}
```

â‘  :`CoreImage.CIFilterBuiltins` ã®import

â‘¡ : ç”»åƒæ‹¡å¤§ç¸®å°æ™‚ã®è£œé–“ã‚’ãªãã™

â€» è£œé–“ã¯ã€ç”»åƒã‚’æ‹¡å¤§ã¾ãŸã¯ç¸®å°ã™ã‚‹ã¨ãã«ã€ãƒ”ã‚¯ã‚»ãƒ«é–“ã‚’åŸ‹ã‚ãŸã‚Šã‚¹ãƒ ãƒ¼ã‚ºã«è¡¨ç¤ºã™ã‚‹ãŸã‚ã®ã‚¢ãƒ«ã‚´ãƒªã‚ºãƒ ã€‚QRã‚³ãƒ¼ãƒ‰ã§ã¯èª­ã¿å–ã‚Šã‚¨ãƒ©ãƒ¼ã‚’èµ·ã“ã™å¯èƒ½æ€§ãŒã‚ã‚‹ã€‚

â‘¢ : ã‚¢ã‚¹ãƒšã‚¯ãƒˆæ¯”ã‚’ä¿ã¡ãªãŒã‚‰ãƒªã‚µã‚¤ã‚ºå¯èƒ½ã«ã™ã‚‹

â‘£ : `CIFilter.qrCodeGenerator` ã‚’ä½¿ç”¨ã—ã¦å‡ºåŠ›ç”»åƒã‚’ `UIImage` ã«å¤‰æ›ã—ã¦ã„ã‚‹

ğŸ‘‡Previewè¡¨ç¤ºã®æ§˜å­

![image1.png](/images/3c53b230229054/image1.png =300x)

# JSONæ–‡å­—åˆ—ã‚’QRã‚³ãƒ¼ãƒ‰åŒ–ã™ã‚‹

æ¬¡ã«JSONæ–‡å­—åˆ—ã‚’å—ã‘å–ã£ã¦QRã‚³ãƒ¼ãƒ‰ã‚’ç”Ÿæˆã•ã›ã¦ã¿ãŸã„ã¨æ€ã„ã¾ã™ã€‚æ–°è¦ã«`JsonQrCodeView.swift` ã‚’ä½œæˆã—ã¾ã™ã€‚

ã¾ãšã¯JSONåŒ–ã™ã‚‹ã‚ªãƒ–ã‚¸ã‚§ã‚¯ãƒˆã‚’å®šç¾©ã—ã¾ã™ã€‚ä»®ã« `Book` ã¨ã„ã†ã‚ªãƒ–ã‚¸ã‚§ã‚¯ãƒˆã‚’å®šç¾©ã—ã¾ã™ã€‚

```swift
struct Book: Codable {
    let id: Int
    let title: String
    let author: String
    let publicationAt: Date
}
```

ã“ã® `Book` ã‚’å—ã‘å–ã£ã¦JSONæ–‡å­—åˆ—åŒ–ã—ã¦QRã‚³ãƒ¼ãƒ‰ç”Ÿæˆã—ã¾ã™ã€‚

```swift
struct JsonQrCodeView: View {
    var book: Book
    var body: some View {
        if let json = jsonStr {
            QrCodeView(data: json)
                .frame(width: 150, height: 150)
        } else {
            Text("Qr Code Generate Error")
        }
    }

    private var jsonStr: String? {
        do {
            let encoder = JSONEncoder()
            encoder.outputFormatting = [.prettyPrinted, .withoutEscapingSlashes]
            let jsonData = try encoder.encode(book)
            return String(data: jsonData, encoding: .utf8)
        } catch {
            print(error.localizedDescription)
        }
        return nil
    }
}

#Preview {
    let book = Book(
        id: 1,
        title: "ã“ã“ã‚",
        author: "å¤ç›®æ¼±çŸ³",
        publicationAt: Date()
    )
    JsonQrCodeView(book: book)
}
```

ğŸ‘‡Previewè¡¨ç¤ºã®æ§˜å­

![image2.png](/images/3c53b230229054/image2.png =300x)

ã“ã¡ã‚‰ã‚’iOSã®ã‚«ãƒ¡ãƒ©ã§ãƒ•ã‚©ãƒ¼ã‚«ã‚¹ã™ã‚‹ã¨JSONæ–‡å­—åˆ—ãŒè¡¨ç¤ºã•ã‚Œã‚‹ã‹ã¨æ€ã„ã¾ã™ã€‚

# QRã‚³ãƒ¼ãƒ‰èª­ã¿å–ã‚Š

æ¬¡ã«QRã‚³ãƒ¼ãƒ‰ã®èª­ã¿å–ã‚Šã‚’å®Ÿè£…ã—ã¦ã„ããŸã„ã¨æ€ã„ã¾ã™ã€‚

å®Ÿè£…ã®æ‰‹æ®µã¨ã—ã¦ã¯ã–ã£ã¨èª¿ã¹ã¦ä»¥ä¸‹ã®3ã¤ã®æ–¹æ³•ãŒã‚ã‚‹ã¿ãŸã„ã§ã™ã€‚

1. ã‚µãƒ¼ãƒ‰ãƒ‘ãƒ¼ãƒ†ã‚£ã®ãƒ©ã‚¤ãƒ–ãƒ©ãƒªã‚’ä½¿ã†
    - æœ‰åã©ã“ã‚ã ã¨ [CodeScanner](https://github.com/twostraws/CodeScanner) ãŒã‚ã‚Šãã†ã§ã™
2. `AVFoundation` ã‚’ä½¿ç”¨ã—ã¦å®Ÿè£…ã™ã‚‹
3. `VisionKit`ã®`DataScannerViewController`ã‚’ä½¿ç”¨ã—ã¦å®Ÿè£…ã™ã‚‹
    - iOS 16ä»¥é™ã®ã¿ä½¿ç”¨å¯èƒ½

ä»Šå›ã¯`VisionKit`ã®`DataScannerViewController`ã‚’è©¦ã—ã¦ã¿ãŸã„ã¨æ€ã„ã¾ã™ã€‚

https://developer.apple.com/documentation/visionkit/datascannerviewcontroller

## æº–å‚™

ã‚«ãƒ¡ãƒ©ã‚’ä½¿ã†ã®ã§ `Info.plist` ã« `Privacy - Camera Usage Description` ã®è¨­å®šã‚’è¿½åŠ ã—ã¾ã™ã€‚

`Value` ã¯ä½•ã®ç‚ºã«ä½¿ã†ã‹ç†ç”±ã‚’æ›¸ã„ã¨ã‘ã°OKã§ã™ã€‚

â€» Xcode13ä»¥é™ã®å ´åˆã¯ãƒ‡ãƒ•ã‚©ãƒ«ãƒˆã§ `Info.plist` ã¯ä½œã‚‰ã‚Œãªã„ã®ã§ã€ã€ŒTARGETSã€>ã€ŒInfoã€ã‚¿ãƒ– >ã€ŒCustom macOS Application Target Propertiesã€ã‹ã‚‰è¿½åŠ ã—ã¦ä¸‹ã•ã„ã€‚

ã¾ãŸã‚«ãƒ¡ãƒ©ã‚’ä½¿ã†éš›ã«å®Ÿæ©Ÿã§ãªã„ã¨ä½¿ãˆãªã„ç‚ºã€å®Ÿæ©Ÿã§å‹•ä½œã•ã›ã‚‹ç‚ºã®è¨­å®šã‚‚å¿…è¦ã«ãªã‚Šã¾ã™ã€‚

ğŸ‘‡å‚è€ƒURL

https://www.ingenious.jp/articles/howto/xcode/xcode-actual-machine-test/

## å®Ÿè£…

æ–°è¦ `JsonQrCodeReaderView.swift` ã‚’ä»¥ä¸‹å†…å®¹ã§ä½œæˆã—ã¾ã™ã€‚

```swift
import SwiftUI
import VisionKit // â‘ 

struct QRCodeScanner: UIViewControllerRepresentable {
    func makeUIViewController(context: Context) -> DataScannerViewController {
        // â‘¡
        let dataScannerViewController = DataScannerViewController(
            recognizedDataTypes: [.barcode(symbologies: [.qr])],
            isHighlightingEnabled: true
        )
        try? dataScannerViewController.startScanning() // â‘¢
        return dataScannerViewController
    }

    func updateUIViewController(_ uiViewController: DataScannerViewController, context: Context) {
    }
}

struct JsonQrCodeReaderView: View {
    var body: some View {
        QRCodeScanner()
    }
}

#Preview {
    JsonQrCodeReaderView()
}
```

â‘  : `VisionKit` ã‚’importã—ã¦ã„ã¾ã™

â‘¡ : `DataScannerViewController` ã‚’ä½œæˆã—ã¦ã„ã¾ã™

- [recognizedDataTypes](https://developer.apple.com/documentation/visionkit/datascannerviewcontroller/recognizeddatatype)
  - `recognizedDataTypes: Set<DataScannerViewController.RecognizedDataType>`
  - `text(languages:textContentType:)` åˆã¯ `barcode(symbologies:)` ã‚’æŒ‡å®šã—ã¾ã™
  - ä»Šå›ã¯ ORã‚³ãƒ¼ãƒ‰ãªã®ã§ `[.barcode(symbologies: [.qr])]` ã‚’æŒ‡å®šã—ã¦ã„ã¾ã™
- isHighlightingEnabled
  - ORã‚³ãƒ¼ãƒ‰ã‚’èªè­˜ã—ãŸã‚‰ãƒã‚¤ãƒ©ã‚¤ãƒˆã•ã‚Œã‚‹ã‚ˆã†ã« `true` ã«è¨­å®šã—ã¦ã„ã¾ã™

â‘¢ : ã‚«ãƒ¡ãƒ©èµ·å‹•ã—Scanã‚’é–‹å§‹ã™ã‚‹ã‚ˆã†ã«ã—ã¦ã„ã¾ã™

ğŸ‘‡å®Ÿæ©Ÿã§å‹•ä½œã•ã›ã¦ã„ã‚‹æ§˜å­

![image3.gif](/images/3c53b230229054/image3.gif =300x)

## èª­ã¿å–ã£ãŸå†…å®¹ã‚’è¡¨ç¤º

æœ€å¾Œã«ã€èª­ã¿å–ã£ãŸQRã‚³ãƒ¼ãƒ‰ã®å†…å®¹ã‚’ç”»é¢ä¸Šã«è¡¨ç¤ºã•ã›ã¦ã¿ãŸã„ã¨æ€ã„ã¾ã™ã€‚

ğŸ‘‡Â å®Œæˆå½¢ã®å®Ÿè£…ã«ãªã‚Šã¾ã™ã€‚

```swift
struct QRCodeScanner: UIViewControllerRepresentable {
    // â‘ 
    var dataScannerViewController = DataScannerViewController(
        recognizedDataTypes: [.barcode(symbologies: [.qr])],
        isHighlightingEnabled: true
    )

    func makeUIViewController(context: Context) -> DataScannerViewController {
        dataScannerViewController.delegate = context.coordinator
        try? dataScannerViewController.startScanning()
        return dataScannerViewController
    }

    func updateUIViewController(_ uiViewController: DataScannerViewController, context: Context) {
    }
    // â‘¡
    func makeCoordinator() -> Coordinator {
        Coordinator(self)
    }

    final class Coordinator: NSObject, DataScannerViewControllerDelegate {
        private let parent: QRCodeScanner
        private var textView: UIView?

        init(_ parent: QRCodeScanner) {
            self.parent = parent
        }

        func dataScanner(_ dataScanner: DataScannerViewController,
                         didAdd addedItems: [RecognizedItem],
                         allItems: [RecognizedItem]
        ) {
            guard case .barcode(let barcode) = addedItems.first else {
                return
            }
            // â‘¢
            if let text = barcode.payloadStringValue {
                let frame = CGRect(
                    x: barcode.bounds.topLeft.x,
                    y: barcode.bounds.topLeft.y,
                    width: abs(barcode.bounds.topRight.x - barcode.bounds.topLeft.x) + 15,
                    height: abs(barcode.bounds.topLeft.y - barcode.bounds.bottomLeft.y) + 15
                )
                let textView = UITextView(frame: frame)
                textView.font = UIFont.systemFont(ofSize: 10)
                textView.text = text
                parent.dataScannerViewController.overlayContainerView.addSubview(textView)
                self.textView = textView
            }
        }
        // â‘£
        func dataScanner(_ dataScanner: DataScannerViewController,
                         didRemove removedItems: [RecognizedItem],
                         allItems: [RecognizedItem]
        ) {
            self.textView?.removeFromSuperview()
        }
    }
}
```

â‘  : Delegateã‹ã‚‰ä½¿ãˆã‚‹ã‚ˆã†ã« `DataScannerViewController` ã‚’å¤–å‡ºã—ã—ã¦ã„ã¾ã™

â‘¡ : `DataScannerViewControllerDelegate` ã§ã‚¤ãƒ™ãƒ³ãƒˆã®ã‚„ã‚Šã¨ã‚ŠãŒã§ãã‚‹æ§˜ã« `makeCoordinator` ã§ `Coordinator` ã‚¯ãƒ©ã‚¹ã‚’è¿”ã—ã¦ã„ã¾ã™

â‘¢ :  QRã‚³ãƒ¼ãƒ‰ãŒèªè­˜ã•ã‚ŒãŸã‚‰å‘¼ã°ã‚Œã¾ã™ã€‚`barcode: RecognizedItem.Barcode` ã® `bounds` ã«èªè­˜ã—ãŸé ˜åŸŸãŒã‚»ãƒƒãƒˆã•ã‚Œã¦ã„ã‚‹ã®ã§ã€ãã®é ˜åŸŸã«èª­ã¿å–ã£ãŸæ–‡å­—åˆ—ã‚’ `UITextView` ã¨ã—ã¦ä½œæˆã—ã€dataScannerViewControllerã® `overlayContainerView` ã«Viewã‚’è¿½åŠ ã—ã¦ã„ã¾ã™

â‘£ : QRã‚³ãƒ¼ãƒ‰ãŒèªè­˜ãŒåœæ­¢ã•ã‚ŒãŸã‚‰å‘¼ã°ã‚Œã¾ã™ã€‚ä»Šå›ã¯1ã¤ã ã‘ã—ã‹èªè­˜ã•ã›ãªã„å‰æãªã®ã§ã€â‘¢ã§ä½œæˆã—ãŸ `UITextView` ã‚’å‰Šé™¤ã—ã¦ã¾ã™

ğŸ‘‡å®Ÿæ©Ÿã§å‹•ä½œã•ã›ã¦ã„ã‚‹æ§˜å­

![image4.gif](/images/3c53b230229054/image4.gif =300x)

# å‚è€ƒURL

https://qiita.com/ikaasamay/items/58d1a401e98673a96fd2

https://medium.com/@ramesh_aran86/how-to-use-visionkit-in-swiftui-for-text-and-barcode-scanning-on-ios-e3f66c9006f2