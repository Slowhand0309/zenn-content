---
title: "WXTï¼ˆWeb Extension Toolkitï¼‰ã§Shadow DOM ã®ãƒ¬ã‚¤ãƒ¤ãƒ¼ã‚’ä»»æ„è¦ç´ ã«é‡ã­ã‚‹"
emoji: "ğŸ§°"
type: "tech" # tech: æŠ€è¡“è¨˜äº‹ / idea: ã‚¢ã‚¤ãƒ‡ã‚¢
topics:
  - "wxt"
  - "chromeæ‹¡å¼µ"
  - "shadowdom"
  - "extensions"
published: true
---
# æ¦‚è¦

ä»Šå›ã¯ WXT ã‚’ä½¿ã£ã¦æœ€å°æ§‹æˆã®æ‹¡å¼µæ©Ÿèƒ½ã‚’ä½œæˆã—ã€Content Script ã§ Shadow DOM ã®ãƒ¬ã‚¤ãƒ¤ãƒ¼ã‚’ä»»æ„è¦ç´ ã«é‡ã­ã‚‹ã¾ã§ã‚’è©¦ã—ã¦ã¿ã¾ã—ãŸã€‚ã‚¤ãƒ³ã‚¹ãƒˆãƒ¼ãƒ«æ™‚ã®ç‰¹å®šãƒãƒ¼ã‚¸ãƒ§ãƒ³ã§ã®ã‚¨ãƒ©ãƒ¼ã‚„ã€ã‚ªãƒ—ã‚·ãƒ§ãƒ³ã®æ¯”è¼ƒãªã©ã‚‚è¡Œãªã£ã¦ã„ã‚‹ã®ã§å‚è€ƒã«ãªã‚Œã°å¬‰ã—ã„ã§ã™ã€‚

## WXTã¨ã¯?

https://wxt.dev/

> WXTã¯ã€Webæ‹¡å¼µæ©Ÿèƒ½ã‚’æ§‹ç¯‰ã™ã‚‹ãŸã‚ã®æœ€æ–°ã®ã‚ªãƒ¼ãƒ—ãƒ³ã‚½ãƒ¼ã‚¹ãƒ•ãƒ¬ãƒ¼ãƒ ãƒ¯ãƒ¼ã‚¯ã§ã™ã€‚Nuxtã«è§¦ç™ºã•ã‚Œã€ä»¥ä¸‹ã®ç›®æ¨™ã‚’æ²ã’ã¦ã„ã¾ã™ã€‚
>
> - ç´ æ™´ã‚‰ã—ã„**DXã‚’æä¾›ã™ã‚‹**
> - ã™ã¹ã¦ã®ä¸»è¦ãƒ–ãƒ©ã‚¦ã‚¶ã«ãƒ•ã‚¡ãƒ¼ã‚¹ãƒˆã‚¯ãƒ©ã‚¹ã®ã‚µãƒãƒ¼ãƒˆã‚’æä¾›ã—ã¾ã™

### ç‰¹å¾´

- ã‚µãƒãƒ¼ãƒˆãƒ–ãƒ©ã‚¦ã‚¶
  - Chrome, Firefox, Edge, Safariãªã©ã®Chromiumãƒ™ãƒ¼ã‚¹ã®ãƒ–ãƒ©ã‚¦ã‚¶ç”¨æ‹¡å¼µæ©Ÿèƒ½ã‚’æ§‹ç¯‰
- MV2ã¨MV3
  - åŒã˜ã‚³ãƒ¼ãƒ‰ãƒ™ãƒ¼ã‚¹ã§ä»»æ„ã®ãƒ–ãƒ©ã‚¦ã‚¶ç”¨ã®Manifest V2 / V3 ã‚’æ§‹ç¯‰
- HMRã‚µãƒãƒ¼ãƒˆ
- ãƒ•ã‚¡ã‚¤ãƒ«ãƒ™ãƒ¼ã‚¹ã®ã‚¨ãƒ³ãƒˆãƒªãƒã‚¤ãƒ³ãƒˆ
  - [ãƒ—ãƒ­ã‚¸ã‚§ã‚¯ãƒˆæ§‹é€ ](https://wxt.dev/guide/essentials/project-structure.html)
- TypeScriptãŒãƒ‡ãƒ•ã‚©ãƒ«ãƒˆ
- è‡ªå‹•ã‚¤ãƒ³ãƒãƒ¼ãƒˆ
  - [unimport](https://www.npmjs.com/package/unimport) ã‚’ä½¿ç”¨ã—ãŸè‡ªå‹•ã‚¤ãƒ³ãƒãƒ¼ãƒˆã‚µãƒãƒ¼ãƒˆ
- è‡ªå‹•å…¬é–‹

# ãƒ—ãƒ­ã‚¸ã‚§ã‚¯ãƒˆä½œæˆ

ä»Šå›ã¯ `wxt-example` ã¨ã„ã†åå‰ã§ãƒ—ãƒ­ã‚¸ã‚§ã‚¯ãƒˆã‚’ä½œæˆã—ã¦é€²ã‚ã¦è¡ŒããŸã„ã¨æ€ã„ã¾ã™ã€‚

```bash
$ mkdir wxt-example
$ cd wxt-example
$ pnpm --version
10.18.3
$ pnpm init
```

â€» ä»Šå› `wxt@0.20.11` ã®ãƒã‚°ã«é­é‡ã—ãŸã®ã§ `package.json` ã«ä»¥ä¸‹ã‚’è¿½åŠ ã—ã¦ã‚¤ãƒ³ã‚¹ãƒˆãƒ¼ãƒ«å®Ÿæ–½ã—ã¦ã¾ã™ã€‚ä»Šå¾Œãƒã‚°ãŒè§£æ¶ˆã•ã‚Œã‚Œã° `pnpm i -D wxt` ã§æ¸ˆã‚€è©±ã‹ã‚‚ã—ã‚Œã¾ã›ã‚“ (ãƒãƒƒãƒ‰ãƒã‚¦ãƒã‚¦å‚ç…§)

`package.json` ã«ä»¥ä¸‹ã‚’è¿½åŠ 

```json
{
  "devDependencies": {
    "wxt": "0.20.11"
  },
  "pnpm": {
    "overrides": {
      "@wxt-dev/storage": "1.2.0"
    }
  }
}
```

`pnpm install` å®Ÿæ–½ã—ã€`entrypoints/background.ts` ã‚’ä»¥ä¸‹å†…å®¹ã§ä½œæˆã—ã¾ã™ã€‚

```tsx
export default defineBackground(() => {
  console.log("Hello world!");
});
```

`package.json` ã® `scripts` ã«ä»¥ä¸‹ã‚’è¿½åŠ ã—ã¾ã™ã€‚

```json
  "scripts": {
    "dev": "wxt",
    "dev:firefox": "wxt -b firefox",
    "build": "wxt build",
    "build:firefox": "wxt build -b firefox",
    "zip": "wxt zip",
    "zip:firefox": "wxt zip -b firefox",
    "postinstall": "wxt prepare"
  },
```

`pnpm dev` ã‚’å®Ÿæ–½ã™ã‚‹ã¨ Chrome ãŒèµ·å‹•ã•ã‚Œæ‹¡å¼µæ©Ÿèƒ½ãŒã‚¤ãƒ³ã‚¹ãƒˆãƒ¼ãƒ«ã•ã‚Œã¦ã„ã‚‹çŠ¶æ…‹ã«ãªã£ã¦ã„ã‚Œã°OKã§ã™ã€‚

![image1.png](/images/69205b8e5c26ab/image1.png)

â€» ã‚³ãƒ³ã‚½ãƒ¼ãƒ«ãƒ­ã‚°ã‚’è¦‹ã‚‹å ´åˆã¯å³ä¸Šã®ã€Œãƒ‡ãƒ™ãƒ­ãƒƒãƒ‘ãƒ¼ãƒ¢ãƒ¼ãƒ‰ã€ã‚’ONã«ã—ã¦ã€Œãƒ“ãƒ¥ãƒ¼ã‚’æ¤œè¨¼ Service Workerã€ã®ãƒªãƒ³ã‚¯ã‚’é–‹ãã¨è¦‹ã‚Œã¾ã™ã€‚

# ç°¡å˜ãªã‚µãƒ³ãƒ—ãƒ«å®Ÿè£…

ä»Šå›ã¯ç‰¹å®šã®ã‚µã‚¤ãƒˆä¸Šã§ã¨ã‚ã‚‹è¦ç´ ã®ä¸Šã«è¢«ã›ã‚‹Layerã‚’è¿½åŠ ã™ã‚‹æ§˜ãªã‚µãƒ³ãƒ—ãƒ«ã‚’ä½œæˆã—ã¦ã¿ãŸã„ã¨æ€ã„ã¾ã™ã€‚å®Ÿè£…ã™ã‚‹ã«ã‚ãŸã‚Šä»¥ä¸‹ã®Exampleã‚’å‚è€ƒã«ã—ã¾ã—ãŸã€‚

https://github.com/wxt-dev/examples/tree/main/examples/vue-overlay

## Entrypoints

https://wxt.dev/guide/essentials/entrypoints.html#entrypoint-types

WXTã§ã¯æ©Ÿèƒ½æ¯ã«ğŸ‘†ã®ãƒªãƒ³ã‚¯å…ˆã«ã‚ã‚‹æ§˜ãªè¤‡æ•°ã®ã‚¨ãƒ³ãƒˆãƒªãƒã‚¤ãƒ³ãƒˆãŒç”¨æ„ã•ã‚Œã¦ã„ã¾ã™ã€‚ä»Šå›ã¯ã“ã®ä¸­ã® **`Content Scripts`** ã‚’ä½¿ç”¨ã—ã¾ã™ã€‚**`Content Scripts`** ã§ã¯ä»¥ä¸‹ã®UIã‚’å·®ã—è¾¼ã‚€ãƒ¡ã‚½ãƒƒãƒ‰ãŒç”¨æ„ã•ã‚Œã¦ã„ã¾ã™ã€‚

1. **Integrated**
    - `createIntegratedUi`
    - ã‚³ãƒ³ãƒ†ãƒ³ãƒ„ãŒç›´æ¥å·®ã—è¾¼ã¾ã‚Œã¦ã€ãƒšãƒ¼ã‚¸ã®CSSã®å½±éŸ¿ã‚’å—ã‘ã¾ã™
2. **Shadow Root**
    - `createShadowRootUi`
    - [Shadow DOM](https://developer.mozilla.org/ja/docs/Web/API/Web_components/Using_shadow_DOM)ã¨ã—ã¦å·®ã—è¾¼ã¾ã‚Œã¾ã™
3. **IFrame**
    - `createIframeUi`
    - iframeã¨ã—ã¦å·®ã—è¾¼ã¾ã‚Œã¾ã™

ä»Šå›ã¯ `Shadow Root` ã‚’ä½¿ã£ã¦Layerã‚’å·®ã—è¾¼ã‚€ã‚ˆã†ã«ã—ã¦ã¿ãŸã„ã¨æ€ã„ã¾ã™ã€‚

## å®Ÿè£…

æ–°è¦ã« `entrypoints/content.ts` ã‚’ä»¥ä¸‹å†…å®¹ã§ä½œæˆã—ã¾ã™ã€‚

```tsx
export default defineContentScript({
  matches: ["*://*/*"],
  cssInjectionMode: "ui",

  async main(ctx) {
    const ui = await createShadowRootUi(ctx, {
      name: "example-overlay",
      position: "inline",
      anchor: ".main",
      onMount(container) {
        const app = document.createElement("p");
        app.textContent = "Hello world!";
        app.style.color = "red";
        container.append(app);
      },
    });
    ui.mount();
  },
});
```

- **cssInjectionMode**
  - å·®ã—è¾¼ã¾ã‚ŒãŸè¦ç´ ã®ã‚¹ã‚¿ã‚¤ãƒ«ã‚’ã‚³ãƒ³ãƒ†ãƒ³ãƒ„ã‚¹ã‚¯ãƒªãƒ—ãƒˆã«æŒ¿å…¥ã™ã‚‹æ–¹æ³•ã‚’ã‚«ã‚¹ã‚¿ãƒã‚¤ã‚ºã—ã¾ã™
    - manifest
      - ãƒãƒ‹ãƒ•ã‚§ã‚¹ãƒˆå†…ã®ã‚³ãƒ³ãƒ†ãƒ³ãƒ„ ã‚¹ã‚¯ãƒªãƒ—ãƒˆã®`css`é…åˆ—ã®ä¸‹ã« CSS ã‚’å«ã‚ã¾ã™
    - manual
      - ãƒãƒ‹ãƒ•ã‚§ã‚¹ãƒˆã‹ã‚‰CSSã‚’é™¤å¤–ã—ã¾ã™ã€‚ãƒšãƒ¼ã‚¸ã«æ‰‹å‹•ã§èª­ã¿è¾¼ã‚€å¿…è¦ãŒã‚ã‚Šã¾ã™
    - ui
      - ãƒãƒ‹ãƒ•ã‚§ã‚¹ãƒˆã‹ã‚‰CSSã‚’é™¤å¤–ã—ã¾ã™ã€‚CSSã¯ã€å‘¼ã³å‡ºã—æ™‚ã«UIã«è‡ªå‹•çš„ã«è¿½åŠ ã•ã‚Œã¾ã™
- **position**
  - ä»¥ä¸‹ã®3ç¨®é¡ã®ä¸­ã‹ã‚‰è¨­å®šã—ã¾ã™
    - `inline`
    - `overlay`
    - `modal`
- **anchor**
  - CSSã‚»ãƒ¬ã‚¯ã‚¿ã€XPathå¼ã€è¦ç´ ã€ã¾ãŸã¯ã“ã‚Œã‚‰3ã¤ã®ã„ãšã‚Œã‹ã‚’è¿”ã™é–¢æ•°ã‚’æ¸¡ã™
  - ãƒšãƒ¼ã‚¸å†…ã®UIè¿½åŠ ä½ç½®ã‚’æ±ºå®šã™ã‚‹

ä»Šå›ã¯ [https://wxt.dev/](https://wxt.dev/) ãƒšãƒ¼ã‚¸ã® `.main` è¦ç´ ã«å¯¾ã—ã¦èµ¤å­—ã§ `Hello world!` ã®æ–‡å­—ã‚’ `position` ã‚’å¤‰ãˆã¦å®Ÿè¡Œã—ã¦ã¿ã¾ã—ãŸã€‚

- inline
    ![image2.png](/images/69205b8e5c26ab/image2.png =500x)

  - å·®ã—è¾¼ã¾ã‚ŒãŸShadow DOM
  ![image3.png](/images/69205b8e5c26ab/image3.png =400x)

- overlay
    ![image4.png](/images/69205b8e5c26ab/image4.png =500x)

  - å·®ã—è¾¼ã¾ã‚ŒãŸShadow DOM
  ![image5.png](/images/69205b8e5c26ab/image5.png =400x)

- modal
    ![image6.png](/images/69205b8e5c26ab/image6.png =500x)

  - å·®ã—è¾¼ã¾ã‚ŒãŸShadow DOM
  ![image7.png](/images/69205b8e5c26ab/image7.png =400x)

å·®ã—è¾¼ã¾ã‚ŒãŸShadow DOM ã‚’æ¯”è¼ƒã—ã¦ã¿ã‚‹ã¨positionã®é•ã„ãŒä¸€ç›®ç­ç„¶ã§ã™ã­!

## Layerè¿½åŠ 

æ¬¡ã« `.main` è¦ç´ ã®ä¸Šã«èƒŒæ™¯è‰²ãŒã¤ã„ãŸLayerã‚’é‡ã­ã¦è¡¨ç¤ºã—ã¦ã¿ãŸã„ã¨æ€ã„ã¾ã™ã€‚å…ˆã»ã©ã® `entrypoints/content.ts` ã‚’ä»¥ä¸‹ã«ä¿®æ­£ã—ã¾ã™ã€‚

```tsx
export default defineContentScript({
  matches: ["*://*/*"],
  cssInjectionMode: "ui",

  async main(ctx) {
    const ui = await createShadowRootUi(ctx, {
      name: "example-overlay",
      position: "inline",
      anchor: ".main",
      append: "last",
      css: `
        :host{
          display: block !important;
          position: absolute !important;
          inset: 0 !important;
        }
        html, body { width: 100%; height: 100%; margin: 0; }
        #layer { width: 100%; height: 100%; background: red; opacity: 0.5; }
      `,
      onMount(container) {
        const root = document.createElement("div");
        root.id = "layer";
        container.append(root);

        // ã‚‚ã— .mainãŒ position:relative ã§ãªã„å ´åˆã¯ä»˜ä¸
        const main = document.querySelector(".main");
        if (main) {
          (main as HTMLElement).style.position = "relative";
        }
      },
    });
    ui.mount();
  },
});
```

ğŸ‘†ã§ã¯optionã®cssã§å·®ã—è¾¼ã¾ã‚ŒãŸè¦ç´ ã‚’ã€è¦ªè¦ç´ ã®ã‚µã‚¤ã‚ºä¸€æ¯ã«åºƒã’ã¦è¡¨ç¤ºã™ã‚‹ã‚ˆã†ã«ã—ã¦ã¾ã™ã€‚ã“ã®æ™‚ã«è¦ªè¦ç´ ãŒ `position: relative` ã§ã‚ã‚‹å¿…è¦ãŒã‚ã‚Šã¾ã™ã€‚ã‚ã¨ã¯ `id: layer` ã® div è¦ç´ ã®ã‚¹ã‚¿ã‚¤ãƒ«ã‚‚è¨­å®šã—ã¦ã¾ã™ã€‚

å®Ÿè¡Œã™ã‚‹ã¨ğŸ‘‡ã®ã‚ˆã†ã« `.main` è¦ç´ ã®ä¸Šã«LayerãŒè¢«ã•ã£ã¦è¡¨ç¤ºã•ã‚Œã¦ã„ã‚‹è¦‹ãŸç›®ã«ãªã‚Šã¾ã™ã€‚

![image8.png](/images/69205b8e5c26ab/image8.png =500x)

# Loadingãªã©ã§é…ã‚Œã¦è¡¨ç¤ºã•ã‚Œã‚‹ãƒ‘ã‚¿ãƒ¼ãƒ³

æ¬¡ã«ã¨ã‚ã‚‹è¦ç´ ãŒLoadingãªã©ã§é…ã‚Œã¦è¡¨ç¤ºã•ã‚Œã‚‹ãƒ‘ã‚¿ãƒ¼ãƒ³ã®å ´åˆã‚’è©¦ã—ã¦ã¿ãŸã„ã¨æ€ã„ã¾ã™ã€‚

åˆ†ã‹ã‚Šã¥ã‚‰ã„ã‹ã‚‚ã§ã™ãŒã€ğŸ‘‡zennã®ç­†è€…ã®è¨˜äº‹ä¸€è¦§ã®å…¨Cardã®ä¸Šã«åŒã˜ãèµ¤ã„åŠé€æ˜ã®Layerã‚’è¢«ã›ã‚‹æ§˜ã«ã—ã¦ã¿ãŸã„ã¨æ€ã„ã¾ã™ã€‚

![image9.gif](/images/69205b8e5c26ab/image9.gif =600x)

ğŸ‘†ã¯æ—¢ã«å…ˆã»ã©ã®å®Ÿè£…ã§å…¨Cardã«Layerã‚’è¢«ã›ã‚‹ã‚ˆã†ã«ã—ã¦ã„ã‚‹ã®ã§ã™ãŒã€LoadingãŒæŒŸã‚€ã®ã§ `anchor` ã§æŒ‡å®šã—ãŸè¦ç´ ãŒè¦‹ã¤ã‹ã‚‰ãšã†ã¾ãã„ãã¾ã›ã‚“ã€‚

ã“ã®å¯¾å¿œã¯ãã‚“ãªé›£ã—ã„äº‹ã¯ãªã `ui.mount();` ã®éƒ¨åˆ†ã§ **[autoMount](https://wxt.dev/api/reference/wxt/utils/content-script-ui/iframe/interfaces/IframeContentScriptUi.html#automount)** ã‚’ä½¿ã†ã‚ˆã†ã«ã—ã¦ã‚ã’ã¾ã™ã€‚åå‰ã®é€šã‚Šã‚¢ãƒ³ã‚«ãƒ¼ãŒå‹•çš„ã«è¿½åŠ /å‰Šé™¤ã•ã‚Œã‚‹éš›ã«ã€UIã‚’è‡ªå‹•çš„ã«ãƒã‚¦ãƒ³ãƒˆãŠã‚ˆã³å‰Šé™¤ã—ã¦ãã‚Œã¾ã™ã€‚

```tsx
export default defineContentScript({
  // ...
  async main(ctx) {
    const ui = await createShadowRootUi(ctx, {
      // ...
    });
    ui.autoMount(); // â† mount() ã§ã¯ãªã autoMount() ã‚’å‘¼ã¶
  },
});
```

ğŸ‘‡å®Ÿè¡Œçµæœ

![image10.gif](/images/69205b8e5c26ab/image10.gif =600x)

# ã¾ã¨ã‚

ä»Šå›ã¯ãŸã¾ãŸã¾ã‚¤ãƒ³ã‚¹ãƒˆãƒ¼ãƒ«æ™‚ã®ã‚¨ãƒ©ãƒ¼ã§ãƒãƒã‚Šã¾ã—ãŸãŒã€ãã‚Œä»¥å¤–ã¯ `ç´ æ™´ã‚‰ã—ã„DXã‚’æä¾›ã™ã‚‹` ã¨è¬³ã£ã¦ã„ã‚‹ã ã‘ã‚ã‚Šã‚µã‚¯ãƒƒã¨é–‹ç™ºã«ç€æ‰‹ã§ãã‚‹ä½“é¨“ã¯è‰¯ã‹ã£ãŸã§ã™ã€‚ã¾ãŸä»Šå¾Œåˆ¥ã®æ©Ÿèƒ½ã‚‚è‰²ã€…è©¦ã—ã¦ã¿ãŸã„ã¨æ€ã„ã¾ã™ã€‚

# ãƒãƒƒãƒ‰ãƒã‚¦ãƒã‚¦

`pnpm i -D wx`  æ™‚ã«ä»¥ä¸‹ã®ã‚¨ãƒ©ãƒ¼ãŒç™ºç”Ÿã™ã‚‹

```bash
â€‰ERR_PNPM_WORKSPACE_PKG_NOT_FOUNDâ€‰ In : "@wxt-dev/browser@workspace:^" is in the dependencies but no package named "@wxt-dev/browser" is present in the workspace
 This error happened while installing the dependencies of wxt@0.20.11
 at @wxt-dev/storage@1.2.5
```

https://github.com/wxt-dev/wxt/issues/1933

ğŸ‘†ã®Issueã«ã‚ˆã‚‹ã¨ `wxt@0.20.11` ãŒä¾å­˜ã—ã¦ã„ã‚‹ `@wxt-dev/storage@1.2.5` ãŒåŸå› ã§ã‚¨ãƒ©ãƒ¼ãŒèµ·ãã¦ã„ã‚‹ã‚ˆã†ã€‚wxtã®ãƒãƒ¼ã‚¸ãƒ§ãƒ³ã‚’ä¸‹ã’ã‚‹ã‹ã€æœ¬è¨˜äº‹ã§ã‚‚ã‚„ã£ã¦ã„ã‚‹æ§˜ã« `@wxt-dev/storage` ã‚’ `1.2.0` ã§overrideã™ã‚‹ã€‚

# å‚è€ƒURL

https://zenn.dev/daichan132/articles/0a2889173e1797

https://zenn.dev/cybozu_frontend/articles/introduction-browser-extensions-tools

https://eiji.page/blog/crx-wxt-content-anchor/
