---
title: "Testcontainers for NodeJS ã‚’ Docker in Dokcerç’°å¢ƒã§Redisã‚„Prismaã‚’è©¦ã™"
emoji: "ğŸ³"
type: "tech" # tech: æŠ€è¡“è¨˜äº‹ / idea: ã‚¢ã‚¤ãƒ‡ã‚¢
topics:
  - "testcontainers"
  - "nodejs"
  - "docker"
  - "devcontainer"
  - "prisma"
published: true
---
# Testcontainers ã¨ã¯

https://testcontainers.com/

> Testcontainersã¯ã€çµ±åˆãƒ†ã‚¹ãƒˆã‚„ã‚¨ãƒ³ãƒ‰ãƒ„ãƒ¼ã‚¨ãƒ³ãƒ‰ãƒ†ã‚¹ãƒˆã®ãŸã‚ã«ã€ãƒ‡ãƒ¼ã‚¿ãƒ™ãƒ¼ã‚¹ã€ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸ãƒ–ãƒ­ãƒ¼ã‚«ãƒ¼ã€ã‚¦ã‚§ãƒ–ãƒ–ãƒ©ã‚¦ã‚¶ãªã©ã®è»½é‡ã§ä½¿ã„æ¨ã¦ã®Dockerã‚³ãƒ³ãƒ†ãƒŠã‚¤ãƒ³ã‚¹ã‚¿ãƒ³ã‚¹ã‚’æä¾›ã™ã‚‹ã‚ªãƒ¼ãƒ—ãƒ³ã‚½ãƒ¼ã‚¹ãƒ•ãƒ¬ãƒ¼ãƒ ãƒ¯ãƒ¼ã‚¯ã§ã™ã€‚

## Testcontainers for NodeJS

https://node.testcontainers.org/

Testcontainersã¯è‰²ã‚“ãªè¨€èªã«å¯¾å¿œã—ã¦ã„ã¾ã™ã€‚ä»Šå›ã¯ãã®ä¸­ã®NodeJSã‚’è©¦ã—ã¦ã¿ãŸã„ã¨æ€ã„ã¾ã™ã€‚

## Docker in Docker

è‡ªèº«ãŒã‚ˆãDockerã‚’ä½¿ã£ã¦é–‹ç™ºã™ã‚‹ã“ã¨ãŒå¤šã„ã®ã§ã€Dockerå†…ã§ã‚‚TestcontainersãŒä½¿ãˆã‚‹ã®ã‹ã€ãƒ†ã‚¹ãƒˆé…ããªã£ãŸã‚Šã—ãªã„ã‹ãªã©è‰²ã€…è©¦ã—ã¦ã¿ãŸã„ã¨æ€ã„ã¾ã™ã€‚

# ç’°å¢ƒæ§‹ç¯‰

https://github.com/Slowhand0309/nodejs-devcontainer-boilerplate

NodeJSãŒä½¿ãˆã‚‹Dockerç’°å¢ƒã§ã‚ã‚Œã°ã©ã®æ§˜ã«æ§‹ç¯‰ã—ã¦ã‚‚ã„ã„ã¨æ€ã„ã¾ã™ãŒã€ä»Šå›ã‚‚â†‘ã‚’Forkã— `testcontainers-nodejs-example` ã¨ã„ã†ãƒªãƒã‚¸ãƒˆãƒªã§é€²ã‚ã¦ã„ãã¾ã™ã€‚

NodeJSã®Versionã¯ `v20.10.0` ã«ãªã£ã¦ã¾ã™ã€‚

## Docker in Docker ã® Dev Container Features è¿½åŠ 

Dev Container ã‚’ä½¿ã†å ´åˆã€Featuresã¨ã—ã¦æ‹¡å¼µæ©Ÿèƒ½ã¿ãŸã„ãªã‚‚ã®ã‚’è¿½åŠ ã§ãã¾ã™ã€‚

ä»Šå›ã¯â†“ã®Docker in Docker ã®æ©Ÿèƒ½ã‚’è¿½åŠ ã—ã¦ãã‚Œã‚‹Featuresã‚’è¿½åŠ ã—ã¾ã™ã€‚

https://github.com/devcontainers/features/tree/main/src/docker-in-docker

`.devcontainer/devcontainer.json` ã® `features` ã«ä»¥ä¸‹ã‚’è¿½åŠ ã—ã¾ã™ã€‚

```json
  "features": {
    ...
    "ghcr.io/devcontainers/features/docker-in-docker:2": {}
  },
```

## ãƒ‘ãƒƒã‚±ãƒ¼ã‚¸ã‚¤ãƒ³ã‚¹ãƒˆãƒ¼ãƒ«

æ—©é€Ÿã‚³ãƒ³ãƒ†ãƒŠèµ·å‹•ã—ã€å¿…è¦ãªãƒ‘ãƒƒã‚±ãƒ¼ã‚¸ã‚’è¿½åŠ ã—ã¦ã„ããŸã„ã¨æ€ã„ã¾ã™ã€‚

ã¾ãšã¯ [ã“ã¡ã‚‰](https://node.testcontainers.org/quickstart/) ã®Quickstartã‚’è©¦ã—ã¦ã¿ãŸã„ã®ã§ã€ãã‚Œã«å‘ã‘ã¦å¿…è¦ãªãƒ‘ãƒƒã‚±ãƒ¼ã‚¸ã‚’è¿½åŠ ã—ã¾ã™ã€‚

(â€» async-redis ã®ä»£ã‚ã‚Šã« ioredis ã‚’ä½¿ã†æ§˜ã«ã—ã¦ã¾ã™)

```bash
yarn add -D testcontainers typescript jest ts-jest @types/jest ioredis @types/ioredis
```

å„è¨­å®šãƒ•ã‚¡ã‚¤ãƒ«ã¯ä»¥ä¸‹ã®æ§˜ã«è¨­å®šã—ã¦ã¾ã™ã€‚

- tsconfig.json

    ```json
    {
      "compilerOptions": {
        "target": "esnext",
        "module": "commonjs",
        "lib": ["esnext"],
        "baseUrl": "./src",
        "outDir": "dist",
        "strict": true,
        "forceConsistentCasingInFileNames": true,
        "noFallthroughCasesInSwitch": true,
        "noImplicitOverride": true,
        "noImplicitReturns": true,
        "noPropertyAccessFromIndexSignature": true,
        "esModuleInterop": true
      },
      "include": ["src"]
    }
    ```

- jest.config.js

    ```jsx
    /** @type {import('ts-jest').JestConfigWithTsJest} */
    module.exports = {
      preset: 'ts-jest',
      testEnvironment: 'node',
      roots: ['tests'],
      testTimeout: 30000,
      testMatch: [
        '**/?(*.)+(spec|test).ts'
      ],
    };
    
    ```

    â€» ä»¥ä¸‹ã®timeoutãŒç™ºç”Ÿã™ã‚‹ç‚º `testTimeout` ã‚’ä¼¸ã°ã—ã¦ã¾ã™

    ```text
    thrown: "Exceeded timeout of 5000 ms for a hook.
    Add a timeout value to this test to increase the timeout, if this is a long-running test. See [https://jestjs.io/docs/api#testname-fn-timeout."](https://jestjs.io/docs/api#testname-fn-timeout.%22)
    ```

# ãƒ†ã‚¹ãƒˆå®Ÿè£…

## ã‚·ãƒ³ãƒ—ãƒ«ãªredisã®ãƒ†ã‚¹ãƒˆ

`tests/redis.spec.ts` ã‚’ä»¥ä¸‹å†…å®¹ã§ä½œæˆã—ã¾ã™ã€‚

```tsx
import * as IORedis from "ioredis";
import { GenericContainer, StartedTestContainer } from "testcontainers";

describe("Redis", () => {
  let container: StartedTestContainer;
  let redisClient: IORedis.Redis;

  beforeAll(async () => {
    container = await new GenericContainer("redis")
      .withExposedPorts(6379)
      .start();

    redisClient = new IORedis.Redis({
      host: container.getHost(),
      port: container.getMappedPort(6379),
    });
  });

  afterAll(async () => {
    await redisClient.quit();
    await container.stop();
  });

  it("works", async () => {
    await redisClient.set("key", "val");
    expect(await redisClient.get("key")).toBe("val");
  });
});
```

ã„ã–å®Ÿè¡Œã™ã‚‹ã¨ãƒ†ã‚¹ãƒˆãŒãƒ‘ã‚¹ã—ã¾ã—ãŸ! ã“ã‚Œã§è¨­å®šã¯è‰¯ã•ãã†ã§ã™ã€‚

```bash
$ yarn test
yarn run v1.22.19
$ jest
 PASS  tests/redis.spec.ts
  Redis
    âœ“ works (3 ms)

Test Suites: 1 passed, 1 total
Tests:       1 passed, 1 total
Snapshots:   0 total
Time:        1.338 s, estimated 2 s
Ran all test suites.
Done in 1.58s.

```

ãƒ†ã‚¹ãƒˆã«ã‹ã‹ã£ãŸæ™‚é–“ã¯5å›ã‚„ã£ãŸå¹³å‡ã‚’å–ã‚‹ã¨**ç´„1.6s**ã§ã—ãŸã€‚

## å®Ÿéš›ã®redisã®ã‚³ãƒ³ãƒ†ãƒŠãŸã¦ã¦è¨ˆæ¸¬

æ¬¡ã¯å®Ÿéš›ã«redisã®ã‚³ãƒ³ãƒ†ãƒŠã‚’èµ·å‹•ã—ã¦ãã“ã«æ¥ç¶šã—ãŸå ´åˆã®ãƒ†ã‚¹ãƒˆãŒã©ã‚Œãã‚‰ã„ã‹ã‹ã‚‹ã‹è¨ˆæ¸¬ã—ã¦ã¿ãŸã„ã¨æ€ã„ã¾ã™ã€‚

- `.devcontainer/compose.yaml` ã«ä»¥ä¸‹ã‚’è¿½åŠ 

```yaml
services:
  # â†“è¿½åŠ 
  redis:
    image: "redis:7.2.5-alpine"
    ports:
      - "6379:6379"
```

- å…ˆã»ã©ä½œæˆã—ãŸ `tests/redis.spec.ts` ã‚’ä»¥ä¸‹ã«ä¿®æ­£ã—ã¾ã™

```tsx
import * as IORedis from "ioredis";

describe("Redis", () => {
  let redisClient: IORedis.Redis;

  beforeAll(async () => {
    redisClient = new IORedis.Redis({
      host: "redis",
      port: 6379,
    });
  });

  afterAll(async () => {
    await redisClient.del("key");
    await redisClient.quit();
  });

  it("works", async () => {
    await redisClient.set("key", "val");
    expect(await redisClient.get("key")).toBe("val");
  });
});
```

æº–å‚™ãŒã§ããŸã®ã§ã‚³ãƒ³ãƒ†ãƒŠå†èµ·å‹•ã—ã¦æ—©é€Ÿãƒ†ã‚¹ãƒˆã‚’å®Ÿè¡Œã—ã¦ã¿ãŸã„ã¨æ€ã„ã¾ã™ã€‚

```bash
$ yarn test
yarn run v1.22.19
$ jest
 PASS  tests/redis.spec.ts
  Redis
    âœ“ works (5 ms)

Test Suites: 1 passed, 1 total
Tests:       1 passed, 1 total
Snapshots:   0 total
Time:        0.172 s, estimated 1 s
Ran all test suites.
Done in 0.40s.
```

ãƒ†ã‚¹ãƒˆã«ã‹ã‹ã£ãŸæ™‚é–“ã¯5å›ã‚„ã£ãŸå¹³å‡ã‚’å–ã‚‹ã¨**ç´„0.4s**ã§ã—ãŸã€‚

ã¨ã„ã†äº‹ã§Testcontainersã‚’ä½¿ã£ãŸå ´åˆã¨æ¯”è¼ƒã™ã‚‹ã¨ **ç´„1.2s** Testcontainersã®èµ·å‹•ã‚„å¾Œç‰‡ä»˜ã‘ã§ã‹ã‹ã£ã¦ã„ã‚‹äº‹ã«ãªã‚Šãã†ã§ã™ã€‚æ™®é€šã«dockerèµ·å‹•ã™ã‚‹æ™‚ã¨æ¯”ã¹ãŸã‚‰å½“ãŸã‚Šå‰ã§ã™ãŒçˆ†é€Ÿã§ã™ã­ã€‚

å¤§é‡ã®ãƒ†ã‚¹ãƒˆã§æ¯å›Testcontainersã‚’èµ·å‹•ã™ã‚‹ã¨ã‹ã ã©æ™‚é–“ã‹ã‹ã£ã¡ã‚ƒã„ãã†ãªã®ã§ã€ä½•ã‹ã—ã‚‰å·¥å¤«ãŒå¿…è¦ãªã®ã‹ã‚‚ã§ã™ã­ã€‚

# å®Ÿéš›ã‚ã‚Šãã†ãªã‚±ãƒ¼ã‚¹ã§ã®ãƒ†ã‚¹ãƒˆã‚’è©¦ã™

## prismaã‚’ä½¿ã£ãŸDBã‚¢ã‚¯ã‚»ã‚¹ã®ãƒ†ã‚¹ãƒˆ

ä»Šå›ã¯prismaã¨posgresqlã®æœ€ä½é™ã®æ§‹æˆã§ç°¡å˜ãªãƒ†ã‚¹ãƒˆã‚’è©¦ã—ã¦ã¿ãŸã„ã¨æ€ã„ã¾ã™ã€‚

- `.devcontainer/compose.yaml` ã«ä»¥ä¸‹ã‚’è¿½åŠ 

```yaml
volumes:
  db_data:

services:
  db:
    image: postgres:16.2
    ports:
      - 5432:5432
    volumes:
      - db_data:/var/lib/postgresql/data
    environment:
      POSTGRES_USER: postgres
      POSTGRES_PASSWORD: postgres
```

ã‚³ãƒ³ãƒ†ãƒŠã‚’å†èµ·å‹•ã—ã¨ãã¾ã™ã€‚

- å¿…è¦ãªãƒ‘ãƒƒã‚±ãƒ¼ã‚¸ã‚¤ãƒ³ã‚¹ãƒˆãƒ¼ãƒ«ã¨åˆæœŸåŒ–

```bash
yarn add -D prisma @testcontainers/postgresql
yarn prisma init --datasource-provider postgresql
```

- ç”Ÿæˆã•ã‚ŒãŸÂ `.env`Â ãƒ•ã‚¡ã‚¤ãƒ«ã®Â `DATABASE_URL`Â ã‚’ä»¥ä¸‹ã«ä¿®æ­£ã—ã¾ã™ã€‚

```yaml
DATABASE_URL="postgresql://postgres:postgres@db:5432/example?schema=public"
```

- `prisma/schema.prisma`Â ã«Â `User`Â ãƒ†ãƒ¼ãƒ–ãƒ«ã‚’è¿½åŠ 

```text
model User {
  id    Int     @id @default(autoincrement())
  email String  @unique
  name  String?
}

```

- ãƒã‚¤ã‚°ãƒ¬ãƒ¼ã‚·ãƒ§ãƒ³å®Ÿè¡Œã—ã¨ãã¾ã™

```bash
yarn prisma migrate dev --name init
```

ã“ã‚Œã§Â `@prisma/client`Â ãƒ‘ãƒƒã‚±ãƒ¼ã‚¸ãŒè¿½åŠ ã•ã‚Œå†…éƒ¨çš„ã«Â `prisma generate`Â ãŒå®Ÿè¡Œã•ã‚Œã¾ã™ã€‚ã¾ãŸ `prisma/migrations` é…ä¸‹ã«ãƒã‚¤ã‚°ãƒ¬ãƒ¼ã‚·ãƒ§ãƒ³ç”¨ã®ãƒ•ã‚¡ã‚¤ãƒ«ãŒç”Ÿæˆã•ã‚Œã¦ã„ã‚‹ã‹ã¨æ€ã„ã¾ã™ã€‚

æ¬¡ã«ãƒ†ã‚¹ãƒˆã‚’æ›¸ã„ã¦ã„ããŸã„ã¨æ€ã„ã¾ã™ `tests/prisma.spec.ts` ã‚’ä»¥ä¸‹å†…å®¹ã§ä½œæˆã—ã¾ã™ã€‚

```tsx
import { PrismaClient } from "@prisma/client";
import {
  PostgreSqlContainer,
  StartedPostgreSqlContainer,
} from "@testcontainers/postgresql";
import { exec } from "child_process";
import { promisify } from "util";

const execAsync = promisify(exec);

describe("Prisma", () => {
  let container: StartedPostgreSqlContainer;
  let prisma: PrismaClient;

  beforeAll(async () => {
    container = await new PostgreSqlContainer().start();
    const connectionConfig = {
      host: container.getHost(), // '172.17.0.1'
      port: container.getMappedPort(5432), // 32779
      database: container.getDatabase(), // 'test'
      user: container.getUsername(), // 'test'
      password: container.getPassword(), // 'test'
    };

    // Testcontainersã®ãƒã‚¹ã‚°ãƒ¬ã‚³ãƒ³ãƒ†ãƒŠã®æƒ…å ±ã‚’å…ƒã«DATABASE_URLã‚’ä½œæˆ
    const databaseUrl = `postgresql://${connectionConfig.user}:${connectionConfig.password}@${connectionConfig.host}:${connectionConfig.port}/${connectionConfig.database}`;
    // ãƒã‚¤ã‚°ãƒ¬ãƒ¼ã‚·ãƒ§ãƒ³å®Ÿè¡Œ
    const result = await execAsync(
      `DATABASE_URL=${databaseUrl} npx prisma migrate dev --skip-generate`
    );

    prisma = new PrismaClient({
      datasources: {
        db: {
          url: databaseUrl,
        },
      },
    });
    await prisma.user.create({
      data: {
        email: "john@example.com",
        name: "John Doe",
      },
    });
  });

  it("works", async () => {
    const users = await prisma.user.findMany();
    expect(users).toHaveLength(1);
    expect(users[0].email).toBe("john@example.com");
    expect(users[0].name).toBe("John Doe");
  });

  afterAll(async () => {
    await container.stop();
  });
});
```

ãƒ†ã‚¹ãƒˆå®Ÿè¡Œã•ã›ã¦Passã•ã‚Œã¦ã„ã‚Œã°OKã§ã™ã€‚

```bash
$ yarn test tests/prisma.spec.ts
yarn run v1.22.19
$ jest tests/prisma.spec.ts
 PASS  tests/prisma.spec.ts
  Prisma
    âœ“ works (2 ms)

Test Suites: 1 passed, 1 total
Tests:       1 passed, 1 total
Snapshots:   0 total
Time:        3.662 s, estimated 4 s
Ran all test suites matching /tests\/prisma.spec.ts/i.
Done in 3.90s.
```

ã“ã¡ã‚‰5å›ãƒ†ã‚¹ãƒˆã—ã¦å¹³å‡ãŒç´„ `3.9382s` ã§ã—ãŸã€‚

# ãã®ä»–

ãƒ†ã‚¹ãƒˆæ™‚ã«Testcontainersã®ãƒ‡ãƒãƒƒã‚°ãƒ­ã‚°ã‚’å‡ºåŠ›ã—ãŸã„å ´åˆã¯ä»¥ä¸‹ã®ã‚ˆã†ã« `DEBUG=testcontainers*` ã‚’ã¤ã‘ã¦å®Ÿè¡Œã—ã¾ã™ã€‚

```bash
DEBUG=testcontainers* yarn test
```

ã‚¢ã‚¹ã‚¿ãƒªã‚¹ã‚¯ã®éƒ¨åˆ†ã¯buildæ™‚ã®ãƒ­ã‚°ã‚„execæ™‚ã®ãƒ­ã‚°ãªã©ã€è‰²ã€…åˆ‡ã‚Šæ›¿ãˆã¦å‡ºåŠ›ã§ãã¾ã™ã€‚

è©³ã—ãã¯â†“ã‚’å‚ç…§ã€‚

https://node.testcontainers.org/configuration

# ãƒˆãƒ©ãƒ–ãƒ«ã‚·ãƒ¥ãƒ¼ãƒ†ã‚£ãƒ³ã‚°

## ãƒ‘ãƒƒã‚±ãƒ¼ã‚¸ã‚¤ãƒ³ã‚¹ãƒˆãƒ¼ãƒ«æ™‚ã« **`Unable to detect compiler type error`** ãŒå‡ºã‚‹å ´åˆ

https://github.com/testcontainers/testcontainers-node/issues/652

â†‘ã®issueã«ã‚‚ã‚ã‚‹é€šã‚Šã€`--omit=optional` ã‚’ã¤ã‘ã¦ `yarn install` ã—ã¦ã‚„ã‚‹

## ãƒ†ã‚¹ãƒˆä¸­ã«`An error occurred listing credentials` ãŒç™ºç”Ÿã™ã‚‹å ´åˆ

https://github.com/microsoft/vscode-remote-release/issues/4202

â†‘ã®issueã«ã‚ã‚‹ã‚ˆã†ã«ã€VSCodeä¸Šã®ã‚¿ãƒ¼ãƒŸãƒŠãƒ«ã‹ã‚‰ã§ã¯å®Ÿè¡Œã§ãã€ `docker exec` ã‹ã‚‰ã ã¨ã‚¨ãƒ©ãƒ¼ãŒèµ·ãã‚‹ã‚ˆã†ã§ã™ã€‚è©³ã—ãã¯èª­ã¿è§£ã‘ãªã‹ã£ãŸã®ã§ã™ãŒã€ãŠãã‚‰ã `REMOTE_CONTAINERS_IPC` ãŒ `docker exec` ã ã¨è¨­å®šã•ã‚Œã¦ã„ãªã„ã®ã§èªè¨¼æƒ…å ±ã‚’æ‰±ã†éš›ã«å¤±æ•—ã™ã‚‹ã®ã‹ã‚‚ã—ã‚Œãªã„ã§ã™ã€‚

ã¾ãŸã€â†“ã®è¨˜äº‹ã®ã‚ˆã†ã« `.gitconfig` ã® `credential` ã‚’åŒæœŸã—ãŸã‚Šã€å‹æ‰‹ã«è¿½åŠ ã—ãªã„ã‚ˆã†ã«ã—ã¦ã‚‚ã„ã‘ã‚‹ã‚ˆã†ã§ã™ã€‚

https://rexbytes.com/2022/08/23/visual-studio-docker-container-target-stop-importing-local-git-config/

ãŸã ã€å®Ÿéš›ã«è©¦ã—ã¦ã†ã¾ãã„ãã¾ã—ãŸãŒã€è©³ç´°ãŒåˆ†ã‹ã‚‰ãªã‹ã£ãŸã®ã§å…ƒã«æˆ»ã—ã¾ã—ãŸã€‚ã€‚

# å‚è€ƒURL

https://zenn.dev/tsaeki/articles/fdf5d7f2cae2fb

https://blog.yarsalabs.com/isolating-test-environments-with-testcontainers-in-nodejs/