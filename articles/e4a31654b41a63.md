---
title: "macOSã‚¢ãƒ—ãƒªã§è¦‹ã‹ã‘ã‚‹è‡ªå‹•ã‚¢ãƒƒãƒ—ãƒ‡ãƒ¼ãƒˆæ©Ÿèƒ½ã‚’å®Ÿè£…ã™ã‚‹"
emoji: "ğŸ“¥"
type: "tech" # tech: æŠ€è¡“è¨˜äº‹ / idea: ã‚¢ã‚¤ãƒ‡ã‚¢
topics:
  - "swift"
  - "swiftui"
  - "mac"
  - "sparkle"
published: true
---
# æ¦‚è¦

ä»Šå›ã¯macOSå‘ã‘ã®ã‚¢ãƒ—ãƒªã§è¦‹ã‹ã‘ã‚‹ã€ã‚¢ãƒƒãƒ—ãƒ‡ãƒ¼ãƒˆãŒã‚ã‚Œã°ãŠçŸ¥ã‚‰ã›ã—ã¦ãã‚Œã‚‹æ©Ÿèƒ½(ğŸ‘‡ã®ã‚ˆã†ãªãƒ€ã‚¤ã‚¢ãƒ­ã‚°ãŒå‡ºã¦ãŠçŸ¥ã‚‰ã›ã—ã¦ãã‚Œã‚‹)ã‚’å®Ÿè£…ã—ã¦ã„ããŸã„ã¨æ€ã„ã¾ã™ã€‚

![image1.png](/images/e4a31654b41a63/image1.png)

## å®£ä¼

macOSå‘ã‘ã®ãƒ¡ãƒ‹ãƒ¥ãƒ¼ãƒãƒ¼ã‚¢ãƒ—ãƒªã€ŒQuickShelfã€ã‚’å…¬é–‹ã—ã¦ã„ã‚‹ã®ã§ã€è‰¯ã‘ã‚Œã°ä½¿ã£ã¦ã¿ã¦ä¸‹ã•ã„ã€‚ãƒ¡ãƒ‹ãƒ¥ãƒ¼ãƒãƒ¼ä¸Šã§ç‰¹å®šã®ãƒ‡ã‚£ãƒ¬ã‚¯ãƒˆãƒªã‚’ä¿å­˜ã—ã¨ã„ã¦ã€ã„ã¤ã§ã‚‚ãã®ãƒ‡ã‚£ãƒ¬ã‚¯ãƒˆãƒªé…ä¸‹ã®ãƒ•ã‚¡ã‚¤ãƒ«ç­‰ã‚’Drag&Dropã§ãã‚‹ã‚¢ãƒ—ãƒªã«ãªã‚Šã¾ã™ã€‚äº‹å‹™ä½œæ¥­ãªã©ã§ã‚ˆããƒ•ã‚¡ã‚¤ãƒ«ã‚¢ãƒƒãƒ—ãƒ­ãƒ¼ãƒ‰ã™ã‚‹ç‚ºã«Finderã‚’æ¢ã—ã¦ã„ã‚‹æ–¹ã¯è©¦ã—ã¦ã¿ã¦ä¸‹ã•ã„ã€‚

https://quickshelf-app.slowlab.dev/

ä»Šå›ã¯ã“ã®ã‚¢ãƒ—ãƒªã«è‡ªå‹•ã‚¢ãƒƒãƒ—ãƒ‡ãƒ¼ãƒˆæ©Ÿèƒ½ã®å®Ÿè£…ã‚’è¡Œãªã£ã¦ã„ããŸã„ã¨æ€ã„ã¾ã™ã€‚

## å‰æ

- ç›´é…å¸ƒï¼ˆé App Storeï¼‰
- ç½²å: Developer IDï¼ˆHardened Runtime æœ‰åŠ¹ï¼‰ã§ã‚³ãƒ¼ãƒ‰ç½²åã—ã€å…¬è¨¼ï¼ˆnotarizeï¼‰ã—ã¦é…å¸ƒæ¸ˆã¿

# å®Ÿè£…æ–¹æ³•
å®Ÿè£…æ–¹æ³•ã¨ã—ã¦ã¯å¤§ããä»¥ä¸‹ã®2ã¤ãŒã‚ã‚‹æ§˜ã§ã™ã€‚ä»Šå›ã¯ç›´é…å¸ƒï¼ˆé App Storeï¼‰ã§è‡ªå‹•ã‚¢ãƒƒãƒ—ãƒ‡ãƒ¼ãƒˆæ©Ÿèƒ½ã‚’å®Ÿè£…ã™ã‚‹ã®ã§ã€ãƒ•ãƒ¬ãƒ¼ãƒ ãƒ¯ãƒ¼ã‚¯ **Sparkle** ã‚’ä½¿ã£ã¦å®Ÿè£…ã‚’é€²ã‚ã¦ã„ããŸã„ã¨æ€ã„ã¾ã™ã€‚

## 1. ãƒ•ãƒ¬ãƒ¼ãƒ ãƒ¯ãƒ¼ã‚¯ã‚’ä½¿ã† Sparkle

https://sparkle-project.org/

> macOS å‘ã‘å®šç•ªã®è‡ªå‹•ã‚¢ãƒƒãƒ—ãƒ‡ãƒ¼ãƒˆãƒ•ãƒ¬ãƒ¼ãƒ ãƒ¯ãƒ¼ã‚¯ã€‚ZIP/DMG ãªã©ã®é…å¸ƒã¨ã€ŒAppcastï¼ˆXMLï¼‰ã€ã§å·®åˆ†æ›´æ–°ã‚‚å¯èƒ½ã€‚EdDSA ç½²å + Appleã®ã‚³ãƒ¼ãƒ‰ç½²åã§æ¤œè¨¼ã€ã‚µãƒ³ãƒ‰ãƒœãƒƒã‚¯ã‚¹å¯¾å¿œã€‚SwiftPMã§å°å…¥å¯ã€‚

## 2. è‡ªå‰å®Ÿè£…ï¼ˆç‹¬è‡ª updater + pkg/zip é…å¸ƒï¼‰

> è‡ªã‚µãƒ¼ãƒã§ãƒãƒ¼ã‚¸ãƒ§ãƒ³ç…§ä¼š â†’ ãƒ€ã‚¦ãƒ³ãƒ­ãƒ¼ãƒ‰ â†’ ç½®æ›ãƒ»å†èµ·å‹•ã‚’è‡ªä½œã€‚
ãŸã ã—ç½²å/å…¬è¨¼ã€å·®åˆ†æ›´æ–°ã€å®‰å…¨ãªç½®æ›ã€ãƒ­ãƒ¼ãƒ«ãƒãƒƒã‚¯ç­‰ã‚’**å…¨éƒ¨è‡ªåˆ†ã§**æ‹…ã†å¿…è¦ãŒã‚ã‚Šã€å®Ÿå‹™ã§ã¯ Sparkle ã‚’ä½¿ã†æ–¹ãŒå®‰å…¨ãƒ»é«˜é€Ÿ

# Sparkle ã‚’ä½¿ã£ãŸå®Ÿè£…

ã¾ãšã¯ã‚»ãƒƒãƒˆã‚¢ãƒƒãƒ—ã‹ã‚‰é€²ã‚ã¦ã„ãã¾ã™ã€‚

## Basic Setup

https://sparkle-project.org/documentation/

ğŸ‘†ã“ã¡ã‚‰ã‚’å…ƒã«é€²ã‚ã¦è¡Œã“ã†ã¨æ€ã„ã¾ã™ã€‚

### å…¨ä½“ã®æµã‚Œ

1. **ãƒ—ãƒ­ã‚¸ã‚§ã‚¯ãƒˆã«Sparkleãƒ•ãƒ¬ãƒ¼ãƒ ãƒ¯ãƒ¼ã‚¯ã‚’è¿½åŠ **
2. **ç½²åéµï¼ˆEdDSA/ed25519ï¼‰ã®ä½œæˆ**
3. **appcast.xml ã®ç”Ÿæˆ**

### **1. ãƒ—ãƒ­ã‚¸ã‚§ã‚¯ãƒˆã«Sparkleãƒ•ãƒ¬ãƒ¼ãƒ ãƒ¯ãƒ¼ã‚¯ã‚’è¿½åŠ **

ã€ŒXcodeã€ > ã€ŒFileã€ > ã€ŒAdd Packages Dependenciesâ€¦ã€ã‹ã‚‰å³ä¸Šã®æ¤œç´¢çª“ã« `https://github.com/sparkle-project/Sparkle` ã‚’å…¥åŠ›ã—ã¾ã™ã€‚

![image2.png](/images/e4a31654b41a63/image2.png)

ã€ŒApp Packageã€ã§ãƒ•ãƒ¬ãƒ¼ãƒ ãƒ¯ãƒ¼ã‚¯ã‚’è¿½åŠ ã—ã¾ã™ã€‚

![image3.png](/images/e4a31654b41a63/image3.png)

ã€ŒAdd to Targetã€ã§Targetã®é¸æŠã‚‚è¨­å®šã—ã¨ãã¾ã™ã€‚

### 2. ç½²åéµï¼ˆEdDSA/ed25519ï¼‰ã®ä½œæˆ

`DerivedData/QuickShelf/SourcePackages/artifacts/sparkle/Sparkle/bin` (ã‚¢ãƒ—ãƒªåã®ç®‡æ‰€ã¯é©å®œå¤‰æ›´ã—ã¦ä¸‹ã•ã„)ã« `generate_keys` ãŒä½œæˆã•ã‚Œã¦ã„ã‚‹ã¨æ€ã†ã®ã§ã€ã“ã¡ã‚‰ã§ç½²åéµã®ä½œæˆã‚’è¡Œã„ã¾ã™ã€‚

```bash
$ ./generate_keys --account com.xxxx
Generating a new signing key. This may take a moment, depending on your machine.
A key has been generated and saved in your keychain. Add the `SUPublicEDKey` key to
the Info.plist of each app for which you intend to use Sparkle for distributing
updates. It should appear like this:

    <key>SUPublicEDKey</key>
    <string>xxxxxxxxxxxxxxxxxxxxxxxxxxx</string>
```

â€»ã‚¢ã‚«ã‚¦ãƒ³ãƒˆã¯ãƒ‡ãƒ•ã‚©ãƒ«ãƒˆã§ `ed25519` ã«ãªã‚‹ã¨ã®äº‹ãªã®ã§ `--acount` ã§æŒ‡å®šã—ã¦ã¾ã™

ä½œæˆãŒè¡Œã‚ã‚ŒãŸã‚‰è‡ªå‹•ã§KeyChainã«ã‚‚æ›¸ãè¾¼ã¾ã‚Œã¦ã„ã¾ã™ã€‚ã¾ãŸç§˜å¯†éµã‚’ã‚¨ã‚¯ã‚¹ãƒãƒ¼ãƒˆã—ãŸã‚Šã€ã‚¤ãƒ³ãƒãƒ¼ãƒˆã™ã‚‹ã«ã‚‚ `generate_keys` ã‚’ä½¿ç”¨ã—ã¾ã™ã€‚

```bash
# ã‚¨ã‚¯ã‚¹ãƒãƒ¼ãƒˆ
./generate_keys --account com.xxxx -x /path/to/exported_private_key

# ã‚¤ãƒ³ãƒãƒ¼ãƒˆ
./generate_keys --account com.xxxx -f /path/to/exported_private_key
```

æ¬¡ã«éµã‚’ç”Ÿæˆã•ã‚ŒãŸæ™‚ã«å‡ºåŠ›ã•ã‚ŒãŸå…¬é–‹éµğŸ‘‡ã‚’ `Info.plist` ã«è¿½è¨˜ã—ã¾ã™ã€‚

```bash
    <key>SUPublicEDKey</key>
    <string>xxxxxxxxxxxxxxxxxxxxxxxxxxx</string>
```

Xcode 12ä»¥é™ã¯ç‰©ç†çš„ãª Info.plist ã‚’ç½®ã‹ãªãã¦ã‚‚XcodeãŒãƒ“ãƒ«ãƒ‰æ™‚ã«ç”Ÿæˆã™ã‚‹ã®ã§ `Info.plist` ã¯ãªã„ã‹ã¨æ€ã„ã¾ã™ã€‚ãªã®ã§ã€ŒTargetã€>ã€ŒInfoã€ã§ã€Œ+ã€ã§é©å½“ã«Keyã‚’è¿½åŠ ã—ã€ãã®ã¾ã¾Keyã‚’ç·¨é›†ã—ã¦ã‚ã’ã¾ã™ã€‚

![image4.png](/images/e4a31654b41a63/image4.png)

ã™ã‚‹ã¨ `SUPublicEDKey` ãŒè¿½åŠ ã•ã‚ŒãŸ `Info.plist` ãŒä½œæˆã•ã‚Œã¾ã™ã€‚

### 3. appcast.xml ã®ç”Ÿæˆ

æ¬¡ã«ç¾åœ¨é…å¸ƒã—ã¦ã„ã‚‹æœ€æ–°ã®release (DMG / ZIP) ã‹ã‚‰ `appcast.xml` ã‚’ç”Ÿæˆã—ã¾ã™ã€‚

```bash
./generate_appcast /path/to/releases/
```

ã™ã‚‹ã¨ `/path/to/releases/appcast.xml` ãŒä½œæˆã•ã‚Œã¦ã„ã‚‹ã®ã§ `enclosure url` ãªã©å¿…è¦ãªé …ç›®ã‚’ä¿®æ­£ã—ã¦ã‚µãƒ¼ãƒãƒ¼ã«è¨­ç½®ã—ã¾ã™ã€‚

æ¬¡ã« `SUFeedURL` ã‚’ `Info.plist` ã«è¨­å®šã—ã¾ã™ã€‚å€¤ã¯å…ˆã»ã© `appcast.xml` ã‚’è¨­ç½®ã—ãŸURLã‚’è¨­å®šã™ã‚Œã°OKã§ã™ã€‚

```xml
 <key>SUFeedURL</key>
 <string>https://xxxxx/appcast.xml</string>
```

## ã‚µãƒ³ãƒ‰ãƒœãƒƒã‚¯ã‚¹ã‚¢ãƒ—ãƒªã®å ´åˆã®è¿½åŠ è¨­å®š

https://sparkle-project.org/documentation/sandboxing/

> Sparkle ãŒã‚µãƒ³ãƒ‰ãƒœãƒƒã‚¯ã‚¹ç’°å¢ƒã§æ©Ÿèƒ½ã™ã‚‹ã«ã¯ã€ã‚¢ãƒ—ãƒªã‚±ãƒ¼ã‚·ãƒ§ãƒ³ãŒ XPC ã‚µãƒ¼ãƒ“ã‚¹ã‚’å‘¼ã³å‡ºã—ã€ã‚¢ãƒ—ãƒªã‚±ãƒ¼ã‚·ãƒ§ãƒ³ã®æ¨©é™è¦ä»¶ãŒæº€ãŸã•ã‚Œã¦ã„ã‚‹ã“ã¨ã‚’ç¢ºèªã™ã‚‹å¿…è¦ãŒã‚ã‚Šã¾ã™ã€‚

ã“ã“ã§ç™»å ´ã—ãŸ `XPC ã‚µãƒ¼ãƒ“ã‚¹`ã¨ã¯?

https://developer.apple.com/documentation/xpc

> XPCã¯ã€åŸºæœ¬çš„ãªãƒ—ãƒ­ã‚»ã‚¹é–“é€šä¿¡ã®ãŸã‚ã®è»½é‡ãªãƒ¡ã‚«ãƒ‹ã‚ºãƒ ã‚’æä¾›ã—ã€ä½ãƒ¬ãƒ™ãƒ«ã®ãƒ—ãƒ­ã‚»ã‚¹é–“é€šä¿¡ãƒ¡ã‚«ãƒ‹ã‚ºãƒ ã«ã‚¢ã‚¯ã‚»ã‚¹ã—ã¾ã™

ãã®XPC ã‚µãƒ¼ãƒ“ã‚¹ã‚’Sparkleã§ã¯ä»¥ä¸‹ã®2ã¤ã‚’ä½¿ç”¨ã—ã¦ã„ã‚‹æ§˜ã§ã™ã€‚

- Installer.xpc (Sparkle 2.2 ã‚ˆã‚Šå‰ã® org.sparkle-project.InstallerLauncher.xpc)
  - ã‚¢ãƒ—ãƒªã‚±ãƒ¼ã‚·ãƒ§ãƒ³ã®ã‚µãƒ³ãƒ‰ãƒœãƒƒã‚¯ã‚¹å¤–ã§æ›´æ–°ãƒ—ãƒ­ã‚°ãƒ©ãƒ ã‚’ã‚¤ãƒ³ã‚¹ãƒˆãƒ¼ãƒ«ã§ãã‚‹ã‚ˆã†ã«ã™ã‚‹ã‚‚ã®
- Downloader.xpc (Sparkle 2.2 ã‚ˆã‚Šå‰ã® org.sparkle-project.Downloader.xpc)
  - ã‚¢ãƒ—ãƒªæœ¬ä½“ã« `Outgoing Connections` ã‚’ä»˜ä¸ã§ããªã„å ´åˆã«ä½¿ç”¨
    ![image5.png](/images/e4a31654b41a63/image5.png)

### Installer.xpc ã®è¨­å®š

`Info.plist` ã§ `SUEnableInstallerLauncherService = YES` ã‚’è¨­å®šã™ã‚‹

![image6.png](/images/e4a31654b41a63/image6.png)

`.entitlements`ãƒ•ã‚¡ã‚¤ãƒ«ã«ä»¥ä¸‹ã‚’è¿½åŠ ã™ã‚‹

```xml
<key>com.apple.security.temporary-exception.mach-lookup.global-name</key>
<array>
    <string>$(PRODUCT_BUNDLE_IDENTIFIER)-spks</string>
    <string>$(PRODUCT_BUNDLE_IDENTIFIER)-spki</string>
</array>
```

![image7.png](/images/e4a31654b41a63/image7.png)

### Downloader.xpcã®è¨­å®š

ã“ã¡ã‚‰ã§ã™ãŒã€ãƒ‰ã‚­ãƒ¥ãƒ¡ãƒ³ãƒˆã«

> ãƒ€ã‚¦ãƒ³ãƒ­ãƒ¼ãƒ€ãƒ¼ã‚µãƒ¼ãƒ“ã‚¹ã®ä½¿ç”¨ã«ã¯ã„ãã¤ã‹ã®æ¬ ç‚¹ãŒã‚ã‚Šã€è€ƒæ…®ã™ã¹ãç‚¹ãŒã‚ã‚Šã¾ã™

ã¨ãªã£ã¦ã„ã‚‹ã®ã§ã€ç´ ç›´ã«ã€ŒApp Sandboxã€>ã€ŒNetworkã€>ã€ŒOutgoing Connectionsã€ã«ãƒã‚§ãƒƒã‚¯å…¥ã‚Œã¦ã‚‚å•é¡Œãªã„å ´åˆã¯ãã¡ã‚‰ã§å¯¾å¿œã—ãŸæ–¹ãŒè‰¯ã„ã®ã‹ã‚‚ã—ã‚Œã¾ã›ã‚“ã€‚

ä»Šå›ã¯ãƒã‚§ãƒƒã‚¯ã‚’å…¥ã‚Œã¦å¯¾å¿œã™ã‚‹ã“ã¨ã«ã—ã¾ã—ãŸã€‚

# ã‚¢ãƒ—ãƒªã«çµ„ã¿è¾¼ã‚€

æ¬¡ã«ãƒ¡ãƒ‹ãƒ¥ãƒ¼å†…ã«ã€ŒCheck for Updatesâ€¦ã€ã‚’è¨­ç½®ã—ã‚¯ãƒªãƒƒã‚¯ã—ãŸã‚‰ã‚¢ãƒƒãƒ—ãƒ‡ãƒ¼ãƒˆã®ç¢ºèªã‚’è¡Œã†ã‚ˆã†ã«ã—ãŸã„ã¨æ€ã„ã¾ã™ã€‚

ä»Šå›ã¯ `Support/Updater` ãƒ‡ã‚£ãƒ¬ã‚¯ãƒˆãƒªã‚’æ–°è¦ã«ä½œæˆã—ãã®ä¸­ã«ã‚¢ãƒƒãƒ—ãƒ‡ãƒ¼ãƒˆãƒã‚§ãƒƒã‚¯ã®å®Ÿè£…ã‚’è¿½åŠ ã™ã‚‹å½¢ã§é€²ã‚ã¦ã„ããŸã„ã¨æ€ã„ã¾ã™ã€‚

ã¾ãšã¯ `Sparkle` ã® `SPUStandardUpdaterController` ã‚’æ‰±ã† `AppUpdater` ã‚¯ãƒ©ã‚¹ã‚’ä½œæˆã—ã¾ã™ã€‚

- Support/Updater/AppUpdater.swift

```swift
import Sparkle

final class AppUpdater {
    private let updaterController = SPUStandardUpdaterController(
        startingUpdater: true, updaterDelegate: nil, userDriverDelegate: nil
    )

    func checkForUpdates() {
        updaterController.updater.checkForUpdates()
    }
}
```

æ¬¡ã« `QuickShelfApp` ã« `NSMenuItem` ã‚’è¿½åŠ ã— `AppDelegate` çµŒç”±ã§å…ˆã»ã©ä½œæˆã—ãŸ `AppUpdater` ã®ãƒ¡ã‚½ãƒƒãƒ‰ã‚’å‘¼ã¶æ§˜ã«ã—ã¾ã™ã€‚

- QuickShelfApp.swift

```swift
private func popupContextMenu(for item: NSStatusItem) {
  // ...
  let updaterItem = NSMenuItem(
      title: "Check for Updatesâ€¦",
      action: #selector(AppDelegate.checkForUpdates(_:)),
      keyEquivalent: ""
  )
  updaterItem.target = AppDelegate.shared
  menu.addItem(updaterItem)
  menu.addItem(.separator())
  // ...
}

class AppDelegate: NSObject {
    static let shared = AppDelegate()
    // ...

    private let updater = AppUpdater()

    @objc func checkForUpdates(_ sender: Any?) {
        updater.checkForUpdates()
    }
    // ...
}
```

ã“ã“ã¾ã§ã§å®Ÿè¡Œã—ã¦ã¾ã™ã€‚å®Ÿè¡Œã—ã¦ãƒ¡ãƒ‹ãƒ¥ã®ã€ŒCheck for Updatesâ€¦ã€ã‚’é¸æŠã™ã‚‹ã¨ã€

![image8.png](/images/e4a31654b41a63/image8.png =400x)

ç¾åœ¨ã¯ã‚¢ãƒƒãƒ—ãƒ‡ãƒ¼ãƒˆãŒç„¡ã„ç‚ºã€ä»¥ä¸‹ã®æ§˜ãªãƒ€ã‚¤ã‚¢ãƒ­ã‚°ãŒè¡¨ç¤ºã•ã‚Œã‚‹ã‹ã¨æ€ã„ã¾ã™ã€‚

![image9.png](/images/e4a31654b41a63/image9.png =400x)

### ã‚¢ãƒƒãƒ—ãƒ‡ãƒ¼ãƒˆãƒã‚§ãƒƒã‚¯ä¸­ã«ä»¥ä¸‹ã®WarningãŒå‡ºã‚‹

å®Ÿè¡Œã™ã‚‹ã¨ã‚³ãƒ³ã‚½ãƒ¼ãƒ«ãƒ­ã‚°ã«ä»¥ä¸‹ã®WarningãŒè¡¨ç¤ºã•ã‚Œã‚‹å ´åˆãŒã‚ã‚‹ã‹ã¨æ€ã„ã¾ã™ã€‚

```text
Warning: Background app automatically schedules for update checks but does not implement gentle reminders. As a result, users may not take notice to update alerts that show up in the background. Please visit https://sparkle-project.org/documentation/gentle-reminders for more information. This warning will only be logged once.
```

> gentle reminders æ©Ÿèƒ½ãŒå®Ÿè£…ã•ã‚Œã¦ã„ã¾ã›ã‚“ã€‚ãã®ãŸã‚ã€ãƒ¦ãƒ¼ã‚¶ãƒ¼ã¯ãƒãƒƒã‚¯ã‚°ãƒ©ã‚¦ãƒ³ãƒ‰ã«è¡¨ç¤ºã•ã‚Œã‚‹æ›´æ–°é€šçŸ¥ã«æ°—ã¥ã‹ãªã„å¯èƒ½æ€§ãŒã‚ã‚Šã¾ã™

ã“ã“ã§ã„ã† `gentle reminders` æ©Ÿèƒ½ã¨ã¯ä¸€ä½“ä½•ã§ã—ã‚‡ã†ã‹â€¦? ãƒ­ã‚°ã«è¡¨ç¤ºã•ã‚Œã¦ã„ãŸãƒ‰ã‚­ãƒ¥ãƒ¡ãƒ³ãƒˆã‚’èª­ã‚“ã§ã¿ã¾ã™ğŸ‘‡

https://sparkle-project.org/documentation/gentle-reminders/

> ã€Œã‚¢ãƒƒãƒ—ãƒ‡ãƒ¼ãƒˆã‚’è¦‹ã¤ã‘ã¦ã‚‚å³ãƒ¢ãƒ¼ãƒ€ãƒ«ã‚’å‰é¢ã«å‡ºã•ãšã€**ã‚¢ãƒ—ãƒªå´ã®â€œã•ã‚Šã’ãªã„åˆå›³â€ã§æ°—ã¥ã‹ã›ã‚‹**ã€ãŸã‚ã®ä»•çµ„ã¿ã€‚ã¨ãã« ãƒãƒƒã‚°ã‚°ãƒ©ã‚¦ãƒ³ãƒ‰ã®ã‚¢ãƒ—ãƒª(Dockã«è¡¨ç¤ºã•ã‚Œãªã„)ã§ã€ä»–ã‚¢ãƒ—ãƒªã®ä½œæ¥­ã‚’é‚ªé­”ã›ãšã«æ›´æ–°ã¸èª˜å°ã§ãã‚‹

ãƒãƒƒã‚¯ã‚°ãƒ©ã‚¦ãƒ³ãƒ‰ã®ã‚¢ãƒ—ãƒªã§æœªå®Ÿè£…ã®å ´åˆã€è­¦å‘Šã®ãƒ­ã‚°ãŒå‡ºã‚‹ã®ã‹ã‚‚ã—ã‚Œã¾ã›ã‚“ã€‚ä»Šå›ã¯ [UserNotifications](https://developer.apple.com/documentation/usernotifications) ã‚’ä½¿ã£ã¦ã€Œã•ã‚Šã’ãªã„åˆå›³ã€ã‚’å®Ÿè£…ã—ã‚ˆã†ã¨æ€ã„ã¾ã™ã€‚

æ–°è¦ã«ä»¥ä¸‹å†…å®¹ã‚’å®Ÿè£…ã—ã¾ã™ã€‚

- Support/Updater/NotificationBridge.swift

```swift
import UserNotifications

final class NotificationBridge: NSObject, UNUserNotificationCenterDelegate {
    func configure() {
        UNUserNotificationCenter.current().delegate = self
    }
    func requestAuth() {
        // çµæœã®ãƒãƒ³ãƒ‰ãƒªãƒ³ã‚°ã¯ä»Šå›ã¯ã‚¹ã‚­ãƒƒãƒ—
        UNUserNotificationCenter.current()
            .requestAuthorization(options: [.badge, .alert, .sound]) { _, _ in }
    }
    func postGentleUpdate(version: String) {
        let content = UNMutableNotificationContent()
        content.title = "Update available"
        content.body  = "Version \(version) is now available"
        UNUserNotificationCenter.current().add(
            UNNotificationRequest(identifier: "QS_UPDATE", content: content, trigger: nil)
        )
    }
    func clearGentleUpdate() {
        UNUserNotificationCenter.current().removeDeliveredNotifications(withIdentifiers: ["QS_UPDATE"])
    }
}
```

- Support/Updater/UpdaterDelegate.swift

```swift
import Sparkle

final class UpdaterDelegate: NSObject, SPUStandardUserDriverDelegate, SPUUpdaterDelegate {
    weak var updaterController: SPUStandardUpdaterController?
    private let notifier: NotificationBridge

    init(notifier: NotificationBridge) {
        self.notifier = notifier
    }

    // ã“ã‚Œã‚’ true ã«ã™ã‚‹ã¨ Gentle Reminders ã‚’ä½¿ã†å®£è¨€ã«ãªã‚‹ï¼ˆå¿…é ˆï¼‰
    var supportsGentleScheduledUpdateReminders: Bool { true }

    func standardUserDriverShouldHandleShowingScheduledUpdate(_ update: SUAppcastItem,
                                                             andInImmediateFocus immediateFocus: Bool) -> Bool {
        // Sparkleã«æ–°ã—ã„ã‚¹ã‚±ã‚¸ãƒ¥ãƒ¼ãƒ«ã•ã‚ŒãŸæ›´æ–°ã®è¡¨ç¤ºã®å‡¦ç†ã‚’ä»»ã›ã‚‹ã‹?
        // ä»»ã›ã‚‹å ´åˆ immediateFocus ã‚’è¿”ã™
        return immediateFocus
    }

    // Sparkle ãŒå‰é¢ã«å‡ºã•ãªã„ï¼ˆ= gentle ã«çŸ¥ã‚‰ã›ã‚‹ï¼‰ã¨ãã«å‘¼ã°ã‚Œã‚‹
    func standardUserDriverWillHandleShowingUpdate(_ handleShowingUpdate: Bool,
                                                   forUpdate update: SUAppcastItem,
                                                   state: SPUUserUpdateState) {
        guard !handleShowingUpdate else { return } // ãƒ¦ãƒ¼ã‚¶ãƒ¼ç™ºç«ãªã©ã¯ Sparkle ã«ä»»ã›ã‚‹
        // ãƒ¦ãƒ¼ã‚¶ãƒ¼ç™ºç«ã§ãªã„å ´åˆã¯é€šçŸ¥ã§ãŠçŸ¥ã‚‰ã›ã™ã‚‹
        if !state.userInitiated { notifier.postGentleUpdate(version: update.displayVersionString) }
    }
    // ãƒ¦ãƒ¼ã‚¶ãƒ¼ãŒã‚¢ãƒƒãƒ—ãƒ‡ãƒ¼ãƒˆã«æ³¨æ„ã‚’å‘ã‘ãŸã‚‰ã€é€šçŸ¥ã‚’ã‚¯ãƒªã‚¢
    func standardUserDriverDidReceiveUserAttention(forUpdate update: SUAppcastItem) {
        notifier.clearGentleUpdate()
    }
    // ã‚»ãƒƒã‚·ãƒ§ãƒ³çµ‚äº†æ™‚ï¼ˆã‚¹ã‚­ãƒƒãƒ—/å®Œäº†/ã‚¨ãƒ©ãƒ¼ï¼‰
    func standardUserDriverWillFinishUpdateSession() {
        notifier.clearGentleUpdate()
    }
    // Sparkle ãŒæ¬¡å›ã®å®šæœŸãƒã‚§ãƒƒã‚¯ã‚’ã‚¹ã‚±ã‚¸ãƒ¥ãƒ¼ãƒ«ã™ã‚‹æ™‚ã«é€šçŸ¥è¨±å¯ã‚’è¦æ±‚
    func updater(_ updater: SPUUpdater, willScheduleUpdateCheckAfterDelay delay: TimeInterval) {
        notifier.requestAuth()
    }
}
```

- Support/Updater/AppUpdater.swift

```swift
import Sparkle

final class AppUpdater {
    // å…ˆã»ã©ã® NotificationBridge ã‚’ä¿æŒ
    private let notifier = NotificationBridge()
    // delegate ã‚’ SPUStandardUpdaterControlleråˆæœŸåŒ–æ™‚ã«æ¸¡ã™
    private lazy var delegate = UpdaterDelegate(notifier: notifier)
    private lazy var updaterController = SPUStandardUpdaterController(
        startingUpdater: true, updaterDelegate: delegate, userDriverDelegate: delegate
    )

    init() {
        // updaterController ã‚’æ¸¡ã•ãªã„ã¨å‹•ã‹ãªã„
        delegate.updaterController = updaterController
        notifier.configure()
    }

    func checkForUpdates() {
        updaterController.updater.checkForUpdates()
    }
}
```

å®Ÿè£…ã§ããŸã®ã§ãƒ†ã‚¹ãƒˆã—ã¦ã¿ãŸã„ã¨æ€ã„ã¾ã™ã€‚ä»Šå›ã¯ã¾ã é‹ç”¨ãŒå§‹ã¾ã£ã¦ãªã„å‰æãªã®ã§ã€ç›´æ¥**appcast.xml** ã®ãƒãƒ¼ã‚¸ãƒ§ãƒ³ã‚’ã‚ã’ã¦ã‚µãƒ¼ãƒãƒ¼ã«ã‚¢ãƒƒãƒ—ãƒ­ãƒ¼ãƒ‰ã—ã¦ç¢ºèªã—ã¦ã¿ã¾ã™ã€‚

`defaults delete [ã‚¢ãƒ—ãƒªbundleId] SULastCheckTime`

ğŸ‘†ã‚’å®Ÿæ–½ã™ã‚‹ã¨ã‚¢ãƒ—ãƒªèµ·å‹•æ™‚ã«ã‚¢ãƒƒãƒ—ãƒ‡ãƒ¼ãƒˆãƒã‚§ãƒƒã‚¯ãŒèµ°ã‚Šã¾ã™ã€‚ãƒã‚§ãƒƒã‚¯ãŒèµ°ã‚‹ã¨ä»¥ä¸‹ã®ã‚ˆã†ãªãƒ€ã‚¤ã‚¢ãƒ­ã‚°ãŒè¡¨ç¤ºã•ã‚Œã¾ã™ã€‚

![image10.png](/images/e4a31654b41a63/image10.png)

ã¡ãªã¿ã«ã“ã®æ™‚é€šçŸ¥ã¯è¡¨ç¤ºã•ã‚Œãªã„ã§ã™ã€‚ğŸ‘†ã®ãƒ€ã‚¤ã‚¢ãƒ­ã‚°ãŒã€Œãƒ¦ãƒ¼ã‚¶ãƒ¼ç™ºç«ã€ã¨ãªã‚ŠUpdaterDelegate.swiftã§é€šçŸ¥ã‚’ã‚¹ã‚­ãƒƒãƒ—ã—ã¦ã„ã‚‹ç‚ºã§ã™ã€‚ãƒ†ã‚¹ãƒˆã®å ´åˆã©ã†ã—ã¦ã‚‚å…ˆã«ãƒ€ã‚¤ã‚¢ãƒ­ã‚°ãŒèµ°ã‚‹ç‚ºã€é€šçŸ¥ã®ãƒ†ã‚¹ãƒˆã‚’è¡Œã†å ´åˆUpdaterDelegate.swiftã§ã‚¹ã‚­ãƒƒãƒ—ã—ã¦ã„ã‚‹ç®‡æ‰€ã‚’ã‚³ãƒ¡ãƒ³ãƒˆã‚¢ã‚¦ãƒˆã—ã¦ç¢ºèªãŒå¿…è¦ã§ã—ãŸã€‚

(ã‚³ãƒ¡ãƒ³ãƒˆã‚¢ã‚¦ãƒˆã—ãªãã¦ã‚‚ç¢ºèªã§ãã‚‹æ–¹æ³•ã”å­˜çŸ¥ã®æ–¹æ•™ãˆã¦é ‚ã‘ã‚‹ã¨åŠ©ã‹ã‚Šã¾ã™ ğŸ™‡)

# ã¾ã¨ã‚

ä»Šå›ã¯macOSã‚¢ãƒ—ãƒªã§è¦‹ã‹ã‘ã‚‹è‡ªå‹•ã‚¢ãƒƒãƒ—ãƒ‡ãƒ¼ãƒˆæ©Ÿèƒ½ã‚’å®Ÿè£…ã—ã¦ã¿ã¾ã—ãŸã€‚Sparkleã‚’ä½¿ã†ã¨äº‹å‰æº–å‚™ã¯å°‘ã—æ‰‹é–“ã§ã™ãŒã€
ä¸€åº¦å®Ÿè£…ã—ã¦ã—ã¾ãˆã°ç°¡å˜ã«è‡ªå‹•ã‚¢ãƒƒãƒ—ãƒ‡ãƒ¼ãƒˆæ©Ÿèƒ½ã‚’å®Ÿè£…ã§ãã‚‹ã®ã§ä¾¿åˆ©ã ãªã¨æ„Ÿã˜ã¾ã—ãŸã€‚

# å‚è€ƒURL

https://zenn.dev/usagimaru/scraps/276953d38b5222

https://yutokun.com/knowledges/unity-xcode-macos-tips/index.html

https://medium.com/@borto_ale/integrating-sparkle-updater-in-swiftui-for-macos-82ae4e0b4ac6