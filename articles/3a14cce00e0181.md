---
title: "ã€Flutterã€‘hiveã®å¾Œç¶™Isarã‚’è©¦ã—ã¦ã¿ã‚‹"
emoji: "ğŸ“±"
type: "tech"
topics:
  - "flutter"
  - "isar"
  - "dart"
  - "riverpod"
published: true
published_at: "2022-05-04 00:59"
---

# [isar | Dart Package](https://pub.dev/packages/isar)
[hive](https://docs.hivedb.dev/)ã®v2ç³»ã¨ã—ã¦åˆ¥ãƒ—ãƒ­ã‚¸ã‚§ã‚¯ãƒˆã§é€²ã‚ã‚‰ã‚Œã¦ã„ã‚‹ã€isarã‚’å®Ÿéš›ã«ã‚¢ãƒ—ãƒªã«çµ„ã¿è¾¼ã‚“ã§ä½¿ã†æƒ³å®šã§è‰²ã€…è©¦ã—ã¦ã¿ãŸã„ã¨æ€ã„ã¾ã™ã€‚

## ç’°å¢ƒã‚»ãƒƒãƒˆã‚¢ãƒƒãƒ—

`pubspec.yaml` ã«ä»¥ä¸‹ã‚’è¿½åŠ 
```yml
dependencies:
  isar: 2.2.1
  isar_flutter_libs: 2.2.1 # contains the binaries

dev_dependencies:
  isar_generator: 2.2.1
  build_runner: any
```

## è©¦ã—ã« `user` ãƒ†ãƒ¼ãƒ–ãƒ«ã‚’ä½œæˆã—ã¦ã¿ã‚‹

```dart
import 'package:isar/isar.dart';

part 'user.g.dart';

@Collection()
class User {
  @Id()
  int? id;

  late String name;

  String? avatarUri;

  late DateTime createdAt;

  late DateTime updatedAt;
}
```

`build_runner` å®Ÿè¡Œ
```sh
$ flutter pub run build_runner build
```
`user.g.dart` ãŒç”Ÿæˆã•ã‚Œã¦ã„ã‚Œã°OKã§ã™ã€‚

## ã‚¹ãƒ—ãƒ©ãƒƒã‚·ãƒ¥ç”»é¢ä¸­ã«isaråˆæœŸåŒ–ã‚’è¡Œã†æƒ³å®šã§è©¦ã—ã¦ã¿ã‚‹
å®Ÿéš›ã«isaråˆæœŸåŒ–ã™ã‚‹å ´é¢ã‚’æƒ³å®šã—ã¦ã€ä»Šå›ã¯ã‚¹ãƒ—ãƒ©ãƒƒã‚·ãƒ¥ç”»é¢è¡¨ç¤ºä¸­ã«åˆæœŸåŒ–ã‚’å®Ÿæ–½ã—ã¦ã¿ãŸã„ã¨æ€ã„ã¾ã™ã€‚
ã¾ãšã¯ã€[flutter_native_splash](https://pub.dev/packages/flutter_native_splash) ã¨ [path_provider](https://pub.dev/packages/path_provider) ãƒ‘ãƒƒã‚±ãƒ¼ã‚¸ã‚’è¿½åŠ ã—ã¾ã™ã€‚

```yml
dependencies:
  flutter_native_splash: ^2.1.6
  path_provider: ^2.0.9
```
é©å½“ãªã‚¢ã‚¤ã‚³ãƒ³ç”¨æ„ã—ã¦ `pubspec.yaml` ã«ä»¥ä¸‹ã‚’è¿½åŠ ã—ã¾ã™ã€‚

```yml
flutter_native_splash:
  color: '#ffffff'
  image: 'assets/images/splash.png'
  fullscreen: true
```
â€» ä»Šå›ã¯Android12å¯¾å¿œãªã©ç´°ã‹ã„æ‰€ã¯çœç•¥ã—ã¦ã¾ã™

`flutter pub run flutter_native_splash:create`  ã‚³ãƒãƒ³ãƒ‰å®Ÿæ–½ã—ã¦splashç”»é¢ã‚’ä½œæˆã€‚
[ver 2.0.3ä»¥é™](https://pub.dev/packages/flutter_native_splash/versions/2.0.3#3-set-up-app-initialization-optional)ã‹ã‚‰ `FlutterNativeSplash.remove()` å‘¼ã¶ã¾ã§splashç”»é¢ã‚’è¡¨ç¤ºã—ã¦ãã‚Œã‚‹ã¿ãŸã„ãªã®ã§ã€ãã¡ã‚‰ã‚’ä½¿ã£ã¦isarã®åˆæœŸåŒ–ã‚’å®Ÿè£…ã—ã¦ã¿ãŸã„ã¨æ€ã„ã¾ã™ã€‚

```dart: main.dart
import 'package:flutter_native_splash/flutter_native_splash.dart';

void main() {
  WidgetsBinding widgetsBinding = WidgetsFlutterBinding.ensureInitialized();
  FlutterNativeSplash.preserve(widgetsBinding: widgetsBinding);
  runApp(const MyApp());
}
```
`MyApp` å†…ã§åˆæœŸåŒ– + ã‚¹ãƒ—ãƒ©ãƒƒã‚·ãƒ¥ç”»é¢ã‚’éè¡¨ç¤ºã«ã™ã‚‹å‡¦ç†ã‚’è¿½åŠ ã—ã¾ã™ã€‚

```dart
import 'package:isar/isar.dart';
import 'package:path_provider/path_provider.dart';
import 'package:flutter_native_splash/flutter_native_splash.dart';

late Isar isar;

class MyApp extends StatelessWidget {
 const MyApp({Key? key}) : super(key: key);

 Future<void> initialize() async {
   final dir = await getApplicationSupportDirectory();

   isar = await Isar.open(
       schemas: [UserSchema],
       directory: dir.path,
       inspector: true);
   FlutterNativeSplash.remove(); // â† ã‚¹ãƒ—ãƒ©ãƒƒã‚·ãƒ¥ã‚’éè¡¨ç¤ºã«ã™ã‚‹
 }

 @override
 Widget build(BuildContext context) {
   return FutureBuilder(
       future: initialize(),
       builder: (BuildContext context, AsyncSnapshot<void> snapshot) {
         if (snapshot.connectionState == ConnectionState.waiting) {
           return const Center(child: CircularProgressIndicator());
         }
         return MaterialApp(
           title: 'Flutter Demo',
           theme: ThemeData(
             primarySwatch: Colors.blue,
           ),
           home: const MyHomePage(title: 'Flutter Demo Home Page'),
         );
       });
 }
}
```
ã“ã‚Œã§ã‚¹ãƒ—ãƒ©ãƒƒã‚·ãƒ¥ç”»é¢å¾Œã«ã¯ `isar` ãŒä½¿ãˆã‚‹çŠ¶æ…‹ã«ãªã£ã¦ã„ã¾ã™ã€‚

## Riverpodã¨çµ„ã¿åˆã‚ã›ã¦ä½¿ã£ã¦ã¿ã‚‹
å®Ÿéš›ã«ã‚ã‚Šãã†ãª [Riverpod](https://riverpod.dev/ja/) ã¨çµ„ã¿åˆã‚ã›ã¦ä½¿ã†æƒ³å®šã§é€²ã‚ã¦ã„ããŸã„ã¨æ€ã„ã¾ã™ã€‚

ä»Šå›ã¯å®Ÿéš›ã«isarã‚’ä½¿ç”¨ã™ã‚‹ `user_service.dart` ã¨åˆ©ç”¨ã™ã‚‹ `user_repository.dart` ã‚’ä½œæˆã—ã¾ã™ã€‚

- user_service.dart
    - Riverpodã®familyã‚’ä½¿ç”¨ã—ã¦ã€å¤–éƒ¨ã‹ã‚‰isarã®ã‚¤ãƒ³ã‚¹ã‚¿ãƒ³ã‚¹ã‚’DIã§ãã‚‹æ§˜ã«ã—ã¦ã¾ã™

```dart
import 'package:hooks_riverpod/hooks_riverpod.dart';
import 'package:isar/isar.dart';
import 'package:xxxx/repositories/entities/user.dart';

final ProviderFamily<UserService, Isar> userServiceProvider =
    Provider.family<UserService, Isar>((_, isar) => UserService(isar: isar));

class UserService {
  UserService({required this.isar});

  final Isar isar;

  Future<User?> find() async {
    return isar.users.where().findFirst(); // 1ãƒ¦ãƒ¼ã‚¶ãƒ¼ã—ã‹ç™»éŒ²ã—ãªã„æƒ³å®š
  }

  Future<int> add({required String name, String? avatarUri}) async {
    final user = User()
      ..name = name
      ..avatarUri = avatarUri
      ..createdAt = DateTime.now()
      ..updatedAt = DateTime.now();
    return isar.writeTxn((isar) => isar.users.put(user));
  }
}
```

- user_repository.dart
    - user_serviceã«æ¸¡ã™isarã¯ã‚¹ãƒ—ãƒ©ãƒƒã‚·ãƒ¥ç”»é¢ä¸­ã«åˆæœŸåŒ–ã—ãŸã‚‚ã®ã‚’æ¸¡ã—ã¦ã„ã¾ã™

```dart
import 'package:hooks_riverpod/hooks_riverpod.dart';
import 'package:xxxx/app.dart';
import 'package:xxxx/repositories/entities/user.dart';
import 'package:xxxx/repositories/services/db/user_service.dart';

final Provider<UserRepository> userRepositoryProvider =
    Provider<UserRepository>(
        (ref) => UserRepository(service: ref.watch(userServiceProvider(isar))));

class UserRepository {
  UserRepository({required this.service});

  final UserService service;

  Future<User?> find() => service.find();

  // ãƒ¦ãƒ¼ã‚¶ãƒ¼æœªç™»éŒ²ã®å ´åˆãƒ¦ãƒ¼ã‚¶ãƒ¼ä½œæˆ
  Future<void> initUser() async {
    final user = await find();
    if (user == null) {
      await service.add(name: 'anonymous');
    }
  }
}
```
ã‚ã¨ã¯ `ref.watch(userRepositoryProvider)` ã§ä½¿ã£ã¦é€²ã‚ã¦ã„ã‘ã°è‰¯ã•ãã†ã‹ã¨æ€ã„ã¾ã™ã€‚

## Isar Inspector ã‚’ä½¿ã£ã¦ã¿ã‚‹
[isar/README.md at main Â· isar/isar](https://github.com/isar/isar/blob/main/packages/isar_inspector/README.md)

å®Ÿéš›ã®ãƒ‡ãƒ¼ã‚¿ã‚’å‚ç…§ã§ãã‚‹ Isar Inspectorã‚’ä½¿ã£ã¦ã¿ãŸã„ã¨æ€ã„ã¾ã™ã€‚

ã¾ãšã¯ [ãƒªãƒªãƒ¼ã‚¹ãƒšãƒ¼ã‚¸](https://github.com/isar/isar/releases)ã‹ã‚‰ `Isar.Inspector.zip` ã‚’ãƒ€ã‚¦ãƒ³ãƒ­ãƒ¼ãƒ‰ã—ã¦ãã¾ã™ã€‚

`Isar.open` ã™ã‚‹éš›ã« **`inspector: true`** ã®ãƒ‘ãƒ©ãƒ¡ãƒ¼ã‚¿ãŒå¿…è¦ã¨ã®äº‹ãªã®ã§ `inspector: true` ã‚’è¿½åŠ ã—èµ·å‹•ã™ã‚‹ã¨ã‚³ãƒ³ã‚½ãƒ¼ãƒ«ã«
ä»¥ä¸‹ã®æ§˜ãªãƒ¡ãƒƒã‚»ãƒ¼ã‚¸ãŒè¡¨ç¤ºã•ã‚Œã‚‹ã‚ˆã†ã«ãªã‚Šã¾ã™ã€‚

![](https://storage.googleapis.com/zenn-user-upload/5cbf7f552ead-20220504.png)

æŒ‡å®šã•ã‚ŒãŸURLã‚’ Isar Inspectorã«è¨­å®šã—ã¦ã‚„ã‚‹ã¨è¦‹ã‚Œã‚‹ã‚ˆã†ã«ãªã‚Šã¾ã™ã€‚
â†“ Isar Inspectorã‚’èµ·å‹•ã—ãŸæ§˜å­

![](https://storage.googleapis.com/zenn-user-upload/5be79c7ad388-20220504.png)


# ãƒãƒƒãƒ‰ãƒã‚¦ãƒã‚¦
`build_runner` å®Ÿè¡Œæ™‚ã«ä»¥ä¸‹ã®ã‚¨ãƒ©ãƒ¼ãŒç™ºç”Ÿã™ã‚‹ã€‚
```
line 1, column 22 of package:xxxx/user.dart: Could not resolve annotation for `class User`.
  â•·
1 â”‚ @Collection()
  â”‚ ^^^^^^^^^^^^^
  â•µ
```
å…¬å¼ã®ã‚µãƒ³ãƒ—ãƒ«ã«ã¯ç„¡ã„ `import 'package:isar/isar.dart';` ã‚’å…ˆé ­ã«è¿½è¨˜

# å‚è€ƒURL
- [Flutterã§æ—¥è¨˜ã‚¢ãƒ—ãƒªã‚’ä½œã‚ã†](https://zenn.dev/ken1flan/scraps/e31ea62bff0e40)
- [ã€Flutterã€‘åˆæœŸåŒ–ãŒçµ‚ã‚ã‚‹ã¾ã§ã‚¹ãƒ—ãƒ©ãƒƒã‚·ãƒ¥ç”»é¢ã‚’è¡¨ç¤ºã—ãŸã„ã€flutter_native_splashã€‘](https://zenn.dev/susatthi/articles/20220409-052221-flutter-native-splash-setup)
- [ã€Flutterã€‘ã‚³ãƒãƒ³ãƒ‰ä¸€ç™ºã§ã‚¹ãƒ—ãƒ©ãƒƒã‚·ãƒ¥ç”»é¢ã‚’å®Ÿè£…ã™ã‚‹ã€flutter_native_splashã€‘](https://zenn.dev/susatthi/articles/20220406-061305-flutter-native-splash)



