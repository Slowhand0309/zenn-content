---
title: "ã€Flutterã€‘Isarã§åˆæœŸãƒ‡ãƒ¼ã‚¿æŠ•å…¥ã‚’è©¦ã™"
emoji: "ğŸ“²"
type: "tech"
topics:
  - "flutter"
  - "dart"
  - "isar"
published: true
published_at: "2022-05-10 05:21"
---

# ã‚„ã‚ŠãŸã„äº‹
ã‚¢ãƒ—ãƒªåˆå›èµ·å‹•æ™‚ã«ã€å¿…è¦ãªåˆæœŸãƒ‡ãƒ¼ã‚¿ãªã©ã‚’äº‹å‰ã«ç™»éŒ²ã—ã¦ãŠããŸã„!
â€» APIçµŒç”±ãªã©ã§ã¯ãªãã€ã‚¢ãƒ—ãƒªå†…ã«åˆæœŸãƒ‡ãƒ¼ã‚¿ç”¨ã®jsonãƒ•ã‚¡ã‚¤ãƒ«ã‚’ç”¨æ„ã—ã¦ãƒ‡ãƒ¼ã‚¿æŠ•å…¥ã™ã‚‹æƒ³å®šã§ã™

##  è©¦ã—ãŸæ–¹æ³•
[isar/samples: Sample apps using Isar](https://github.com/isar/samples)
â†‘ã§ã€åˆæœŸãƒ‡ãƒ¼ã‚¿ãŒç„¡ã„å ´åˆã€ `assets/quotes.json` ã‹ã‚‰èª­è¾¼ã‚“ã§ç™»éŒ²ã‚’è¡Œãªã£ã¦ã„ãŸã®ã§ã€ã“ã‚Œã«ãªã‚‰ã£ã¦é€²ã‚ã¦ã¿ãŸã„ã¨æ€ã„ã¾ã™ã€‚

##  ç’°å¢ƒæ§‹ç¯‰
ä»Šå›ã¯ fvm ã‚’ä½¿ç”¨ã—ä»¥ä¸‹ã®ç’°å¢ƒã§å®Ÿæ–½ã—ã¾ã™ã€‚
```
macOS Monterey ãƒãƒ¼ã‚¸ãƒ§ãƒ³12.1 Apple M1
iOS15.0 iPhone 13 ã‚·ãƒ¥ãƒŸãƒ¬ãƒ¼ã‚¿
Flutter SDK version: 2.10.3
Dart SDK version: 2.16.1
```

ã¾ãšã¯ç©ºã®Flutterãƒ—ãƒ­ã‚¸ã‚§ã‚¯ãƒˆã‚’ä½œæˆã—ã€ä»¥ä¸‹isaré–¢é€£ã®ãƒ‘ãƒƒã‚±ãƒ¼ã‚¸ã‚’è¿½åŠ ã—ã¾ã™ã€‚
```yml
dependencies:
  isar: 2.2.1
  isar_flutter_libs: 2.2.1 # contains the binaries
  path_provider: ^2.0.9

dev_dependencies:
  isar_generator: 2.2.1
  build_runner: any
```

## Spotã‚¹ã‚­ãƒ¼ãƒä½œæˆ
ä»Šå›ã¯â†“ã®Spotã‚¹ã‚­ãƒ¼ãƒã‚’ä½œæˆã—ã€Spotã®åˆæœŸãƒ‡ãƒ¼ã‚¿ã‚’ç™»éŒ²ã—ã¦ã„ãã¾ã™ã€‚
(ã€Œäº‹å‰ã«ä¸–ç•Œä¸­ã®æœ‰åãªã‚¹ãƒãƒƒãƒˆã‚’ç™»éŒ²ã—ã¦ãŠãå¿…è¦ãŒã‚ã‚‹ã€ ã¨ã„ã£ãŸã€ã‚ã‚Šãã†(?)ãªå‰æã§é€²ã‚ã¾ã™ã€‚)

```dart
import 'package:isar/isar.dart';

part 'spot.g.dart';

@Collection()
class Spot {
  int? id;

  @Index()
  late String name;

  late double longitude;

  late double latitude;

  late DateTime createdAt;

  late DateTime updatedAt;
}
```

`build_runner` å®Ÿæ–½ã—ã€`spot.g.dart` ã‚’ä½œæˆã—ã¨ãã¾ã™ã€‚
```sh
$ flutter pub run build_runner build
```

## IsaråˆæœŸåŒ–

```dart
void main() async {
  WidgetsFlutterBinding.ensureInitialized();
  final dir = await getApplicationSupportDirectory();

  final isar = await Isar.open(
      schemas: [SpotSchema], directory: dir.path, inspector: true);
  runApp(const MyApp());
}
```
â€» Isar Inspector ã§å‚ç…§ã™ã‚‹ç‚º `inspector: true` ã‚’è¨­å®šã—ã¦ã¾ã™

## Assetå†…ã®jsonãƒ•ã‚¡ã‚¤ãƒ«èª­ã¿è¾¼ã‚“ã§DBæ›¸ãè¾¼ã¿

```dart
Future<void> _loadSpots(Isar isar) async {
  try {
    final bytes = await rootBundle.load('assets/spots.json');
    final jsonStr = const Utf8Decoder().convert(bytes.buffer.asUint8List());
    final json = jsonDecode(jsonStr) as List;
    final now = DateTime.now();
    final spots = json.map((e) => Spot()
      ..name = e['name']
      ..longitude = double.parse(e['longitude'])
      ..latitude = double.parse(e['latitude'])
      ..createdAt = now
      ..updatedAt = now);
    isar.writeTxn((isar) async {
      await isar.spots.putAll(spots.toList());
    });
  } catch (e) {
    debugPrint(e.toString());
  }
}

void main() async {
  WidgetsFlutterBinding.ensureInitialized();
  final dir = await getApplicationSupportDirectory();

  final isar = await Isar.open(
      schemas: [SpotSchema], directory: dir.path, inspector: true);
  await _loadSpots(isar); // â† è¿½åŠ 

  runApp(const MyApp());
}
```

`_loadSpots` ã«é–¢ã—ã¦ã¯ Isar sampleã®[ã“ã¡ã‚‰](https://github.com/isar/samples/blob/3ad33123038fe9d4dc3b9e80210ba9762e7d9ce6/quotes/lib/load_quotes.dart#L49)ã‚’å°‘ã—ã‚«ã‚¹ã‚¿ãƒ ã—ãŸã‚‚ã®ã§ã€ã‚„ã£ã¦ã‚‹äº‹ã¯åŒã˜ã§ã™ã€‚

`assets/spots.json` ã®ä¸­èº«ã¯å˜ç´”ãªå†…å®¹ã«ãªã£ã¦ã¾ã™ â†“

```json
[
  {
    "name": "ã‚¢ãƒ†ãƒ",
    "longitude": "23.718989",
    "latitude": "37.973620"
  },
  {
    "name": "ã‚¤ã‚¹ã‚¿ãƒ³ãƒ–ãƒ¼ãƒ«",
    "longitude": "29.006069",
    "latitude": "41.065960"
  },
  {
    "name": "ã‚¦ã‚£ãƒ¼ãƒ³",
    "longitude": "16.364571",
    "latitude": "48.201841"
  }
]
```

`pubspec.yaml` ã« `assets/spots.json` ã‚’è¨­å®šã—ã¾ã™ã€‚

```yml
flutter:
  assets:
    - assets/spots.json
```

ã„ã–ã‚¢ãƒ—ãƒªèµ·å‹•ã—ã¦ã€Isar Inspector ã§ç™»éŒ²ã§ãã¦ã„ã‚‹ã‹ç¢ºèªã—ã¾ã™ã€‚
![](https://storage.googleapis.com/zenn-user-upload/92cb5f1dce47-20220510.png)

â†‘ã¡ã‚ƒã‚“ã¨jsonã§è¨­å®šã—ãŸãƒ‡ãƒ¼ã‚¿ãŒç™»éŒ²ã•ã‚Œã¦ã„ã¾ã™ âœ¨

### isarãŒç”¨æ„ã—ã¦ã„ã‚‹ `importJson` ã‚’ä½¿ã†
å®Ÿã¯isarã«ã¯jsonãƒ•ã‚¡ã‚¤ãƒ«ã‹ã‚‰importå‡ºæ¥ãã†ãª `importJson`, `importJsonRaw`, `importJsonSync`, `importJsonRawSync` ãŒç”¨æ„ã•ã‚Œã¦ã¾ã™ã€‚
https://github.com/isar/isar/blob/cb047f18c9f7711de4bc41832327a4e1c1b4d934/packages/isar/lib/src/native/isar_collection_impl.dart#L383

ã“ã¡ã‚‰ã‚‚è©¦ã—ã¦ã¿ãŸã„ã¨æ€ã„ã¾ã™ ğŸ‘€
å…ˆã»ã©ã® `_loadSpots` ã‚’ä»¥ä¸‹ã«ä¿®æ­£ã—ã¾ã™ã€‚
```dart
Future<void> _loadSpots(Isar isar) async {
  try {
    final bytes = await rootBundle.load('assets/spots.json');
    final jsonStr = const Utf8Decoder().convert(bytes.buffer.asUint8List());
    final json = jsonDecode(jsonStr) as List;
    final now = DateTime.now().microsecondsSinceEpoch;
    final importJson = json
        .map((e) => {
              'name': e['name'],
              'latitude': double.parse(e['latitude']),
              'longitude': double.parse(e['longitude']),
              'createdAt': now,
              'updatedAt': now,
            })
        .toList();
    isar.writeTxn((isar) async {
      await isar.spots.importJson(importJson);
    });
  } catch (e) {
    debugPrint(e.toString());
  }
}
```
ä»Šå› `createdAt` ã‚„ `updatedAt` ãŒã‚ã‚‹ç‚ºã€`importJsonRaw` ã§ãƒ€ã‚¤ãƒ¬ã‚¯ãƒˆã«ã‚¤ãƒ³ãƒãƒ¼ãƒˆå‡ºæ¥ãªã„ç‚ºã€`importJson` ã‚’ä½¿ç”¨ã—ã¦ã„ã¾ã™ã€‚
`putAll` ã§ç™»éŒ²ã™ã‚‹å ´åˆã¨ãƒ‘ãƒ•ã‚©ãƒ¼ãƒãƒ³ã‚¹ã«é•ã„ãŒã‚ã‚‹ã‹æ¯”è¼ƒã—ã¦ã¿ã¾ã™ ğŸ‘€

è©¦ã—ã« 1ä¸‡ä»¶ç™»éŒ²ã—ã¦ã¿ãŸæ‰€ã€æ‰‹å…ƒã®ç’°å¢ƒã§ã¯ 
- `importJson` ã ã¨ `59msec`
- `putAll` ã ã¨ `90msec`

ã§ã—ãŸã€‚å¤§é‡ã®ãƒ‡ãƒ¼ã‚¿ç™»éŒ²ã‚„ãƒ€ã‚¤ãƒ¬ã‚¯ãƒˆã«ã‚¤ãƒ³ãƒãƒ¼ãƒˆã§ãã‚‹å ´åˆã¯ `importJson` ã®æ–¹ãŒè‰¯ã•ãã†ã‹ã‚‚ã§ã™ã€‚

## æ—¢ã«ç™»éŒ²ã•ã‚Œã¦ã„ã‚‹å ´åˆã¯ã‚¹ã‚­ãƒƒãƒ—
æœ€å¾Œã«ã€æ—¢ã«ç™»éŒ²æ¸ˆã¿ã®å ´åˆã¯åˆæœŸãƒ‡ãƒ¼ã‚¿ç™»éŒ²éƒ¨åˆ†ã‚’ã‚¹ã‚­ãƒƒãƒ—ã™ã‚‹ã‚ˆã†ã«å®Ÿè£…ã—ã¾ã™ã€‚
`SharedPreferences` ä½¿ã£ã¦ãƒ•ãƒ©ã‚°ã§ç™»éŒ²æ¸ˆã¿ã‹åˆ¤æ–­ã—ãŸã‚Šã€ç™»éŒ²ä»¶æ•°ã«å¿œã˜ã¦åˆ¤æ–­ã—ãŸã‚Šã¨ã€è¤‡æ•°ãƒ‘ã‚¿ãƒ¼ãƒ³ãŒã‚ã‚Šãã†ã§ã™ãŒã€ä»Šå›ã¯1ä»¶ã§ã‚‚ç™»éŒ²ã•ã‚Œã¦ã„ãŸã‚‰ã‚¹ã‚­ãƒƒãƒ—ã™ã‚‹æ§˜ã«å®Ÿè£…ã—ã¾ã—ãŸã€‚â†“

```dart
  final isar = await Isar.open(
      schemas: [SpotSchema], directory: dir.path, inspector: true);
  final exists = await isar.spots.count() > 0;
  if (!exists) {
    debugPrint('Loading spots...');
    await _loadSpots(isar);
  }
```

