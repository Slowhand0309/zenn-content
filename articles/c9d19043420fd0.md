---
title: "CloudRun(Prisma)ã‹ã‚‰ãƒ—ãƒ©ã‚¤ãƒ™ãƒ¼ãƒˆIPã®CloudSQL(MySQL)ã¸æ¥ç¶šã™ã‚‹"
emoji: "ğŸ”‘"
type: "tech" # tech: æŠ€è¡“è¨˜äº‹ / idea: ã‚¢ã‚¤ãƒ‡ã‚¢
topics:
  - "GCP"
  - "CloudRun"
  - "CloudSQL"
  - "Prisma"
  - "MySQL"
published: true
---
# æ¥ç¶šæ–¹æ³•

1. **VPCã‚³ãƒã‚¯ã‚¿ã®è¨­å®š**: Cloud Runã‹ã‚‰ãƒ—ãƒ©ã‚¤ãƒ™ãƒ¼ãƒˆIPã®Cloud SQLã‚¤ãƒ³ã‚¹ã‚¿ãƒ³ã‚¹ã¸æ¥ç¶šã™ã‚‹ã«ã¯ã€ã¾ãšVPCã‚³ãƒã‚¯ã‚¿ã‚’è¨­å®šã™ã‚‹å¿…è¦ãŒã‚ã‚Šã¾ã™ã€‚VPCã‚³ãƒã‚¯ã‚¿ã¯ã€Cloud Runã‚µãƒ¼ãƒ“ã‚¹ã¨VPCãƒãƒƒãƒˆãƒ¯ãƒ¼ã‚¯é–“ã®æ¥ç¶šã‚’æä¾›ã—ã¾ã™ã€‚
[ã“ã¡ã‚‰](https://cloud.google.com/sql/docs/postgres/connect-run)ã®å…¬å¼ãƒ‰ã‚­ãƒ¥ãƒ¡ãƒ³ãƒˆã«å¾“ã£ã¦ã€VPCã‚³ãƒã‚¯ã‚¿ã‚’ä½œæˆã—ã¾ã™ã€‚

2. **`schema.prisma`** ãƒ•ã‚¡ã‚¤ãƒ«ã®è¨­å®š

    ```tsx
    datasource db {
      provider = "mysql"
      url      = env("DATABASE_URL")
    }
    
    generator client {
      provider = "prisma-client-js"
    }
    ```

3. `DATABASE_URL` ã®è¨­å®š

    CloudRunãƒ‡ãƒ—ãƒ­ã‚¤æ™‚ã« `DATABASE_URL` ã‚’è¨­å®šã—ã¾ã™ã€‚

    ```bash
    gcloud run deploy [SERVICE_NAME] \
      --image [IMAGE_NAME] \
      --set-env-vars DATABASE_URL=mysql://[USER]:[PASSWORD]@[PRIVATE_IP]:3306/[DATABASE_NAME] \
      --vpc-connector projects/[PROJECT_ID]/locations/[REGION]/connectors/[VPC_CONNECTOR_NAME] \
      --allow-unauthenticated
    ```

# SSLæ¥ç¶šã‚’è¡Œã†å ´åˆ

SSLæ¥ç¶šã‚’è¡Œã†å ´åˆã¯ã€åˆ¥é€”è¨¼æ˜æ›¸ã‚’ç”¨æ„ã™ã‚‹å¿…è¦ãŒã‚ã‚Šã¾ã™ã€‚

```bash
gcloud run deploy [SERVICE_NAME] \
  --image [IMAGE_NAME] \
  --set-env-vars DATABASE_URL=mysql://[USER]:[PASSWORD]@[PRIVATE_IP]:3306/[DATABASE_NAME]?sslidentity=[CLIENT_CERT_PATH]&sslpassword=[PASSWORD]&sslcert=[SERVER_CERT_PATH] \
  --vpc-connector projects/[PROJECT_ID]/locations/[REGION]/connectors/[VPC_CONNECTOR_NAME] \
  --allow-unauthenticated
```

:::message alert
æ³¨: sslidentity, sslpassword, sslcertãªã©ã®PATHã¯ `Prisma` ãƒ•ã‚©ãƒ«ãƒ€ã‹ã‚‰ã®ç›¸å¯¾ãƒ‘ã‚¹ã§è§£æ±ºã•ã‚Œã¾ã™
:::

[MySQL database connector (Reference)](https://www.prisma.io/docs/concepts/database-connectors/mysql#configuring-an-ssl-connection)

- SSLæ¥ç¶šã‚’è¡Œã†å ´åˆã®æŒ‡å®šå¯èƒ½ãªãƒ‘ãƒ©ãƒ¡ãƒ¼ã‚¿ã¯ä»¥ä¸‹
  - **sslcert=<PATH>**
    - PATH: ã‚µãƒ¼ãƒãƒ¼è¨¼æ˜æ›¸ã¸ã®ãƒ‘ã‚¹
    - ãƒ‡ãƒ¼ã‚¿ãƒ™ãƒ¼ã‚¹ãƒ»ã‚µãƒ¼ãƒãŒã‚¯ãƒ©ã‚¤ã‚¢ãƒ³ãƒˆè¨¼æ˜æ›¸ã«ç½²åã™ã‚‹ãŸã‚ã«ä½¿ç”¨ã™ã‚‹ãƒ«ãƒ¼ãƒˆè¨¼æ˜æ›¸
    - è¨¼æ˜æ›¸ãŒã‚·ã‚¹ãƒ†ãƒ ã®ä¿¡é ¼ã§ãã‚‹è¨¼æ˜æ›¸ã‚¹ãƒˆã‚¢ã«å­˜åœ¨ã—ãªã„å ´åˆã¯ã€ã“ã‚Œã‚’æä¾›ã™ã‚‹å¿…è¦ãŒã‚ã‚‹
    - Google Cloudã®å ´åˆ: server-ca.pem
    - è¨¼æ˜æ›¸ã®ãƒ‘ã‚¹ã¯ ./prisma ãƒ•ã‚©ãƒ«ãƒ€ã‹ã‚‰ã®ç›¸å¯¾ãƒ‘ã‚¹ã§è§£æ±ºã•ã‚Œã‚‹

  - **sslidentity=<PATH>**
    - PATH: PKCS12è¨¼æ˜æ›¸ãƒ‡ãƒ¼ã‚¿ãƒ™ãƒ¼ã‚¹ã¸ã®ãƒ‘ã‚¹
    - ã‚¯ãƒ©ã‚¤ã‚¢ãƒ³ãƒˆè¨¼æ˜æ›¸ã¨ã‚¯ãƒ©ã‚¤ã‚¢ãƒ³ãƒˆéµã‹ã‚‰PKCS12è¨¼æ˜æ›¸ãƒ‡ãƒ¼ã‚¿ãƒ™ãƒ¼ã‚¹ãŒä½œæˆã•ã‚Œã‚‹
      - ã‚¯ãƒ©ã‚¤ã‚¢ãƒ³ãƒˆéµã¨ã‚¯ãƒ©ã‚¤ã‚¢ãƒ³ãƒˆè¨¼æ˜æ›¸ã‚’ä½¿ã£ã¦ç”Ÿæˆã•ã‚Œã‚‹PKCS12å½¢å¼ã®SSL IDãƒ•ã‚¡ã‚¤ãƒ«
    - ã“ã®äºŒã¤ã®ãƒ•ã‚¡ã‚¤ãƒ«ã‚’ä¸€ã¤ã«ã¾ã¨ã‚ã¦ã€ãƒ‘ã‚¹ãƒ¯ãƒ¼ãƒ‰ã§ä¿è­·ã™ã‚‹
    - ã‚¯ãƒ©ã‚¤ã‚¢ãƒ³ãƒˆã‚­ãƒ¼ã¨ã‚¯ãƒ©ã‚¤ã‚¢ãƒ³ãƒˆè¨¼æ˜æ›¸ã‚’ä½¿ã£ã¦ã“ã®ãƒ•ã‚¡ã‚¤ãƒ«ã‚’ä½œã‚‹ã«ã¯ã€æ¬¡ã®ã‚³ãƒãƒ³ãƒ‰ã‚’ä½¿ã†

        ```bash
        openssl pkcs12 -export -out client-identity.p12 -inkey client-key.pem -in client-cert.pem
        ```

- **sslpassword=<PASSWORD>**
  - PKCS12ãƒ•ã‚¡ã‚¤ãƒ«ã‚’ä¿è­·ã™ã‚‹ãŸã‚ã«ä½¿ç”¨ã•ã‚ŒãŸãƒ‘ã‚¹ãƒ¯ãƒ¼ãƒ‰
  - å‰ã®ã‚¹ãƒ†ãƒƒãƒ—ã§æŒ™ã’ãŸopensslã‚³ãƒãƒ³ãƒ‰ã¯ã€PKCS12ãƒ•ã‚¡ã‚¤ãƒ«ã‚’ä½œæˆã™ã‚‹éš›ã«ãƒ‘ã‚¹ãƒ¯ãƒ¼ãƒ‰ã‚’å°‹ã­ã¦ãã‚‹ã®ã§ã€åŒã˜ãƒ‘ã‚¹ãƒ¯ãƒ¼ãƒ‰ã‚’ã“ã“ã§å…¥åŠ›ã™ã‚‹å¿…è¦ãŒã‚ã‚‹

- **sslaccept=(strict|accept_invalid_certs)**
  - **strict**
  - **accept_invalid_certs (default)**

ä¾‹)

```bash
mysql://USER:PASSWORD@HOST:PORT/DATABASE?sslidentity=client-identity.p12&sslpassword=mypassword&sslcert=rootca.cert
```

# ãƒãƒƒãƒ‰ãƒã‚¦ãƒã‚¦

ä¸‹è¨˜ã®ã‚¨ãƒ©ãƒ¼ãŒç™ºç”Ÿã™ã‚‹å ´åˆ

```text
Error: P1011: Error opening a TLS connection: error:0308010C:digital envelope routines:inner_evp_generic_fetch:unsupported:../crypto/evp/evp_fetch.c:373:Global default library context, Algorithm (RC2-40-CBC : 0), Properties ()
```

`inner_evp_generic_fetch`

[curl - OpenSSL error error:0308010C:digital envelope routines::unsupported](https://stackoverflow.com/questions/72598983/curl-openssl-error-error0308010cdigital-envelope-routinesunsupported)

[PHP OpenSSL ã«ã‚ˆã‚‹ã‚·ã‚§ãƒ«ã‚³ãƒãƒ³ãƒ‰ãƒ™ãƒ¼ã‚¹ã®æš—å·åŒ–](https://zenn.dev/dragonarrow/articles/ee392a9bd67ae2)

https://github.com/openssl/openssl/issues/20513

[digital envelope routines:inner_evp_generic_fetch:unsupported:crypto\evp\evp_fetch.c:373:global default library context, algorithm (rc2-40-cbc : 0), properties () ğŸ” You.com Search](https://you.com/search?q=digital+envelope+routines:inner_evp_generic_fetch:unsupported:crypto\evp\evp_fetch.c:373:global+default+library+context,+algorithm+(rc2-40-cbc+:+0),+properties+()&tbm=youchat&cfr=chatb&cid=c2_24b95c82-41f8-419e-a51c-0c4efe72e886)

â†‘ã‚‚ã—ã‹ã™ã‚‹ã¨opensslã®ãƒãƒ¼ã‚¸ãƒ§ãƒ³ãŒå¤ã„?ã‹ã‚‚ã—ã‚Œãªã„ã®ã§ã€opensslã®ãƒãƒ¼ã‚¸ãƒ§ãƒ³ã‚’ç¢ºèªã—ã¦ã¿ã¾ã™ã€‚

- opensslã®ãƒãƒ¼ã‚¸ãƒ§ãƒ³ç¢ºèª

    ```bash
    $ openssl version
    LibreSSL 3.3.6
    ```

- æ—©é€Ÿãƒãƒ¼ã‚¸ãƒ§ãƒ³ã‚¢ãƒƒãƒ—ã—ã¦ã¿ã‚‹

    ```bash
    $ brew update
    $ brew upgrade openssl
    $ openssl version     
    LibreSSL 3.3.6
    ```

    å¤‰ã‚ã‚‰ãªã„ã€‚ã€‚

[Openssl 3.x and Legacy Providers â€“ Practical Networking .net](https://www.practicalnetworking.net/practical-tls/openssl-3-and-legacy-providers/)

â†‘ã‚’è¦‹ã‚‹ã¨CloudRun or prisma ä¸Šã¯å¤ã„opensslã®providerã‚’è¦‹ã«ã„ã£ã¦ã‚‹ã®ã«ã€ä½œã‚‰ã‚ŒãŸéš›ã«æ–°ã—ã„ã‚¢ãƒ«ã‚´ãƒªã‚ºãƒ ã‚’ä½¿ã£ã¦ã„ã‚‹ã®ã§ã‚¨ãƒ©ãƒ¼ãŒå‡ºã‚‹ã£ã½ã„?

çµæœ

`OpenSSL 3.0.9 30 May 2023 (Library: OpenSSL 3.0.9 30 May 2023)` ã®ãƒãƒ¼ã‚¸ãƒ§ãƒ³ã®opesslã§ãªã‚‰æˆåŠŸã—ã¾ã—ãŸ
