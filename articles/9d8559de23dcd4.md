---
title: "ã€GCPã€‘GCPã®ç’°å¢ƒã‚’Terraformã§æ§‹ç¯‰ã™ã‚‹"
emoji: "ğŸ› ï¸"
type: "tech"
topics:
  - "gcp"
  - "terraform"
  - "note"
published: true
published_at: "2022-07-03 00:50"
---

# æ¦‚è¦
GCPã®ã‚¤ãƒ³ãƒ•ãƒ©ç®¡ç†ã‚’Terraformã‚’ä½¿ã£ã¦è¡Œã†éš›ã®äº‹å‰æº–å‚™ã‚„ã€è¨­å®šãªã©ã«é–¢ã™ã‚‹è¨˜äº‹ã«ãªã‚Šã¾ã™ã€‚

## ä½¿ç”¨ã™ã‚‹ãƒ„ãƒ¼ãƒ«
- [Terraform](https://www.terraform.io/)
- [Terragrunt](https://terragrunt.gruntwork.io/)
- [gcloud](https://cloud.google.com/sdk/gcloud?hl=ja)

â€» Terraformã‚„Terragruntã®ç´°ã‹ã„è§£èª¬ãªã©ã¯ä»Šå›ã¯è¡Œã£ã¦ã¾ã›ã‚“ã€‚

## äº‹å‰æº–å‚™
[Getting Started with the Google provider | Guides | hashicorp/google | Terraform Registry](https://registry.terraform.io/providers/hashicorp/google/latest/docs/guides/getting_started)

`gcloud auth` ã‚’ä½¿ç”¨ã—ã¦ã‚¯ãƒ¬ãƒ‡ãƒ³ã‚·ãƒ£ãƒ«ãƒ•ã‚¡ã‚¤ãƒ«ã‚’ç”Ÿæˆã—ã€Terraformã§å®Ÿè¡Œã™ã‚‹éš›ã«åˆ©ç”¨ã§ãã‚‹ã‚ˆã†ã«ã—ã¾ã™ã€‚ãã®ç‚ºã€ã¾ãšã¯gcloudã¨terraformä¸¡æ–¹ã‚’ä½¿ãˆã‚‹Dockerç’°å¢ƒã‚’ä½œæˆã—ã¾ã™ã€‚

```dockerfile
# https://hub.docker.com/r/hashicorp/terraform
FROM hashicorp/terraform:1.1.8 as terraform

FROM google/cloud-sdk:377.0.0-alpine

COPY --from=terraform /bin/terraform /usr/local/bin/terraform

RUN apk --update add \
      vim

# https://github.com/gruntwork-io/terragrunt/releases
RUN curl -L "https://github.com/gruntwork-io/terragrunt/releases/download/v0.36.7/terragrunt_linux_amd64" -o /usr/local/bin/terragrunt \
    && chmod +x /usr/local/bin/terragrunt
```
â€» å„Verã¯é©å®œå¤‰æ›´ã—ã¦ä¸‹ã•ã„
â†‘ã§ã¯[multi-stage builds](https://docs.docker.com/develop/develop-images/multistage-build/)ã‚’ä½¿ç”¨ã—ã¦ `google/cloud-sdk` ã‚¤ãƒ¡ãƒ¼ã‚¸ã«terraformã®å®Ÿè¡Œãƒ•ã‚¡ã‚¤ãƒ«ã‚’ã‚³ãƒ”ãƒ¼ã—ã¦ä½¿ã£ã¦ã„ã¾ã™

â†“ ã¡ãªã¿ã«gcloudã®Dockerfileã®ãƒªãƒã‚¸ãƒˆãƒªã¯ä»¥ä¸‹ã«ãªã‚Šã¾ã™
[GoogleCloudPlatform/cloud-sdk-docker: Docker image with all the components of the Google Cloud SDK](https://github.com/GoogleCloudPlatform/cloud-sdk-docker)

æ¬¡ã« `docker-compose.yml` ã‚’ä»¥ä¸‹ã§ä½œæˆã—ã¾ã™ã€‚

```yml
version: '3.8'
services:
  infra:
    build: .
    image: xxxx/infra
    container_name: "xxxx-infra"
    volumes:
      - ./:/infrastructure
      - gcloud_config:/root/.config/gcloud
    working_dir: /infrastructure
    entrypoint: bash

volumes:
  gcloud_config:
```

### ã‚¢ã‚«ã‚¦ãƒ³ãƒˆãƒ­ã‚°ã‚¤ãƒ³ã¨ã‚¯ãƒ¬ãƒ‡ãƒ³ã‚·ãƒ£ãƒ«ä½œæˆ

ã‚³ãƒ³ãƒ†ãƒŠå†…ã§ã‚‚ã‚ã‚‚ã‚ä½œæ¥­ã—ã¦ã„ãã¾ã™ã€‚

```sh
$ docker-compose run --rm infra
$ gcloud auth login --no-launch-browser
```
â†‘URLãŒç™ºè¡Œã•ã‚Œã‚‹ã®ã§Webãƒ–ãƒ©ã‚¦ã‚¶ã§é–‹ãã€è©²å½“ã®ã‚¢ã‚«ã‚¦ãƒ³ãƒˆã§ãƒ­ã‚°ã‚¤ãƒ³å¾Œèªè¨¼ã‚³ãƒ¼ãƒ‰ã‚’å…¥åŠ›ã™ã‚‹ã€‚

```sh
$ gcloud projects list
```
â†‘æ­£ã—ã„ã‚¢ã‚«ã‚¦ãƒ³ãƒˆã§ã¡ã‚ƒã‚“ã¨ãƒ­ã‚°ã‚¤ãƒ³ã§ãã¦ã„ã‚‹ã‹ç¢ºèª(ã‚¢ã‚«ã‚¦ãƒ³ãƒˆã®ç®¡ç†ä¸‹ã®ãƒ—ãƒ­ã‚¸ã‚§ã‚¯ãƒˆä¸€è¦§ãŒè¡¨ç¤ºã•ã‚Œã‚‹)

```sh
$ gcloud auth application-default login --no-launch-browser
```
â†‘ã§ã‚¯ãƒ¬ãƒ‡ãƒ³ã‚·ãƒ£ãƒ«ä½œæˆå®Ÿæ–½ã€‚å®Ÿéš›ã®ãƒ•ã‚¡ã‚¤ãƒ«ã¯ `/root/.config/gcloud` é…ä¸‹ã«ç”Ÿæˆã•ã‚Œã¾ã™ã€‚
ä»Šå›ã¯`gcloud_config` volumeã«ãƒã‚¦ãƒ³ãƒˆã—ã¦ã¾ã™ã€‚

## tfstateãƒ•ã‚¡ã‚¤ãƒ«ã‚’GCPã®Cloud Storageã§ç®¡ç†ã™ã‚‹
æœ€åˆã«tfstateã‚’æ ¼ç´ã™ã‚‹Cloud Storageã®ãƒã‚±ãƒƒãƒˆã‚’ä½œæˆã—ã¾ã™ã€‚

```sh
$ gsutil mb -l asia-northeast1 gs://xxx-tfstate
$ gsutil versioning set on gs://xxx-tfstate
$ gsutil lifecycle set /infrastructure/tfstate_lifecycle.json gs://xxx-tfstate
```
`tfstate_lifecycle.json` ã®ä¸­èº«ã¨ã—ã¦ã¯ä»¥ä¸‹

```json
{
  "rule":
  [
    {
      "action": {"type": "Delete"},
      "condition": {"numNewerVersions": 5}
    }
  ]
}
```
â†‘ä¸–ä»£ç®¡ç†ã‚’ã—ã¦å¤ã„ã‚‚ã®ã¯å‰Šé™¤ã™ã‚‹æ§˜ã«ã—ã¾ã—ãŸã€‚

## ã‚µãƒ³ãƒ—ãƒ«
æº–å‚™ã¨ã—ã¦ã¯ä»¥ä¸Šã«ãªã‚Šã¾ã™ã€‚æŠ˜è§’ãªã®ã§å®Ÿéš›ã«GCPå†…ã®ãƒªã‚½ãƒ¼ã‚¹ã‚’ä½œæˆã™ã‚‹ã‚µãƒ³ãƒ—ãƒ«ã‚’è¼‰ã›ã¦ã„ãã¾ã™ã€‚

### CloudSQLã®ã‚¤ãƒ³ã‚¹ã‚¿ãƒ³ã‚¹ã‚’ä½œæˆã™ã‚‹ã‚µãƒ³ãƒ—ãƒ«
ã‚µãƒ³ãƒ—ãƒ«ã®ã‚±ãƒ¼ã‚¹ã¨ã—ã¦ã¯ã€ãƒ—ãƒ©ã‚¤ãƒ™ãƒ¼ãƒˆIPã§ã®CloudSQLã‚¤ãƒ³ã‚¹ã‚¿ãƒ³ã‚¹ä½œæˆã€‚ã‹ã¤ã‚¢ã‚¯ã‚»ã‚¹ãƒ¦ãƒ¼ã‚¶ãƒ¼ã‚’CloudSQLProxyç”¨ã®ãƒ¦ãƒ¼ã‚¶ãƒ¼ã¨CloudRunã‚¢ã‚¯ã‚»ã‚¹ç”¨ã®ãƒ¦ãƒ¼ã‚¶ãƒ¼ã®2ã¤ä½œæˆã™ã‚‹æƒ³å®šã§ã™ã€‚

```tf
# ãƒ—ãƒ©ã‚¤ãƒ™ãƒ¼ãƒˆIPã‚’ä½¿ç”¨ã—ãŸå ´åˆã®CloudSQLã‚¤ãƒ³ã‚¹ã‚¿ãƒ³ã‚¹ä½œæˆã®ã‚µãƒ³ãƒ—ãƒ«
resource "google_sql_database_instance" "master" {
  name             = "xxxxx-db-master"
  database_version = "${var.database_version}"
  region           = "${var.region}"

  settings {
    tier      = "${var.tier}"
    disk_type = "${var.disk_type}"
    disk_size = "${var.disk_size}"

    ip_configuration {
      ipv4_enabled    = false
      require_ssl     = true
      private_network = "${var.private_network}"
      allocated_ip_range = "${var.allocated_ip_range}"
    }
  }
}

# CloudSQLProxyç”¨ã®ãƒ¦ãƒ¼ã‚¶ãƒ¼
resource "google_sql_user" "proxy_user" {
  name     = "${var.proxy_user}"
  instance = "${google_sql_database_instance.master.name}"
  host     = "cloudsqlproxy~%"
  password = "${var.proxy_password}"
}

# CloudRunã‚¢ã‚¯ã‚»ã‚¹ç”¨ã®ãƒ¦ãƒ¼ã‚¶ãƒ¼
resource "google_sql_user" "cloud_run_user" {
  name     = "${var.cloud_run_user}"
  instance = "${google_sql_database_instance.master.name}"
  host     = "%"
  password = "${var.cloud_run_password}"
}
```

### CloudStorageã®ãƒã‚±ãƒƒãƒˆã‚’ä½œæˆã™ã‚‹ã‚µãƒ³ãƒ—ãƒ«
ã‚µãƒ³ãƒ—ãƒ«ã®ã‚±ãƒ¼ã‚¹ã¨ã—ã¦ã¯ã€ãƒ—ãƒ­ã‚¸ã‚§ã‚¯ãƒˆã®ã‚ªãƒ¼ãƒŠãƒ¼ã¨ã€ç‰¹å®šã®ã‚µãƒ¼ãƒ“ã‚¹ã‚¢ã‚«ã‚¦ãƒ³ãƒˆã« `roles/storage.admin` ã®ãƒ­ãƒ¼ãƒ«ã‚’æŒãŸã›ã‚‹ãƒã‚±ãƒƒãƒˆã‚’ä½œæˆã™ã‚‹æƒ³å®šã§ã™ã€‚

```tf
resource "google_storage_bucket" "storage" {
  name          = "xxxx-storage"
  location      = "${var.location}"
  storage_class = "${var.storage_class}"
  uniform_bucket_level_access = true
  force_destroy = true
}

data "google_iam_policy" "role_binding" {
  binding {
    role = "roles/storage.admin"

    members = [
      "projectOwner:{ãƒ—ãƒ­ã‚¸ã‚§ã‚¯ãƒˆID}",
    ]
  }

  binding {
    role = "roles/storage.objectAdmin"

    members = [
      "serviceAccount:${var.allowed_service_account}",
    ]
  }
}

resource "google_storage_bucket_iam_policy" "policy_binding" {
  bucket      = google_storage_bucket.storage.name
  policy_data = data.google_iam_policy.role_binding.policy_data
}
```

# å‚è€ƒURL
- [Terraformã§Google Cloudã‚’æ‰±ã†ãŸã‚ã®ãƒ­ãƒ¼ã‚«ãƒ«ç«¯æœ«ç’°å¢ƒæ§‹ç¯‰ | DevelopersIO](https://dev.classmethod.jp/articles/accesse-google-cloud-with-terraform/)
- [Terraformã®tfstateãƒ•ã‚¡ã‚¤ãƒ«ã‚’GCSã§ç®¡ç†ã™ã‚‹ - Qiita](https://qiita.com/kawakawaryuryu/items/58d8afbb21155c2e9572)
- [mb - Make buckets Â |Â  Cloud Storage Â |Â  Google Cloud](https://cloud.google.com/storage/docs/gsutil/commands/mb?hl=ja)
- [CloudBuild ã§æœ€å¼·ã®Terraform & Terragrunt CIç’°å¢ƒã‚’ä½œã‚‹ | mixi developers](https://mixi-developers.mixi.co.jp/strongest-terraform-terragrunt-ci-e4c350d627e6)
- [Google Cloud SQL for MySQL ã‚¤ãƒ³ã‚¹ã‚¿ãƒ³ã‚¹ä½œæˆ â€“ Terraform â€“ â€“ IT curry blog](https://awsbloglink.wordpress.com/2018/02/12/google-cloud-sql-%E3%82%A4%E3%83%B3%E3%82%B9%E3%82%BF%E3%83%B3%E3%82%B9%E4%BD%9C%E6%88%90-terraform/)
- [Google Cloud SQLã®ã‚¤ãƒ³ã‚¹ã‚¿ãƒ³ã‚¹ã‚’private IPã§æ‰±ã† - ã¿ãƒ¼ã®ãºãƒ¼ã˜](https://pc.atsuhiro-me.net/entry/2021/03/31/231017)
- [Terraform ã‚’ä½¿ã£ã¦ Google Cloud ã®ãƒªã‚½ãƒ¼ã‚¹ã‚’ç®¡ç†ã™ã‚‹ã“ã¨ã¯ã˜ã‚ï¼ˆgloud authã‚’åˆ©ç”¨ï¼‰](https://zenn.dev/waddy/articles/terraform-google-cloud)
- [gruntwork-io/terraform-google-sql: Terraform modules for deploying Google Cloud SQL (e.g. MySQL, PostgreSQL) in GCP](https://github.com/gruntwork-io/terraform-google-sql)
- [Terraform ã§ GCP ã®ãƒªã‚½ãƒ¼ã‚¹ã‚’ç®¡ç†ã™ã‚‹ - kawabatasæŠ€è¡“ãƒ–ãƒ­ã‚°](https://kawabatas.hatenablog.com/entry/2018/07/16/142034)