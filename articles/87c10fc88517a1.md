---
title: "ã€GCPã€‘Cloud Run è‰²ã€…è©¦ã—ãŸæ™‚ã®è¦šæ›¸"
emoji: "ğŸƒ"
type: "tech"
topics:
  - "gcp"
  - "cloudrun"
  - "firestore"
  - "pubsub"
  - "cloudsql"
published: true
published_at: "2022-06-18 23:29"
---

GCPã®Cloud Runã‚’è‰²ã€…è©¦ã—ãŸéš›ã«ã€ãƒ¡ãƒ¢ã—ãŸå†…å®¹ã‚’ã¤ã‚‰ã¤ã‚‰æ›¸ã„ã¦ã„ã¾ã™ã€‚

# ã¾ãšã¯ Hello Worldçš„ãªã“ã¨ã‚’ã‚„ã£ã¦ã¿ã‚‹
[ã‚¯ã‚¤ãƒƒã‚¯ã‚¹ã‚¿ãƒ¼ãƒˆ: äº‹å‰ã«ãƒ“ãƒ«ãƒ‰ã•ã‚ŒãŸã‚µãƒ³ãƒ—ãƒ« ã‚³ãƒ³ãƒ†ãƒŠã‚’ãƒ‡ãƒ—ãƒ­ã‚¤ã™ã‚‹ Â |Â  Cloud Run ã®ãƒ‰ã‚­ãƒ¥ãƒ¡ãƒ³ãƒˆ Â |Â  Google Cloud](https://cloud.google.com/run/docs/quickstarts/prebuilt-deploy)
â†‘ã®ã‚µãƒ³ãƒ—ãƒ«ã‚’è©¦ã—ã«ã‚„ã£ã¦ã¿ãŸã„ã¨æ€ã„ã¾ã™ã€‚
![](https://storage.googleapis.com/zenn-user-upload/83f6f42bde4a-20220618.png)

â†‘ã®ã‚µãƒ¼ãƒ“ã‚¹ã®ä½œæˆã‚’é¸æŠ

![](https://storage.googleapis.com/zenn-user-upload/129478013396-20220618.png)

â†‘ã‚µãƒ³ãƒ—ãƒ«ã‚³ãƒ³ãƒ†ãƒŠã§ãƒ†ã‚¹ãƒˆã‚’é¸æŠ

![](https://storage.googleapis.com/zenn-user-upload/38355ee8d175-20220618.png)


â†‘æœªèªè¨¼ã®å‘¼ã³å‡ºã—ã‚’è¨±å¯ã«ãƒã‚§ãƒƒã‚¯
ä½œæˆã‚’ã‚¯ãƒªãƒƒã‚¯ã—ã€Cloud RunãŒä½œæˆã•ã‚Œã‚‹ã¾ã§å¾…ã¡ã¾ã™ã€‚

![](https://storage.googleapis.com/zenn-user-upload/e5794aec9721-20220618.png)

ä½œæˆã•ã‚ŒãŸã‚‰è¡¨ç¤ºã•ã‚Œã¦ã„ã‚‹URLã«ã‚¢ã‚¯ã‚»ã‚¹ã—ã€ä»¥ä¸‹ã®æ§˜ãªç”»é¢ãŒè¡¨ç¤ºã•ã‚Œã‚Œã°OKã§ã™ âœ¨
![](https://storage.googleapis.com/zenn-user-upload/f6922466cc6d-20220618.png)
ãƒãƒãƒãƒã‚„ã£ã¦ç°¡å˜ã«ãƒ‡ãƒ—ãƒ­ã‚¤ã—ã¦è©¦ã™äº‹ãŒã§ãã¾ã—ãŸã€‚

# ãƒ‡ãƒ—ãƒ­ã‚¤æ–¹æ³•
æ¬¡ã¯å®Ÿéš›ã«è‡ªä½œã—ãŸã‚³ãƒ³ãƒ†ãƒŠã‚¤ãƒ¡ãƒ¼ã‚¸ã‚’Cloud Runä¸Šã§å‹•ã‹ã—ã¦ã¿ãŸã„ã¨æ€ã„ã¾ã™ã€‚
ã‚³ãƒ³ãƒ†ãƒŠã‚¤ãƒ¡ãƒ¼ã‚¸ã‚’Pushã™ã‚‹å…ˆã¯ç¾æ™‚ç‚¹ã§ã¯ä»¥ä¸‹ã®2ç¨®é¡ã‚ã‚Šã¾ã™ã€‚
- Container Registry 
- Artifact Registry

> Artifact Registry ã¯å¾“æ¥ã® Container Registry ã®æ©Ÿèƒ½ã‚’æ‹¡å¼µã—ãŸã‚‚ã®ã§ã€
Docker ã‚¤ãƒ¡ãƒ¼ã‚¸ã«åŠ ãˆã¦ã€è¨€èªãƒ»OSãƒ‘ãƒƒã‚±ãƒ¼ã‚¸ç®¡ç†ã‚‚æä¾›ã—ã¦ã„ã‚‹
Container Registry ã¨é•ã„ã€1ã¤ã®ãƒ—ãƒ­ã‚¸ã‚§ã‚¯ãƒˆå†…ã«è¤‡æ•°ã®ãƒªãƒã‚¸ãƒˆãƒªã‚’ä½œæˆå¯èƒ½ã§ã€ãã®ä»–ã«ã‚‚æ§˜ã€…ãªæ‹¡å¼µãŒã•ã‚Œã¦ã„ã‚‹

## gcloudä½¿ã£ã¦ãƒ‡ãƒ—ãƒ­ã‚¤
ä»Šå›ã¯ `gcloud` CLIã‚’ä½¿ã£ã¦ Dockerfileã‚’ç”¨æ„ã—ã¦ã‚³ãƒãƒ³ãƒ‰å®Ÿè¡Œã™ã‚‹ã¨ãŠã¾ã‹ã›ã§ã‚ˆã—ãªã«ã‚„ã£ã¦ãã‚Œã‚‹æ–¹æ³•ã‚’è©¦ã—ã¦ã¿ãŸã„ã¨æ€ã„ã¾ã™ã€‚

### ãƒ‡ã‚£ãƒ¬ã‚¯ãƒˆãƒªæ§‹æˆ
```
- gcp
    - README.md
    - docker-compose.yml
    - cloudrun
        - ã‚½ãƒ¼ã‚¹ãƒ•ã‚¡ã‚¤ãƒ«è‰²ã€…
        - .gcloudignore
        - deploy.sh
    - etc...
```

docker-compose.yml
```yml
version: '3.0'
services:
  gcloud:
    image: google/cloud-sdk:376.0.0-alpine
    volumes:
      - .:/usr/src
      - gcloud_config_data:/root/.config/gcloud
    working_dir: /usr/src
    entrypoint: bash

volumes:
  gcloud_config_data:
```

CLIãŒä½¿ãˆã‚‹ç’°å¢ƒã‚’â†‘ã® `docker-compose.yml` ã«ã¦æº–å‚™ã—ã€æ—©é€Ÿã‚³ãƒ³ãƒ†ãƒŠèµ·å‹•ã—ã¦ã‚¢ã‚«ã‚¦ãƒ³ãƒˆãƒ­ã‚°ã‚¤ãƒ³ã‚’å®Ÿæ–½ã—ã¦ã¿ã¾ã™ã€‚
```sh
$ docker-compose run --rm gcloud
$ gcloud auth login --no-launch-browser
```
â†‘ã§è¡¨ç¤ºã•ã‚ŒãŸURLã«ã‚¢ã‚¯ã‚»ã‚¹ã—GCPã‚’æ‰±ã†ã‚¢ã‚«ã‚¦ãƒ³ãƒˆã§é€£æºã€èªè¨¼ã‚³ãƒ¼ãƒ‰ã‚’å…¥åŠ›ã—ã¦ãƒ­ã‚°ã‚¤ãƒ³ã—ã¦ãŠãã¾ã™ã€‚
[gcloud auth login Â |Â  Google Cloud CLI Documentation](https://cloud.google.com/sdk/gcloud/reference/auth/login)

```sh
$ gcloud projects list # ãƒ—ãƒ­ã‚¸ã‚§ã‚¯ãƒˆä¸€è¦§ç¢ºèª
$ gcloud config set project [ãƒ—ãƒ­ã‚¸ã‚§ã‚¯ãƒˆå] # å¯¾è±¡ã®ãƒ—ãƒ­ã‚¸ã‚§ã‚¯ãƒˆã‚’è¨­å®š
$ gcloud config list # è¨­å®šã•ã‚Œã¦ã„ã‚‹ã‹ç¢ºèª
```

â†‘ã§å®Ÿéš›ã«é€£æºã•ã‚ŒãŸã‹ã®ç¢ºèªã‚„ã€ãƒ‡ãƒ•ã‚©ãƒ«ãƒˆã®ãƒ—ãƒ­ã‚¸ã‚§ã‚¯ãƒˆãªã©ã‚’å¿…è¦ã«å¿œã˜ã¦è¨­å®šã—ã¦ãŠãã¾ã™ã€‚

### ã‚µãƒ³ãƒ—ãƒ«ã®Expressã‚’å®Ÿè£…ã™ã‚‹
è©¦ã™ã‚‚ã®ã¨ã—ã¦ã€Expressã‚’ç”¨ã„ã¦ `/hello` ã«ã‚¢ã‚¯ã‚»ã‚¹ã™ã‚‹ã¨ã‚¿ã‚¤ãƒ ã‚¹ã‚¿ãƒ³ãƒ—ã‚’è¿”ã™ã‚ˆã†ãªç°¡å˜ãªã‚‚ã®ã‚’ãƒ‡ãƒ—ãƒ­ã‚¤ã—ã¦ã¿ãŸã„ã¨æ€ã„ã¾ã™ã€‚

```js
const express = require('express');
const app = express();

const port = process.env.PORT || 8080;
app.listen(port, () => {
  console.log(`Listening on port ${port}.`);
});

app.get("/hello", async (req, res) => {
  const word = new Date();
  res.send(`Hello, timestamp ${word.getTime()}!`);
});
```
â†‘ã‚’ `index.js` ã¨ã—ã¦ä¿å­˜ã€‚

```Dockerfile
 FROM node:12.4.0-alpine

 WORKDIR /usr/src/app
 COPY package*.json ./
 RUN yarn install
 COPY . ./
 CMD [ "yarn", "start" ]
```
`Dockerfile` ã‚’â†‘ã§ç”¨æ„ã—ã¦ãŠãã€‚

```json
{
  "name": "node",
  "version": "1.0.0",
  "main": "index.js",
  "license": "MIT",
  "scripts": {
     "start": "node index.js"
  },
  "dependencies": {
     "express": "^4.17.3"
  }
}
```
`package.json` ã¯â†‘ã®æ§˜ãªè¨­å®šã€‚

```sh
#! /bin/bash

# ã‚¨ãƒ©ãƒ¼ã§å‡¦ç†ä¸­æ–­
set -ex

# ã‚µãƒ¼ãƒ“ã‚¹å
export SERVICE_NAME=$1

gcloud run deploy \
  ${SERVICE_NAME}
  --region asia-northeast1
  --source .
```
ä»Šå›ã¯ã€ãƒ‡ãƒ—ãƒ­ã‚¤ç”¨ã®ã‚¹ã‚¯ãƒªãƒ—ãƒˆã¨ã—ã¦ `deploy.sh` ã‚’â†‘ã®å†…å®¹ã§ä½œæˆã—ã¾ã—ãŸã€‚
ã„ã–ã€ãƒ‡ãƒ—ãƒ­ã‚¤ã—ã¦ã¿ã¾ã™ã€‚

```
bash-5.1# ./deploy.sh express-sample
+ export SERVICE_NAME=express-sample
+ SERVICE_NAME=express-sample
+ gcloud run deploy express-sample
Deploying from source. To deploy a container use [--image]. See https://cloud.google.com/run/docs/deploying-source-code for more details.
Source code location (/usr/src/cloudrun):  

Deploying from source requires an Artifact Registry Docker repository to store built 
containers. A repository named [cloud-run-source-deploy] in region [asia-northeast1] will 
be created.

Do you want to continue (Y/n)?  Y

This command is equivalent to running `gcloud builds submit --tag [IMAGE] /usr/src/cloudrun` and `gcloud run deploy express-sample --image [IMAGE]`

Allow unauthenticated invocations to [express-sample] (y/N)?  y

Building using Dockerfile and deploying container to Cloud Run service [express-sample] in project [xxxxx] region [asia-northeast1]
â ¹ Building and deploying new service... Building Container.                              
  âœ“ Creating Container Repository...                                                     
  âœ“ Uploading sources...                                                                 
  â ¹ Building Container... Logs are available at [https://console.cloud.google.com/cloud-b
  uild/builds/........].                
  . Creating Revision...                                                                 
  . Routing traffic...                                                                   
  . Setting IAM Policy...     
```

ãƒ‡ãƒ—ãƒ­ã‚¤ã«æˆåŠŸã™ã‚‹ã¨GCPå†…ã«é–¢é€£ã—ãŸãƒªã‚½ãƒ¼ã‚¹ã¨ã—ã¦
- Cloud Storage
- Code Build
- Artifact Registry
- Cloud Run
ã«ä½•ã‹ã—ã‚‰ãƒªã‚½ãƒ¼ã‚¹ãŒä½œæˆã•ã‚Œã¾ã™ã€‚

ä»Šå›ä½œæˆã•ã‚ŒãŸã‚µãƒ¼ãƒ“ã‚¹ã®è©³ç´°ã¯
- å®¹é‡
![](https://storage.googleapis.com/zenn-user-upload/72c294375f8e-20220618.png)

- å¤‰æ•°ã¨ã‚·ãƒ¼ã‚¯ãƒ¬ãƒƒãƒˆ
![](https://storage.googleapis.com/zenn-user-upload/3b576a6090b2-20220618.png)

- æ¥ç¶š
![](https://storage.googleapis.com/zenn-user-upload/18d863cad386-20220618.png)

â†‘ã®æ§˜ãªè¨­å®šã§ãƒ‡ãƒ—ãƒ­ã‚¤ã•ã‚Œã¦ã„ã¾ã—ãŸã€‚

## å‰Šé™¤

```sh
$ gcloud run services delete SERVICE-NAME
```
å‰Šé™¤å¯¾è±¡ã¨ã—ã¦ã¯ `Cloud Run` ã®ã¿ã§ Cloud Storageã‚„Code Build, Artifact Registryã¯æ®‹ã£ãŸã¾ã¾ã§ã—ãŸã€‚

# Railsã‚’å‹•ã‹ã—ã¦ã¿ã‚‹
[Cloud Run ç’°å¢ƒã§ã® Rails ã®å®Ÿè¡Œ Â |Â  Ruby Â |Â  Google Cloud](https://cloud.google.com/ruby/rails/run)
â†‘ã®è¨˜äº‹ã‚’å‚è€ƒã«ã€Cloud Runã§Railsã‚’å‹•ã‹ã—ã¦ã€Databaseã¯CloudSQL for MySQLã¨é€£æºã™ã‚‹æƒ³å®šã§è©¦ã—ã¦ã¿ã¾ã™ã€‚

## ç’°å¢ƒæ§‹ç¯‰
ä»¥ä¸‹ã®Verã§Railsãƒ—ãƒ­ã‚¸ã‚§ã‚¯ãƒˆã‚’æ–°è¦ä½œæˆã—è©¦ã—ã¦ã¿ã¾ã™ã€‚
```
- Ruby: 3.1.0
- Rails: 7.0.1
```

## DBè¨­å®š

æœ€çµ‚çš„ãª `database.yml` ã¯ä»¥ä¸‹ã®ã‚ˆã†ã«ãªã‚Šã¾ã—ãŸã€‚(CloudSQLã¯ãƒ‘ãƒ–ãƒªãƒƒã‚¯IPã¨ã—ãŸå ´åˆ)
`staging` ãŒCloudSQLã®æ¥ç¶šè¨­å®šã«ãªã‚Šã¾ã™ã€‚

```yml
default: &default
  adapter: mysql2
  encoding: utf8mb4
  pool: <%= ENV.fetch("RAILS_MAX_THREADS") { 5 } %>
  username: root
  password:
  host: <%= ENV.fetch('RAILS_DB_HOST') { 'mysql' } %>

development:
  <<: *default
  database: xxxx_development

test:
  <<: *default
  database: xxxx_test

staging:
  <<: *default
  database: xxxx_staging
  username: <%= ENV.fetch('CLOUDSQL_USERNAME') { 'root' } %>
  password: <%= ENV.fetch('CLOUDSQL_PASSWORD') { '' } %>
  socket: <%= ENV.fetch('CLOUDSQL_SOCKETPATH') { '' } %>
  host: localhost
```

## ãƒ­ã‚°ã«é–¢ã—ã¦
[GKEä¸ŠRailsã®ã‚¢ãƒ—ãƒªã‚±ãƒ¼ã‚·ãƒ§ãƒ³ãƒ­ã‚°ã‚’Stackdriver Loggingã§é‹ç”¨ã™ã‚‹æ–¹æ³• | by Riki Shimma | Medium](https://medium.com/@r.shimma/rails-on-gke-with-stackdriver-logging-63163c72934)

â†‘ã‚’è¦‹ã‚‹é™ã‚Šæ–¹æ³•ã¯2é€šã‚Šã‚ã‚Šãã†ã§ã€
1. [google-cloud-ruby gem](https://github.com/googleapis/google-cloud-ruby/tree/main/stackdriver) ã‚’åˆ©ç”¨ã—ã¦ã€APIçµŒç”±ã§ãƒ­ã‚°ã‚’ä¿å­˜ã™ã‚‹
2. æ¨™æº–å‡ºåŠ›
å˜ç´”ã« `2. æ¨™æº–å‡ºåŠ›` ã™ã‚‹æ–¹ãŒç°¡å˜ãã†ã ã£ãŸã®ã§è¨­å®šã‚’è¿½åŠ 

```rb
  config.log_formatter = ::Logger::Formatter.new
  if ENV['RAILS_LOG_TO_STDOUT'].present?
    logger           = ActiveSupport::Logger.new(STDOUT)
    logger.formatter = config.log_formatter
    config.logger    = ActiveSupport::TaggedLogging.new(logger)
    config.colorize_logging = false
  end
```

## ãƒ—ãƒ©ã‚¤ãƒ™ãƒ¼ãƒˆIPãªCloudSQLæ¥ç¶šã«SSLã‚’ä½¿ç”¨ã™ã‚‹
Serverless VPC Accessã®ã‚³ãƒã‚¯ã‚¿ã‚’é€šã˜ã¦SSLã§ãƒ—ãƒ©ã‚¤ãƒ™ãƒ¼ãƒˆIPãªCloud SQLã«æ¥ç¶šã™ã‚‹å ´åˆ

```yml
development:
  adapter: mysql2
  database: some_database
  host: localhost
  username: rails
  password: password
  sslca: /path/to/rails/root/db/cacert.pem
  sslkey: /path/to/rails/root/db/test01.key
  sslcert: /path/to/rails/root/db/test01.cer
```
â†‘[ã“ã¡ã‚‰](https://cloud.google.com/sql/docs/mysql/connect-instance-cloud-run?hl=ja#expandable-4)ã‚’å‚è€ƒã«äº‹å‰ã«è¨¼æ˜æ›¸ã‚’ä½œæˆã—ã€å‚ç…§ã§ãã‚‹å ´æ‰€ã«æ ¼ç´ã—ã¦ãŠãã¾ã™ã€‚

ãƒ‡ãƒ—ãƒ­ã‚¤ç”¨ã® `deploy.sh` ã®å†…å®¹ã‚’ä»¥ä¸‹ã§ä½œæˆã—ã¦å®Ÿè¡Œã—ã¾ã™ã€‚

```sh
#! /bin/bash

# ã‚¨ãƒ©ãƒ¼ã§å‡¦ç†ä¸­æ–­
set -ex

# dev / stg / prod
export ENV=$1

# CloudSQLæ¥ç¶šå…ˆ
export INSTANCE_CONNECTION_NAME=$2

# MASKTER_KEY
export RAILS_MASTER_KEY=$3

# CloudSQLã®ãƒ‘ã‚¹ãƒ¯ãƒ¼ãƒ‰
export CLOUDSQL_PASSWORD=$4

# CloudSQLã®ãƒ›ã‚¹ãƒˆ
export CLOUDSQL_HOST=$5

# ã‚µãƒ¼ãƒ“ã‚¹å
export SERVICE_NAME=xxxx-${ENV}

gcloud run deploy \
  ${SERVICE_NAME} \
  --min-instances 1 \
  --add-cloudsql-instances ${INSTANCE_CONNECTION_NAME} \
  --set-env-vars "RAILS_ENV=${ENV}" \
  --set-env-vars "RAILS_LOG_TO_STDOUT=true" \
  --set-env-vars "RAILS_MASTER_KEY=${RAILS_MASTER_KEY}" \
  --set-env-vars "CLOUDSQL_USERNAME=xxxx" \
  --set-env-vars "CLOUDSQL_PASSWORD=${CLOUDSQL_PASSWORD}" \
  --set-env-vars "CLOUDSQL_HOST=${CLOUDSQL_HOST}" \
  --vpc-connector=xxxxxx \
  --region asia-northeast1 \
  --source .
```

## ãƒãƒƒãƒ‰ãƒã‚¦ãƒã‚¦
[Cloud Runä¸Šã§Railsã‹ã‚‰Cloud SQLã«æ¥ç¶šã§ããªã„æ™‚ã¯ `host: localhost` ãŒå¿…è¦ã‹ã‚‚](https://zenn.dev/haze_it_ac/articles/2dec7fd345e2bb)
host ã§ã‚¨ãƒ©ãƒ¼ãŒå‡ºã¦ã„ãŸã®ã§ã€â†‘ã®è¨­å®šã‚’ã—ãŸã‚‰ã„ã‘ã¾ã—ãŸ :sparkles: 

# GCPã®PubSubãƒˆãƒªã‚¬ãƒ¼ã§åå¿œã™ã‚‹ã‚µãƒ³ãƒ—ãƒ«ã‚’ãƒ‡ãƒ—ãƒ­ã‚¤ã™ã‚‹
[Pub/Sub ã® push ã«ã‚ˆã‚‹ãƒˆãƒªã‚¬ãƒ¼ Â |Â  Cloud Run ã®ãƒ‰ã‚­ãƒ¥ãƒ¡ãƒ³ãƒˆ Â |Â  Google Cloud](https://cloud.google.com/run/docs/triggering/pubsub-push)
â†‘ã“ã¡ã‚‰ã‚’å‚è€ƒã«è©¦ã—ã¦ã¿ãŸã„ã¨æ€ã„ã¾ã™ã€‚

## ãƒˆãƒ”ãƒƒã‚¯ã®ä½œæˆ
ä»Šå›ä½¿ç”¨ã™ã‚‹ãƒˆãƒ”ãƒƒã‚¯åã¯ `test-topic` ã¨ã—ã¦é€²ã‚ã¦ã„ãã¾ã™ã€‚
CLIã§ãƒˆãƒ”ãƒƒã‚¯ä½œæˆ

```sh
$ gcloud pubsub topics create test-topic
#=> Created topic [projects/[ãƒ—ãƒ­ã‚¸ã‚§ã‚¯ãƒˆå]/topics/test-topic].
```

## Expressã®ã‚µãƒ³ãƒ—ãƒ«ã‚’PubSubç”¨ã«ä¿®æ­£ã™ã‚‹
[ã“ã¡ã‚‰](https://github.com/GoogleCloudPlatform/nodejs-docs-samples/blob/a8de73bc920620429d837eabc8c0fd8e72e905af/run/pubsub/app.js)ã‚’å‚è€ƒã«ä¿®æ­£ã€‚

```js
const express = require('express');
const app = express();

app.use(express.json());

const port = process.env.PORT || 8080;
app.listen(port, () => {
  console.log(`Listening on port ${port}.`);
});

app.post('/', (req, res) => {
  if (!req.body) {
    const msg = 'no Pub/Sub message received';
    console.error(`error: ${msg}`);
    res.status(400).send(`Bad Request: ${msg}`);
    return;
  }
  if (!req.body.message) {
    const msg = 'invalid Pub/Sub message format';
    console.error(`error: ${msg}`);
    res.status(400).send(`Bad Request: ${msg}`);
    return;
  }

  const pubSubMessage = req.body.message;
  const name = pubSubMessage.data
    ? Buffer.from(pubSubMessage.data, 'base64').toString().trim()
    : 'NONE';

  console.log(`Receive ${name}!`);
  res.status(204).send();
});

module.exports = app;
```
æ—©é€Ÿãƒ‡ãƒ—ãƒ­ã‚¤ã™ã‚‹
```sh
$ ./deploy.sh pubsub-sample
```

## Pub/Sub ã¨ Cloud Run ã®é€£æºè¨­å®š
1. ãƒ—ãƒ­ã‚¸ã‚§ã‚¯ãƒˆã§ Pub / Sub èªè¨¼ãƒˆãƒ¼ã‚¯ãƒ³ã‚’ä½œæˆã§ãã‚‹ã‚ˆã†ã«ã™ã‚‹
    ```sh
    $ gcloud projects add-iam-policy-binding $PROJECT_ID \
        --member=serviceAccount:service-${PROJECT_NUMBER}@gcp-sa-pubsub.iam.gserviceaccount.com \
        --role=roles/iam.serviceAccountTokenCreator
    ```
2. Cloud Run ã«ä½œæˆã—ãŸã‚µãƒ¼ãƒ“ã‚¹ã‚’èµ·å‹•ã™ã‚‹ãŸã‚ã®ã‚µãƒ¼ãƒ“ã‚¹ã‚¢ã‚«ã‚¦ãƒ³ãƒˆã‚’ä½œæˆ 
    ```sh
    $ gcloud iam service-accounts create cloud-run-pubsub-invoker \
        --display-name "Cloud Run Pub/Sub Invoker"
    ```

3. ä½œæˆã—ãŸã‚µãƒ¼ãƒ“ã‚¹ã‚¢ã‚«ã‚¦ãƒ³ãƒˆã«ã‚µãƒ¼ãƒ“ã‚¹ã‚’èµ·å‹•ã™ã‚‹æ¨©é™ã‚’ä»˜ä¸
    ```sh
    $ gcloud run services add-iam-policy-binding $SERVICE_NAME \
        --member=serviceAccount:cloud-run-pubsub-invoker@${PROJECT_ID}.iam.gserviceaccount.com \
        --role=roles/run.invoker
    ```

ã‚ã¨ã¯ã€ãƒˆãƒ”ãƒƒã‚¯ã‚’è³¼èª­ã™ã‚‹ã‚µãƒ–ã‚¹ã‚¯ãƒªãƒ—ã‚·ãƒ§ãƒ³ã‚’ã€endpointã‚’cloudrunã®URLã«ã€`auth-service-account` ã‚’â†‘ã§ä½œæˆã—ãŸã‚µãƒ¼ãƒ“ã‚¹ã‚¢ã‚«ã‚¦ãƒ³ãƒˆã‚’è¨­å®šã—ã¦ä½œæˆã—ã¦ã‚„ã‚Œã°OKã§ã™ã€‚

# Firestoreã«ã‚¢ã‚¯ã‚»ã‚¹ã™ã‚‹
Cloud Runã®ä¸­ã‹ã‚‰Firestoreã«ã‚¢ã‚¯ã‚»ã‚¹ã™ã‚‹æ–¹æ³•ã‚’èª¿æŸ»ã€‚
å®Ÿã¯ã€ŒCloud Datastore ãƒ¦ãƒ¼ã‚¶ãƒ¼ã€ã®æ¨©é™ã‚’æŒã¤ã‚µãƒ¼ãƒ“ã‚¹ã‚¢ã‚«ã‚¦ãƒ³ãƒˆã‚’é–¢é€£ã¥ã‘ã¦ã—ã¾ãˆã°ã‚¢ã‚¯ã‚»ã‚¹ã§ãã‚‹ã‚ˆã†ã«ãªã‚Šã¾ã™ã€‚

## å®Ÿè£…ä¾‹
[@google-cloud/firestore](https://www.npmjs.com/package/@google-cloud/firestore)ãƒ‘ãƒƒã‚±ãƒ¼ã‚¸ã‚’è¿½åŠ 

```sh
$ yarn add @google-cloud/firestore
```

ãƒ‘ãƒƒã‚±ãƒ¼ã‚¸è¿½åŠ ã—ãŸã‚‰ãã®ã¾ã¾ç‰¹ã«ãªã«ã‚‚ã—ãªãã¦ã‚‚ä½¿ç”¨ã§ãã¾ã™ã€‚

```ts
import { Firestore } from '@google-cloud/firestore';

const db = new Firestore();

  app.get('/fs', async (req: express.Request, res: express.Response) => {
    const ret = await db.doc('xxxx').get();
    res.json(ret.data());
  });
```


# å‚è€ƒURL
- [Google Cloudãªã‚“ã‚‚ã‚ã‹ã‚‰ãªã„ãƒãƒ³ãŒã€Cloud Runã®å‡„ã•ã‚’ã‚ã‚Œã“ã‚Œèª¿ã¹ã¦ã¿ãŸ | DevelopersIO](https://dev.classmethod.jp/articles/gc-cloud-run/)
- [Google Cloud Run ã‚’ä½¿ã†ã¾ã§ - Qiita](https://qiita.com/massie_g/items/5a9ce514eaa7c460b5e3)
- [Google Cloud Runã«ã‚¢ãƒ—ãƒªã‚’ãƒ‡ãƒ—ãƒ­ã‚¤ã™ã‚‹æ–¹æ³•ã‚’åˆ†ã‹ã‚Šã‚„ã™ãè§£èª¬ã€GCPã€‘ï½œWebã‚¨ãƒ³ã‚¸ãƒ‹ã‚¢ç ”ç©¶å®¤](https://www.engilaboo.com/google-cloudrun-deploy/)
- [Artifact Registry ã¨ Container Analysis ã‚’è©¦ã™ - Qiita](https://qiita.com/suzuyui/items/24e9ba8590deea17c456)
- [Google Cloud Run ã®å€‹äººçš„ãªQ&Aï¼ˆ2021å¹´2æœˆç¾åœ¨ï¼‰ - Qiita](https://qiita.com/nekoshita_yuki/items/95d2d6a889629a557c54)