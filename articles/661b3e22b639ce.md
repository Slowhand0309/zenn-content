---
title: "Cloudflare Workers + Github Actionsã§CI/CD"
emoji: "ğŸŒ©ï¸"
type: "tech" # tech: æŠ€è¡“è¨˜äº‹ / idea: ã‚¢ã‚¤ãƒ‡ã‚¢
topics:
  - "cloudflare"
  - "cloudflareworkers"
  - "githubactions"
  - "cicd"
published: true
---
# æ¦‚è¦

å€‹äººçš„ãªå‚™å¿˜éŒ²ã‚‚å…¼ã­ãŸã€Cloudflare Workersã®ã‚¢ãƒ—ãƒªã‚’Github Actionsã‚’ä½¿ã£ã¦ãƒ‡ãƒ—ãƒ­ã‚¤ã§ãã‚‹ã¾ã§ã®è¨˜äº‹ã«ãªã‚Šã¾ã™ã€‚

# æº–å‚™

äº‹å‰ã«Cloudflareã¸ãƒ‡ãƒ—ãƒ­ã‚¤ã§ãã‚‹ã‚ˆã†ã«API Tokenã‚’å–å¾—ã—ã¾ã™ã€‚

[ã“ã¡ã‚‰](https://dash.cloudflare.com/profile/api-tokens)ã®ãƒšãƒ¼ã‚¸ã¸ç§»å‹•ã—ã€ã€Œãƒˆãƒ¼ã‚¯ãƒ³ã‚’ç”Ÿæˆã™ã‚‹ã€ã‚’é¸æŠã—ã¾ã™ã€‚

![image1.png](/images/661b3e22b639ce/image1.png =600x)

æ¬¡ã«ã€ŒAPI ãƒˆãƒ¼ã‚¯ãƒ³ ãƒ†ãƒ³ãƒ—ãƒ¬ãƒ¼ãƒˆã€ã‹ã‚‰ã€ŒCloudflare Workers ã‚’ç·¨é›†ã™ã‚‹ã€ã‚’é¸æŠã—ã¾ã™ã€‚

![image2.png](/images/661b3e22b639ce/image2.png =600x)

ã€Œã‚¢ã‚«ã‚¦ãƒ³ãƒˆãƒªã‚½ãƒ¼ã‚¹ã€ã‚„ã€Œã‚¾ãƒ¼ãƒ³ãƒªã‚½ãƒ¼ã‚¹ã€ã‚’è‡ªèº«ã®ã‚¢ã‚«ã‚¦ãƒ³ãƒˆã«è¨­å®šã—ã€Œæ¦‚è¦ã«é€²ã‚€ã€ã‚’é¸æŠ

![image3.png](/images/661b3e22b639ce/image3.png =600x)

å†…å®¹ãŒè‰¯ã‘ã‚Œã°ã€Œãƒˆãƒ¼ã‚¯ãƒ³ã‚’ä½œæˆã™ã‚‹ã€ã‚’é¸æŠã—ã€API Tokenã‚’ä½œæˆã—ã¾ã™ã€‚è¡¨ç¤ºã•ã‚ŒãŸAPI Tokenã‚’ä¿ç®¡ã—ã¦ãŠãã¾ã™ã€‚

æ¬¡ã«ã‚¢ã‚«ã‚¦ãƒ³ãƒˆIDã‚‚ç”¨æ„ã—ã¨ãã¾ã™ã€‚ã‚¢ã‚«ã‚¦ãƒ³ãƒˆIDã¯ã€ŒWorkers & Pagesã€>ã€Œæ¦‚è¦ã€ãƒšãƒ¼ã‚¸ãªã©ã®å³å´ã«ã—ã‚Œã£ã¨è¡¨ç¤ºã•ã‚Œã¦ã„ã¾ã™ã€‚

![image4.png](/images/661b3e22b639ce/image4.png =600x)

å–å¾—ã—ãŸAPI Tokenã¨Account ID ã‚’ãƒ‡ãƒ—ãƒ­ã‚¤å¯¾è±¡ã®Githubãƒªãƒã‚¸ãƒˆãƒªã® ã€ŒActions secrets and variablesã€ã«ç™»éŒ²ã—ã¾ã™ã€‚

ã€ŒSettingsã€>ã€ŒSecrets and variablesã€>ã€ŒActionsã€ã‚’é¸æŠã—ã¾ã™ã€‚ã€ŒNew repository secretã€ã‚’é¸æŠã— `CLOUDFLARE_API_TOKEN` `CLOUDFLARE_ACCOUNT_ID` ã‚’ç™»éŒ²ã—ã¾ã™ã€‚

![image5.png](/images/661b3e22b639ce/image5.png =600x)

# Github Actions Workflow ä½œæˆ

ä»¥ä¸‹å†…å®¹ã§ `.github/workflows/deploy.yml` ã‚’ä½œæˆã—ã¾ã™ã€‚(åå‰ã¯é©å®œå¤‰æ›´ã—ã¦ä¸‹ã•ã„)

```yaml
name: Deploy

on:
  push:
    branches:
      - develop
      - main

concurrency:
  group: ${{ github.workflow }}-${{ github.ref_name }}
  cancel-in-progress: true

jobs:
  deploy:
    permissions:
      contents: read
    runs-on: ubuntu-latest
    name: Deploy
    steps:
      - uses: actions/checkout@v4
      - name: Use Node.js
        uses: actions/setup-node@v4
        with:
          node-version: 20.11
          cache: "yarn"
      - run: yarn install
      - name: Deploy
        uses: cloudflare/wrangler-action@v3
        with:
          apiToken: ${{ secrets.CLOUDFLARE_API_TOKEN }}
          accountId: ${{ secrets.CLOUDFLARE_ACCOUNT_ID }}
          command: deploy --env ${{ github.ref_name == 'main' && 'prod' || 'staging' }} --minify src/index.ts

```

`env` ã®ç®‡æ‰€ã‚‚ `main` ãƒ–ãƒ©ãƒ³ãƒã ã¨ `prod` ã€ãã‚Œä»¥å¤–ã ã¨ `staging` ã«ã—ã¦ã„ã‚‹ã®ã§ã™ãŒã€ã“ã¡ã‚‰ã‚‚é©å®œå¤‰æ›´ã—ã¦ã‚‚ã‚‰ãˆã‚Œã°ã¨æ€ã„ã¾ã™ã€‚

ä½•ã‹å¤‰æ•°ã¾ãŸã¯ã‚·ãƒ¼ã‚¯ãƒ¬ãƒƒãƒˆå€¤ã‚’æ¸¡ã—ãŸã„å ´åˆã¯ğŸ‘‡ã®æ§˜ã«ã™ã‚‹ã¨æ¸¡ã™ã“ã¨ãŒã§ãã¾ã™ã€‚

```yaml
      - name: Deploy
        uses: cloudflare/wrangler-action@v3
        with:
          apiToken: ${{ secrets.CLOUDFLARE_API_TOKEN }}
          accountId: ${{ secrets.CLOUDFLARE_ACCOUNT_ID }}
          secrets: |
            SECRET1
            SECRET2
          command: deploy --env ${{ github.ref_name == 'main' && 'prod' || 'staging' }} --minify src/index.ts
        env:
          SECRET1: ${{ secrets.SECRET1 }}
          SECRET2: ${{ secrets.SECRET2 }}
```

# ãƒ‡ãƒ—ãƒ­ã‚¤çµæœ

## ãƒ‡ãƒ—ãƒ­ã‚¤å

ãƒ‡ãƒ—ãƒ­ã‚¤å®Ÿæ–½ã™ã‚‹ã¨ `wrangler.toml` ã® `name` ã¨ `--env` ã§è¨­å®šã—ãŸç’°å¢ƒåãŒä»˜ä¸ã•ã‚ŒãŸåå‰ã§ãƒ‡ãƒ—ãƒ­ã‚¤ã•ã‚Œã¾ã™ã€‚

ä¾‹ãˆã° `wrangler.toml` ã®è¨­å®šãŒ

```toml
name = "my-worker"
compatibility_date = "2024-07-29"
```

ã§ `--env` ãŒ `staging` ã®å ´åˆã€**my-worker-staging**ã®åå‰ã§ãƒ‡ãƒ—ãƒ­ã‚¤ã•ã‚Œã¾ã™ã€‚

![image6.png](/images/661b3e22b639ce/image6.png =600x)
