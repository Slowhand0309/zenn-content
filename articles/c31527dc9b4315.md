---
title: "Flutterã§ã‚³ãƒ­ãƒ—ãƒ¬ã‚¹å›³ã‚’å®Ÿç¾ã™ã‚‹"
emoji: "ğŸ—ºï¸"
type: "tech" # tech: æŠ€è¡“è¨˜äº‹ / idea: ã‚¢ã‚¤ãƒ‡ã‚¢
topics:
  - "flutter"
  - "googlemap"
  - "dart"
  - "ios"
  - "android"
published: true
---
# æ¦‚è¦

ã“ã®è¨˜äº‹ã§ã¯ã€Flutterã‚’ä½¿ç”¨ã—ã¦ã‚³ãƒ­ãƒ—ãƒ¬ã‚¹å›³ï¼ˆåœ°åŸŸã”ã¨ã«çµ±è¨ˆãƒ‡ãƒ¼ã‚¿ã‚’è‰²ã®æ¿ƒæ·¡ã§è¡¨ç¾ã—ãŸåœ°å›³ï¼‰ã‚’å®Ÿè£…ã™ã‚‹æ–¹æ³•ã«ã¤ã„ã¦ã®è§£èª¬è¨˜äº‹ã«ãªã‚Šã¾ã™ã€‚

å…·ä½“çš„ã«ã¯ä»¥ä¸‹ã®å†…å®¹ã«ãªã‚Šã¾ã™

- æ—¥æœ¬ã®éƒ½é“åºœçœŒå¢ƒç•Œãƒ‡ãƒ¼ã‚¿ï¼ˆGeoJSONï¼‰ã®å–å¾—ã¨æœ€é©åŒ–
- Google Maps Flutter ãƒ—ãƒ©ã‚°ã‚¤ãƒ³ã‚’ä½¿ç”¨ã—ãŸåœ°å›³è¡¨ç¤ºã®å®Ÿè£…
- GeoJSONãƒ‡ãƒ¼ã‚¿ã®ãƒ‘ãƒ¼ã‚¹ã¨åœ°å›³ã¸ã®ãƒãƒªã‚´ãƒ³æç”»

ã©ã‚Œãã‚‰ã„ã®ç²¾åº¦ã§ã‚³ãƒ­ãƒ—ãƒ¬ã‚¹å›³ã‚’è¡¨ç¤ºã™ã‚‹ã‹ã¯ã€éƒ½é“åºœçœŒå¢ƒç•Œãƒ‡ãƒ¼ã‚¿ã®ç²¾åº¦ã«ä¾å­˜ã—ã¾ã™ãŒã€ä»Šå›ã¯ã‹ãªã‚Šç°¡ç•¥åŒ–ã—ãŸãƒ‡ãƒ¼ã‚¿ã‚’ä½¿ç”¨ã—ã¦å®Ÿè£…ã—ã¦ã„ããŸã„ã¨æ€ã„ã¾ã™ã€‚

## é–‹ç™ºç’°å¢ƒ

```text
macOS Sonoma ãƒãƒ¼ã‚¸ãƒ§ãƒ³14.6.1 Apple M3
iOS18.1 iPhone 16 Pro simulator
Android API 34 simulator
Flutter SDK version: 3.32.0
Dart SDK version: 3.8.0
```

## ã‚³ãƒ­ãƒ—ãƒ¬ã‚¹å›³ã¨ã¯?

https://visualizing.jp/choropleth-map/

> è¡Œæ”¿åŒºç”»å˜ä½ã«ã‚ˆã£ã¦é›†è¨ˆã•ã‚ŒãŸãƒ‡ãƒ¼ã‚¿ã‚’ã€è‰²ã‚„ãƒ†ã‚¯ã‚¹ãƒãƒ£ã§è¡¨ç¾ã™ã‚‹åœ°å›³

ã‚ˆãå¤©æ°—äºˆå ±ã¨ã‹ã§è¦‹ã‹ã‘ã‚‹ğŸ‘‡ã“ã‚“ãªå›³ã«ãªã‚Šã¾ã™ã€‚

![image1.png](/images/c31527dc9b4315/image1.png =400x)

## ãƒ‡ãƒ¼ã‚¿æº–å‚™

ã¾ãšã¯æ—¥æœ¬ã®éƒ½é“åºœçœŒå¢ƒç•Œãƒ‡ãƒ¼ã‚¿ã‚’å–å¾—ã—ãŸã„ã¨æ€ã„ã¾ã™ã€‚ä»¥ä¸‹ã‹ã‚‰ãƒ‡ãƒ¼ã‚¿ã¯å–å¾—ã§ãã‚‹ã®ã§ã™ãŒã€å…¨å›½ã ã¨å®¹é‡ãŒä»¤å’Œ6å¹´ç‰ˆã ã¨ `583MB` ã‚‚ã‚ã‚Šã¾ã™ã€‚ãã®ä¸­ã®ã€ŒXXXX_prefecture.geojsonã€ãƒ•ã‚¡ã‚¤ãƒ«ãŒ `336.8MB` ã¨ãªã£ã¦ã„ã¾ã™ã€‚

https://nlftp.mlit.go.jp/ksj/gml/datalist/KsjTmplt-N03-2024.html

ãã“ã§ä»¥ä¸‹ã®ã‚µã‚¤ãƒˆã§ç°¡ç•¥åŒ–ã—ã¦ã‚µã‚¤ã‚ºã‚’åœ§ç¸®ã—ãŸã„ã¨æ€ã„ã¾ã™ã€‚

https://mapshaper.org/

ğŸ‘†ã®ã‚µã‚¤ãƒˆã§ãƒ€ãƒ³ãƒ­ãƒ¼ãƒ‰ã—ãŸãƒ•ã‚¡ã‚¤ãƒ«ã®ä¸­ã‹ã‚‰ã€ŒXXXX_prefecture.geojsonã€ã¨ãªã£ã¦ã„ã‚‹ãƒ•ã‚¡ã‚¤ãƒ«ã‚’ã‚¢ãƒƒãƒ—ãƒ­ãƒ¼ãƒ‰ã—ã¾ã™ã€‚

å³ä¸Šã®ã€ŒSimplifyã€>ã€ŒApplyã€ã‚’é¸æŠã—ã¾ã™ã€‚

![image2.png](/images/c31527dc9b4315/image2.png)

ä¸Šéƒ¨ã®ã‚¹ãƒ©ã‚¤ãƒ‰ãƒãƒ¼ã‚’èª¿æ•´ã—ã€ã©ã‚Œãã‚‰ã„ã–ã£ãã‚Šã®éƒ½é“åºœçœŒå¢ƒç•Œãƒ‡ãƒ¼ã‚¿ã«ã™ã‚‹ã‹èª¿æ•´ã—ã¾ã™ã€‚ä»Šå›ã¯ãã“ã¾ã§è©³ç´°ãªãƒ‡ãƒ¼ã‚¿ã˜ã‚ƒãªãã¦è‰¯ã„ã®ã§ã€Œ0.01%ã€ã«ã—ã¾ã—ãŸã€‚

![image3.png](/images/c31527dc9b4315/image3.png)

èª¿æ•´ã§ããŸã‚‰å³ä¸Šã®ã€ã€ŒExportã€>ã€ŒGeoJSONã€ã«ãƒã‚§ãƒƒã‚¯ã‚’å…¥ã‚Œã¦ã€ŒExportã€ã‚’ã‚¯ãƒªãƒƒã‚¯ã—ã¦åœ§ç¸®ã—ãŸãƒ‡ãƒ¼ã‚¿ã‚’ã€Œprefecture.jsonã€ã¨ã—ã¦ãƒ€ã‚¦ãƒ³ãƒ­ãƒ¼ãƒ‰ã—ã¨ãã¾ã™ã€‚

æ‰‹å…ƒã®ç’°å¢ƒã ã¨ `18.5MB` ã¾ã§åœ§ç¸®ã§ãã¦ã„ã¾ã—ãŸã€‚

ãŸã ã€ä¸­èº«ã‚’è¦‹ã‚‹ã¨ `geometry` ãŒ `null` ã®ã‚‚ã®ãŒå¤§é‡ã«å«ã¾ã‚Œã¦ã„ã¾ã—ãŸã€‚LLM

ã®è¿”ç­”ã§ã¯ã€Œä½ç½®æƒ…å ±ã‚’æŒãŸãªã„ï¼ˆï¼unlocatedï¼‰æœ‰åŠ¹ãª Featureã€ã§ã¯ã‚ã‚‹ãŒåœ°å›³æç”»ã‚„ç©ºé–“è§£æã§ã¯åº§æ¨™ãŒãªã„ã¨å½¹ã«ç«‹ãŸãªã„ãŸã‚ã€å¤šãã®ãƒ¯ãƒ¼ã‚¯ãƒ•ãƒ­ãƒ¼ã§ã¯é™¤å¤–å¯¾è±¡ã«ãªã‚Šã¾ã™ã€ã¨ã®äº‹ã§ã€å®Ÿéš›ã«å†åº¦ãƒ‡ãƒ¼ã‚¿ã‚’èª­ã¿è¾¼ã¾ã›ã¦ã‚‚å•é¡Œãªã•ãã†ã ã£ãŸã®ã§å‰Šé™¤ã—ã¨ãã¾ã™ã€‚

jq ã‚³ãƒãƒ³ãƒ‰ã‚’ç”¨ã„ã¦ã€ ä»¥ä¸‹ã®æ§˜ã«`geometry` ãŒ `null` ã®ã‚‚ã®ã‚’é™¤å¤–ã—ã¦ã‚„ã‚Šã¾ã™ã€‚

https://jqlang.org/

ğŸ‘‡ã‚’å®Ÿè¡Œã—ã¦ã‚„ã‚‹ã¨ `158KB` ã¾ã§åœ§ç¸®ã§ãã¾ã—ãŸï¼

```bash
jq '.features |= map(select(.geometry != null))' prefecture.json > prefectures.geojson
```

## ã¾ãšã¯æ™®é€šã«Google Mapsè¡¨ç¤º

æ‰‹å‰å‘³å™Œã§ã™ãŒã€ä»¥ä¸‹ã‚’å…ƒã« [google_maps_flutter](https://pub.dev/packages/google_maps_flutter) ã‚’ã‚¤ãƒ³ã‚¹ãƒˆãƒ¼ãƒ«ã—ã¦API Keyã‚’è¨­å®šã—ã¦Google Maps ã‚’å˜ç´”ã«è¡¨ç¤ºã•ã›ã¾ã™ã€‚

https://zenn.dev/slowhand/articles/f4e4e092f9b72b

- google_maps_flutter

    ```yaml
    dependencies:
      google_maps_flutter: ^2.12.2
    ```

- `choropleth_map.dart` ã‚’ä»¥ä¸‹å†…å®¹ã§ä½œæˆã—ã¾ã™

```dart
import 'dart:async';

import 'package:flutter/material.dart';
import 'package:google_maps_flutter/google_maps_flutter.dart';

class ChoroplethMap extends StatefulWidget {
  const ChoroplethMap({super.key});

  @override
  State<ChoroplethMap> createState() => ChoroplethMapState();
}

class ChoroplethMapState extends State<ChoroplethMap> {
  final Completer<GoogleMapController> _controller =
      Completer<GoogleMapController>();

  static const CameraPosition _initialCameraPosition = CameraPosition(
    target: LatLng(35.68123428932672, 139.76714355230686),
    zoom: 14.4746,
  );

  @override
  Widget build(BuildContext context) {
    return Scaffold(
      appBar: AppBar(title: const Text('Choropleth Map')),
      body: GoogleMap(
        mapType: MapType.normal,
        initialCameraPosition: _initialCameraPosition,
        onMapCreated: (GoogleMapController controller) {
          _controller.complete(controller);
        },
      ),
    );
  }
}
```

å®Ÿè¡Œã™ã‚‹ã¨ğŸ‘‡ã®ã‚ˆã†ãªåœ°å›³ãŒè¡¨ç¤ºã•ã‚Œã¦ã‚Œã°OKã§ã™ã€‚

![image4.png](/images/c31527dc9b4315/image4.png =300x)

## GeoJSONã®ãƒ‘ãƒ¼ã‚¹å‡¦ç†

å…ˆã»ã©ãƒ€ã‚¦ãƒ³ãƒ­ãƒ¼ãƒ‰ã—ãŸGeoJSONãƒ•ã‚¡ã‚¤ãƒ« (prefectures.geojson)ã‚’ `assets/prefectures.geojson` ã«ç½®ãã¾ã™ã€‚(assetsãƒ‡ã‚£ãƒ¬ã‚¯ãƒˆãƒªã¯ç„¡ã‘ã‚Œã°ä½œæˆã—ã¨ãã¾ã™)

`pubspec.yaml` ã«ä»¥ä¸‹ã‚’è¿½åŠ ã—ã¾ã™ã€‚

```yaml
flutter:
  # ...
  assets:
    - assets/prefectures.geojson
```

ä»Šå›ãƒ‘ãƒ¼ã‚¹ç”¨ã®ãƒ‘ãƒƒã‚±ãƒ¼ã‚¸ã¨ã—ã¦ `geojson_vi` ã‚’ä½¿ã„ã¾ã™ã€‚

https://pub.dev/packages/geojson_vi

ã“ã®ãƒ‘ãƒƒã‚±ãƒ¼ã‚¸ã¯ GeoJSON Formatã®æ¨™æº–åŒ–è¦ç´„ã® `RFC 7946` ã«æº–æ‹ ã—ã¦ã„ã‚‹ãƒ‘ãƒƒã‚±ãƒ¼ã‚¸ã«ãªã‚Šã¾ã™ã€‚

https://tex2e.github.io/rfc-translater/html/rfc7946.html

`pubspec.yaml` ã«ä»¥ä¸‹ã‚’è¿½åŠ ã—ã¾ã™ã€‚

```yaml
dependencies:
  geojson_vi: ^2.2.5
```

æ¬¡ã«ã€GeoJSONãƒ•ã‚¡ã‚¤ãƒ«ã‚’Assetsã‹ã‚‰èª­ã¿è¾¼ã‚“ã§ `google_maps_flutter`ã®Polygonã«ã‚»ãƒƒãƒˆã§ãã‚‹å½¢ã«å¤‰æ›ã™ã‚‹å‡¦ç†ã‚’å®Ÿè£…ã—ã¾ã™ã€‚

- `geojson_polygon_loader.dart` ã‚’ä»¥ä¸‹å†…å®¹ã§ä½œæˆã—ã¾ã™

```dart
import 'dart:ui' show Color;

import 'package:flutter/services.dart' show rootBundle;
import 'package:geojson_vi/geojson_vi.dart';
import 'package:google_maps_flutter/google_maps_flutter.dart';

/// GeoJSONï¼ˆFeatureCollectionï¼‰ã‹ã‚‰GoogleMapsç”¨Polygonç¾¤ã‚’ç”Ÿæˆ
///
/// [assetPath] ã‚¢ã‚»ãƒƒãƒˆãƒ•ã‚¡ã‚¤ãƒ«ã®ãƒ‘ã‚¹
/// [fillColor] ãƒãƒªã‚´ãƒ³ã®å¡—ã‚Šã¤ã¶ã—è‰²ï¼ˆãƒ‡ãƒ•ã‚©ãƒ«ãƒˆ: åŠé€æ˜ã®é’ï¼‰
/// [strokeColor] ãƒãƒªã‚´ãƒ³ã®æ ç·šè‰²ï¼ˆãƒ‡ãƒ•ã‚©ãƒ«ãƒˆ: é’ï¼‰
/// [strokeWidth] ãƒãƒªã‚´ãƒ³ã®æ ç·šå¹…ï¼ˆãƒ‡ãƒ•ã‚©ãƒ«ãƒˆ: 1ï¼‰
Future<Set<Polygon>> loadPolygonsFromGeoJson({
  required String assetPath,
  Color fillColor = const Color(0x55377EF6),
  Color strokeColor = const Color(0xFF377EF6),
  int strokeWidth = 1,
}) async {
  // â¶ GeoJSONã‚’æ–‡å­—åˆ—ã§å–å¾—
  final geojsonStr = await rootBundle.loadString(assetPath);
  return parseGeoJsonToPolygons(
    geojsonStr,
    fillColor: fillColor,
    strokeColor: strokeColor,
    strokeWidth: strokeWidth,
  );
}

/// GeoJSONæ–‡å­—åˆ—ã‹ã‚‰GoogleMapsç”¨Polygonç¾¤ã‚’ç”Ÿæˆ
///
/// [geojsonStr] GeoJSONæ–‡å­—åˆ—
/// [fillColor] ãƒãƒªã‚´ãƒ³ã®å¡—ã‚Šã¤ã¶ã—è‰²
/// [strokeColor] ãƒãƒªã‚´ãƒ³ã®æ ç·šè‰²
/// [strokeWidth] ãƒãƒªã‚´ãƒ³ã®æ ç·šå¹…
Set<Polygon> parseGeoJsonToPolygons(
  String geojsonStr, {
  Color fillColor = const Color(0x55377EF6),
  Color strokeColor = const Color(0xFF377EF6),
  int strokeWidth = 1,
}) {
  // â· ãƒ‘ãƒ¼ã‚¹ï¼ˆFeatureCollectionã¨ã—ã¦å–å¾—ï¼‰
  final collection = GeoJSONFeatureCollection.fromJSON(geojsonStr);

  // â¸ Polygonã¸å¤‰æ›
  final polygons = <Polygon>{};
  for (final feature in collection.features) {
    // featureã‚„geometryãŒnullã®å ´åˆã¯ã‚¹ã‚­ãƒƒãƒ—
    final geom = feature?.geometry;
    if (geom == null) continue;

    // å˜ä¸€ãƒãƒªã‚´ãƒ³
    if (geom is GeoJSONPolygon) {
      _addPolygon(
        geom.coordinates,
        polygons,
        feature?.id,
        fillColor: fillColor,
        strokeColor: strokeColor,
        strokeWidth: strokeWidth,
      );
    }

    // ãƒãƒ«ãƒãƒãƒªã‚´ãƒ³
    if (geom is GeoJSONMultiPolygon) {
      for (int i = 0; i < geom.coordinates.length; i++) {
        final ring = geom.coordinates[i];
        _addPolygon(
          ring,
          polygons,
          feature?.id != null
              ? '${feature?.id}_$i'
              : 'multipolygon_$i', // idãŒnullã®å ´åˆã®ãƒ•ã‚©ãƒ¼ãƒ«ãƒãƒƒã‚¯
          fillColor: fillColor,
          strokeColor: strokeColor,
          strokeWidth: strokeWidth,
        );
      }
    }
  }

  return polygons;
}

/// åº§æ¨™é…åˆ—ã‚’LatLngã«å¤‰æ›ã—ã¦Polygonã‚’ç”Ÿæˆ
void _addPolygon(
  List<List<List<double>>> rings,
  Set<Polygon> polygons,
  String? id, {
  required Color fillColor,
  required Color strokeColor,
  required int strokeWidth,
}) {
  if (rings.isEmpty) return;

  final exterior = rings.first; // å¤–å‘¨ãƒªãƒ³ã‚°

  // åº§æ¨™ãŒä¸æ­£ãªå ´åˆã¯ã‚¹ã‚­ãƒƒãƒ—
  if (exterior.length < 3) return;

  final points = exterior
      .map((xy) {
        // åº§æ¨™ã®å¦¥å½“æ€§ãƒã‚§ãƒƒã‚¯
        if (xy.length < 2) return null;
        return LatLng(xy[1], xy[0]); // [lon,lat] â†’ LatLng(lat,lon)
      })
      .where((point) => point != null)
      .cast<LatLng>()
      .toList();

  // æœ€ä½3ç‚¹å¿…è¦
  if (points.length < 3) return;

  polygons.add(
    Polygon(
      polygonId: PolygonId(id ?? 'polygon_${polygons.length}'),
      points: points,
      fillColor: fillColor,
      strokeColor: strokeColor,
      strokeWidth: strokeWidth,
    ),
  );
}
```

- æ¬¡ã«`choropleth_map.dart` ã‚’ä¿®æ­£ã—ã¾ã™

```dart
import 'dart:async';

import 'package:flutter/material.dart';
import 'package:google_map_flutter_sample/functions/geojson_polygon_loader.dart';
import 'package:google_maps_flutter/google_maps_flutter.dart';

class ChoroplethMap extends StatefulWidget {
  const ChoroplethMap({super.key});

  @override
  State<ChoroplethMap> createState() => ChoroplethMapState();
}

class ChoroplethMapState extends State<ChoroplethMap> {
  final Completer<GoogleMapController> _controller =
      Completer<GoogleMapController>();

  static const CameraPosition _initialCameraPosition = CameraPosition(
    target: LatLng(35.68123428932672, 139.76714355230686),
    zoom: 14.4746,
  );

  Set<Polygon> _polygons = {};
  bool _isLoading = true;

  @override
  void initState() {
    super.initState();
    _loadPolygons();
  }

  /// GeoJSONã‹ã‚‰polygonã‚’èª­ã¿è¾¼ã‚€
  Future<void> _loadPolygons() async {
    try {
      final polygons = await loadPolygonsFromGeoJson(
        assetPath: 'assets/prefectures.geojson',
        fillColor: const Color(0x44377EF6),
        strokeColor: const Color(0xFF377EF6),
        strokeWidth: 2,
      );

      if (mounted) {
        setState(() {
          _polygons = polygons;
          _isLoading = false;
        });
      }
    } catch (e) {
      debugPrint('ãƒãƒªã‚´ãƒ³ã®èª­ã¿è¾¼ã¿ã«å¤±æ•—ã—ã¾ã—ãŸ: $e');
      if (mounted) {
        setState(() {
          _isLoading = false;
        });
      }
    }
  }

  @override
  Widget build(BuildContext context) {
    return Scaffold(
      appBar: AppBar(
        title: const Text('Choropleth Map'),
      ),
      body: _isLoading
          ? const Center(
              child: CircularProgressIndicator(),
            )
          : GoogleMap(
              mapType: MapType.normal,
              initialCameraPosition: _initialCameraPosition,
              polygons: _polygons,
              onMapCreated: (GoogleMapController controller) {
                _controller.complete(controller);
              },
            ),
    );
  }
}
```

å®Ÿè¡Œã™ã‚‹ã¨ğŸ‘‡ã®æ§˜ãªã‚³ãƒ­ãƒ—ãƒ¬ã‚¹å›³ãŒè¡¨ç¤ºã•ã‚Œã‚‹ã‹ã¨æ€ã„ã¾ã™ã€‚

![image5.gif](/images/c31527dc9b4315/image5.gif =300x)

# å‚è€ƒURL

https://note.com/kazukio/n/n974da9bb1ffb

https://github.com/piuccio/open-data-jp-prefectures-geojson
