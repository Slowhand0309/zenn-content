---
title: "Cloudflare Workers ã‚’ä½¿ã£ã¦ãƒ©ãƒ³ãƒ€ãƒ ãªSpotifyã®ãƒ—ãƒ¬ã‚¤ãƒªã‚¹ãƒˆã‚’è¿”ã™"
emoji: "ğŸ¼"
type: "tech" # tech: æŠ€è¡“è¨˜äº‹ / idea: ã‚¢ã‚¤ãƒ‡ã‚¢
topics:
  - "Cloudflare"
  - "CDN"
  - "Spotify"
published: true
---

# ã¯ã˜ã‚ã«

Cloudflare Workers ã‚’ä½¿ã£ã¦å­¦ç¿’ç”¨ã«ä½•ã‹ä½œã‚ã†ã¨æ€ã„ã€Spotifyã®ãƒ—ãƒ¬ã‚¤ãƒªã‚¹ãƒˆã‚’ãƒ©ãƒ³ãƒ€ãƒ ã§è¿”ã™ã‚‚ã®ã‚’ä½œã£ã¦ã¿ã¾ã—ãŸã€‚

å‡¦ç†ã®å¤§ã¾ã‹ãªæµã‚Œã¨ã—ã¦ã¯ä»¥ä¸‹ã«ãªã‚Šã¾ã™ã€‚

1. Workers KVã«ä¿å­˜ã—ã¦ã„ã‚‹æ¤œç´¢ãƒ¯ãƒ¼ãƒ‰ã®ä¸­ã‹ã‚‰ãƒ©ãƒ³ãƒ€ãƒ ãªãƒ¯ãƒ¼ãƒ‰ã‚’é¸ã³å‡ºã™
2. é¸ã‚“ã ãƒ¯ãƒ¼ãƒ‰ã§ãƒ—ãƒ¬ã‚¤ãƒªã‚¹ãƒˆã‚’Spotify APIã§æ¤œç´¢ã™ã‚‹
3. å¾—ã‚‰ã‚ŒãŸè¤‡æ•°ã®ãƒ—ãƒ¬ã‚¤ãƒªã‚¹ãƒˆã‹ã‚‰ã•ã‚‰ã«ãƒ©ãƒ³ãƒ€ãƒ ã«ä¸€ã¤ã‚’é¸ã³ã€ãã‚Œã‚’Responseã¨ã—ã¦è¿”ã™

ã‚ãã¾ã§å­¦ç¿’ç›®çš„ã§ä½œæˆã—ãŸãŸã‚ã€ãƒ—ãƒ¬ã‚¤ãƒªã‚¹ãƒˆã®URIã‚’è¿”ã™ã ã‘ã¨ã„ã†ã‚·ãƒ³ãƒ—ãƒ«ãªã‚‚ã®ã«ãªã£ã¦ã„ã¾ã™ã€‚

## ã‚´ãƒ¼ãƒ«

è¿”ã£ã¦ããŸãƒ—ãƒ¬ã‚¤ãƒªã‚¹ãƒˆã®URIã‚’ã€Spotifyã®ãƒ‡ã‚¹ã‚¯ãƒˆãƒƒãƒ—ã‚¢ãƒ—ãƒªã§é–‹ã„ã¦ãƒ©ãƒ³ãƒ€ãƒ ãªãƒ—ãƒ¬ã‚¤ãƒªã‚¹ãƒˆã«ãªã£ã¦ã„ã‚Œã°OKã¨ã„ã†ã‚´ãƒ¼ãƒ«ã«å‘ã‹ã£ã¦é€²ã‚ã¦è¡ŒããŸã„ã¨æ€ã„ã¾ã™ã€‚

![image1](/images/6f598ea28d82b0/image1.gif =800x)

## Cloudflare workersã¨ã¯

> Cloudflareã®CDNã®ã‚¨ãƒƒã‚¸ã‚µãƒ¼ãƒã§å®Ÿè¡Œã•ã‚Œã‚‹ã‚µãƒ¼ãƒãƒ¬ã‚¹å®Ÿè¡Œç’°å¢ƒ(FaaS)
ã¾ãŸã€CloudFlare workersã§ä½¿ãˆã‚‹ã‚­ãƒ£ãƒƒã‚·ãƒ¥ã¯ Workers KVã€Durable Objectsã€Cache APIã®3ã¤

# ç’°å¢ƒæ§‹ç¯‰ã‚„æº–å‚™

```text
- node: v18.16.0
- wrangler: v2.15.1
```

## 1. Spotify URIã«ã¤ã„ã¦

Spotifyã«ã¯æ›²ã‚„ãƒ—ãƒ¬ã‚¤ãƒªã‚¹ãƒˆãªã©ã«é–¢é€£ã™ã‚‹ä»¥ä¸‹ã®ã‚ˆã†ãªURIãŒå­˜åœ¨ã—ã¾ã™ã€‚

`spotify:artist:xxxxxxxxxxxxxxxx`

Spotifyãƒ‡ã‚¹ã‚¯ãƒˆãƒƒãƒ—ã‚¢ãƒ—ãƒªãŒã‚¤ãƒ³ã‚¹ãƒˆãƒ¼ãƒ«ã•ã‚Œã¦ã„ã‚‹Macã®å ´åˆã€Terminalä¸Šã§ `open spotify:artist:xxxxxxxxxxxxxxxx` ã¨å…¥åŠ›ã™ã‚‹ã“ã¨ã§ã€Spotifyã‚¢ãƒ—ãƒªãŒå¯¾è±¡ã®ã‚³ãƒ³ãƒ†ãƒ³ãƒ„ã‚’é–‹ã„ã¦ãã‚Œã¾ã™ã€‚ã“ã®æ‰‹é †ã«å¾“ã„ã€ãƒ¬ã‚¹ãƒãƒ³ã‚¹ã®URIã‚’Macã®Spotifyã‚¢ãƒ—ãƒªã§ç¢ºèªã—ãªãŒã‚‰ä½œæ¥­ã‚’é€²ã‚ã¦ã„ã“ã†ã¨æ€ã„ã¾ã™ã€‚

[What's a Spotify URI? - The Spotify Community](https://community.spotify.com/t5/FAQs/What-s-a-Spotify-URI/ta-p/919201)

## 2. Cloudflare Workersã®ç’°å¢ƒæ§‹ç¯‰

### 2-1. ã‚µã‚¤ãƒ³ã‚¢ãƒƒãƒ—ã—ã¦æœ€åˆã®Workerã‚’ä½œæˆã—ã¦ã¿ã‚‹

æ—©é€Ÿ Cloudflare Workers ã®ç’°å¢ƒã‚’æ§‹ç¯‰ã—ã¦ã„ããŸã„ã¨æ€ã„ã¾ã™ã€‚

[ã“ã¡ã‚‰](https://dash.cloudflare.com/sign-up)ã®ãƒšãƒ¼ã‚¸ã‹ã‚‰ã‚µã‚¤ãƒ³ã‚¢ãƒƒãƒ—ã—ãƒ€ãƒƒã‚·ãƒ¥ãƒœãƒ¼ãƒ‰ã® `Workers` ãƒšãƒ¼ã‚¸ã«ã„ãã¨ä»¥ä¸‹ã®æ§˜ã«ãªã£ã¦ã„ã‚‹ã®ã§æ—©é€Ÿãƒ€ãƒƒã‚·ãƒ¥ãƒœãƒ¼ãƒ‰ä¸Šã§Workerã‚’ä½œæˆã—ã¦ã¿ã¾ã™ã€‚

![image2](/images/6f598ea28d82b0/image2.png =400x)

ä½œæˆã—ãŸå¾ŒIDEã£ã½ã„ç”»é¢ãŒè¡¨ç¤ºã•ã‚Œã¾ã—ãŸã€‚ã“ã“ã§ã‚‚ç·¨é›†ã€å†ãƒ‡ãƒ—ãƒ­ã‚¤ãªã‚“ã‹ãŒã§ãã‚‹ã¿ãŸã„ã§ã™ã­ ğŸ‘€

![image3](/images/6f598ea28d82b0/image3.png =400x)

ä¸€æ—¦ `Workers` ãƒšãƒ¼ã‚¸ã«æˆ»ã£ã¦ã¿ã‚‹ã¨ã‚µãƒ–ãƒ‰ãƒ¡ã‚¤ãƒ³ãŒå¤‰æ›´ã§ãã‚‹ã‚ˆã†ã«ãªã£ã¦ã„ã¾ã—ãŸ âœ¨

![image4](/images/6f598ea28d82b0/image4.png =400x)

ã“ã“ã‹ã‚‰ãŠå¥½ã¿ã®ã‚µãƒ–ãƒ‰ãƒ¡ã‚¤ãƒ³ã‚’è¨­å®šã§ãã‚‹ã‚ˆã†ã§ã™ã€‚

### 2-2. wranglerã‚’ä½¿ã£ã¦ãƒ‡ãƒ—ãƒ­ã‚¤ã—ã¦ã¿ã‚‹

CLIãƒ„ãƒ¼ãƒ« wrangler ãŒæä¾›ã•ã‚Œã¦ã„ã‚‹ã®ã§ãã¡ã‚‰ã‚’ä½¿ã£ã¦é€²ã‚ã¦ã¿ãŸã„ã¨æ€ã„ã¾ã™ã€‚

[Commands Â· Cloudflare Workers docs](https://developers.cloudflare.com/workers/wrangler/commands/)

ã“ã“ã‹ã‚‰ã¯Dockerã‚’ä½¿ã£ã¦ç’°å¢ƒæ§‹ç¯‰ã—ã¦ã„ãã¾ã™ã€‚
ã¾ãšã¯ãƒ—ãƒ­ã‚¸ã‚§ã‚¯ãƒˆç›´ä¸‹ã«ä»¥ä¸‹å†…å®¹ã®Dockerfileã‚’ä½œæˆã—ã¾ã™ã€‚

```docker
FROM node:18-alpine
WORKDIR /usr/src/app

RUN apk update && \
    apk add git vim bash curl

RUN npm install -g wrangler
```

æ¬¡ã«ä»¥ä¸‹å†…å®¹ã§ `docker-compose.yml` ã‚’ä½œæˆã—ã¾ã™ã€‚

```yaml
version: '3.3'

services:
  worker:
    build: .
    image: wrangler
    container_name: "wrangler"
    tty: true
    stdin_open: true
    volumes:
      - .:/usr/src/app
      - wrangler_config:/root/.config/.wrangler
    ports:
      - '8976:8976'
      - '8787:8787'
    entrypoint: bash

volumes:
  wrangler_config:
```

ã‚³ãƒ³ãƒ†ãƒŠã‚’èµ·å‹•ã•ã›ã€ã‚³ãƒ³ãƒ†ãƒŠå†…ã§ä»¥ä¸‹ã‚³ãƒãƒ³ãƒ‰ã‚’å®Ÿæ–½ã— Cloudflare ã«ãƒ­ã‚°ã‚¤ãƒ³ã—ã¾ã™ã€‚

```bash
wrangler login
```

ãƒ–ãƒ©ã‚¦ã‚¶ãŒé–‹ã‘ãªã„ã®ã§ **`Failed to open`** ã¨è¡¨ç¤ºã•ã‚Œã‚‹ã¾ã™ãŒã€URLã‚’ã‚³ãƒ”ãƒ¼ã—ã¦ãƒ–ãƒ©ã‚¦ã‚¶ã‚’èµ·å‹•ã•ã›ã‚‹ã¨ä»¥ä¸‹ã®ç¢ºèªç”»é¢ãŒè¡¨ç¤ºã•ã‚Œã€ã€ŒAllowã€ã‚’é¸æŠã™ã‚‹äº‹ã§ãƒ­ã‚°ã‚¤ãƒ³ã™ã‚‹äº‹ãŒã§ãã¾ã™ã€‚

![image5](/images/6f598ea28d82b0/image5.png =350x)

`wrangler whoami` ã‚³ãƒãƒ³ãƒ‰ã‚’å®Ÿè¡Œã—è‡ªèº«ã®ã‚¢ã‚«ã‚¦ãƒ³ãƒˆãŒè¡¨ç¤ºã•ã‚Œã¦ã„ã‚Œã°OKã§ã™ã€‚

### 2-3. ãƒ—ãƒ­ã‚¸ã‚§ã‚¯ãƒˆã®åˆæœŸåŒ–

```bash
$ wrangler init hello
â›…ï¸ wrangler 2.15.1 (update available 2.16.0)
-------------------------------------------------------
Using npm as package manager.
âœ¨ Created hello/wrangler.toml
âœ” No package.json found. Would you like to create one? â€¦ yes
âœ¨ Created hello/package.json
âœ” Would you like to use TypeScript? â€¦ yes
âœ¨ Created hello/tsconfig.json
âœ” Would you like to create a Worker at hello/src/index.ts? â€º Fetch handler
âœ¨ Created hello/src/index.ts
âœ” Would you like us to write your first test with Vitest? â€¦ no
```

â†‘ ä»Šå›ã¯ä¸€æ—¦Vitestã¯ãªã—ã§ã€Fetch handlerã¨ã—ã¦ä½œæˆã—ã¦ã¿ã¾ã—ãŸã€‚
æ—©é€Ÿèµ·å‹•ã—ã¦ã¿ã¾ã™ã€‚

```bash
cd hello
npm run start
```

èµ·å‹•å¾Œã€[http://localhost:8787/](http://localhost:8787/) ã«ã‚¢ã‚¯ã‚»ã‚¹ã—ã¦ã¿ã‚‹ã¨ã€ŒHello World!ã€ãŒè¿”ã£ã¦ãã‚‹ã¯ãšã§ã™ã€‚
ä»Šåº¦ã¯ãƒ‡ãƒ—ãƒ­ã‚¤ã—ã¦ã¿ã¾ã™ã€‚

```bash
cd hello
npm run deploy
```

â†‘ã“ã‚Œã§ã‚µã‚¯ãƒƒã¨ãƒ‡ãƒ—ãƒ­ã‚¤ã•ã‚Œã€ãƒ‡ãƒ—ãƒ­ã‚¤ã•ã‚ŒãŸURLã«ã‚¢ã‚¯ã‚»ã‚¹ã™ã‚‹ã¨åŒã˜ã€ŒHello World!ã€ãŒè¿”ã£ã¦ãã‚‹ã¯ãšã‹ã¨æ€ã„ã¾ã™ã€‚
ã¡ãªã¿ã«ãƒ‡ãƒ—ãƒ­ã‚¤ã•ã‚ŒãŸã‚‚ã®ã‚’å‰Šé™¤ã™ã‚‹å ´åˆã¯ `wrangler delete` ã§å‰Šé™¤ã§ãã¾ã™ã€‚
ä¸€æ—¦ã“ã“ã¾ã§ã§Cloudflare Workersã‚’å‹•ã‹ã™ç’°å¢ƒãŒã§ãã¾ã—ãŸ!

# å®Ÿè£…

## 1. ã¾ãšã¯Cloudflare Workersã‹ã‚‰è¿”å´ã•ã‚ŒãŸURIã‚’ã‚¢ãƒ—ãƒªã§é–‹ã„ã¦ã¿ã‚‹

### 1-1. ã‚»ãƒƒãƒˆã‚¢ãƒƒãƒ—

å…ˆç¨‹ã® `hello` ãƒ‡ã‚£ãƒ¬ã‚¯ãƒˆãƒªã‚’å‰Šé™¤ã—ã€ä»¥ä¸‹ã‚³ãƒãƒ³ãƒ‰ã§ãƒ—ãƒ­ã‚¸ã‚§ã‚¯ãƒˆãƒ«ãƒ¼ãƒˆç›´ä¸‹ã«srcãƒ‡ã‚£ãƒ¬ã‚¯ãƒˆãƒªã‚’ä½œæˆã—ã¾ã™ã€‚

```bash
wrangler init .
```

æ¬¡ã« `docker-compose.yml` ã«ä»¥ä¸‹ã‚’è¿½åŠ ã—ã¾ã™ã€‚

```yaml
version: '3.3'

services:
  worker:
    build: .
    image: wrangler
    container_name: "wrangler"
    command:
      - ./bin/start_dev_server.sh # è¿½åŠ 
    tty: true
    stdin_open: true
    environment:
      - RUN_WRANGLER_DEV=${RUN_WRANGLER_DEV:-1} # è¿½åŠ 
    volumes:
      - .:/usr/src/app
      - wrangler_config:/root/.config/.wrangler
      - modules_data:/usr/src/app/node_modules # è¿½åŠ 
    ports:
      - '8976:8976'
      - '8787:8787'

volumes:
  wrangler_config:
  modules_data: # è¿½åŠ 
```

æ¬¡ã« `bin/start_dev_server.sh` ã‚’ä»¥ä¸‹å†…å®¹ã§ä½œæˆã—ã¾ã™ã€‚

```bash
#!/bin/bash

# ã‚¨ãƒ©ãƒ¼ã§å‡¦ç†ä¸­æ–­
set -ex

npm install
if [ "${RUN_WRANGLER_DEV}" = "1" ] ; then
  npm run start
else
  echo "[NOT RUN WRANGLER DEV]"
  tail -f /dev/null
fi
```

`npm run start` ã‚’è¡Œã‚ãš `wrangler login` ãªã©ã®æ“ä½œã‚’å®Ÿæ–½ã™ã‚‹ã‚±ãƒ¼ã‚¹ã‚‚è€ƒæ…®ã—ã¦ `RUN_WRANGLER_DEV` ã®ç’°å¢ƒå¤‰æ•°ã§serverèµ·å‹•ã®ON/OFFã‚’åˆ‡ã‚Šæ›¿ãˆã‚Œã‚‹ã‚ˆã†ã«ã—ã¦ã„ã¾ã™ã€‚
æ—©é€Ÿ`docker compose up -d` ã§èµ·å‹•ã•ã›ã¦ [http://localhost:8787](http://localhost:8787) ã«ã‚¢ã‚¯ã‚»ã‚¹ã—ã€ŒHello Worldã€ãŒè¡¨ç¤ºã•ã‚Œã‚Œã°OKã§ã™ã€‚

â€» serverèµ·å‹•ã•ã›ãªã„å ´åˆã¯ `RUN_WRANGLER_DEV=0 docker compose up -d` ã§èµ·å‹•ã•ã›ã¾ã™ã€‚

### 1-2. å›ºå®šã®Spotify URIã‚’è¿”ã™

ã²ã¨ã¾ãšå›ºå®šã®Spotify URIã‚’ç”¨æ„ã—ã€å˜ç´”ã«URIã‚’è¿”ã™ã‚ˆã†ã«ä¿®æ­£ã—ã¦ã¿ã¾ã™ã€‚
Spotifyã®URIã®å–å¾—æ–¹æ³•ã¯[ã“ã¡ã‚‰](https://support.distrokid.com/hc/en-us/articles/360014159394-How-Do-I-Find-My-Spotify-URIs-)ã‚’å‚è€ƒã«ã€Œã‚·ã‚§ã‚¢ã€ã‚’é¸æŠã—ã¦ã„ã‚‹éš›ã«Optionãƒœã‚¿ãƒ³ã‚’æŠ¼ä¸‹ã™ã‚‹ã¨URIã‚’ã‚³ãƒ”ãƒ¼ã®ãƒ¡ãƒ‹ãƒ¥ãƒ¼ãŒè¡¨ç¤ºã•ã‚Œã¾ã™ â†“

![image6](/images/6f598ea28d82b0/image6.gif =500x)

æ¬¡ã«`src/index.ts` ã® **`Response("Hello World!");`** éƒ¨åˆ†ã‚’ä¿®æ­£ã—ã¾ã™ã€‚
`Response("spotify:track:xxxxxxxxxxxxx");`

èµ·å‹•ã—ã¦ã„ã‚‹çŠ¶æ…‹ã§ä»¥ä¸‹ã‚’ã‚¿ãƒ¼ãƒŸãƒŠãƒ«ã‹ã‚‰å®Ÿè¡Œã—ã€Spotifyã®æŒ‡å®šã—ãŸå†…å®¹ãŒé–‹ã‘ã°OKã§ã™ã€‚

```bash
open `curl http://localhost:8787`
```

## 2. Cloudflare Workerså†…ã§Spotify APIã‚’ä½¿ç”¨ã—ã¦URIã‚’å–å¾—ã™ã‚‹

### 2-1. Client IDã¨ Client secretã®å–å¾—

Spotify Clientã‚’ä½¿ç”¨ã™ã‚‹éš›ã«å¿…è¦ãª `Client ID` ã¨ `Client secret` ã‚’ä»¥ä¸‹æ‰‹é †ã§å–å¾—ã—ã¾ã™ã€‚

1. Spotifyã®ã‚¢ã‚«ã‚¦ãƒ³ãƒˆã‚’ä½¿ã£ã¦[ãƒ€ãƒƒã‚·ãƒ¥ãƒœãƒ¼ãƒ‰](https://developer.spotify.com/dashboard)ã«ãƒ­ã‚°ã‚¤ãƒ³ã—ã¾ã™
2. ã€ŒCreate appã€ã§ã‚¢ãƒ—ãƒªã‚’ä½œæˆã—ã¾ã™
    - ä»Šå›ã¯ä»¥ä¸‹ã®å†…å®¹ã§ä½œæˆã—ã¾ã—ãŸ
        ![image7](/images/6f598ea28d82b0/image7.png =350x)
3. appã®ã€ŒSettingsã€>ã€ŒBasic Informationã€ã‹ã‚‰ `Client ID` ã¨ `Client secret` ã‚’ç¢ºèªã—ã¾ã™

### 2-2.Environment variables

[Environment variables Â· Cloudflare Workers docs](https://developers.cloudflare.com/workers/platform/environment-variables/)

- wranglerã«ã‚ˆã‚‹ç’°å¢ƒå¤‰æ•°
- Secretç’°å¢ƒå¤‰æ•°ã®å ´åˆ
- ãƒ€ãƒƒã‚·ãƒ¥ãƒœãƒ¼ãƒ‰ã‹ã‚‰ç’°å¢ƒå¤‰æ•°ã‚’è¨­å®š

ä»Šå›ã¯Secretã®ç’°å¢ƒå¤‰æ•°ã¨ã—ã¦å…ˆç¨‹å–å¾—ã—ãŸ `Client ID` ã¨ `Client secret` ã‚’ç®¡ç†ã—ã¦ã„ããŸã„ã¨æ€ã„ã¾ã™ã€‚

ãƒ—ãƒ­ã‚¸ã‚§ã‚¯ãƒˆãƒ«ãƒ¼ãƒˆã® `.dev.vars` ãƒ•ã‚¡ã‚¤ãƒ«ã‚’ä½œæˆã—ã€ `Client ID` ã¨ `Client secret` ã‚’è¨­å®šã—ã¾ã™ã€‚

```text
SPOTIFY_CLIENT_ID = "..."
SPOTIFY_CLIENT_SECRET = "..."
```

æ¬¡ã« `export interface Env` éƒ¨åˆ†ã«â†‘ã®ç’°å¢ƒå¤‰æ•°ã‚’å®šç¾©ã—ã¾ã™ã€‚

```tsx
export interface Env {
  SPOTIFY_CLIENT_ID: string;
  SPOTIFY_CLIENT_SECRET: string;
}
```

ã“ã‚Œã§ã€ `env.SPOTIFY_CLIENT_ID` ã®ã‚ˆã†ã«ã‚¢ã‚¯ã‚»ã‚¹ã§ãã‚‹ã‚ˆã†ã«ãªã‚Šã¾ã—ãŸã€‚

### 2-3.ç‰¹å®šã®ãƒ¯ãƒ¼ãƒ‰ã§æ¤œç´¢ã—ã¦ãƒˆãƒƒãƒ—ã®ãƒ—ãƒ¬ã‚¤ãƒªã‚¹ãƒˆã‚’è¿”ã—ã¦ã¿ã‚‹

`src/index.ts` ã‚’ä»¥ä¸‹ã®æ§˜ã«ä¿®æ­£ã—ã¾ã™ã€‚

```tsx
import { Buffer } from "buffer";

export interface Env {
  SPOTIFY_CLIENT_ID: string;
  SPOTIFY_CLIENT_SECRET: string;
}

const getAccessToken = async (clientID: string, clientSecret: string) => {
  try {
    const urlencoded = new URLSearchParams();
    urlencoded.append("grant_type", "client_credentials");

    const res = await fetch("https://accounts.spotify.com/api/token", {
      method: "POST",
      body: urlencoded,
      headers: {
        Authorization:
          "Basic " +
          Buffer.from(clientID + ":" + clientSecret).toString("base64"),
        "Content-Type": "application/x-www-form-urlencoded",
      },
    });
    const result = (await res.json()) as { access_token: string };
    return result["access_token"];
  } catch (e) {
    console.error(e);
  }
};

export default {
  async fetch(
    request: Request,
    env: Env,
    ctx: ExecutionContext
  ): Promise<Response> {
    const token = await getAccessToken(
      env.SPOTIFY_CLIENT_ID,
      env.SPOTIFY_CLIENT_SECRET
    );

    try {
      const params = {
        q: "remaster",
        type: "playlist",
      };
      const query = new URLSearchParams(params);

      const result = await fetch(`https://api.spotify.com/v1/search?${query}`, {
        method: "GET",
        headers: {
          Authorization: `Bearer ${token}`,
        },
      });
      const json = (await result.json()) as any;
      const uri = json["playlists"]["items"][0]["uri"];
      return new Response(uri);
    } catch (e: any) {
      console.error(e);
      return new Response(e.stack, { status: 500 });
    }
  },
};
```

`remaster` ã¨ã„ã†ãƒ¯ãƒ¼ãƒ‰ã§æ¤œç´¢ã—ãŸ `playlist` ã®å€™è£œã‹ã‚‰æœ€åˆã®URIã‚’è¿”ã™ã‚ˆã†ãªå®Ÿè£…ã«ãªã£ã¦ã„ã¾ã™ã€‚

ä»¥ä¸‹ã‚³ãƒãƒ³ãƒ‰ã‚’å®Ÿè¡Œã—ã¦remasterã®ãƒ—ãƒ¬ã‚¤ãƒªã‚¹ãƒˆãŒé–‹ã„ã¦ã„ã‚Œã°OKã§ã™!

```bash
open `curl http://localhost:8787`
```

â€» Spotifyã®Web API ã®è©³ç´°ã¯ä»¥ä¸‹
[Web API | Spotify for Developers](https://developer.spotify.com/documentation/web-api)

## 3. Workers KVã§ãƒ—ãƒ¬ã‚¤ãƒªã‚¹ãƒˆã®URIã‚’è¤‡æ•°ä¿å­˜ã™ã‚‹

Workers KVã«é–¢ã—ã¦
[ã‚µãƒ¼ãƒãƒ¼ãƒ¬ã‚¹ã‚¹ãƒˆãƒ¬ãƒ¼ã‚¸ã¨ã‚¢ãƒ—ãƒªã‚±ãƒ¼ã‚·ãƒ§ãƒ³ | Cloudflare Workers KV | Cloudflare](https://www.cloudflare.com/ja-jp/products/workers-kv/)
Cloudflare Workersã‹ã‚‰åˆ©ç”¨ã§ãã‚‹Key-Valueå‹ã®ã‚¹ãƒˆãƒ¬ãƒ¼ã‚¸ã‚µãƒ¼ãƒ“ã‚¹ã«ãªã‚Šã¾ã™ã€‚

### 3-1. KV namespaceã®ä½œæˆ

ä»Šå›ã¯ `KV_PLAYLISTS` ã¨ã„ã†åå‰ã§KV namespaceã‚’ä½œæˆã—ã¾ã™ã€‚wrangler CLIã‚’ä½¿ã£ã¦ä½œæˆã—ã¦ã„ãã¾ã™ã€‚

```bash
$ wrangler kv:namespace create "KV_PLAYLISTS"
â›…ï¸ wrangler 3.0.0 (update available 3.0.1)
-----------------------------------------------------
ğŸŒ€ Creating namespace with title "app-KV_PLAYLISTS"
âœ¨ Success!
Add the following to your configuration file in your kv_namespaces array:
{ binding = "KV_PLAYLISTS", id = "......." }
```

`--preview` ã‚ªãƒ—ã‚·ãƒ§ãƒ³ã‚’ã¤ã‘ã‚‹ã¨ãƒ­ãƒ¼ã‚«ãƒ«ã‹ã‚‰å®Ÿè¡Œã™ã‚‹éš›ã«å‚ç…§ã•ã‚Œã‚‹namespaceãŒä½œæˆã•ã‚Œã‚‹ã®ã§ãã¡ã‚‰ã‚‚ä½œæˆã—ã¦ãŠãã¾ã™ã€‚

```bash
wrangler kv:namespace create "KV_PLAYLISTS" --preview
```

`wrangler kv:namespace list` ã‚³ãƒãƒ³ãƒ‰ã§2ã¤ã®namespaceãŒä½œæˆã•ã‚Œã¦ã„ã‚Œã°OKã§ã™ã€‚

```bash
$ wrangler kv:namespace list
[
  {
    "id": "....",
    "title": "app-KV_PLAYLISTS",
    "supports_url_encoding": true
  },
  {
    "id": "....",
    "title": "app-KV_PLAYLISTS_preview",
    "supports_url_encoding": true
  }
]
```

ä¸Šè¨˜ã§ä½œæˆã—ãŸ2ã¤ã®namespaceã®idã‚’ `wrangler.toml` ã«è¿½è¨˜ã—ã¨ãã¾ã™ã€‚

```bash
kv_namespaces = [
   { binding = "KV_PLAYLISTS", id = "....", preview_id = "...." }
 ]
```

æ¬¡ã«è¨­å®šã—ãŸ KV namespace  `KV_PLAYLISTS` ãŒæ‰±ãˆã‚‹ã‚ˆã†ã« `export interface Env` ã«ä»¥ä¸‹ã‚’ è¿½åŠ ã—ã¾ã™ã€‚

```tsx
export interface Env {
  KV_PLAYLISTS: KVNamespace; // â† è¿½åŠ 
  SPOTIFY_CLIENT_ID: string;
  SPOTIFY_CLIENT_SECRET: string;
}
```

### 3-2. KV namespaceã‚’ä½¿ç”¨ã™ã‚‹

è©¦ã—ã«ãƒ€ãƒƒã‚·ãƒ¥ãƒœãƒ¼ãƒ‰ç”»é¢ã‹ã‚‰Previewç”¨ã®KV namespaceã«Key Valueã‚’è¿½åŠ ã—ã¦ã¿ã¾ã™ã€‚

![image8](/images/6f598ea28d82b0/image8.png =400x)

æ¬¡ã« Workersä¸Šã§â†‘ã§è¨­å®šã—ãŸå€¤ã‚’ãƒ­ã‚°ã«å–å¾—ã—ã¦ã¿ãŸã„ã¨æ€ã„ã¾ã™ã€‚

```tsx
const value = await env.KV_PLAYLISTS.get("test");
console.log(value);
```

å®Ÿè¡Œã—ã¦ã€ŒHello world!ã€ãŒè¡¨ç¤ºã•ã‚Œã‚Œã°OKã§ã™ã€‚

### 3-3. ãƒ©ãƒ³ãƒ€ãƒ ãªæ¤œç´¢ãƒ¯ãƒ¼ãƒ‰ã‚’å–å¾—ã™ã‚‹

ãƒ€ãƒƒã‚·ãƒ¥ãƒœãƒ¼ãƒ‰ç”»é¢ã§Previewç”¨ã®KV namespaceã‹ã‚‰ä¸€åº¦å…ˆç¨‹ã®ã€Œtestã€keyã®ã‚‚ã®ã¯å‰Šé™¤ã—ã¦ã€Spotifyã§æ¤œç´¢ã™ã‚‹ãƒ¯ãƒ¼ãƒ‰ã‚’ä»¥ä¸‹ã®æ§˜ãªå½¢ã§å¥½ããªãƒ¯ãƒ¼ãƒ‰ã‚’è¤‡æ•°ç™»éŒ²ã—ã¦ãŠãã¾ã™ã€‚

![image9](/images/6f598ea28d82b0/image9.png =500x)

æ¬¡ã«ä»¥ä¸‹ã‚’ `src/index.ts` ã«è¿½åŠ ã—ã€ãƒ©ãƒ³ãƒ€ãƒ ãªæ¤œç´¢ãƒ¯ãƒ¼ãƒ‰ã§ãƒ—ãƒ¬ã‚¤ãƒªã‚¹ãƒˆã‚’å–å¾—ã§ãã‚‹ã‚ˆã†ã«ã—ã¾ã™ã€‚

```tsx
// ãƒ©ãƒ³ãƒ€ãƒ ãªnumberå€¤ã‚’å–å¾—ã™ã‚‹utility
const getRandomInt = (max: number) => {
  return Math.floor(Math.random() * max);
};

// ...

export default {
  async fetch(
    request: Request,
    env: Env,
    ctx: ExecutionContext
  ): Promise<Response> {
    // â†“è¿½åŠ 
    const list = await env.KV_PLAYLISTS.list();
    const randamAt = getRandomInt(list.keys.length);
    const key = list.keys[randamAt].name;
    const queryWord = await env.KV_PLAYLISTS.get(key);
    if (!queryWord) {
      return new Response("Not found query word", { status: 404 });
    }

    const token = await getAccessToken(
      env.SPOTIFY_CLIENT_ID,
      env.SPOTIFY_CLIENT_SECRET
    );

    try {
      const params = {
        q: queryWord, // queryWord ã‚’ä½¿ã†ã‚ˆã†ã«å¤‰æ›´
        type: "playlist",
      };
      const query = new URLSearchParams(params);

      const result = await fetch(`https://api.spotify.com/v1/search?${query}`, {
        method: "GET",
        headers: {
          Authorization: `Bearer ${token}`,
        },
      });
      const json = (await result.json()) as any;
      // â†“ã¤ã„ã§ã«ãƒ’ãƒƒãƒˆã—ãŸPlylistsã‹ã‚‰ãƒ©ãƒ³ãƒ€ãƒ ãªã‚‚ã®ã‚’è¿”ã™ã‚ˆã†ã«å¤‰æ›´
      const items = json["playlists"]["items"];
      const uri = items[getRandomInt(items.length)]["uri"];
      return new Response(uri);
    } catch (e: any) {
      console.error(e);
      return new Response(e.stack, { status: 500 });
    }
  },
};
```

æ—©é€Ÿè©¦ã—ã«ä»¥ä¸‹ã‚’å®Ÿè¡Œã—ã€ãƒ©ãƒ³ãƒ€ãƒ ã«ãƒ—ãƒ¬ã‚¤ãƒªã‚¹ãƒˆãŒé–‹ã„ã¦ã„ã‚Œã°OKã§ã™ã€‚

```bash
open `curl http://localhost:8787`
```

## 4. ãƒ‡ãƒ—ãƒ­ã‚¤

æ—©é€Ÿãƒ‡ãƒ—ãƒ­ã‚¤ã—ã¦ã¿ãŸã„ã¨æ€ã„ã¾ã™ã€‚

```bash
yarn deploy
```

ãƒ€ãƒƒã‚·ãƒ¥ãƒœãƒ¼ãƒ‰ä¸Šã®Workers Overviewã§å¯¾è±¡ã®WorkerãŒãƒ‡ãƒ—ãƒ­ã‚¤ã•ã‚Œã¦ã„ã‚Œã°OKã§ã™ã€‚

![image10](/images/6f598ea28d82b0/image10.png =500x)

æ¬¡ã« Spotifyã® `Client ID` ã¨ `Client secret` ã®ç’°å¢ƒå¤‰æ•°ã‚’è¨­å®šã—ã¦ã‚„ã‚Šã¾ã™ã€‚

ã€ŒWorkeré¸æŠã€>ã€ŒSettingsã€>ã€ŒVariablesã€ã®ç”»é¢ã§ã€ŒEnvironment Variablesã€ã‚’è¨­å®šã—ã¾ã™ã€‚

![image11](/images/6f598ea28d82b0/image11.png =500x)

ä»¥ä¸‹ã‚³ãƒãƒ³ãƒ‰ã‚’å®Ÿæ–½ã—ã€ãƒ­ãƒ¼ã‚«ãƒ«ã¨åŒæ§˜ã«ãƒ©ãƒ³ãƒ€ãƒ ã«PlaylistãŒSpotifyã§é–‹ã„ã¦ã„ã‚Œã°OKã§ã™!

```bash
open `curl [ãƒ‡ãƒ—ãƒ­ã‚¤ã•ã‚ŒãŸURL]`
```

# ãƒãƒƒãƒ‰ãƒã‚¦ãƒã‚¦

## `Error: Adapter 'http' is not available in the build` ãŒç™ºç”Ÿã™ã‚‹!

Spotify APIã‚’ä½¿ã†éš›ã« axios ã‚’ä½¿ã£ã¦ã„ãŸæ™‚ã«â†‘ã®ã‚¨ãƒ©ãƒ¼ãŒç™ºç”Ÿã—ã¾ã—ãŸã€‚è‰²ã€…èª¿ã¹ã¦ã¿ã‚‹ã¨Edgeã®ç’°å¢ƒã ã¨axiosãŒã‚µãƒãƒ¼ãƒˆã•ã‚Œã¦ãªã„(?)ã‚ˆã†ãªã®ã§ Cloudflare Workersã®ãƒ‰ã‚­ãƒ¥ãƒ¡ãƒ³ãƒˆã«ã‚‚ã‚ã‚‹ã‚ˆã†ã«fetchã‚’ä½¿ã†ã‚ˆã†ã«ã—ã¾ã—ãŸã€‚

### å‚è€ƒãƒªãƒ³ã‚¯

- [Uncaught (in promise) Error: Error: Adapter 'http' is not available in the build](https://stackoverflow.com/questions/75280544/uncaught-in-promise-error-error-adapter-http-is-not-available-in-the-build)

- [Fetch Â· Cloudflare Workers docs](https://developers.cloudflare.com/workers/runtime-apis/fetch/)

# ã¾ã¨ã‚

å®Ÿéš›ã®ç”¨é€”ã¨ã—ã¦ã¯ã‚ã£ã¦ãªã„ã‹ã‚‚ã§ã™ãŒã€Cloudflare Workersã‚’ä»Šå›ãƒ­ãƒ¼ã‚«ãƒ«ã§å‹•ã‹ã—ã¦å®Ÿéš›ã«ãƒ‡ãƒ—ãƒ­ã‚¤ã™ã‚‹ã¾ã§ã‚’å®Ÿæ–½ã—ã¦ã¿ã¦ã€Wrangler CLIã§è‰²ã€…è¨­å®šã‚„KVã®ä½œæˆã€Previewç’°å¢ƒãªã©ä½¿ã„ã‚„ã™ãã€ã‚¹ãƒ ãƒ¼ã‚ºã«é€²ã‚ãŸã‹ãªã¨æ€ã„ã¾ã—ãŸã€‚
æ¬¡ã¯Cloudflare D1ã‚„R2ãªã©è©¦ã—ã¦è¦‹ãŸã„ã¨æ€ã„ã¾ã™ã€‚

# ã“ã®è¨˜äº‹ã¯ä»¥ä¸‹ã®æƒ…å ±ã‚’å‚è€ƒã«ã—ã¦åŸ·ç­†ã—ã¾ã—ãŸ

- [workers-sdk/templates at main Â· cloudflare/workers-sdk](https://github.com/cloudflare/workers-sdk/tree/main/templates)

- [Query for Spotify's Web API Client Credentials Flow](https://stackoverflow.com/questions/64034862/query-for-spotifys-web-api-client-credentials-flow)

- [Cloudflare Workers ã® wrangler.toml ã«ç’°å¢ƒå¤‰æ•°ã‚’æ›¸ã‹ãªã„ã§ç®¡ç†ã™ã‚‹](https://zenn.dev/mr_ozin/articles/645502f4a621d6)

- [Remix on Cloudflare Workersã‹ã‚‰Workers KVã‚’ä½¿ã† | DevelopersIO](https://dev.classmethod.jp/articles/remix-on-cloudflare-workers-w-kv/)

- [Cloudflare Workers(Rust)ã‹ã‚‰KVã‚’ä½¿ã†ãƒãƒ¥ãƒ¼ãƒˆãƒªã‚¢ãƒ«ã‚’ã‚„ã£ã¦ã¿ãŸ #Cloudflare | DevelopersIO](https://dev.classmethod.jp/articles/workers-kv-from-rust/)

- [Cloudflare Workers + KV + honoã§ç°¡å˜ãªAPIã‚µãƒ¼ãƒã‚’ä½œã‚‹](https://zenn.dev/razokulover/articles/ac84a141abee86#kvã®è¨­å®š)