---
title: "Cloudflare Workers AI + Vectorizeã‚’è©¦ã™"
emoji: "ğŸ’¡"
type: "tech" # tech: æŠ€è¡“è¨˜äº‹ / idea: ã‚¢ã‚¤ãƒ‡ã‚¢
topics:
  - "cloudflare"
  - "cloudflareworkers"
  - "ai"
  - "rag"
published: true
---
# æ¦‚è¦

ä»Šå›ã¯ã€Cloudflare Workers AIã¨Vectorizeã®åŸºæœ¬çš„ãªä½¿ã„æ–¹ã‚’å®Ÿéš›ã«æ‰‹ã‚’å‹•ã‹ã—ãªãŒã‚‰è©¦ã—ã¦ã¿ãŸã„ã¨æ€ã„ã¾ã™ã€‚Workers AIã§ã¯LLMãƒ¢ãƒ‡ãƒ«ã‚’ä½¿ã£ãŸæ–‡ç« ç”Ÿæˆã‚„å¤šè¨€èªç¿»è¨³ã‚’ã€Vectorizeã§ã¯ãƒ™ã‚¯ãƒˆãƒ«ãƒ‡ãƒ¼ã‚¿ãƒ™ãƒ¼ã‚¹ã®æ§‹ç¯‰ã¨æ¤œç´¢ã‚’ã€æœ€å¾Œã«Workers AIã¨Vectorizeã‚’åˆã‚ã›ãŸã‚µãƒ³ãƒ—ãƒ«ã‚’è©¦ã—ã¦ã¿ã¾ã™ã€‚

## Workers AIã§ä½¿ãˆã‚‹ãƒ¢ãƒ‡ãƒ«ã®ä¸€è¦§

https://developers.cloudflare.com/workers-ai/models/

> Cloudflare Workers AI ã§ã¯ã€50 ä»¥ä¸Šã® OSS ãƒ¢ãƒ‡ãƒ«ã‚’â€œã‚µãƒ¼ãƒãƒ¼ãƒ¬ã‚¹ GPUâ€ã§å³æ™‚å‘¼ã³å‡ºã›ã‚‹ã‚ˆã†ã«ã‚«ã‚¿ãƒ­ã‚°åŒ–ã—ã¦ãŠã‚Šã€ãƒ†ã‚­ã‚¹ãƒˆç”Ÿæˆã‹ã‚‰ç”»åƒç”Ÿæˆã€éŸ³å£°èªè­˜ã¾ã§å¹…åºƒã„ã‚¿ã‚¹ã‚¯ã‚’åŒã˜ API ã§æ‰±ãˆã¾ã™ã€‚

## é–‹ç™ºç’°å¢ƒ

```bash
$ node -v
v22.7.0
$ yarn -v
1.22.22
```

# ã‚·ãƒ³ãƒ—ãƒ«ãªæ§‹æˆã® Workers AI ã‚’è©¦ã™

ã¾ãšã¯Workers AIãŒã©ã‚“ãªæ„Ÿã˜ã‹è©¦ã—ã¦ã¿ãŸã„ã¨æ€ã„ã¾ã™ã€‚

æ—©é€Ÿç’°å¢ƒæ§‹ç¯‰ã—ã¦ã„ãã¾ã™ã€‚

```bash
$ mkdir cloudflare-workers-ai-example
$ cd cloudflare-workers-ai-example
$ npm create cloudflare@latest
# ä»¥ä¸‹ã®é¸æŠã§ãƒ—ãƒ­ã‚¸ã‚§ã‚¯ãƒˆä½œæˆã—ã¾ã—ãŸ
â•­ Create an application with Cloudflare Step 1 of 3
â”‚
â”œ In which directory do you want to create your application?
â”‚ dir ./app
â”‚
â”œ What would you like to start with?
â”‚ category Hello World example
â”‚
â”œ Which template would you like to use?
â”‚ type Worker only
â”‚
â”œ Which language do you want to use?
â”‚ lang TypeScript
â”‚
â”œ Copying template files
â”‚ files copied to project directory
â”‚
â”œ Updating name in `package.json`
â”‚ updated `package.json`
â”‚
â”œ Installing dependencies
â”‚ installed via `npm install`
â”‚
â•° Application created

â•­ Configuring your application for Cloudflare Step 2 of 3
â”‚
â”œ Installing wrangler A command line tool for building Cloudflare Workers
â”‚ installed via `npm install wrangler --save-dev`
â”‚
â”œ Retrieving current workerd compatibility date
â”‚ compatibility date 2025-06-06
â”‚
â”œ Generating types for your application
â”‚ generated to `./worker-configuration.d.ts` via `npm run cf-typegen`
â”‚
â”œ You're in an existing git repository. Do you want to use git for version control?
â”‚ no git
â”‚
â•° Application configured

â•­ Deploy with Cloudflare Step 3 of 3
â”‚
â”œ Do you want to deploy your application?
â”‚ no deploy via `npm run deploy`
â”‚
â•° Done
```

ãƒ—ãƒ­ã‚¸ã‚§ã‚¯ãƒˆãŒä½œæˆã•ã‚ŒãŸã‚‰ `wrangler.jsonc` ã«ä»¥ä¸‹ã‚’è¿½åŠ ã—ã¾ã™ã€‚

```json
{
  // ....
  "observability": {
    "enabled": true
  },
  // ğŸ‘‡è¿½åŠ 
  "ai": {
    "binding": "AI"
  }
}
```

æ¬¡ã«å¿…è¦ãªãƒ‘ãƒƒã‚±ãƒ¼ã‚¸ã‚’ã‚¤ãƒ³ã‚¹ãƒˆãƒ¼ãƒ«ã—ã¨ãã¾ã™ã€‚

```bash
npm install @cloudflare/ai
```

`worker-configuration.d.ts` ã® `Env` ã«ä»¥ä¸‹ã‚’è¿½åŠ ã™ã‚‹ã‹ã€

```tsx
interface Env extends Cloudflare.Env {
  AI: Ai; // è¿½åŠ 
}
```

ä»¥ä¸‹ã‚³ãƒãƒ³ãƒ‰ã§`worker-configuration.d.ts` ã‚’æ›´æ–°ã—ã¾ã™ã€‚

```bash
npx wrangler types
```

`src/index.ts` ã‚’ä»¥ä¸‹ã«å¤‰æ›´ã—ã¾ã™ã€‚

```tsx
import { Ai } from '@cloudflare/ai';
export default {
  async fetch(request, env) {
    const ai = new Ai(env.AI);
    const input = { prompt: "What's the origin of the phrase 'Hello, World'" };
    const output = await ai.run('@cf/meta/llama-2-7b-chat-int8', input);
    return new Response(JSON.stringify(output));
  },
} satisfies ExportedHandler<Env>;
```

ã“ã‚Œã§å‹•ã‹ã™ã ã‘ã§ã™ãŒã€Workers AI ã¯ãƒ­ãƒ¼ã‚«ãƒ«ã ã¨å‹•ã‹ã›ãªã„ã®ã§ `--remote` ã‚’ã¤ã‘ã¦æ‰‹å…ƒã§Cloudflareã®ç’°å¢ƒä¸Šã§å‹•ã‹ã—ã¦ã¿ãŸã„ã¨æ€ã„ã¾ã™ã€‚

äº‹å‰ã«ãƒ­ã‚°ã‚¤ãƒ³ã—ã¨ãã¾ã™ã€‚

```bash
$ npx wrangler login
# ã¡ã‚ƒã‚“ã¨ãƒ­ã‚°ã‚¤ãƒ³ã§ããŸã‹ğŸ‘‡ã§ç¢ºèª
$ npx wrangler whoami
```

ãƒ­ã‚°ã‚¤ãƒ³ã§ããŸã‚‰ğŸ‘‡ã§å‹•ã‹ã—ã¦ã¿ã¾ã™ã€‚

```bash
npx wrangler dev --remote
```

èµ·å‹•ã—ã¦ãƒ–ãƒ©ã‚¦ã‚¶ã§ [http://localhost:8787/](http://localhost:8787/) ã«ã‚¢ã‚¯ã‚»ã‚¹ã™ã‚‹ã¨ä»¥ä¸‹ã®æ§˜ãªãƒ¬ã‚¹ãƒãƒ³ã‚¹ãŒè¿”ã£ã¦ãã¾ã™ã€‚

```json
{
   "response":"What a great question!\n\nThe phrase \"Hello, World\" has a fascinating history! It originated in the early days of computer programming, specifically in the 1970s. The phrase was first used as a test message in the development of programming languages and operating systems.\n\nThe most commonly cited source of the phrase is Brian Kernighan, a computer scientist who worked at Bell Labs, a research and development organization. In 1973, Kernighan and his colleague, Dennis Ritchie, created the C programming language. They used \"Hello, World\" as a test program to ensure that their language was working correctly. The program printed the phrase \"Hello, World\" to the screen, and it has since become a standard phrase in programming culture.\n\nThe phrase was likely chosen because it was a simple, yet effective, way to test the basic functionality of a program. It's also a friendly and approachable greeting, which has contributed to its widespread adoption.\n\nOver time, the phrase has become a cultural phenomenon, symbolizing the beginning of a new program, a new project, or even a new era in technology. It's often used as a placeholder or a test message in various programming contexts, such as:\n\n1. Programming languages: Many programming languages, including C,",
   "usage":{
      "prompt_tokens":56,
      "completion_tokens":256,
      "total_tokens":312
   }
}
```

## åˆ¥ã®ãƒ¢ãƒ‡ãƒ«ã‚‚è©¦ã—ã¦ã¿ã‚‹

å…ˆã»ã©è©¦ã—ãŸã®ãŒ **[llama-2-7b-chat-int8](https://developers.cloudflare.com/workers-ai/models/llama-2-7b-chat-int8/)** ã¨ã„ã†ãƒ¢ãƒ‡ãƒ«ã§

> Meta ãŒå…¬é–‹ã—ãŸå¯¾è©±ç‰¹åŒ–å‹ LLM **Llama 2-Chat** ã® 7 Bï¼ˆâ‰’70 å„„ï¼‰ãƒ‘ãƒ©ãƒ¡ãƒ¼ã‚¿ç‰ˆã‚’ã€æ¨è«–æ™‚ã« **int8 é‡å­åŒ–**ã—ã¦è»½é‡åŒ–ã—ãŸãƒ¢ãƒ‡ãƒ«
**ã‚³ãƒ³ãƒ†ã‚­ã‚¹ãƒˆã‚¦ã‚£ãƒ³ãƒ‰ã‚¦ 8 k ãƒˆãƒ¼ã‚¯ãƒ³**ã§æ¯”è¼ƒçš„é•·ã„å…¥åŠ›ã«ã‚‚å¯¾å¿œã—ã€**Transformer ç³»ã‚¢ãƒ¼ã‚­ãƒ†ã‚¯ãƒãƒ£**ã‚’æ¡ç”¨ã—ã€è‡ªç„¶ãªå¯¾è©±ã‚„æ–‡ç« ç”Ÿæˆã«å¼·ã„

ã¨ã„ã†ç‰¹å¾´ãŒã‚ã‚‹ãƒ¢ãƒ‡ãƒ«ã§ã—ãŸã€‚

ä»Šåº¦ã¯ **[m2m100-1.2b](https://developers.cloudflare.com/workers-ai/models/m2m100-1.2b/)** ã¨ã„ã†ãƒ¢ãƒ‡ãƒ«ã‚’è©¦ã—ã¦ã¿ãŸã„ã¨æ€ã„ã¾ã™ã€‚ç‰¹å¾´ã¯ä»¥ä¸‹ã«ãªã‚Šã¾ã™ã€‚

> Metaï¼ˆæ—§ Facebookï¼‰ãŒå…¬é–‹ã—ãŸ 1.2 billion ï¼ˆç´„12 å„„ï¼‰ãƒ‘ãƒ©ãƒ¡ãƒ¼ã‚¿ã® Transformer ã‚¨ãƒ³ã‚³ãƒ¼ãƒ€-ãƒ‡ã‚³ãƒ¼ãƒ€å‹ LLM ã§ã™ã€‚æœ€å¤§ã®ç‰¹é•·ã¯ã€**100 è¨€èª Ã— 99 æ–¹å‘ï¼9,900 é€šã‚Š**ã®ç¿»è¨³ã‚’ *è‹±èªã‚’ä»‹ã•ãšã«* ç›´æ¥ã“ãªã›ã‚‹ã€ŒMany-to-Manyã€è¨­è¨ˆã§ã€ä½è³‡æºè¨€èªåŒå£«ã§ã‚‚ç²¾åº¦ãŒé«˜ã„ã“ã¨ã§ã™

ã¨ã„ã†ã“ã¨ã§è‹±èªâ†’æ—¥æœ¬èªã®ç¿»è¨³ã‚’è©¦ã—ã¦ã¿ã¾ã™ã€‚å…ˆã»ã©ã® `src/index.ts` ã‚’ä»¥ä¸‹ã«æ›¸ãæ›ãˆã¾ã™ã€‚

```tsx
import { Ai } from '@cloudflare/ai';
export default {
  async fetch(request, env) {
    const ai = new Ai(env.AI);
    const output = await ai.run('@cf/meta/m2m100-1.2b', {
      text: "Workers AI allows you to run AI models in a serverless way, without having to worry about scaling, maintaining, or paying for unused infrastructure. You can invoke models running on GPUs on Cloudflare's network from your own code â€” from Workers, Pages, or anywhere via the Cloudflare API.",
      source_lang: 'english',
      target_lang: 'japanese',
    });
    return new Response(JSON.stringify(output));
  },
} satisfies ExportedHandler<Env>;
```

å®Ÿè¡Œã—ã¦ [http://localhost:8787/](http://localhost:8787/) ã«ã‚¢ã‚¯ã‚»ã‚¹ã™ã‚‹ã¨ä»¥ä¸‹ã®ãƒ¬ã‚¹ãƒãƒ³ã‚¹ãŒè¿”ã£ã¦ãã¾ã—ãŸã€‚

```json
{
   "translated_text":"Workers AI ã‚’ä½¿ç”¨ã™ã‚‹ã¨ã€Serverless ã§ AI ãƒ¢ãƒ‡ãƒ«ã‚’å®Ÿè¡Œã§ãã¾ã™ãŒã€æœªä½¿ç”¨ã®ã‚¤ãƒ³ãƒ•ãƒ©ã‚¹ãƒˆãƒ©ã‚¯ãƒãƒ£ã®ã‚¹ã‚±ãƒ¼ãƒªãƒ³ã‚°ã€ãƒ¡ãƒ³ãƒ†ãƒŠãƒ³ã‚¹ã€ã¾ãŸã¯æ”¯æ‰•ã„ã«ã¤ã„ã¦å¿ƒé…ã™ã‚‹å¿…è¦ã¯ã‚ã‚Šã¾ã›ã‚“ã€‚Cloudflare ã®ãƒãƒƒãƒˆãƒ¯ãƒ¼ã‚¯ä¸Šã® GPU ã§å‹•ä½œã™ã‚‹ãƒ¢ãƒ‡ãƒ«ã¯ã€Workersã€Pages ã‹ã‚‰ã€ã¾ãŸã¯ Cloudflare API ã‚’é€šã˜ã¦ã©ã“ã‹ã‚‰ã§ã‚‚ã€ç‹¬è‡ªã®ã‚³ãƒ¼ãƒ‰ã‹ã‚‰å‘¼ã³å‡ºã™ã“ã¨ãŒã§ãã¾ã™ã€‚",
   "usage":{
      "prompt_tokens":76,
      "completion_tokens":104,
      "total_tokens":180
   }
}
```

ã„ã„æ„Ÿã˜ã§ç¿»è¨³ã§ãã¦ã„ãã†ã§ã™ã€‚

# ã‚·ãƒ³ãƒ—ãƒ«ãªæ§‹æˆã® Cloudflare Vectorize ã‚’è©¦ã™

ğŸ‘‡ã“ã¡ã‚‰ã®è¨˜äº‹ã‚’å‚è€ƒã«é€²ã‚ã¦ã„ããŸã„ã¨æ€ã„ã¾ã™ã€‚

https://developers.cloudflare.com/vectorize/get-started/intro/

å…ˆã»ã©ã® `cloudflare-workers-ai-example` ãƒ—ãƒ­ã‚¸ã‚§ã‚¯ãƒˆã‚’ä½¿ã£ã¦é€²ã‚ã¦ã„ãã¾ã™ã€‚

ã¾ãšã¯Cloudflareä¸Šã«Vectorizeã‚¤ãƒ³ãƒ‡ãƒƒã‚¯ã‚¹ã‚’ä½œæˆã—ã¾ã™ã€‚

```bash
$ npx wrangler vectorize create tutorial-index --dimensions=32 --metric=euclidean
ğŸš§ Creating index: 'tutorial-index'
âœ… Successfully created a new Vectorize index: 'tutorial-index'
ğŸ“‹ To start querying from a Worker, add the following binding configuration to your wrangler.json file:

{
  "vectorize": [
    {
      "binding": "VECTORIZE",
      "index_name": "tutorial-index"
    }
  ]
}
```

ãƒ™ã‚¯ãƒˆãƒ«ã®æ¬¡å…ƒæ•°(32)ã¨metricã¯å‚è€ƒè¨˜äº‹ã«é€šã‚Šã«è¨­å®šã—ã¦ã¾ã™ã€‚ã“ã®2ã¤ã®ãƒ‘ãƒ©ãƒ¡ãƒ¼ã‚¿ã¯ä½œæˆæ™‚ã«ã—ã‹æ±ºå®šã§ããšå¤‰æ›´ã§ããªã„ã®ã§ã€è¦ä»¶ã«å¿œã˜ã¦æ¤œè¨ã™ã‚‹å¿…è¦ãŒã‚ã‚Šãã†ã§ã™ã€‚

â€» metricã¯ä¼¼ã¦ã„ã‚‹æƒ…å ±ã‹ã©ã†ã‹ã‚’åˆ¤å®šã™ã‚‹éš›ã«ä½¿ç”¨ã•ã‚Œã€metricã«ã¯ euclidean(ãƒ¦ãƒ¼ã‚¯ãƒªãƒƒãƒ‰è·é›¢), cosine(ã‚³ã‚µã‚¤ãƒ³è·é›¢), dot product(ãƒ‰ãƒƒãƒˆç©) ã‚’æŒ‡å®šã§ãã‚‹ã‚ˆã†ã§ã™ã€‚ãã‚Œãã‚Œã®èª¬æ˜ã¯ä»¥ä¸‹å‚ç…§ã€‚

:::details ãƒ¦ãƒ¼ã‚¯ãƒªãƒƒãƒ‰è·é›¢, ã‚³ã‚µã‚¤ãƒ³è·é›¢, ãƒ‰ãƒƒãƒˆç©ã®LLMè§£èª¬

ã¾ãšè¦ç‚¹ã ã‘ã¾ã¨ã‚ã‚‹ã¨

**ãƒ¦ãƒ¼ã‚¯ãƒªãƒƒãƒ‰è·é›¢**ã¯ã€Œã¾ã£ã™ãã‚‚ã®ã•ã—ã§æ¸¬ã‚‹è·é›¢ã€ã€**ã‚³ã‚µã‚¤ãƒ³è·é›¢**ã¯ã€Œãƒ™ã‚¯ãƒˆãƒ«ãŒã¤ãã‚‹è§’åº¦ã®é•ã„ã€ã€**ãƒ‰ãƒƒãƒˆç©**ã¯ã€ŒåŒã˜å‘ãã‚’ã©ã‚Œã ã‘å…±æœ‰ã—ã¦ã„ã‚‹ã‹ã€ã‚’æ•°å­—ã«ã—ãŸã‚‚ã®ã§ã™ã€‚ã©ã‚Œã‚‚â€œâ€5 ãƒ¡ãƒ¼ãƒˆãƒ«â€ã®ã‚ˆã†ãªå¤‰ãªå€¤ã¯å‡ºãšã€0ã‚ˆã‚Šå¤§ãã„ã‹ã€0ã«è¿‘ã„ã»ã©ä¼¼ã¦ã„ã‚‹ï¼è¿‘ã„ã¨åˆ¤æ–­ã§ãã¾ã™ãŒã€æ¸¬ã£ã¦ã„ã‚‹ã‚‚ã®ï¼ˆé•·ã• vs å‘ãï¼‰ãŒé•ã„ã¾ã™ã€‚

---

## è·é›¢ã¨å‘ãã£ã¦ä½•ã ã‚ã†ï¼Ÿ

- *ç‚¹ã‚„çŸ¢å°ï¼ˆãƒ™ã‚¯ãƒˆãƒ«ï¼‰**ã‚’äºŒæ¬¡å…ƒã®ç´™ã‚„ä¸‰æ¬¡å…ƒã®ç©ºé–“ã«ç½®ãã¨ãã€ã€Œã©ã‚Œãã‚‰ã„é›¢ã‚Œã¦ã„ã‚‹ã‹ã€ã¨ã€Œã©ã®æ–¹å‘ã‚’å‘ã„ã¦ã„ã‚‹ã‹ã€ã¯åˆ¥ã®æƒ…å ±ã«ãªã‚Šã¾ã™ã€‚([datacamp.com](https://www.datacamp.com/tutorial/euclidean-distance?utm_source=chatgpt.com))
- ãƒ™ã‚¯ãƒˆãƒ«ã®â€œé•·ã•â€ã‚’æ¸¬ã‚‹ã®ãŒè·é›¢ç³»ã€è§’åº¦ã‚’æ¸¬ã‚‹ã®ãŒã‚³ã‚µã‚¤ãƒ³ç³»ã€å‘ãåŒå£«ã®é‡ãªã‚Šå…·åˆã‚’æ¸¬ã‚‹ã®ãŒãƒ‰ãƒƒãƒˆç©ç³»ã ã€ã¨è¦šãˆã‚‹ã¨æ··ä¹±ã—ã¾ã›ã‚“ã€‚([betterexplained.com](https://betterexplained.com/articles/vector-calculus-understanding-the-dot-product/?utm_source=chatgpt.com), [geeksforgeeks.org](https://www.geeksforgeeks.org/cosine-similarity/?utm_source=chatgpt.com))

---

## ãƒ¦ãƒ¼ã‚¯ãƒªãƒƒãƒ‰è·é›¢ï¼šã‚‚ã®ã•ã—ã§æ¸¬ã‚‹â€œã¾ã£ã™ãè·é›¢â€

| ã‚¤ãƒ¡ãƒ¼ã‚¸ | æ•°å­¦çš„ãƒã‚¤ãƒ³ãƒˆ |
| --- | --- |
| 2ç‚¹é–“ã«ç³¸ã‚’ãƒ”ãƒ³ã¨å¼µã£ã¦ã€ãã®ç³¸ã®é•·ã•ã‚’å®šè¦ã§æ¸¬ã‚‹ã‚¤ãƒ¡ãƒ¼ã‚¸ã€‚ | ãƒ”ã‚¿ã‚´ãƒ©ã‚¹ã®å®šç†ã§å°ã‹ã‚Œã€ç›´ç·šè·é›¢ï¼âˆš((xâ‚‚âˆ’xâ‚)Â²+(yâ‚‚âˆ’yâ‚)Â²â€¦)ã€‚ |
- ã€Œé³¥ãŒä¸€ç›´ç·šã«é£›ã¶ã¨ãã®ç§»å‹•è·é›¢ã€ã‚’æ€ã„æµ®ã‹ã¹ã‚‹ã¨ä¸€ç™ºã§ã‚ã‹ã‚Šã¾ã™ã€‚([geeksforgeeks.org](https://www.geeksforgeeks.org/euclidean-distance/?utm_source=chatgpt.com))
- æ¬¡å…ƒãŒå¢—ãˆã¦ã‚‚â€œãã‚Œãã‚Œã®åº§æ¨™å·®ã®2ä¹—ã‚’è¶³ã—ã¦ãƒ«ãƒ¼ãƒˆã‚’å–ã‚‹â€ã¨ã„ã†æ‰‹é †ã¯åŒã˜ã§ã™ã€‚([cuemath.com](https://www.cuemath.com/euclidean-distance-formula/?utm_source=chatgpt.com), [byjus.com](https://byjus.com/maths/euclidean-distance/?utm_source=chatgpt.com))
- ã ã‹ã‚‰**æ•°ãŒå¤§ãã„ã»ã©é ãã€å°ã•ã„ã»ã©è¿‘ã„**ã¨ã‚¹ãƒˆãƒ¬ãƒ¼ãƒˆã«èª­ã‚ã‚‹ã®ãŒé•·æ‰€ã§ã™ã€‚([youtube.com](https://www.youtube.com/watch?v=6N1ZQkndBAY&utm_source=chatgpt.com))

---

## ã‚³ã‚µã‚¤ãƒ³è·é›¢ï¼ˆã‚³ã‚µã‚¤ãƒ³é¡ä¼¼åº¦ï¼‰ï¼šãƒ™ã‚¯ãƒˆãƒ«ã®â€œè§’åº¦â€ã‚’è¦‹ã‚‹

| ã‚¤ãƒ¡ãƒ¼ã‚¸ | æ•°å­¦çš„ãƒã‚¤ãƒ³ãƒˆ |
| --- | --- |
| 2æœ¬ã®çŸ¢å°ã®æŒŸã‚€è§’åº¦ãŒå°ã•ã„ã»ã©ã€Œä¼¼ã¦ã„ã‚‹ã€ã€‚ | cos Î¸ = (ğšãƒ»ğ›)/(â€–ğšâ€–â€–ğ›â€–)ã€‚é¡ä¼¼åº¦=cos Î¸ã€è·é›¢=1âˆ’cos Î¸ ãŒã‚ˆãä½¿ã‚ã‚Œã‚‹ã€‚ |
- é•·ã•ã‚’ãœã‚“ã¶1ã«ãã‚ãˆã¦ã‹ã‚‰è§’åº¦ã ã‘æ¯”ã¹ã¦ã„ã‚‹ã€ã¨æ€ã†ã¨ã‚¤ãƒ¡ãƒ¼ã‚¸ã—ã‚„ã™ã„ã§ã™ã€‚([medium.com](https://medium.com/%40arjunprakash027/understanding-cosine-similarity-a-key-concept-in-data-science-72a0fcc57599?utm_source=chatgpt.com))
- è§’åº¦ãŒ0Â°ãªã‚‰ cos Î¸=1ï¼ˆå®Œå…¨ã«åŒã˜å‘ãï¼‰ã€90Â°ãªã‚‰0ï¼ˆç›´äº¤ï¼ã¾ã£ãŸãæ–¹å‘ãŒé•ã†ï¼‰ã«ãªã‚‹ã®ã§**å€¤ã¯ âˆ’1ã€œ1**ã€‚0.8 ãªã©å¤§ãã„ã»ã©ä¼¼ã¦ã„ã¾ã™ã€‚([geeksforgeeks.org](https://www.geeksforgeeks.org/cosine-similarity/?utm_source=chatgpt.com), [datastax.com](https://www.datastax.com/guides/what-is-cosine-similarity?utm_source=chatgpt.com))
- æ–‡ç« æ¯”è¼ƒãªã©ã€Œæ–‡ã®é•·ã•ãŒé•ã£ã¦ã‚‚è©±é¡ŒãŒåŒã˜ã‹ã€ã‚’èª¿ã¹ãŸã„ã¨ãã«ã‚ˆãä½¿ã‚ã‚Œã¾ã™ã€‚([machinelearningplus.com](https://www.machinelearningplus.com/nlp/cosine-similarity/?utm_source=chatgpt.com))
- å‹•ç”»ã§è¦‹ã‚‹ã¨ã€Œè§’åº¦ãŒé–‹ãã»ã©ãƒãƒ¼ãŒä¸‹ãŒã‚‹ã€ã‚¢ãƒ‹ãƒ¡ãŒã‚ã‹ã‚Šã‚„ã™ã„ã§ã™ã€‚([youtube.com](https://www.youtube.com/watch?v=e9U0QAFbfLI&utm_source=chatgpt.com))

---

## ãƒ‰ãƒƒãƒˆç©ï¼ˆå†…ç©ï¼‰ï¼šå‘ãã®é‡ãªã‚Šå…·åˆã‚’æ¸¬ã‚‹

| ã‚¤ãƒ¡ãƒ¼ã‚¸ | æ•°å­¦çš„ãƒã‚¤ãƒ³ãƒˆ |
| --- | --- |
| ç‰‡æ–¹ã®çŸ¢å°ã‚’â€œå½±â€ã®ã‚ˆã†ã«ã‚‚ã†ç‰‡æ–¹ã«è½ã¨ã—ã€ãã®å½±ã®é•·ã•ã‚’ã‹ã‘åˆã‚ã›ã‚‹æ„Ÿã˜ã€‚ | ğšãƒ»ğ› = |
- **æ­£ã«ãªã‚‹ã¨ã€Œã ã„ãŸã„åŒã˜æ–¹å‘ã€**ã€0ãªã‚‰ç›´äº¤ã€è² ãªã‚‰é€†æ–¹å‘ã¨ç°¡å˜ã«åˆ¤å®šã§ãã¾ã™ã€‚([khanacademy.org](https://www.khanacademy.org/math/multivariable-calculus/thinking-about-multivariable-function/x786f2022%3Avectors-and-matrices/a/dot-products-mvc?utm_source=chatgpt.com), [mathsisfun.com](https://www.mathsisfun.com/algebra/vectors-dot-product.html?utm_source=chatgpt.com))
- ãƒ™ã‚¯ãƒˆãƒ«åŒå£«ã‚’ã€Œæ›ã‘ç®—ã€ã—ã¦ã‚‚ãƒ™ã‚¯ãƒˆãƒ«ã§ã¯ãªã**ãŸã ã®æ•°**ãŒè¿”ã£ã¦ãã‚‹ã®ã§â€œã‚¹ã‚«ãƒ©ãƒ¼ç©â€ã¨ã‚‚å‘¼ã°ã‚Œã¾ã™ã€‚([betterexplained.com](https://betterexplained.com/articles/vector-calculus-understanding-the-dot-product/?utm_source=chatgpt.com))
- åŠ›ã¨è·é›¢ã§ä»•äº‹é‡ï¼ˆã‚¨ãƒãƒ«ã‚®ãƒ¼ï¼‰ã‚’è¨ˆç®—ã™ã‚‹ã¨ããªã©ã€ç‰©ç†ã§ã‚‚ç™»å ´ã—ã¾ã™ã€‚([youtube.com](https://www.youtube.com/watch?pp=0gcJCdgAo7VqN5tD&v=0iNrGpwZwog&utm_source=chatgpt.com))

---

## ã©ã†ä½¿ã„åˆ†ã‘ã‚‹ï¼Ÿ

| ã‚·ãƒ¼ãƒ³ | ãŠã™ã™ã‚æŒ‡æ¨™ | ç†ç”± |
| --- | --- | --- |
| åœ°å›³ã§2åœ°ç‚¹ã®â€œå®Ÿéš›ã®è·é›¢â€ã‚’æ¸¬ã‚ŠãŸã„ | ãƒ¦ãƒ¼ã‚¯ãƒªãƒƒãƒ‰è·é›¢ | ç›´ç·šã§ã©ã‚Œã ã‘é›¢ã‚Œã¦ã„ã‚‹ã‹ãŒçŸ¥ã‚ŠãŸã„ã ã‘ã ã‹ã‚‰ |
| æ–‡ç« ã‚„ç”»åƒã®ã€Œå†…å®¹ãŒä¼¼ã¦ã„ã‚‹ã‹ã€ã‚’æ¯”ã¹ãŸã„ | ã‚³ã‚µã‚¤ãƒ³è·é›¢ / é¡ä¼¼åº¦ | æ–‡å­—æ•°ã‚„ç”»ç´ æ•°ï¼ˆ=é•·ã•ï¼‰ãŒé•ã£ã¦ã‚‚å‘ãï¼ˆç‰¹å¾´ã®æ¯”ç‡ï¼‰ãŒä¼¼ã¦ã„ã‚Œã° OK |
| åŠ›ã®å‘ãã¨ç§»å‹•æ–¹å‘ã®é–¢ä¿‚ãªã©ã€å‘ãã®é‡ãªã‚Šåº¦åˆã„ã‚’æ•°å€¤åŒ–ã—ãŸã„ | ãƒ‰ãƒƒãƒˆç© | æ­£è² ã‚„å¤§ãã•ã§ä¸€çŸ³äºŒé³¥ã«åˆ¤å®šã§ãã‚‹ |
- **é•·ã•ãã®ã‚‚ã®ãŒé‡è¦â†’ãƒ¦ãƒ¼ã‚¯ãƒªãƒƒãƒ‰**ã€**æ–¹å‘ã ã‘é‡è¦â†’ã‚³ã‚µã‚¤ãƒ³**ã€**æ–¹å‘ï¼‹å¼·ã•ã‚’ã¾ã¨ã‚ã¦1ã¤ã®æ•°å­—ã§æ¸ˆã¾ã›ãŸã„â†’ãƒ‰ãƒƒãƒˆç©**ã¨è¦šãˆã‚‹ã¨ä¾¿åˆ©ã§ã™ã€‚([geeksforgeeks.org](https://www.geeksforgeeks.org/euclidean-distance/?utm_source=chatgpt.com), [datastax.com](https://www.datastax.com/guides/what-is-cosine-similarity?utm_source=chatgpt.com), [khanacademy.org](https://www.khanacademy.org/math/multivariable-calculus/thinking-about-multivariable-function/x786f2022%3Avectors-and-matrices/a/dot-products-mvc?utm_source=chatgpt.com))

---

## ã¾ã¨ã‚

| æŒ‡æ¨™ | ä½•ã‚’æ¸¬ã‚‹ï¼Ÿ | å€¤åŸŸ | 0 ã«è¿‘ã„ã¨ï¼Ÿ |
| --- | --- | --- | --- |
| ãƒ¦ãƒ¼ã‚¯ãƒªãƒƒãƒ‰è·é›¢ | ç‚¹ã©ã†ã—ã®ç›´ç·šè·é›¢ | 0 ï½ âˆ | ã¨ã¦ã‚‚è¿‘ã„ |
| ã‚³ã‚µã‚¤ãƒ³è·é›¢ (1âˆ’cos Î¸) | ãƒ™ã‚¯ãƒˆãƒ«é–“ã®è§’åº¦å·® | 0 ï½ 2 | å‘ããŒã»ã¼åŒã˜ |
| ãƒ‰ãƒƒãƒˆç© | å‘ãã®é‡ãªã‚Šï¼‹å¤§ãã• | âˆ’âˆ ï½ âˆ | æ–¹å‘ç›´äº¤ï¼ˆ=0ï¼‰ |

ã“ã‚Œã§ã€Œé•·ã•ã€ã€Œè§’åº¦ã€ã€Œå‘ãã®é‡ãªã‚Šã€ã¨ã„ã†ï¼“ã¤ã®åˆ‡ã‚Šå£ã®é•ã„ãŒã¤ã‹ã‚ãŸã¨æ€ã„ã¾ã™ã€‚ã©ã‚“ãªãƒ‡ãƒ¼ã‚¿ã§ã‚‚**â€œä½•ã‚’æ¯”ã¹ãŸã„ã‹â€**ã‚’å…ˆã«æ±ºã‚ã¦ã‹ã‚‰ã€ã´ã£ãŸã‚Šã®æŒ‡æ¨™ã‚’é¸ã¶ã‚ˆã†ã«ã—ã¾ã—ã‚‡ã†ã­ã€‚
:::

æ¬¡ã«ã‚¿ãƒ¼ãƒŸãƒŠãƒ«ã®å®Ÿè¡Œçµæœã«ã‚‚ã‚ã£ãŸé€šã‚Š `wrangler.jsonc` ã«ä»¥ä¸‹ã‚’è¿½åŠ ã—ã¾ã™ã€‚

```json
{
  "vectorize": [
    {
      "binding": "VECTORIZE",
      "index_name": "tutorial-index"
    }
  ]
}
```

`worker-configuration.d.ts` ã‚‚åˆã‚ã›ã¦æ›´æ–°ã—ã¾ã™ã€‚

```tsx
declare namespace Cloudflare {
  interface Env {
    VECTORIZE: VectorizeIndex; // æ‰‹å‹•ã§è¿½åŠ ã€ã¾ãŸã¯ npx wrangler types å®Ÿæ–½
    AI: Ai;
  }
}
```

æ¬¡ã¯å®Ÿéš›ã«ãƒ™ã‚¯ãƒˆãƒ«ã‚’ã‚¤ãƒ³ãƒ‡ãƒƒã‚¯ã‚¹ã«ç™»éŒ²ã—ã¦ã¿ã¾ã™ã€‚å…ˆã»ã©ã® `src/index.ts` ã‚’ä»¥ä¸‹ã«ä¿®æ­£ã—ã¾ã™ã€‚

```tsx
import { Ai } from '@cloudflare/ai';

const sampleVectors: Array<VectorizeVector> = [
  {
    id: '1',
    values: [
      0.12, 0.45, 0.67, 0.89, 0.23, 0.56, 0.34, 0.78, 0.12, 0.9, 0.24, 0.67, 0.89, 0.35, 0.48, 0.7, 0.22, 0.58, 0.74, 0.33, 0.88, 0.66,
      0.45, 0.27, 0.81, 0.54, 0.39, 0.76, 0.41, 0.29, 0.83, 0.55,
    ],
    metadata: { url: '/products/sku/13913913' },
  },
  {
    id: '2',
    values: [
      0.14, 0.23, 0.36, 0.51, 0.62, 0.47, 0.59, 0.74, 0.33, 0.89, 0.41, 0.53, 0.68, 0.29, 0.77, 0.45, 0.24, 0.66, 0.71, 0.34, 0.86, 0.57,
      0.62, 0.48, 0.78, 0.52, 0.37, 0.61, 0.69, 0.28, 0.8, 0.53,
    ],
    metadata: { url: '/products/sku/10148191' },
  },
  {
    id: '3',
    values: [
      0.21, 0.33, 0.55, 0.67, 0.8, 0.22, 0.47, 0.63, 0.31, 0.74, 0.35, 0.53, 0.68, 0.45, 0.55, 0.7, 0.28, 0.64, 0.71, 0.3, 0.77, 0.6, 0.43,
      0.39, 0.85, 0.55, 0.31, 0.69, 0.52, 0.29, 0.72, 0.48,
    ],
    metadata: { url: '/products/sku/97913813' },
  },
  {
    id: '4',
    values: [
      0.17, 0.29, 0.42, 0.57, 0.64, 0.38, 0.51, 0.72, 0.22, 0.85, 0.39, 0.66, 0.74, 0.32, 0.53, 0.48, 0.21, 0.69, 0.77, 0.34, 0.8, 0.55,
      0.41, 0.29, 0.7, 0.62, 0.35, 0.68, 0.53, 0.3, 0.79, 0.49,
    ],
    metadata: { url: '/products/sku/418313' },
  },
  {
    id: '5',
    values: [
      0.11, 0.46, 0.68, 0.82, 0.27, 0.57, 0.39, 0.75, 0.16, 0.92, 0.28, 0.61, 0.85, 0.4, 0.49, 0.67, 0.19, 0.58, 0.76, 0.37, 0.83, 0.64,
      0.53, 0.3, 0.77, 0.54, 0.43, 0.71, 0.36, 0.26, 0.8, 0.53,
    ],
    metadata: { url: '/products/sku/55519183' },
  },
];

export default {
  async fetch(request, env) {
    const path = new URL(request.url).pathname;
    // å…ˆã»ã©ã®Workers AIã‚µãƒ³ãƒ—ãƒ«
    if (path.startsWith('/ai')) {
      const ai = new Ai(env.AI);
      const output = await ai.run('@cf/meta/m2m100-1.2b', {
        text: "Workers AI allows you to run AI models in a serverless way, without having to worry about scaling, maintaining, or paying for unused infrastructure. You can invoke models running on GPUs on Cloudflare's network from your own code â€” from Workers, Pages, or anywhere via the Cloudflare API.",
        source_lang: 'english',
        target_lang: 'japanese',
      });
      return new Response(JSON.stringify(output));
    }

    if (path.startsWith('/insert')) {
      const inserted = await env.VECTORIZE.insert(sampleVectors);
      return Response.json(inserted);
    }
    return new Response('nothing to do... yet', { status: 404 });
  },
} satisfies ExportedHandler<Env>;
```

`/insert` ã«ãƒªã‚¯ã‚¨ã‚¹ãƒˆãŒã‚ã‚‹ã¨ `sampleVectors` ã‚’ç™»éŒ²ã™ã‚‹ã‚ˆã†ãªå®Ÿè£…ã«ãªã£ã¦ã„ã¾ã™ã€‚æ—©é€Ÿç™»éŒ²ã—ã¦ã¿ãŸã„ã¨æ€ã„ã¾ã™ã€‚

```bash
$ npx wrangler dev --remote
# åˆ¥ã‚¿ãƒ¼ãƒŸãƒŠãƒ«ã§
$ curl http://localhost:8787/insert
{
   "mutationId":"xxxxxxxx-xxxx-xxxx-xxxx-xxxxxxxxxxxx"
}
```

æ¬¡ã«å®Ÿéš›ã«ã‚¯ã‚¨ãƒªã—ã¦ç¢ºèªã—ã¦ã¿ã¾ã™ã€‚`src/index.ts`ã«ä»¥ä¸‹ã‚’è¿½åŠ ã—ã¾ã™ã€‚

```tsx
export default {
  async fetch(request, env) {
    const path = new URL(request.url).pathname;
    // ....
    // ğŸ‘‡è¿½åŠ 
    if (path.startsWith('/query')) {
      const queryVector: Array<number> = [
        0.13, 0.25, 0.44, 0.53, 0.62, 0.41, 0.59, 0.68, 0.29, 0.82, 0.37, 0.5, 0.74, 0.46, 0.57, 0.64, 0.28, 0.61, 0.73, 0.35, 0.78, 0.58,
        0.42, 0.32, 0.77, 0.65, 0.49, 0.54, 0.31, 0.29, 0.71, 0.57,
      ];
      const matches = await env.VECTORIZE.query(queryVector, {
        topK: 3,
        returnValues: true,
        returnMetadata: 'all',
      });
      return Response.json({ matches });
    }
    return new Response('nothing to do... yet', { status: 404 });
  },
} satisfies ExportedHandler<Env>;
```

ã¡ã‚ƒã‚“ã¨ã‚¯ã‚¨ãƒªã§ãã‚‹ã‹è©¦ã—ã¦ã¿ã¾ã™ã€‚

```bash
$ curl http://localhost:8787/query
{
   "matches":{
      "count":3,
      "matches":[
         {
            "id":"4",
            "score":0.46348256,
            "values":[
              0.17, 0.29, 0.42, 0.57, 0.64, 0.38, 0.51, 0.72, 0.22, 0.85, 0.39,
              0.66, 0.74, 0.32, 0.53, 0.48, 0.21, 0.69, 0.77, 0.34, 0.8, 0.55, 0.41,
              0.29, 0.7, 0.62, 0.35, 0.68, 0.53, 0.3, 0.79, 0.49
            ],
            "metadata":{
               "url":"/products/sku/418313"
            }
         },
         {
            "id":"3",
            "score":0.52920616,
            "values":[
              0.21, 0.33, 0.55, 0.67, 0.8, 0.22, 0.47, 0.63, 0.31, 0.74, 0.35, 0.53,
              0.68, 0.45, 0.55, 0.7, 0.28, 0.64, 0.71, 0.3, 0.77, 0.6, 0.43, 0.39,
              0.85, 0.55, 0.31, 0.69, 0.52, 0.29, 0.72, 0.48
            ],
            "metadata":{
               "url":"/products/sku/97913813"
            }
         },
         {
            "id":"2",
            "score":0.6337869,
            "values":[
        "values": [
              0.14, 0.23, 0.36, 0.51, 0.62, 0.47, 0.59, 0.74, 0.33, 0.89, 0.41,
              0.53, 0.68, 0.29, 0.77, 0.45, 0.24, 0.66, 0.71, 0.34, 0.86, 0.57,
              0.62, 0.48, 0.78, 0.52, 0.37, 0.61, 0.69, 0.28, 0.8, 0.53
            ],
            "metadata":{
               "url":"/products/sku/10148191"
            }
         }
      ]
   }
}
```

ã¡ã‚ƒã‚“ã¨ã‚¯ã‚¨ãƒªã§ãã¦ãã†ã§ã™ âœ¨

# **Workers AI + Vectorizeã‚’è©¦ã™**

æœ€å¾Œã«Workers AI + Vectorizeã§RAGã‚‚ã©ãã‚’ä½œã£ã¦ã¿ãŸã„ã¨æ€ã„ã¾ã™ã€‚æ¸¡ã•ã‚ŒãŸãƒ†ã‚­ã‚¹ãƒˆã‚’ãƒ™ã‚¯ãƒˆãƒ«åŒ–ã™ã‚‹ãƒ¢ãƒ‡ãƒ«ã«ã¯ä»¥ä¸‹ã‚’ä½¿ã„ã¾ã™ã€

https://developers.cloudflare.com/workers-ai/models/bge-base-en-v1.5/

> ä»»æ„ã®ãƒ†ã‚­ã‚¹ãƒˆã‚’768æ¬¡å…ƒãƒ™ã‚¯ãƒˆãƒ«ã«å¤‰æ›ã™ã‚‹BAAIä¸€èˆ¬åŸ‹ã‚è¾¼ã¿ãƒ¢ãƒ‡ãƒ«
â€» BAAI General Embeddingï¼ˆ**BGE**ï¼‰ã¯ã€åŒ—äº¬æ™ºæºäººå·¥çŸ¥èƒ½ç ”ç©¶é™¢ (BAAI) ãŒå…¬é–‹ã—ãŸ**æ±ç”¨ãƒ†ã‚­ã‚¹ãƒˆåŸ‹ã‚è¾¼ã¿ãƒ¢ãƒ‡ãƒ«ç¾¤**

`768æ¬¡å…ƒãƒ™ã‚¯ãƒˆãƒ«` ã¨ã„ã†äº‹ãªã®ã§Vectorizeã‚¤ãƒ³ãƒ‡ãƒƒã‚¯ã‚¹ã‚’å†åº¦ä½œã‚Šç›´ã—ãŸã„ã¨æ€ã„ã¾ã™ã€‚

```bash
# å¿…è¦ã‚ã‚Œã°å…ˆã»ã©ã®ã‚¤ãƒ³ãƒ‡ãƒƒã‚¯ã‚¹ã‚’å‰Šé™¤
$ npx wrangler vectorize list
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ name           â”‚ dimensions â”‚ metric    â”‚ description â”‚ created                    â”‚ modified                   â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚ tutorial-index â”‚ 32         â”‚ euclidean â”‚             â”‚ .......................... â”‚ .......................... â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
$ npx wrangler vectorize delete tutorial-index
# 768æ¬¡å…ƒãƒ™ã‚¯ãƒˆãƒ«ã§metricãŒcosineã®ã‚‚ã®ã‚’ä½œæˆ
$ npx wrangler vectorize create embeddings-index --dimensions=768 --metric=cosine
```

`wrangler.jsonc` ã‚’æ›´æ–°ã—ã¨ãã¾ã™ã€‚

```json
{
  "vectorize": [
    {
      "binding": "VECTORIZE",
      "index_name": "embeddings-index"
    }
  ]
}
```

`src/index.ts` ã‚’ä»¥ä¸‹ã«å¤‰æ›´ã—ã¾ã™ã€‚

```tsx
interface EmbeddingResponse {
  shape: number[];
  data: number[][];
}

export default {
  async fetch(request, env) {
    const url = new URL(request.url);
    const path = url.pathname;
    const userQuery = url.searchParams.get('q') ?? '';

    if (path.startsWith('/insert')) {
      const stories = [
        'Orange cloud drifts above the silent sea',
        'A llama hums softly at snowy dawn',
        'Mars robot nurtures tomatoes beneath pink sky',
      ];
      const modelResp: EmbeddingResponse = await env.AI.run('@cf/baai/bge-base-en-v1.5', {
        text: stories,
      });
      const vectors: VectorizeVector[] = [];
      let id = 1;
      modelResp.data.forEach((vector) => {
        vectors.push({ id: `${id}`, values: vector });
        id++;
      });

      let inserted = await env.VECTORIZE.upsert(vectors);
      return Response.json(inserted);
    }
    if (path.startsWith('/query')) {
      const queryVector: EmbeddingResponse = await env.AI.run('@cf/baai/bge-base-en-v1.5', {
        text: [userQuery],
      });

      const matches = await env.VECTORIZE.query(queryVector.data[0], {
        topK: 1, // é¡ä¼¼æ¤œç´¢ã§è¿”ã™ä»¶æ•°
      });
      return Response.json({ matches });
    }
    return new Response('nothing to do... yet', { status: 404 });
  },
} satisfies ExportedHandler<Env>;
```

é€šå¸¸ã¯SQL databaseãªã©ã‹ã‚‰å¼•ã£å¼µã£ã¦ããŸãƒ‡ãƒ¼ã‚¿ã‚’Vectorizeã‚¤ãƒ³ãƒ‡ãƒƒã‚¯ã‚¹ã«ç™»éŒ²ã™ã‚‹ã¨æ€ã„ã¾ã™ãŒã€ä»Šå›ã¯LLMã«è€ƒãˆã¦ã‚‚ã‚‰ã£ãŸä»¥ä¸‹ã®ãƒ†ã‚­ã‚¹ãƒˆã‚’ä¸Šã‹ã‚‰id=1 ã®é †ã§ç™»éŒ²ã—ã¦ã„ã¾ã™ã€‚

| id | ãƒ†ã‚­ã‚¹ãƒˆ |
| --- | --- |
| 1 | Orange cloud drifts above the silent sea |
| 2 | A llama hums softly at snowy dawn |
| 3 | Mars robot nurtures tomatoes beneath pink sky |

æ—©é€Ÿè©¦ã—ã¦ã¿ãŸã„ã¨æ€ã„ã¾ã™ã€‚

```bash
$ npx wrangler dev --remote
# åˆ¥ã‚¿ãƒ¼ãƒŸãƒŠãƒ«ã§
$ curl http://localhost:8787/insert
{
   "mutationId":"xxxxxxxx-xxxx-xxxx-xxxx-xxxxxxxxxxxx"
}
# â€œrobot vegetablesâ€ ã®ãƒ¯ãƒ¼ãƒ‰ã§ã‚¯ã‚¨ãƒª
$ curl http://localhost:8787/query?q=robot+vegetables
{
   "matches":{
      "count":1,
      "matches":[
         {
            "id":"3",
            "score":0.8041519
         }
      ]
   }
}
```

ã‚¹ã‚³ã‚¢ãŒ `1` ã«è¿‘ã„ã»ã©ãƒãƒƒãƒã—ã¦ã„ã‚‹ã®ã§ `0.8..` ãªã®ã§ã„ã„æ„Ÿã˜ã§ã‚¯ã‚¨ãƒªã§ãã¦ãã†ã§ã™ã€‚

ä»–ã®ãƒ¯ãƒ¼ãƒ‰ã§ã‚‚è©¦ã—ã¦ã¿ã¾ã™ã€‚

```bash
# "winter" ã ã‘ã§ã‚¯ã‚¨ãƒª
$ curl http://localhost:8787/query?q=winter
{
   "matches":{
      "count":1,
      "matches":[
         {
            "id":"2",
            "score":0.6488873
         }
      ]
   }
}
# â€œwinter animalâ€ ã®ãƒ¯ãƒ¼ãƒ‰ã§ã‚¯ã‚¨ãƒª
$ curl http://localhost:8787/query?q=winter+animal
{
   "matches":{
      "count":1,
      "matches":[
         {
            "id":"2",
            "score":0.7506682
         }
      ]
   }
}
```

æƒ³åƒé€šã‚Šã®ã‚¹ã‚³ã‚¢ã«ãªã£ã¦ã¾ã™ã€‚

Workers AI + Vectorizeã§ç°¡å˜ã«è©¦ã›ã¦é›°å›²æ°—ãŒæŠŠæ¡ã§ããŸã®ã§è‰¯ã‹ã£ãŸã§ã™ï¼æ¬¡å›ã¯åˆ¥ã®ãƒ¢ãƒ‡ãƒ«ã‚„æ—¥æœ¬èªã§è©¦ã—ãŸã‚Šã€ã‚‚ã£ã¨è¸ã¿è¾¼ã‚“ã§è©¦ã›ãŸã‚‰ã¨æ€ã„ã¾ã™ã€‚

# ãƒãƒƒãƒ‰ãƒã‚¦ãƒã‚¦

### Workers AI ã‚’å‹•ã‹ã—ãŸéš›ã«ä»¥ä¸‹ã®æ§˜ãªã‚¨ãƒ©ãƒ¼ãŒå‡ºã‚‹

```bash
âœ˜ [ERROR] Could not resolve "base64-js"
```

è§£æ±ºç­–ã¨ã—ã¦ã¯å˜ç´”ã« `base64-js` ã‚’è¿½åŠ ã—ã¦ã‚ã’ã‚Œã°OKã§ã™ã€‚

```bash
npm i base64-js
```

# å‚è€ƒURL

https://zenn.dev/tmsic/articles/82dc27ebe702d2

https://zenn.dev/laiso/articles/7a21b5bf14f10c

https://zenn.dev/kameoncloud/articles/fcdf5b7ee3e3a3

https://zenn.dev/kameoncloud/articles/707b3b623bdb87