---
title: "koaã§websocketã‚µãƒ¼ãƒãƒ¼ã‚’æ§‹ç¯‰ã™ã‚‹"
emoji: "ğŸ¨"
type: "tech"
topics:
  - "koa"
  - "websocket"
  - "express"
  - "nodejs"
published: true
published_at: "2022-10-10 21:07"
---

# [koa](https://github.com/koajs/koa)
ãƒ¡ã‚¸ãƒ£ãƒ¼ãª Express.js ã‚’é–‹ç™ºã—ãŸãƒãƒ¼ãƒ ã«ã‚ˆã£ã¦ä½œæˆã•ã‚ŒãŸNode.jsã®ãƒ•ãƒ¬ãƒ¼ãƒ ãƒ¯ãƒ¼ã‚¯ã§ã€
Express.jsã®å¾Œç¶™ã«ã‚ãŸã‚‹ãã†ã§ã™ã€‚ä»Šå›ã¯ã“ã®koaã‚’ä½¿ã£ã¦websoketã‚µãƒ¼ãƒãƒ¼ã‚’å®Ÿè£…ã—ã¦ã¿ãŸã„ã¨æ€ã„ã¾ã™ã€‚

# [koa-websocket](https://github.com/kudos/koa-websocket)
koaã‚’ä½¿ç”¨ã—ã¦websocketã‚µãƒ¼ãƒãƒ¼ã‚’æ§‹ç¯‰ã™ã‚‹éš›ã®middlewareéƒ¨åˆ†ã®ãƒ‘ãƒƒã‚±ãƒ¼ã‚¸ã«ãªã‚Šã¾ã™ã€‚
èª¿ã¹ãŸçµæœã‚ã¾ã‚Škoa + websocketæ§‹æˆã§ã®middlewareãƒ‘ãƒƒã‚±ãƒ¼ã‚¸ãŒãªãã€ã“ã¡ã‚‰ãŒä¸€ç•ªä½¿ã‚ã‚Œã¦ã„ãã†ã ã£ãŸã®ã§è©¦ã—ã¦ã¿ã‚‹äº‹ã«ã—ã¾ã—ãŸã€‚

## ã‚µãƒ³ãƒ—ãƒ«ãƒ—ãƒ­ã‚¸ã‚§ã‚¯ãƒˆã®ä½œæˆ
ä»Šå›ã¯ä»¥ä¸‹ã®æ§‹æˆã§ãƒ—ãƒ­ã‚¸ã‚§ã‚¯ãƒˆä½œæˆã—ã¾ã—ãŸã€‚
```
.
â”œâ”€â”€ Dockerfile
â”œâ”€â”€ docker-compose.yml
â”œâ”€â”€ index.ts
â”œâ”€â”€ node_modules
â”œâ”€â”€ nodemon.json
â”œâ”€â”€ package.json
â”œâ”€â”€ tsconfig.json
â””â”€â”€ yarn.lock
```
ä¸»è¦ãªãƒ•ã‚¡ã‚¤ãƒ«ã®è©³ç´°ã¯ä»¥ä¸‹ã«ãªã‚Šã¾ã™ã€‚

```dockerfile:Dockerfile
FROM node:16-alpine
WORKDIR /usr/src/app

RUN apk update && \
    apk add git vim bash

COPY package*.json yarn.lock ./
RUN yarn install
COPY . ./
CMD [ "yarn", "start" ]
```

```yml:docker-compose.yml
version: '3.3'
volumes:
  modules_data:
    driver: local

services:
  wss:
    build: .
    image: koa/websocket
    container_name: "koa-websocket"
    command: sh -c "yarn install && yarn dev"
    tty: true
    volumes:
      - .:/usr/src/app
      - modules_data:/usr/src/app/node_modules
    ports:
      - '8080:8080'
    working_dir: /usr/src/app
```

```json:package.json
{
  "name": "koa-websocket-sample",
  "version": "1.0.0",
  "main": "index.js",
  "license": "MIT",
  "scripts": {
    "dev": "nodemon",
    "start": "ts-node index.ts"
  },
  "dependencies": {},
  "devDependencies": {
    "@types/node": "^18.0.0",
    "nodemon": "^2.0.16",
    "ts-node": "^10.8.1",
    "typescript": "^4.7.3"
  }
}
```

```json:nodemon.json
{
  "watch": ["."],
   "ext": "ts",
  "exec": "ts-node index.ts",
  "env": {
    "__LOCAL__": "true"
  }
}
```

## ãƒ‘ãƒƒã‚±ãƒ¼ã‚¸ã‚¤ãƒ³ã‚¹ãƒˆãƒ¼ãƒ«

```sh
$ yarn add koa koa-websocket
$ yarn add -D @types/koa @types/koa-websocket
```

ä»Šå›ã®ãƒ†ãƒ¼ãƒã¨ã¯é–¢ä¿‚ç„¡ã„ã§ã™ãŒã€utilityç”¨ã®ãƒ‘ãƒƒã‚±ãƒ¼ã‚¸ã¨ã—ã¦ [radash](https://github.com/rayepps/radash) ã‚‚è¿½åŠ ã—ã¦ã¾ã™ã€‚
radashã«é–¢ã—ã¦ã¯[ã“ã¡ã‚‰](https://medium.com/vanguards-of-code/lodash-is-dead-long-live-radash-d9d52abf428b)ã®è¨˜äº‹ã«è©³ç´°ãŒã‚ã‚Šã¾ã™ã€‚
```sh
$ yarn add radash
```

### [koa-compose](https://www.npmjs.com/package/koa-compose)
Koaã®Middlewareã‚’æ§‹ç¯‰ã™ã‚‹éš›ã®utilityãƒ‘ãƒƒã‚±ãƒ¼ã‚¸ã§ã™ã€‚koaã‚’ã‚¤ãƒ³ã‚¹ãƒˆãƒ¼ãƒ«ã™ã‚‹ã¨ä½¿ãˆã¾ã™ã€‚

```ts
fn = compose([a, b, c, ...])
```
è¤‡æ•°ã®Middlewareã‚’åˆæˆã«1ã¤ã®Middlewareã‚’è¿”ã™ `compose` ã‚’æä¾›ã—ã¾ã™ã€‚

## ç°¡å˜ãªã‚µãƒ³ãƒ—ãƒ«å®Ÿè£…

```ts:index.ts
import Koa from 'koa';
import { websockify, WebSocketServer } from 'koa-websocket';
import { toInt } from 'radash';
import { IncomingMessage } from 'http';

const port = toInt(process.env.PORT, 8080);

const app = websockify(new Koa());
const server: WebSocketServer = app.ws;

server.use((ctx: Koa.Context) => {
  ctx.websocket.on('open', (request: IncomingMessage) => {
    console.log('ctx.websocket connection open');
  });

  ctx.websocket.on('close', () => {
    console.log('ctx.websocket connection close');
  });

  ctx.websocket.on('upgrade', () => {
    console.log('ctx.websocket connection upgrade');
  });

  ctx.websocket.on('ping', () => {
    console.log('ctx.websocket connection ping');
  });

  ctx.websocket.on('message', (message: any) => {
    console.log('ctx.websocket message', message);
  });
});

app.listen(port);
```
ã“ã®çŠ¶æ…‹ã§ã‚³ãƒ³ãƒ†ãƒŠèµ·å‹•ã—ã€ã‚¯ãƒ©ã‚¤ã‚¢ãƒ³ãƒˆã‹ã‚‰æ¥ç¶šã™ã‚‹ã¨ `message` å—ä¿¡æ™‚ã«ãƒ­ã‚°ãŒå‡ºåŠ›ã•ã‚Œã¦ã„ã‚‹ã‹ã¨æ€ã„ã¾ã™ã€‚

## å•é¡Œç‚¹
ã“ã“ã§ã€`koa-websocket` ã®å®Ÿè£…ã‚’è¦‹ã¦ã„ã‚‹ã¨[æ¥ç¶šæ™‚](https://github.com/kudos/koa-websocket/blob/99289c86bbc839b102d5a7e3be663a6af7d6a843/index.js#L20)ã®ã‚¤ãƒ™ãƒ³ãƒˆã§ä½•ã‹å‡¦ç†ã‚’å®Ÿæ–½ã—ãŸãã¦ã‚‚ã€ãã®ã‚¤ãƒ™ãƒ³ãƒˆãŒå–ã‚Œãªã•ãã†ã§ã™ã€‚ã€‚
```ts
  ctx.websocket.on('open', (request: IncomingMessage) => {
    console.log('ctx.websocket connection open');
  });
```
â†‘ã“ã¡ã‚‰ã®ã‚¤ãƒ™ãƒ³ãƒˆã‚‚ä¸€åˆ‡å‘¼ã°ã‚Œãªã„ã®ã§ã€ã“ã®ã¾ã¾ã ã¨æ¥ç¶šæ™‚ã®å‡¦ç†ãŒå‡ºæ¥ãªã•ãã†ã§ã™ã€‚æŠ˜è§’ãªã®ã§Typescriptã§æ›¸ãç›´ã—ã¤ã¤ã‚«ã‚¹ã‚¿ãƒ ã—ã¦ã¿ã‚ˆã†ã‹ã¨æ€ã„ã¾ã™ã€‚

## Typescriptã§æ›¸ãç›´ã—ã¤ã¤ã‚«ã‚¹ã‚¿ãƒ 
 `lib/ws/server.ts` ã«ä»¥ä¸‹ã®å†…å®¹ã§å®Ÿè£…ã—ã¾ã™ã€‚
ä½¿ã†å ´åˆã¯ `koa-websocket` ã®ã‚¤ãƒ³ãƒãƒ¼ãƒˆéƒ¨åˆ†ã‚’ä»¥ä¸‹ã«ä¿®æ­£ã—ã¾ã™ã€‚
```ts
import { websockify, WebSocketServer } from './lib/ws/server';
```

```ts:lib/ws/server.ts
import ws from 'ws';
import Koa from 'koa';
import url from 'url';
import { IncomingMessage, ServerResponse } from 'http';
import compose from 'koa-compose';
import * as https from 'https';

declare module 'koa' {
  interface Context {
    websocket: ws;
    path: string;
  }
}

const wsServer = ws.Server;

export class WebSocketServer {
  private _app: Koa;
  private _server: ws.Server<ws.WebSocket> | undefined = undefined;
  private _middlewares: any[] = [];

  constructor(app: Koa) {
    this._app = app;
  }

  listen(options?: ws.ServerOptions | undefined) {
    this._server = new wsServer(options);
    this._server.on('connection', this.onConnection.bind(this));
  }

  onConnection(socket: ws.WebSocket, request: IncomingMessage) {
    const fn = compose(this._middlewares);

    const context = this._app.createContext(
      request,
      new ServerResponse(request)
    );
    context.websocket = socket;
    context.path = (request.url && url.parse(request.url).pathname) ?? '';

    fn(context)
      .then(() => socket.emit('open', request))
      .catch((e) => console.error(e));
  }

  use(fn: any) {
    this._middlewares.push(fn);
  }
}

export const websockify = (
  app: any,
  wsOptions?: ws.ServerOptions,
  httpsOptions?: https.ServerOptions
) => {
  const oldListen = app.listen;
  app.listen = function listen(...args: any[]) {
    if (typeof httpsOptions === 'object') {
      const httpsServer = https.createServer(httpsOptions, app.callback());
      app.server = httpsServer.listen(...(args as any));
    } else {
      app.server = oldListen.apply(app, args as any);
    }
    const options: { [key: string]: any } = { server: app.server };
    if (wsOptions) {
      Object.keys(wsOptions).forEach((key) => {
        if (Object.prototype.hasOwnProperty.call(wsOptions, key)) {
          options[key] = (wsOptions as any)[key];
        }
      });
    }
    app.ws.listen(options);
    return app.server;
  };
  app.ws = new WebSocketServer(app);
  return app;
};
```

ä»¥ä¸‹ã®éƒ¨åˆ†ã§æ¥ç¶šæ™‚ã« `open` ã‚’å‘¼ã¶ã‚ˆã†ã«ã—ã¦ã„ã¾ã™ã€‚
```ts
    fn(context)
      .then(() => socket.emit('open', request))
      .catch((e) => console.error(e));
```
ã“ã‚Œã§
```ts
  ctx.websocket.on('open', (request: IncomingMessage) => {
    console.log('ctx.websocket connection open');
  });
```
â†‘ãŒæ¥ç¶šæ™‚ã«å‘¼ã°ã‚Œã‚‹æ§˜ã«ãªã£ãŸã‹ã¨æ€ã„ã¾ã™ã€‚

# ã¾ã¨ã‚
ã“ã†ã¿ã‚‹ã¨å®Ÿéš›ã«koa + websocketæ§‹æˆã§websocketã‚µãƒ¼ãƒãƒ¼å®Ÿè£…ã™ã‚‹å ´åˆã¯ã€å¤–éƒ¨ãƒ‘ãƒƒã‚±ãƒ¼ã‚¸ã‚’ä½¿ã†ã‚ˆã‚Šã€Middlewareéƒ¨åˆ†ã¯è‡ªå‰ã§å®Ÿè£…ã—ãŸæ–¹ãŒã€å®Ÿè£…é‡ã‚„å¾Œã€…ã®ãƒ¡ãƒ³ãƒ†ã—ã‚„ã™ã•ã‚’è€ƒãˆã‚‹ã¨è‰¯ã•ãã†ã‹ãªã¨æ€ã„ã¾ã—ãŸã€‚
