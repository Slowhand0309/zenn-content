---
title: "Androidã‚¢ãƒ—ãƒªã‚’codemagic.yamlã§Firebase App Distributionã«ãƒ‡ãƒ—ãƒ­ã‚¤ã™ã‚‹"
emoji: "ğŸ”¥"
type: "tech" # tech: æŠ€è¡“è¨˜äº‹ / idea: ã‚¢ã‚¤ãƒ‡ã‚¢
topics:
  - "android"
  - "kotlin"
  - "codemagic"
  - "firebase"
published: true
---

# ã¯ã˜ã‚ã«

- Codemagicã®ymlãƒ•ã‚¡ã‚¤ãƒ«ã‚’ä½¿ã£ã¦Androidã‚¢ãƒ—ãƒªã‚’Firebase App Distributionã«Publishã§ãã‚‹ã¾ã§ã‚’æ›¸ãç•™ã‚ãŸãƒ¡ãƒ¢ã«ãªã‚Šã¾ã™
- å¤§ã¾ã‹ãªæµã‚Œ
  - äº‹å‰æº–å‚™
  - Codemagicä¸Šã§ãƒ“ãƒ«ãƒ‰ç¢ºèªã‚„ãƒˆãƒªã‚¬ãƒ¼è¨­å®š
  - ã‚µãƒ¼ãƒ“ã‚¹ã‚¢ã‚«ã‚¦ãƒ³ãƒˆã«ã‚ˆã‚‹èªè¨¼ã‚’å…ƒã«Publish

## å‚è€ƒè¨˜äº‹

[Androidç”¨ç¶™ç¶šçš„ã‚¤ãƒ³ãƒ†ã‚°ãƒ¬ãƒ¼ã‚·ãƒ§ãƒ³ï¼†ãƒ‡ãƒªãƒãƒªãƒ¼ï¼ˆCI/CDï¼‰ | Codemagic Blog](https://blog.codemagic.io/native-android-getting-started-guide-with-codemagic-cicd-japanese/)

â†‘ã“ã¡ã‚‰ã®è¨˜äº‹ã‚’å‚è€ƒã«é€²ã‚ã¦ã„ããŸã„ã¨æ€ã„ã¾ã™ã€‚
ã¾ãŸã€äº‹å‰ã«Codemagicã®Appã«å¯¾è±¡ã®Androidãƒ—ãƒ­ã‚¸ã‚§ã‚¯ãƒˆã‚’è¿½åŠ ã—ã¦ã„ã‚‹å‰æã§é€²ã‚ã¦ã„ãã¾ã™.

# ç’°å¢ƒæ§‹ç¯‰ã‚„æº–å‚™

## 1. äº‹å‰æº–å‚™

### 1-1. Firebase App Distribution ã«ãƒ†ã‚¹ã‚¿ãƒ¼ã¨ã‚°ãƒ«ãƒ¼ãƒ—ã‚’è¨­å®šã™ã‚‹

![image1.png](/images/2837a33e3f455b/image1.png)

ä»Šå›ã¯ã€Œãƒ†ã‚¹ã‚¿ãƒ¼ã¨ã‚°ãƒ«ãƒ¼ãƒ—ã€ã§ã€ŒDeveloperã€ã¨ã„ã†ã‚°ãƒ«ãƒ¼ãƒ—ã‚’ä½œæˆã—ã€æ–°è¦ãƒªãƒªãƒ¼ã‚¹ãŒã‚ã‚Œã°é€šçŸ¥ã•ã‚Œã‚‹ã‚ˆã†ã«ã—ãŸã„ã¨æ€ã„ã¾ã™ã€‚

â€» åˆã‚ã¦ã®å ´åˆã¯ã€Œ é–‹å§‹ã€ã‚’ã‚¯ãƒªãƒƒã‚¯ã™ã‚‹ã¨â†‘ã®ç”»é¢è¡¨ç¤ºã•ã‚Œã‚‹ã¯ãšã§ã™ã€‚

### 1-2. `buildTypes` ã¨ `productFlavors`

ä»Šå›ãƒ‡ãƒ—ãƒ­ã‚¤ã‚’è¡Œã† `buildTypes` ã¨ `productFlavors` æ§‹æˆã¯ä»¥ä¸‹ã‚’æƒ³å®šã—ã¦ã¾ã™ã€‚

```kotlin
// app/build.gradle.kts
android {
    // ...
    flavorDimensions += "default"
    productFlavors {
        create("dev") {
            signingConfig = signingConfigs.getByName("dev") // signingConfigæŒ‡å®šæ¸ˆã¿
            isDefault = true
            applicationIdSuffix = ".dev"
            dimension = "default"
        }
    }

    buildTypes {
        release {
            isMinifyEnabled = false
            proguardFiles(
                getDefaultProguardFile("proguard-android-optimize.txt"),
                "proguard-rules.pro"
            )
        }
    }
}
```

# CIãƒ“ãƒ«ãƒ‰

## 1. ãƒ†ã‚¹ãƒˆã¨ãƒ“ãƒ«ãƒ‰ã‚’è¡Œã†ã‚·ãƒ³ãƒ—ãƒ«ãªãƒ¯ãƒ¼ã‚¯ãƒ•ãƒ­ãƒ¼

ã¾ãšã¯ã‚·ãƒ³ãƒ—ãƒ«ãªãƒ¯ãƒ¼ã‚¯ãƒ•ãƒ­ãƒ¼ã‚’ä½œæˆã—ã¾ã™ã€‚ä»¥ä¸‹å†…å®¹ã§ `codemagic.yaml` ã‚’ãƒ—ãƒ­ã‚¸ã‚§ã‚¯ãƒˆç›´ä¸‹ã«ä½œæˆã—ã¾ã™ã€‚

```yaml
workflows:
  build-dev-android-workflow:
    name: Build Dev Android Workflow
    max_build_duration: 60
    instance_type: mac_mini_m1
    environment:
      groups:
        - setup # JAVA_HOMEã®å¤‰æ›´ãªã©å¿…è¦ãŒã‚ã‚Œã°(è©³ç´°ã¯ãƒˆãƒ©ãƒ–ãƒ«ã‚·ãƒ¥ãƒ¼ãƒ†ã‚£ãƒ³ã‚°å‚ç…§)
    scripts:
      - name: Run tests
        script: ./gradlew test
      - name: Build devRelease
        script: ./gradlew assembleDevRelease
    artifacts:
      - app/build/outputs/apk/**/*.apk
```

ã‚³ãƒŸãƒƒãƒˆã—ãŸã‚‰æ—©é€Ÿpushã—ã¾ã™ã€‚

### 1-1. æ‰‹å‹•ã§ãƒ“ãƒ«ãƒ‰

Pushã—ãŸã‚‰Codemagicã®ãƒ€ãƒƒã‚·ãƒ¥ãƒœãƒ¼ãƒ‰ã‚’ç¢ºèªã™ã‚‹ã¨å¯¾è±¡ã®ãƒ—ãƒ­ã‚¸ã‚§ã‚¯ãƒˆã§ã€ã€ŒStart your first buildã€ãŒã§ãã‚‹ã‚ˆã†ã«ãªã£ã¦ã„ã‚‹ã‹ã¨æ€ã„ã¾ã™ã€‚

![image2.png](/images/2837a33e3f455b/image2.png)

èµ¤æ ã‚’å¿…è¦ã«å¿œã˜ã¦è¨­å®šã—ã€ã€ŒStart new buildã€ã§ãƒ“ãƒ«ãƒ‰ã‚’é–‹å§‹ã—ã¾ã™ã€‚

![image3.png](/images/2837a33e3f455b/image3.png)

ãƒ“ãƒ«ãƒ‰ãŒæˆåŠŸã™ã‚Œã°OKã§ã™!

### 1-2. ç‰¹å®šã®branchã«pushã•ã‚ŒãŸã‚‰ãƒ“ãƒ«ãƒ‰ã•ã‚Œã‚‹æ§˜ã«ã™ã‚‹

[https://docs.codemagic.io/yaml-running-builds/starting-builds-automatically/](https://docs.codemagic.io/yaml-running-builds/starting-builds-automatically/)

â†‘ã‚’å‚è€ƒã«ä»¥ä¸‹ã‚’è¿½åŠ ã—ã¾ã™ã€‚ã“ã®å ´åˆã ã¨ `develop` ãƒ–ãƒ©ãƒ³ãƒã«pushã•ã‚ŒãŸã‚‰ãƒ“ãƒ«ãƒ‰ãŒèµ°ã‚‹ã‚ˆã†ã«ãªã‚Šã¾ã™ã€‚

```yaml

triggering:
  events:
    - push
  branch_patterns:
    - pattern: "develop"
      include: true
      source: true
```

# Firebase App Distributionã¸Publish

## ã‚µãƒ¼ãƒ“ã‚¹ã‚¢ã‚«ã‚¦ãƒ³ãƒˆã«ã‚ˆã‚‹èªè¨¼

Firebaseã®ãƒ€ãƒƒã‚·ãƒ¥ãƒœãƒ¼ãƒ‰ã‹ã‚‰æ­¯è»Šã‚¢ã‚¤ã‚³ãƒ³ > ã‚µãƒ¼ãƒ“ã‚¹ã‚¢ã‚«ã‚¦ãƒ³ãƒˆ > Nå€‹ã®ã‚µãƒ¼ãƒ“ã‚¹ã‚¢ã‚«ã‚¦ãƒ³ãƒˆ ã‚’ã‚¯ãƒªãƒƒã‚¯ã—ã¾ã™ã€‚

![image4.png](/images/2837a33e3f455b/image4.png)

GCPã®ç”»é¢ãŒé–‹ã„ãŸã‚‰å·¦ãƒ¡ãƒ‹ãƒ¥ãƒ¼ã®ã€Œã‚µãƒ¼ãƒ“ã‚¹ã‚¢ã‚«ã‚¦ãƒ³ãƒˆã€ã‚’é¸æŠã—ã€ä¸Šéƒ¨ãƒ¡ãƒ‹ãƒ¥ãƒ¼ã®ã€Œã‚µãƒ¼ãƒ“ã‚¹ã‚¢ã‚«ã‚¦ãƒ³ãƒˆã‚’ä½œæˆã€ ã‹ã‚‰ã‚µãƒ¼ãƒ“ã‚¹ã‚¢ã‚«ã‚¦ãƒ³ãƒˆã®è©³ç´°ã‚’å…¥åŠ›ã—ã€ã€Œä½œæˆã—ã¦ç¶šè¡Œã€ã‚’ã‚¯ãƒªãƒƒã‚¯ã—ã¾ã™ã€‚

![image5.png](/images/2837a33e3f455b/image5.png)

æ¬¡ã«ã€Œãƒ­ãƒ¼ãƒ«ã‚’é¸æŠã€ã§ã€ŒFirebase App Distribution Admin SDK ã‚µãƒ¼ãƒ“ã‚¹ã‚¨ãƒ¼ã‚¸ã‚§ãƒ³ãƒˆã€ã‚’é¸æŠã—ã¾ã™ã€‚

![image6.png](/images/2837a33e3f455b/image6.png)

æœ€å¾Œã¯ä½•ã‚‚å…¥åŠ›ã›ãšã€Œå®Œäº†ã€ã‚’ã‚¯ãƒªãƒƒã‚¯ã—ã¾ã™ã€‚

![image7.png](/images/2837a33e3f455b/image7.png)

æ¬¡ã«ä½œæˆã—ãŸã‚µãƒ¼ãƒ“ã‚¹ã‚¢ã‚«ã‚¦ãƒ³ãƒˆã®ãƒ¡ãƒ‹ãƒ¥ãƒ¼ã‹ã‚‰ã€Œéµã‚’ç®¡ç†ã€ã‚’ã‚¯ãƒªãƒƒã‚¯ã—ã¾ã™ã€‚

![image8.png](/images/2837a33e3f455b/image8.png)

ã€Œéµã‚’è¿½åŠ ã€>ã€Œæ–°ã—ã„éµã‚’ä½œæˆã€ã‹ã‚‰ã‚­ãƒ¼ã®ã‚¿ã‚¤ãƒ—ã€ŒJSONã€ã§ã€Œä½œæˆã€ã‚’ã‚¯ãƒªãƒƒã‚¯ã—ã¾ã™ã€‚ãƒ€ã‚¦ãƒ³ãƒ­ãƒ¼ãƒ‰ã•ã‚ŒãŸJSONãƒ•ã‚¡ã‚¤ãƒ«ã¯ã“ã®å¾Œä½¿ã†ã®ã§é©åˆ‡ãªå ´æ‰€ã§ç®¡ç†ã—ã¾ã™ã€‚

![image9.png](/images/2837a33e3f455b/image9.png)

## Codemagicã®ç’°å¢ƒå¤‰æ•°è¨­å®š

å…ˆã»ã©ãƒ€ã‚¦ãƒ³ãƒ­ãƒ¼ãƒ‰ã—ãŸJSONãƒ•ã‚¡ã‚¤ãƒ«ã‚’ã‚¯ãƒªãƒƒãƒ—ãƒœãƒ¼ãƒ‰ã«ã‚³ãƒ”ãƒ¼ã—ã¾ã™ã€‚

```bash
cat xxxxxxxxx.json | pbcopy
```

Codemagicã®å¯¾è±¡ã®ã‚¢ãƒ—ãƒªã®è¨­å®šã€ŒEnvironment variablesã€ã‚¿ãƒ–ã§æ–°è¦ã« `FIREBASE_SERVICE_ACCOUNT` ã¨ã„ã†ç’°å¢ƒå¤‰æ•°ã‚’è¿½åŠ ã—ã¾ã™ã€‚

![image10.png](/images/2837a33e3f455b/image10.png)

å€¤ã¯å…ˆã»ã©ã‚¯ãƒªãƒƒãƒ—ãƒœãƒ¼ãƒ‰ã«ã‚³ãƒ”ãƒ¼ã—ãŸå†…å®¹ã‚’è²¼ã‚Šä»˜ã‘ã¾ã™ã€‚

æœ€å¾Œã« `codemagic.yaml` ã«ä»¥ä¸‹ã‚’è¿½åŠ ã—Pushã—ã¾ã™ã€‚

```yaml
publishing:
  firebase:
    firebase_service_account: $FIREBASE_SERVICE_ACCOUNT
    android:
      app_id: $ANDROID_APP_ID
      groups:
        - Developer
```

Firebase App Distribution ã§ä»¥ä¸‹ã®æ§˜ã«ã‚¢ãƒ—ãƒªãŒãƒªãƒªãƒ¼ã‚¹ã•ã‚Œã¦ã„ã‚Œã°æˆåŠŸã§ã™!

![image11.png](/images/2837a33e3f455b/image11.png)

# ãƒˆãƒ©ãƒ–ãƒ«ã‚·ãƒ¥ãƒ¼ãƒ†ã‚£ãƒ³ã‚°

## `Android Gradle plugin requires Java 17 to run. You are currently using Java 11.` **ãŒç™ºç”Ÿã™ã‚‹!**

### ã‚¨ãƒ©ãƒ¼ã®è©³ç´°

```bash
* What went wrong:
An exception occurred applying plugin request [id: 'com.android.application', version: '8.1.1']
> Failed to apply plugin 'com.android.internal.application'.
   > Android Gradle plugin requires Java 17 to run. You are currently using Java 11.
      Your current JDK is located in /Library/Java/JavaVirtualMachines/zulu-11.jdk/Contents/Home
      You can try some of the following options:
       - changing the IDE settings.
       - changing the JAVA_HOME environment variable.
       - changing `org.gradle.java.home` in `gradle.properties`.
```

### è§£æ±ºæ–¹æ³•

`Java 17` ã® `JAVA_HOME` ã®å ´æ‰€ãŒ[ã“ã¡ã‚‰](https://docs.codemagic.io/specs/versions-macos/)ã«è¼‰ã£ã¦ã„ã¾ã™ã€‚

![image12.png](/images/2837a33e3f455b/image12.png)

â†‘ã‚’å‚è€ƒã«Codemagicã®å¯¾è±¡ã‚¢ãƒ—ãƒªã®è¨­å®šç”»é¢ã‹ã‚‰ã€ŒEnvironment variablesã€ã‚’é¸æŠã—ã€ä»¥ä¸‹ã‚’è¿½åŠ ã—ã¦ã‚„ã‚Šã¾ã™ã€‚

```text
Name: JAVA_HOME
Value: /Library/Java/JavaVirtualMachines/zulu-17.jdk/Contents/Home
Variable group: setup (groupã¯å¿…è¦ã«å¿œã˜ã¦å¤‰æ›´ã—ã¦è¨­å®š)
```

![image13.png](/images/2837a33e3f455b/image13.png)

## Publishingæ™‚ã«ä»¥ä¸‹ã‚¨ãƒ©ãƒ¼ãŒç™ºç”Ÿã™ã‚‹

```text
Authenticating with `--token` is deprecated and will be removed in a future major version of `firebase-tools`. Instead, use a service account key with `GOOGLE_APPLICATION_CREDENTIALS`:
```

ç¾åœ¨ `firebase_token` ã¯ä½¿ãˆãªã„ã®ã§ `firebase_service_account` ã‚’ä½¿ã†å¿…è¦ãŒã‚ã‚‹ã€‚

# ã“ã®è¨˜äº‹ã¯ä»¥ä¸‹ã®æƒ…å ±ã‚’å‚è€ƒã«ã—ã¦åŸ·ç­†ã—ã¾ã—ãŸ

- [Codemagic YAML cheat sheet | Codemagic Blog](https://blog.codemagic.io/codemagic-yaml-cheatsheet/)