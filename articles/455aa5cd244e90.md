---
title: "DataStoreã‚’è©¦ã—ã¦ã¿ã‚‹"
emoji: "ğŸ™Œ"
type: "tech"
topics:
  - "android"
  - "datastore"
  - "kotlin"
published: true
published_at: "2021-10-22 06:12"
---

# [DataStore](https://developer.android.com/topic/libraries/architecture/datastore?hl=ja)ã¨ã¯?
> ãƒ—ãƒ­ãƒˆã‚³ãƒ« ãƒãƒƒãƒ•ã‚¡ã‚’ä½¿ç”¨ã—ã¦ Key-Value ãƒšã‚¢ã‚„å‹ä»˜ãã‚ªãƒ–ã‚¸ã‚§ã‚¯ãƒˆã‚’æ ¼ç´ã§ãã‚‹SharedPreferencesã®é€²åŒ–ç‰ˆ

DataStore ã«ã¯ã€ä»¥ä¸‹2 ç¨®é¡ãŒã‚ã‚‹
- **Preferences DataStore**
    - ã‚­ãƒ¼ã‚’ä½¿ç”¨ã—ã¦ãƒ‡ãƒ¼ã‚¿ã®ä¿å­˜ãŠã‚ˆã³ã‚¢ã‚¯ã‚»ã‚¹ã‚’è¡Œã„ã¾ã™ã€‚ã“ã®å®Ÿè£…ã§ã¯ã€
        å®šç¾©æ¸ˆã¿ã®ã‚¹ã‚­ãƒ¼ãƒã¯å¿…è¦ã‚ã‚Šã¾ã›ã‚“ãŒã€ã‚¿ã‚¤ãƒ—ã‚»ãƒ¼ãƒ•ã§ã¯ã‚ã‚Šã¾ã›ã‚“ã€‚
- **Proto DataStore**
    - ã‚«ã‚¹ã‚¿ãƒ ãƒ‡ãƒ¼ã‚¿å‹ã®ã‚¤ãƒ³ã‚¹ã‚¿ãƒ³ã‚¹ã¨ã—ã¦ãƒ‡ãƒ¼ã‚¿ã‚’ä¿å­˜ã—ã¾ã™ã€‚ã“ã®å®Ÿè£…ã§ã¯ã€
        ãƒ—ãƒ­ãƒˆã‚³ãƒ« ãƒãƒƒãƒ•ã‚¡ã‚’ä½¿ç”¨ã—ã¦ã‚¹ã‚­ãƒ¼ãƒã‚’å®šç¾©ã™ã‚‹å¿…è¦ãŒã‚ã‚Šã¾ã™ãŒã€ã‚¿ã‚¤ãƒ—ã‚»ãƒ¼ãƒ•ã§ã™ã€‚

## è©¦ã—ãŸç’°å¢ƒ
ã‚µãƒ³ãƒ—ãƒ«ç”¨ã«[ã“ã¡ã‚‰](https://github.com/Slowhand0309/DataStoreSample)ã«ãƒªãƒã‚¸ãƒˆãƒªä½œæˆã—ã¦ã„ã¾ã™ã€‚

```
macOS Catalina ver 10.15.7 (intelç‰ˆ)
Android Studio Arctic Fox | 2020.3.1 Pat ch 2
```

## Preferences DataStore

ã¾ãšã¯ `Preferences DataStore` ã‚’è©¦ã—ã¦ã¿ã¾ã™ã€‚æ—©é€Ÿãƒ—ãƒ­ã‚¸ã‚§ã‚¯ãƒˆã‚’ä½œæˆã—ã€ä»¥ä¸‹ã‚’ `app/build.gradle` ã«è¿½åŠ ã—ã¾ã™ã€‚

```gradle
implementation "androidx.datastore:datastore-preferences:1.0.0"
```

DataStore ã‚¯ãƒ©ã‚¹ã¨ Preferences ã‚¯ãƒ©ã‚¹ã‚’ä½¿ç”¨ã—ã¦ã€å˜ç´”ãª Key-Value ãƒšã‚¢ã‚’ãƒ‡ã‚£ã‚¹ã‚¯ã«ä¿æŒã—ã¦ã¿ã¾ã™ã€‚
Kotlinãƒ•ã‚¡ã‚¤ãƒ«ã®ãƒˆãƒƒãƒ—ã§ä»¥ä¸‹ã‚’è¿½åŠ ã—ã€DataStoreã‚’ã‚·ãƒ³ã‚°ãƒ«ãƒˆãƒ³ã¨ã—ã¦æ‰±ãˆã‚‹ã‚ˆã†ã«ã—ã¾ã™ã€‚

```kotlin
import androidx.datastore.core.DataStore
import androidx.datastore.preferences.core.Preferences
import androidx.datastore.preferences.preferencesDataStore

val Context.dataStore: DataStore<Preferences> by preferencesDataStore(name = "settings")
```

### å€¤ã‚’ä¿å­˜ã—ã¦èª­ã¿è¾¼ã‚€å‡¦ç†ã‚’æ›¸ã„ã¦ã¿ã‚‹
ã‚·ãƒ³ãƒ—ãƒ«ã«ä¿å­˜ -> èª­ã¿è¾¼ã¿ã‚’è¡Œã£ã¦ãƒ­ã‚°å‡ºåŠ›ã‚’è¡Œã„ã¾ã™ã€‚

```kotlin
val Context.dataStore: DataStore<Preferences> by preferencesDataStore(name = "settings")
val TEXT_KEY = stringPreferencesKey("example_text")

class MainActivity : ComponentActivity() {
    override fun onCreate(savedInstanceState: Bundle?) {
        super.onCreate(savedInstanceState)
        ...

        GlobalScope.launch {
            saveText(this@MainActivity, "sample")

            val textFlow: Flow<String> = dataStore.data.map { p -> p[TEXT_KEY] ?: "" }
            textFlow.collect { Log.d("DataStore", "text = $it") }
        }
    }
}

suspend fun saveText(context: Context, text: String) {
    context.dataStore.edit { settings ->
        settings[TEXT_KEY] = text
    }
}
```
çµæœ `DataStore: text = sample` ãŒå‡ºåŠ›ã•ã‚Œã‚Œã°OK

## Proto DataStore
æ¬¡ã¯ `Proto DataStore` ã‚’è©¦ã—ã¦ã¿ã¾ã™ã€‚

### ç’°å¢ƒæ§‹ç¯‰
ã¾ãšã¯ä»¥ä¸‹å†…å®¹ã§ãƒ¢ã‚¸ãƒ¥ãƒ¼ãƒ«å†…ã® `build.gradle` ã‚’ä¿®æ­£ã—ã¾ã™ã€‚

```gradle
plugins {
    id "com.google.protobuf"
}

dependencies {
    implementation "androidx.datastore:datastore:1.0.0"
    implementation  "com.google.protobuf:protobuf-javalite:3.14.0"
}

protobuf {
    protoc {
        artifact = "com.google.protobuf:protoc:3.14.0"
    }

    // Generates the java Protobuf-lite code for the Protobufs in this project. See
    // https://github.com/google/protobuf-gradle-plugin#customizing-protobuf-compilation
    // for more information.
    generateProtoTasks {
        all().each { task ->
            task.builtins {
                java {
                    option 'lite'
                }
            }
        }
    }
}
```

ãƒ—ãƒ­ã‚¸ã‚§ã‚¯ãƒˆãƒ«ãƒ¼ãƒˆã® `build.gradle` ã® `dependencies` ã«ä»¥ä¸‹ã‚’è¿½åŠ ã—ã¾ã™ã€‚

```gradle
dependencies {
        classpath 'com.google.protobuf:protobuf-gradle-plugin:0.8.17'
}
```

æ¬¡ã« `app/src/main/proto` ã« `settings.proto` ã‚’ä½œæˆã—ã¾ã™ã€‚

```proto
syntax = "proto3";

option java_package = "com.slowhand.datastoresample.model";
option java_multiple_files = true;

message Settings {
  int32 example_counter = 1;
}
```

`Settings.kt` ã‚’ä»¥ä¸‹å†…å®¹ã§ä½œæˆã—ã¾ã™ã€‚

```kotlin
package com.slowhand.datastoresample.model

import android.content.Context
import androidx.datastore.core.CorruptionException
import androidx.datastore.core.DataStore
import androidx.datastore.core.Serializer
import androidx.datastore.dataStore
import androidx.datastore.preferences.protobuf.InvalidProtocolBufferException
import java.io.InputStream
import java.io.OutputStream

object SettingsSerializer : Serializer<Settings> {
    override val defaultValue: Settings = Settings.getDefaultInstance()

    override suspend fun readFrom(input: InputStream): Settings {
        try {
            return Settings.parseFrom(input)
        } catch (exception: InvalidProtocolBufferException) {
            throw CorruptionException("Cannot read proto.", exception)
        }
    }

    override suspend fun writeTo(
        t: Settings,
        output: OutputStream
    ) = t.writeTo(output)
}

val Context.settingsDataStore: DataStore<Settings> by dataStore(
    fileName = "settings.proto",
    serializer = SettingsSerializer
)
```

ä¿å­˜ã—ã¦èª­ã¿è¾¼ã‚“ã§ã¿ã¾ã™ã€‚

```kotlin
GlobalScope.launch {
    incrementCounter(this@MainActivity)
    val exampleCounterFlow: Flow<Int> = settingsDataStore.data
        .map { settings ->
            settings.exampleCounter
        }
    exampleCounterFlow.collect { Log.d("DataStore", "counter = $it")}
}

suspend fun incrementCounter(context: Context) {
    context.settingsDataStore.updateData { currentSettings ->
        currentSettings.toBuilder()
            .setExampleCounter(currentSettings.exampleCounter + 1)
            .build()
    }
}
```
`counter = ` ã®ãƒ­ã‚°ãŒå‡ºåŠ›ã•ã‚Œã‚Œã°OKã§ã™ã€‚

# å‚è€ƒURL
- [Jetpack DataStoreå…¥é–€ã€œPreferences DataStoreå®Ÿè£…ç·¨ã€œ - Sansan Builders Blog](https://buildersbox.corp-sansan.com/entry/2021/02/24/110000)
- [Coroutinesã®launchã¨asyncã¨Channelã¨Flowã®ä½¿ã„åˆ†ã‘ - Qiita](https://qiita.com/naoi/items/9892db4cec2e9c0f6114)
- [Jetpack Compose ã®ä¾‹ - ãŸãã•ã‚“ã®è‡ªç”±å¸³](https://takusan.negitoro.dev/posts/android_jc_recipe/)
- [ã‚³ãƒ³ãƒãƒ¼ã‚¶ãƒ–ãƒ«ã®ãƒ©ã‚¤ãƒ•ã‚µã‚¤ã‚¯ãƒ« Â |Â  Jetpack Compose Â |Â  Android Developers](https://developer.android.com/jetpack/compose/lifecycle)
- [Android Jetpack Proto DataStore. A Jetpack recommended solution forâ€¦ | by Satya Pavan Kantamani | ProAndroidDev](https://proandroiddev.com/android-jetpack-proto-datastore-a11ff8edcda8)
- [å…¬å¼ãƒšãƒ¼ã‚¸ã‚’çœºã‚ã¦ã„ã‚‹ã ã‘ã§ã¯ã‚ã‹ã‚‰ãªã„Jetpack DataStoreã®ã‚ã‚Œã“ã‚Œ - Qiita](https://qiita.com/que9/items/54c60d9cbca1dfaffdbf)